diff -r 39d71149faea -r 1ce74c61c5c3 layout/base/nsPresContext.cpp
--- a/layout/base/nsPresContext.cpp	Sat Nov 04 11:01:09 2017 +0100
+++ b/layout/base/nsPresContext.cpp	Wed Nov 01 11:24:17 2017 +0100
@@ -2123,6 +2123,10 @@
 
   mPendingViewportChange = false;
 
+  if (!mShell || !mShell->DidInitialize()) {
+    return;
+  }
+
   if (mDocument->IsBeingUsedAsImage()) {
     MOZ_ASSERT(mDocument->MediaQueryLists().isEmpty());
     return;
@@ -2130,7 +2134,7 @@
 
   mDocument->NotifyMediaFeatureValuesChanged();
 
-  MOZ_ASSERT(nsContentUtils::IsSafeToRunScript());
+  MOZ_DIAGNOSTIC_ASSERT(nsContentUtils::IsSafeToRunScript());
 
   // Media query list listeners should be notified from a queued task
   // (in HTML5 terms), although we also want to notify them on certain
