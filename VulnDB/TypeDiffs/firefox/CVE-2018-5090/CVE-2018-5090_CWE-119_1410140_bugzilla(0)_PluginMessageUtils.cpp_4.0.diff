diff -r 370e36a039fe -r 3d2a3e89c197 dom/plugins/ipc/PluginMessageUtils.cpp
--- a/dom/plugins/ipc/PluginMessageUtils.cpp	Wed Oct 25 13:07:21 2017 +0200
+++ b/dom/plugins/ipc/PluginMessageUtils.cpp	Sat Oct 21 15:02:28 2017 -0700
@@ -226,7 +226,11 @@
     aLpofn->nMaxCustFilter = 0;
   }
   aLpofn->nFilterIndex = mFilterIndex;
-  wcscpy(aLpofn->lpstrFile, mFile.c_str());
+  if (mNMaxFile > 0) {
+    wcsncpy(aLpofn->lpstrFile, mFile.c_str(),
+            std::min(static_cast<uint32_t>(mFile.size()+1), mNMaxFile));
+    aLpofn->lpstrFile[mNMaxFile - 1] = L'\0';
+  }
   aLpofn->nMaxFile = mNMaxFile;
   aLpofn->nMaxFileTitle = mNMaxFileTitle;
   if (mHasInitialDir) {
@@ -252,7 +256,7 @@
   }
   if (mHasCustomFilter) {
     aLpofn->lpstrCustomFilter =
-      static_cast<LPTSTR>(moz_xmalloc(sizeof(wchar_t) * (mCustomFilterIn.size() + 1) + mNMaxCustFilterOut));
+      static_cast<LPTSTR>(moz_xmalloc(sizeof(wchar_t) * (mCustomFilterIn.size() + 1 + mNMaxCustFilterOut)));
   }
   aLpofn->lpstrFile =
     static_cast<LPTSTR>(moz_xmalloc(sizeof(wchar_t) * mNMaxFile));
