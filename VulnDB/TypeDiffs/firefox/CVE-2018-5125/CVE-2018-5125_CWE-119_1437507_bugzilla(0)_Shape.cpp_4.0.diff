diff -r 2811aeb13e51 -r 9d7c295d9570 js/src/vm/Shape.cpp
--- a/js/src/vm/Shape.cpp	Wed Feb 21 16:03:45 2018 +0100
+++ b/js/src/vm/Shape.cpp	Fri Feb 23 13:25:53 2018 -0500
@@ -1329,6 +1329,10 @@
     if (obj->hasAllFlags(flags))
         return true;
 
+    Shape* existingShape = obj->ensureShape(cx);
+    if (!existingShape)
+        return false;
+
     if (obj->isNative() && obj->as<NativeObject>().inDictionaryMode()) {
         if (generateShape == GENERATE_SHAPE) {
             if (!NativeObject::generateOwnShape(cx, obj.as<NativeObject>()))
@@ -1344,10 +1348,6 @@
         return true;
     }
 
-    Shape* existingShape = obj->ensureShape(cx);
-    if (!existingShape)
-        return false;
-
     Shape* newShape = Shape::setObjectFlags(cx, flags, obj->taggedProto(), existingShape);
     if (!newShape)
         return false;
