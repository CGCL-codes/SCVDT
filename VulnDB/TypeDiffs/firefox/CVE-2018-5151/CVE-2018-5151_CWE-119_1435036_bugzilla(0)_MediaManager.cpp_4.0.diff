diff -r 2fee5cc3ec3a -r 99a22b7c1e8e dom/media/MediaManager.cpp
--- a/dom/media/MediaManager.cpp	Mon Mar 19 15:52:36 2018 +0100
+++ b/dom/media/MediaManager.cpp	Mon Mar 19 09:40:38 2018 +0100
@@ -1142,14 +1142,17 @@
   public:
     TracksAvailableCallback(MediaManager* aManager,
                             const nsMainThreadPtrHandle<nsIDOMGetUserMediaSuccessCallback>& aSuccess,
-                            uint64_t aWindowID,
+                            const RefPtr<GetUserMediaWindowListener>& aWindowListener,
                             DOMMediaStream* aStream)
-      : mWindowID(aWindowID), mOnSuccess(aSuccess), mManager(aManager),
-        mStream(aStream) {}
+      : mWindowListener(aWindowListener),
+        mOnSuccess(aSuccess),
+        mManager(aManager),
+        mStream(aStream)
+    {}
     void NotifyTracksAvailable(DOMMediaStream* aStream) override
     {
-      // We're in the main thread, so no worries here.
-      if (!(mManager->IsWindowStillActive(mWindowID))) {
+      // We're on the main thread, so no worries here.
+      if (!mManager->IsWindowListenerStillActive(mWindowListener)) {
         return;
       }
 
@@ -1162,7 +1165,7 @@
       LOG(("Returning success for getUserMedia()"));
       mOnSuccess->OnSuccess(aStream);
     }
-    uint64_t mWindowID;
+    RefPtr<GetUserMediaWindowListener> mWindowListener;
     nsMainThreadPtrHandle<nsIDOMGetUserMediaSuccessCallback> mOnSuccess;
     RefPtr<MediaManager> mManager;
     // Keep the DOMMediaStream alive until the NotifyTracksAvailable callback
@@ -1185,10 +1188,8 @@
 
     // We're on main-thread, and the windowlist can only
     // be invalidated from the main-thread (see OnNavigation)
-    GetUserMediaWindowListener* listener =
-      mManager->GetWindowListener(mWindowID);
-    if (!listener || !window || !window->GetExtantDoc()) {
-      // This window is no longer live.  mListener has already been removed
+    if (!mManager->IsWindowListenerStillActive(mWindowListener)) {
+      // This window is no longer live. mListener has already been removed.
       return NS_OK;
     }
 
@@ -1378,7 +1379,7 @@
         MakeAndAddRef<Callback>(
           new TracksAvailableCallback(mManager,
                                       mOnSuccess,
-                                      mWindowID,
+                                      mWindowListener,
                                       domStream))));
 
     // Dispatch to the media thread to ask it to start the sources,
@@ -3169,6 +3170,13 @@
        aWindowId, outerID));
 }
 
+bool
+MediaManager::IsWindowListenerStillActive(GetUserMediaWindowListener* aListener)
+{
+  MOZ_DIAGNOSTIC_ASSERT(aListener);
+  return aListener && aListener == GetWindowListener(aListener->WindowID());
+}
+
 void
 MediaManager::GetPref(nsIPrefBranch *aBranch, const char *aPref,
                       const char *aData, int32_t *aVal)
