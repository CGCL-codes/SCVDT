diff -r c5ef0a450889 -r 5259d71c643f layout/style/nsComputedDOMStyle.cpp
--- a/layout/style/nsComputedDOMStyle.cpp	Thu Oct 26 17:27:31 2017 +0800
+++ b/layout/style/nsComputedDOMStyle.cpp	Sun Oct 29 17:39:20 2017 -0400
@@ -826,17 +826,17 @@
   mFlushedPendingReflows = aNeedsLayoutFlush;
 #endif
 
+  nsCOMPtr<nsIPresShell> presShellForContent = GetPresShellForContent(mContent);
+  if (presShellForContent && presShellForContent != document->GetShell()) {
+    presShellForContent->FlushPendingNotifications(FlushType::Style);
+  }
+
   mPresShell = document->GetShell();
   if (!mPresShell || !mPresShell->GetPresContext()) {
     ClearStyleContext();
     return;
   }
 
-  nsCOMPtr<nsIPresShell> presShellForContent = GetPresShellForContent(mContent);
-  if (presShellForContent && presShellForContent != mPresShell) {
-    presShellForContent->FlushPendingNotifications(FlushType::Style);
-  }
-
   // We need to use GetUndisplayedRestyleGeneration instead of
   // GetRestyleGeneration, because the caching of mStyleContext is an
   // optimization that is useful only for displayed elements.
