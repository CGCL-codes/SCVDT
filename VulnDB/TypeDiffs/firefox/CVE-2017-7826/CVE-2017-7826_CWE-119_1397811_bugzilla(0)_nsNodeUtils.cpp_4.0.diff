diff -r f430287412d3 -r f609508b197d dom/base/nsNodeUtils.cpp
--- a/dom/base/nsNodeUtils.cpp	Thu Aug 31 10:19:04 2017 +0800
+++ b/dom/base/nsNodeUtils.cpp	Fri Oct 20 11:02:29 2017 +0100
@@ -605,6 +605,15 @@
     }
   }
 
+  if (aNodesWithProperties && aNode->HasProperties()) {
+    bool ok = aNodesWithProperties->AppendObject(aNode);
+    MOZ_RELEASE_ASSERT(ok, "Out of memory");
+    if (aClone) {
+      ok = aNodesWithProperties->AppendObject(clone);
+      MOZ_RELEASE_ASSERT(ok, "Out of memory");
+    }
+  }
+
   if (aDeep && (!aClone || !aNode->IsNodeOfType(nsINode::eATTRIBUTE))) {
     // aNode's children.
     for (nsIContent* cloneChild = aNode->GetFirstChild();
@@ -664,18 +673,6 @@
   }
 #endif
 
-  if (aNodesWithProperties && aNode->HasProperties()) {
-    bool ok = aNodesWithProperties->AppendObject(aNode);
-    if (aClone) {
-      ok = ok && aNodesWithProperties->AppendObject(clone);
-    }
-
-    if (NS_WARN_IF(!ok)) {
-      aError.Throw(NS_ERROR_OUT_OF_MEMORY);
-      return nullptr;
-    }
-  }
-
   return clone.forget();
 }
 
