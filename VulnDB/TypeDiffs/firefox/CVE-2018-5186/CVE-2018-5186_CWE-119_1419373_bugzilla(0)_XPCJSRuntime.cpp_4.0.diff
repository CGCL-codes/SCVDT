diff -r dcfb7f0bb6a9 -r d1c67d1afe26 js/xpconnect/src/XPCJSRuntime.cpp
--- a/js/xpconnect/src/XPCJSRuntime.cpp	Fri Apr 20 16:41:07 2018 +0900
+++ b/js/xpconnect/src/XPCJSRuntime.cpp	Mon Apr 23 10:51:33 2018 +0100
@@ -187,8 +187,13 @@
 CompartmentPrivate::~CompartmentPrivate()
 {
     MOZ_COUNT_DTOR(xpc::CompartmentPrivate);
+    delete mWrappedJSMap;
+}
+
+void
+CompartmentPrivate::SystemIsBeingShutDown()
+{
     mWrappedJSMap->ShutdownMarker();
-    delete mWrappedJSMap;
 }
 
 RealmPrivate::RealmPrivate(JS::Realm* realm)
@@ -1018,6 +1023,14 @@
 /***************************************************************************/
 
 void
+XPCJSRuntime::SystemIsBeingShutDown()
+{
+    // We don't want to track wrapped JS roots after this point since we're
+    // making them !IsValid anyway through SystemIsBeingShutDown.
+    mWrappedJSRoots = nullptr;
+}
+
+void
 XPCJSRuntime::Shutdown(JSContext* cx)
 {
     // This destructor runs before ~CycleCollectedJSContext, which does the
@@ -1031,10 +1044,6 @@
 
     JS::SetGCSliceCallback(cx, mPrevGCSliceCallback);
 
-    // We don't want to track wrapped JS roots after this point since we're
-    // making them !IsValid anyway through SystemIsBeingShutDown.
-    mWrappedJSRoots = nullptr;
-
     // clean up and destroy maps...
     mWrappedJSMap->ShutdownMarker();
     delete mWrappedJSMap;
