diff -r 76c9e778b0e1 -r 42e0ec24006e dom/html/nsHTMLDocument.cpp
--- a/dom/html/nsHTMLDocument.cpp	Thu Dec 21 15:03:30 2017 -0500
+++ b/dom/html/nsHTMLDocument.cpp	Thu Dec 21 15:08:49 2017 -0500
@@ -1598,6 +1598,18 @@
         nsCOMPtr<nsIDocument> ret = this;
         return ret.forget();
       }
+
+      // Now double-check that our invariants still hold.
+      if (!mScriptGlobalObject) {
+        nsCOMPtr<nsIDocument> ret = this;
+        return ret.forget();
+      }
+
+      nsPIDOMWindowOuter* outer = GetWindow();
+      if (!outer || (GetInnerWindow() != outer->GetCurrentInnerWindow())) {
+        nsCOMPtr<nsIDocument> ret = this;
+        return ret.forget();
+      }
     }
 
     nsCOMPtr<nsIWebNavigation> webnav(do_QueryInterface(shell));
