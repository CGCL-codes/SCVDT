diff --git a/php-5.4.43/var.c b/php-5.4.43-fixed/var.c
index 7603ff2..837e65f 100644
--- a/php-5.4.43/var.c
+++ b/php-5.4.43-fixed/var.c
@@ -775,6 +775,10 @@ static void php_var_serialize_intern(smart_str *buf, zval *struc, HashTable *var
 					/* has custom handler */
 					unsigned char *serialized_data = NULL;
 					zend_uint serialized_length;
+					
+					if (ZEND_INTERNAL_CLASS != ce->type) {
+						BG(serialize_lock)++;
+					}
 
 					if (ce->serialize(struc, &serialized_data, &serialized_length, (zend_serialize_data *)var_hash TSRMLS_CC) == SUCCESS) {
 						smart_str_appendl(buf, "C:", 2);
@@ -790,6 +794,11 @@ static void php_var_serialize_intern(smart_str *buf, zval *struc, HashTable *var
 					} else {
 						smart_str_appendl(buf, "N;", 2);
 					}
+					
+					if (ZEND_INTERNAL_CLASS != ce->type) {
+						BG(serialize_lock)--;
+					}
+					
 					if (serialized_data) {
 						efree(serialized_data);
 					}