--- php/php-src/branches/PHP_5_2/ext/gd/libgd/gd_gd.c	2009/10/12 09:44:18	289556
+++ php/php-src/branches/PHP_5_2/ext/gd/libgd/gd_gd.c	2009/10/12 10:01:37	289557
@@ -39,6 +39,9 @@
 			if (!gdGetWord(&im->colorsTotal, in)) {
 				goto fail1;
 			}
+			if (im->colorsTotal > gdMaxColors) {
+				goto fail1;
+			}
 		}
 		/* Int to accommodate truecolor single-color transparency */
 		if (!gdGetInt(&im->transparent, in)) {
