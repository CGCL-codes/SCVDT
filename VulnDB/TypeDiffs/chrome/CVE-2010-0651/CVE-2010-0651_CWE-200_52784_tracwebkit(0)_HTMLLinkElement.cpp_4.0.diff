Index: /trunk/WebCore/html/HTMLLinkElement.cpp

===================================================================

--- /trunk/WebCore/html/HTMLLinkElement.cpp	(revision 52783)

+++ /trunk/WebCore/html/HTMLLinkElement.cpp	(revision 52784)

@@ -261,4 +261,6 @@

     bool strictParsing = !document()->inCompatMode();

     bool enforceMIMEType = strictParsing;

+    bool crossOriginCSS = false;

+    bool validMIMEType = false;

     bool needsSiteSpecificQuirks = document()->page() && document()->page()->settings()->needsSiteSpecificQuirks();

 

@@ -276,6 +278,17 @@

 #endif

 

-    String sheetText = sheet->sheetText(enforceMIMEType);

+    String sheetText = sheet->sheetText(enforceMIMEType, &validMIMEType);

     m_sheet->parseString(sheetText, strictParsing);

+

+    // If we're loading a stylesheet cross-origin, and the MIME type is not

+    // standard, require the CSS to at least start with a syntactically

+    // valid CSS rule.

+    // This prevents an attacker playing games by injecting CSS strings into

+    // HTML, XML, JSON, etc. etc.

+    if (!document()->securityOrigin()->canRequest(KURL(ParsedURLString, url)))

+        crossOriginCSS = true;

+

+    if (crossOriginCSS && !validMIMEType && !m_sheet->hasSyntacticallyValidCSSHeader())

+        m_sheet = CSSStyleSheet::create(this, url, charset);

 

     if (strictParsing && needsSiteSpecificQuirks) {

