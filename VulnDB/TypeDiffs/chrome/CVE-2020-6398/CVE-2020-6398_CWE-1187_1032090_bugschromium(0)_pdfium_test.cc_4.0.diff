--- a/samples/pdfium_test.cc
+++ b/samples/pdfium_test.cc
@@ -30,6 +30,7 @@
 #include "public/fpdf_ext.h"
 #include "public/fpdf_formfill.h"
 #include "public/fpdf_progressive.h"
+#include "public/fpdf_save.h"
 #include "public/fpdf_structtree.h"
 #include "public/fpdf_text.h"
 #include "public/fpdfview.h"
@@ -842,7 +842,7 @@ void RenderPdf(const std::string& name,
         is_linearized = true;
       }
     } else {
-      doc.reset(FPDF_LoadCustomDocument(&file_access, nullptr));
+      doc.reset(FPDF_LoadCustomDocument(&file_access, "PDF"));
     }
   }
 
@@ -940,6 +940,14 @@ void RenderPdf(const std::string& name,
     }
   }
 
+  FPDF_FILEWRITE write;
+  write.version = 1;
+  write.WriteBlock = [](FPDF_FILEWRITE*, const void*, unsigned long) {
+    return 1;
+  };
+
+  FPDF_SaveAsCopy(doc.get(), &write, 0);
+
   FORM_DoDocumentAAction(form.get(), FPDFDOC_AACTION_WC);
   fprintf(stderr, "Rendered %d pages.\n", rendered_pages);
   if (bad_pages)