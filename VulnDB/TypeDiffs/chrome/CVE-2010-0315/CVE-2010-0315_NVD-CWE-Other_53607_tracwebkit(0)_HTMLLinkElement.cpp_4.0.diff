Index: /trunk/WebCore/html/HTMLLinkElement.cpp

===================================================================

--- /trunk/WebCore/html/HTMLLinkElement.cpp	(revision 53606)

+++ /trunk/WebCore/html/HTMLLinkElement.cpp	(revision 53607)

@@ -255,7 +255,7 @@

 }

 

-void HTMLLinkElement::setCSSStyleSheet(const String& url, const String& charset, const CachedCSSStyleSheet* sheet)

-{

-    m_sheet = CSSStyleSheet::create(this, url, charset);

+void HTMLLinkElement::setCSSStyleSheet(const String& href, const KURL& baseURL, const String& charset, const CachedCSSStyleSheet* sheet)

+{

+    m_sheet = CSSStyleSheet::create(this, href, baseURL, charset);

 

     bool strictParsing = !document()->inCompatMode();

@@ -273,5 +273,5 @@

     if (enforceMIMEType && needsSiteSpecificQuirks) {

         // Covers both http and https, with or without "www."

-        if (url.contains("mcafee.com/japan/", false))

+        if (baseURL.string().contains("mcafee.com/japan/", false))

             enforceMIMEType = false;

     }

@@ -286,9 +286,9 @@

     // This prevents an attacker playing games by injecting CSS strings into

     // HTML, XML, JSON, etc. etc.

-    if (!document()->securityOrigin()->canRequest(KURL(ParsedURLString, url)))

+    if (!document()->securityOrigin()->canRequest(baseURL))

         crossOriginCSS = true;

 

     if (crossOriginCSS && !validMIMEType && !m_sheet->hasSyntacticallyValidCSSHeader())

-        m_sheet = CSSStyleSheet::create(this, url, charset);

+        m_sheet = CSSStyleSheet::create(this, href, baseURL, charset);

 

     if (strictParsing && needsSiteSpecificQuirks) {

@@ -298,5 +298,5 @@

         // There are two variants of KHTMLFixes.css. One is equal to mediaWikiKHTMLFixesStyleSheet,

         // while the other lacks the second trailing newline.

-        if (url.endsWith(slashKHTMLFixesDotCss) && !sheetText.isNull() && mediaWikiKHTMLFixesStyleSheet.startsWith(sheetText)

+        if (baseURL.string().endsWith(slashKHTMLFixesDotCss) && !sheetText.isNull() && mediaWikiKHTMLFixesStyleSheet.startsWith(sheetText)

                 && sheetText.length() >= mediaWikiKHTMLFixesStyleSheet.length() - 1) {

             ASSERT(m_sheet->length() == 1);

