Index: /trunk/WebCore/css/CSSImportRule.cpp

===================================================================

--- /trunk/WebCore/css/CSSImportRule.cpp	(revision 53606)

+++ /trunk/WebCore/css/CSSImportRule.cpp	(revision 53607)

@@ -55,9 +55,9 @@

 }

 

-void CSSImportRule::setCSSStyleSheet(const String& url, const String& charset, const CachedCSSStyleSheet* sheet)

+void CSSImportRule::setCSSStyleSheet(const String& href, const KURL& baseURL, const String& charset, const CachedCSSStyleSheet* sheet)

 {

     if (m_styleSheet)

         m_styleSheet->setParent(0);

-    m_styleSheet = CSSStyleSheet::create(this, url, charset);

+    m_styleSheet = CSSStyleSheet::create(this, href, baseURL, charset);

 

     bool crossOriginCSS = false;

@@ -71,5 +71,5 @@

     if (enforceMIMEType && needsSiteSpecificQuirks) {

         // Covers both http and https, with or without "www."

-        if (url.contains("mcafee.com/japan/", false))

+        if (baseURL.string().contains("mcafee.com/japan/", false))

             enforceMIMEType = false;

     }

@@ -79,9 +79,9 @@

     m_styleSheet->parseString(sheetText, strict);

 

-    if (!parent || !parent->doc() || !parent->doc()->securityOrigin()->canRequest(KURL(ParsedURLString, url)))

+    if (!parent || !parent->doc() || !parent->doc()->securityOrigin()->canRequest(baseURL))

         crossOriginCSS = true;

 

     if (crossOriginCSS && !validMIMEType && !m_styleSheet->hasSyntacticallyValidCSSHeader())

-        m_styleSheet = CSSStyleSheet::create(this, url, charset);

+        m_styleSheet = CSSStyleSheet::create(this, href, baseURL, charset);

 

     if (strict && needsSiteSpecificQuirks) {

@@ -89,5 +89,5 @@

         DEFINE_STATIC_LOCAL(const String, slashKHTMLFixesDotCss, ("/KHTMLFixes.css"));

         DEFINE_STATIC_LOCAL(const String, mediaWikiKHTMLFixesStyleSheet, ("/* KHTML fix stylesheet */\n/* work around the horizontal scrollbars */\n#column-content { margin-left: 0; }\n\n"));

-        if (url.endsWith(slashKHTMLFixesDotCss) && sheetText == mediaWikiKHTMLFixesStyleSheet) {

+        if (baseURL.string().endsWith(slashKHTMLFixesDotCss) && sheetText == mediaWikiKHTMLFixesStyleSheet) {

             ASSERT(m_styleSheet->length() == 1);

             ExceptionCode ec;

@@ -118,7 +118,7 @@

 

     String absHref = m_strHref;

-    if (!parentSheet->href().isNull())

+    if (!parentSheet->putativeBaseURL().isNull())

         // use parent styleheet's URL as the base URL

-        absHref = KURL(KURL(ParsedURLString, parentSheet->href()), m_strHref).string();

+        absHref = KURL(parentSheet->putativeBaseURL(), m_strHref).string();

 

     // Check for a cycle in our import chain.  If we encounter a stylesheet

@@ -126,5 +126,6 @@

     StyleBase* root = this;

     for (StyleBase* curr = parent(); curr; curr = curr->parent()) {

-        if (curr->isCSSStyleSheet() && absHref == static_cast<CSSStyleSheet*>(curr)->href())

+        // FIXME: This is wrong if the putativeBaseURL was updated via document::updateBaseURL. 

+        if (curr->isCSSStyleSheet() && absHref == static_cast<CSSStyleSheet*>(curr)->putativeBaseURL().string())

             return;

         root = curr;

