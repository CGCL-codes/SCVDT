diff --git a/wiretap/mpeg.c b/wiretap/mpeg.c
index 321f45a..6d5cbe5 100644
--- a/wiretap/mpeg.c
+++ b/wiretap/mpeg.c
@@ -4,8 +4,6 @@
  * Written by Shaun Jackman <sjackman@gmail.com>
  * Copyright 2007 Shaun Jackman
  *
- * $Id$
- *
  * Wiretap Library
  * This program is free software; you can redistribute it and/or
  * modify it under the terms of the GNU General Public License
@@ -53,7 +51,7 @@ typedef struct {
 	time_t t0;
 } mpeg_t;
 
-static int 
+static int
 mpeg_resync(wtap *wth, int *err, gchar **err_info _U_)
 {
 	gint64 offset = file_tell(wth->fh);
@@ -74,7 +72,7 @@ mpeg_resync(wtap *wth, int *err, gchar **err_info _U_)
 	return count;
 }
 
-static int 
+static int
 mpeg_read_header(wtap *wth, int *err, gchar **err_info, guint32 *n)
 {
 	int bytes_read;
@@ -113,7 +111,7 @@ mpeg_read_rec_data(FILE_T fh, guint8 *pd, int length, int *err,
 
 #define SCRHZ 27000000
 
-static gboolean 
+static gboolean
 mpeg_read(wtap *wth, int *err, gchar **err_info, gint64 *data_offset)
 {
 	mpeg_t *mpeg = (mpeg_t *)wth->priv;
@@ -227,6 +225,18 @@ mpeg_read(wtap *wth, int *err, gchar **err_info, gint64 *data_offset)
 	}
 	*data_offset = file_tell(wth->fh);
 
+	if (packet_size > WTAP_MAX_PACKET_SIZE) {
+		/*
+		 * Larger than we can handle. Don't blow up trying
+		 * to allocate space for an immensely-large packet
+		 * or clobber the stack.
+		 */
+		*err = WTAP_ERR_BAD_FILE;
+		*err_info = g_strdup_printf("mpeg: File has %u-byte packet, bigger than maximum of %u",
+				packet_size, WTAP_MAX_PACKET_SIZE);
+		return FALSE;
+	}
+
 	buffer_assure_space(wth->frame_buffer, packet_size);
 	if (!mpeg_read_rec_data(wth->fh, buffer_start_ptr(wth->frame_buffer),
 				packet_size, err, err_info))
@@ -260,14 +270,14 @@ struct _mpeg_magic {
 	{ 0, NULL }
 };
 
-int 
+int
 mpeg_open(wtap *wth, int *err, gchar **err_info)
 {
 	int bytes_read;
 	char magic_buf[16];
 	struct _mpeg_magic* m;
 	mpeg_t *mpeg;
-	
+
 	errno = WTAP_ERR_CANT_READ;
 	bytes_read = file_read(magic_buf, sizeof magic_buf, wth->fh);
 	if (bytes_read != (int) sizeof magic_buf) {
@@ -281,7 +291,7 @@ mpeg_open(wtap *wth, int *err, gchar **err_info)
 		if (memcmp(magic_buf, m->match, m->len) == 0)
 			goto good_magic;
 	}
-	
+
 	return 0;
 
 good_magic:
@@ -304,3 +314,17 @@ good_magic:
 
 	return 1;
 }
+
+/*
+ * Editor modelines  -  http://www.wireshark.org/tools/modelines.html
+ *
+ * Local variables:
+ * c-basic-offset: 8
+ * tab-width: 8
+ * indent-tabs-mode: t
+ * End:
+ *
+ * vi: set shiftwidth=8 tabstop=8 noexpandtab:
+ * :indentSize=8:tabSize=8:noTabs=false:
+ */
+
-- 
2.7.4

