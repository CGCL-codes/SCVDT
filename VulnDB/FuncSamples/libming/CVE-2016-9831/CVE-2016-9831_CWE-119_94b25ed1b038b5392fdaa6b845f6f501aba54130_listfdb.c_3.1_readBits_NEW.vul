int readBits(FILE *f, int number)
{
  int ret = buffer;

  if(number == bufbits)
  {
    bufbits = 0;
    buffer = 0;
    return ret;
  }

  if(number > bufbits)
  {
    number -= bufbits;

    while(number>8)
    {
      ret <<= 8;
      ret += fgetc(f);
      if (feof(f))
      {
        fprintf(stderr, "truncated file\n");
        exit(-1);
      }

      ++fileOffset;
      number -= 8;
    }

    ++fileOffset;
    buffer = fgetc(f);
    if (feof(f))
    {
      fprintf(stderr, "truncated file\n");
      exit(-1);
    }


    if(number>0)
    {
      ret <<= number;
      bufbits = 8-number;
      ret += buffer >> (8-number);
      buffer &= (1<<bufbits)-1;
    }

    return ret;
  }

  ret = buffer >> (bufbits-number);
  bufbits -= number;
  buffer &= (1<<bufbits)-1;

  return ret;
}
