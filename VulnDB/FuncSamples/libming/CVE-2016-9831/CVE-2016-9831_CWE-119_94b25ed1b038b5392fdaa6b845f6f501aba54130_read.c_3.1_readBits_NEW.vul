int readBits(FILE *f, int number)
{
  int ret = buffer;
  int tmp_char;

  if(number == bufbits)
  {
    bufbits = 0;
    buffer = 0;
    return ret;
  }

  if(number > bufbits)
  {
    number -= bufbits;

    while(number>8)
    {
      ret <<= 8;
      tmp_char = fgetc(f);
      if (tmp_char == EOF)
      {
        // exit here instead of crashing elswhere
        fprintf(stderr, "truncated file\n");
        exit(-1);
      }

      ret += tmp_char;
      ++fileOffset;
      number -= 8;
    }

    ++fileOffset;
    tmp_char = fgetc(f);
    if (tmp_char == EOF)
    {
      // exit here instead of crashing elswhere
      fprintf(stderr, "truncated file\n");
      exit(-1);
    }

    buffer = tmp_char;

    if(number>0)
    {
      ret <<= number;
      bufbits = 8-number;
      ret += buffer >> (8-number);
      buffer &= (1<<bufbits)-1;
    }

    return ret;
  }

  ret = buffer >> (bufbits-number);
  bufbits -= number;
  buffer &= (1<<bufbits)-1;

  return ret;
}
