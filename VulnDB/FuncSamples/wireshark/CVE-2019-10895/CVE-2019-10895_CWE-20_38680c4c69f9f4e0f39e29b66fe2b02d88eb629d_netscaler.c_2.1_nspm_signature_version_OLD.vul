static guint32
nspm_signature_version(wtap *wth, gchar *nstrace_buf, gint32 len)
{
    gchar *dp = nstrace_buf;
    int bytes_read;

    bytes_read = file_read(dp, len, wth->fh);
    if (bytes_read == len) {

        for ( ; len > (gint32)(MIN(sizeof(NSPR_SIGSTR_V10), sizeof(NSPR_SIGSTR_V20))); dp++, len--)
        {
#define sigv10p    ((nspr_signature_v10_t*)dp)
            if ((pletoh16(&sigv10p->nsprRecordType) == NSPR_SIGNATURE_V10) &&
                (pletoh16(&sigv10p->nsprRecordSize) <= len) &&
                ((gint32)sizeof(NSPR_SIGSTR_V10) <= len) &&
                (!nspm_signature_isv10(sigv10p->sig_Signature)))
                return WTAP_FILE_TYPE_SUBTYPE_NETSCALER_1_0;
#undef    sigv10p

#define sigv20p    ((nspr_signature_v20_t*)dp)
            if ((sigv20p->sig_RecordType == NSPR_SIGNATURE_V20) &&
                (sigv20p->sig_RecordSize <= len) &&
                ((gint32)sizeof(NSPR_SIGSTR_V20) <= len))
            {
                if (!nspm_signature_isv20(sigv20p->sig_Signature)){
                    return WTAP_FILE_TYPE_SUBTYPE_NETSCALER_2_0;
                } else if (!nspm_signature_isv30(sigv20p->sig_Signature)){
                    return WTAP_FILE_TYPE_SUBTYPE_NETSCALER_3_0;
                }else if (!nspm_signature_isv35(sigv20p->sig_Signature)){
                    return WTAP_FILE_TYPE_SUBTYPE_NETSCALER_3_5;
                }
            }
#undef    sigv20p
        }
    }

    return WTAP_FILE_TYPE_SUBTYPE_UNKNOWN;    /* no version found */
}
