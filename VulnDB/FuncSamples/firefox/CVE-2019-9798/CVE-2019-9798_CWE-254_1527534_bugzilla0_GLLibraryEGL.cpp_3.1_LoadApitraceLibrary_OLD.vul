static PRLibrary* LoadApitraceLibrary() {
  // Initialization of gfx prefs here is only needed during the unit tests...
  gfxPrefs::GetSingleton();
  if (!gfxPrefs::UseApitrace()) {
    return nullptr;
  }

  static PRLibrary* sApitraceLibrary = nullptr;

  if (sApitraceLibrary) return sApitraceLibrary;

  nsAutoCString logFile;
  Preferences::GetCString("gfx.apitrace.logfile", logFile);
  if (logFile.IsEmpty()) {
    logFile = "firefox.trace";
  }

  // The firefox process can't write to /data/local, but it can write
  // to $GRE_HOME/
  nsAutoCString logPath;
  logPath.AppendPrintf("%s/%s", getenv("GRE_HOME"), logFile.get());

  // apitrace uses the TRACE_FILE environment variable to determine where
  // to log trace output to
  printf_stderr("Logging GL tracing output to %s", logPath.get());
  setenv("TRACE_FILE", logPath.get(), false);

  printf_stderr("Attempting load of %s\n", APITRACE_LIB);

  sApitraceLibrary = PR_LoadLibrary(APITRACE_LIB);

  return sApitraceLibrary;
}
