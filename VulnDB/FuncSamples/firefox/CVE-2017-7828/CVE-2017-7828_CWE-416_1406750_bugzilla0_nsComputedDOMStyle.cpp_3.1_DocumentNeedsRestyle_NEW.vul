static bool
DocumentNeedsRestyle(
  const nsIDocument* aDocument,
  Element* aElement,
  nsAtom* aPseudo)
{
  nsIPresShell* shell = aDocument->GetShell();
  if (!shell) {
    return true;
  }
  // Unfortunately we don't know if the sheet change affects mContent or not, so
  // just assume it will and that we need to flush normally.
  StyleSetHandle styleSet = shell->StyleSet();
  if (styleSet->StyleSheetsHaveChanged()) {
    return true;
  }

  // If the pseudo-element is animating, make sure to flush.
  if (aElement->MayHaveAnimations() && aPseudo) {
    if (aPseudo == nsCSSPseudoElements::before) {
      if (EffectSet::GetEffectSet(aElement, CSSPseudoElementType::before)) {
        return true;
      }
    } else if (aPseudo == nsCSSPseudoElements::after) {
      if (EffectSet::GetEffectSet(aElement, CSSPseudoElementType::after)) {
        return true;
      }
    }
  }

  nsPresContext* presContext = shell->GetPresContext();
  if (styleSet->IsServo()) {
    // For Servo, we need to process the restyle-hint-invalidations first, to
    // expand LaterSiblings hint, so that we can look whether ancestors need
    // restyling.
    ServoRestyleManager* restyleManager =
      presContext->RestyleManager()->AsServo();
    restyleManager->ProcessAllPendingAttributeAndStateInvalidations();

    if (!presContext->EffectCompositor()->HasPendingStyleUpdates() &&
        !aDocument->GetServoRestyleRoot()) {
      return false;
    }

    // Then if there is a restyle root, we check if the root is an ancestor of
    // this content. If it is not, then we don't need to restyle immediately.
    // Note this is different from Gecko: we only check if any ancestor needs
    // to restyle _itself_, not descendants, since dirty descendants can be
    // another subtree.
    return restyleManager->HasPendingRestyleAncestor(aElement);
  }

  // For Gecko, first check if there is any pending restyle, then we check if
  // any ancestor has dirty bits for restyle.
  GeckoRestyleManager* restyleManager =
    presContext->RestyleManager()->AsGecko();
  if (!presContext->EffectCompositor()->HasPendingStyleUpdates() &&
      !restyleManager->HasPendingRestyles()) {
    return false;
  }

  return ContentNeedsRestyle(aElement);
}
