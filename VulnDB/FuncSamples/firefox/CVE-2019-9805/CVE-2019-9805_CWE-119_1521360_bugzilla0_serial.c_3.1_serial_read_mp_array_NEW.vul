static SECStatus
serial_read_mp_array(msgpack_unpacker* upk, MPArray arr, size_t len,
                     const mp_int* max)
{
  SECStatus rv = SECSuccess;

  msgpack_unpacked res;
  msgpack_unpacked_init(&res);

  P_CHECKCB(upk != NULL);
  P_CHECKCB(arr != NULL);
  P_CHECKCB(max != NULL);

  UP_CHECK(msgpack_unpacker_next(upk, &res))

  msgpack_object obj = res.data;
  P_CHECKCB(obj.type == MSGPACK_OBJECT_ARRAY);

  msgpack_object_array objarr = obj.via.array;
  P_CHECKCB(objarr.size == len);

  P_CHECKC(MPArray_resize(arr, len));
  for (unsigned int i = 0; i < len; i++) {
    P_CHECKC(object_to_mp_int(&objarr.ptr[i], &arr->data[i], max));
  }

cleanup:
  msgpack_unpacked_destroy(&res);

  return rv;
}
