SECStatus
PrioPacketClient_decrypt(PrioPacketClient p, const_PrioConfig cfg,
                         PrivateKey server_priv, const unsigned char* data_in,
                         unsigned int data_len)
{
  SECStatus rv = SECSuccess;
  msgpack_unpacker upk;
  if (!msgpack_unpacker_init(&upk, data_len)) {
    return SECFailure;
  }

  // Decrypt the ciphertext into dec_buf
  unsigned int bytes_decrypted;
  P_CHECKC(PrivateKey_decrypt(server_priv,
                              (unsigned char*)msgpack_unpacker_buffer(&upk),
                              &bytes_decrypted, data_len, data_in, data_len));
  msgpack_unpacker_buffer_consumed(&upk, bytes_decrypted);

  P_CHECKC(serial_read_packet_client(&upk, p, cfg));

cleanup:
  msgpack_unpacker_destroy(&upk);
  return rv;
}
