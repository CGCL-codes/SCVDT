bool
CreateThis(JSContext* cx, HandleObject callee, HandleObject newTarget, MutableHandleValue rval)
{
    rval.set(MagicValue(JS_IS_CONSTRUCTING));

    if (callee->is<JSFunction>()) {
        RootedFunction fun(cx, &callee->as<JSFunction>());
        if (fun->isInterpreted() && fun->isConstructor()) {
            JSScript* script = JSFunction::getOrCreateScript(cx, fun);
            AutoKeepTypeScripts keepTypes(cx);
            if (!script || !script->ensureHasTypes(cx, keepTypes))
                return false;
            if (!js::CreateThis(cx, fun, script, newTarget, GenericObject, rval))
                return false;
        }
    }

    return true;
}
