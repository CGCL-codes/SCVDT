template <IndexInBounds InBounds>
void
PostWriteElementBarrier(JSRuntime* rt, JSObject* obj, int32_t index)
{
    AutoUnsafeCallWithABI unsafe;

    MOZ_ASSERT(!IsInsideNursery(obj));

    if (InBounds == IndexInBounds::Yes) {
        MOZ_ASSERT(uint32_t(index) < obj->as<NativeObject>().getDenseInitializedLength());
    } else {
        if (MOZ_UNLIKELY(!obj->is<NativeObject>() ||
                         index < 0 ||
                         uint32_t(index) >= NativeObject::MAX_DENSE_ELEMENTS_COUNT))
        {
            rt->gc.storeBuffer().putWholeCell(obj);
            return;
        }
    }

    NativeObject* nobj = &obj->as<NativeObject>();
    if (nobj->isInWholeCellBuffer())
        return;

    if (nobj->getDenseInitializedLength() > MAX_WHOLE_CELL_BUFFER_SIZE
#ifdef JS_GC_ZEAL
         || rt->hasZealMode(gc::ZealMode::ElementsBarrier)
#endif
        )
    {
        rt->gc.storeBuffer().putSlot(nobj, HeapSlot::Element,
                                     nobj->unshiftedIndex(index),
                                     1);
        return;
    }

    rt->gc.storeBuffer().putWholeCell(obj);
}
