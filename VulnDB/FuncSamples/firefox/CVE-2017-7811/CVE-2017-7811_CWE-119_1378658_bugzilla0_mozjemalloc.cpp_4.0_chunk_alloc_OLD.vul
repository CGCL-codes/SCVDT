static void *
chunk_alloc(size_t size, size_t alignment, bool base, bool zero)
{
	void *ret;

	MOZ_ASSERT(size != 0);
	MOZ_ASSERT((size & chunksize_mask) == 0);
	MOZ_ASSERT(alignment != 0);
	MOZ_ASSERT((alignment & chunksize_mask) == 0);

	if (CAN_RECYCLE(size)) {
		ret = chunk_recycle(&chunks_szad_mmap, &chunks_ad_mmap,
			size, alignment, base, &zero);
		if (ret)
			goto RETURN;
	}
	ret = chunk_alloc_mmap(size, alignment);
	if (ret) {
		goto RETURN;
	}

	/* All strategies for allocation failed. */
	ret = nullptr;
RETURN:

	if (ret && base == false) {
		if (malloc_rtree_set(chunk_rtree, (uintptr_t)ret, ret)) {
			chunk_dealloc(ret, size);
			return nullptr;
		}
	}

	MOZ_ASSERT(CHUNK_ADDR2BASE(ret) == ret);
	return (ret);
}
