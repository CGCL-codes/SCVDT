static unsigned long
generate_hash_secret_salt(XML_Parser parser)
{
#if defined(__UINTPTR_TYPE__)
# define PARSER_CAST(p)  (__UINTPTR_TYPE__)(p)
#elif defined(_WIN64) && defined(_MSC_VER)
# define PARSER_CAST(p)  (unsigned __int64)(p)
#else
# define PARSER_CAST(p)  (p)
#endif

  /* Factors are 2^31-1 and 2^61-1 (Mersenne primes M31 and M61) */
  unsigned long small_factory = 2147483647ul;
  unsigned long long big_factory = 2305843009213693951ull;

  /* Process ID is 0 bits entropy if attacker has local access
   * XML_Parser address is few bits of entropy if attacker has local access */
  const unsigned long entropy =
      gather_time_entropy() ^ getpid() ^ (unsigned long)PARSER_CAST(parser);

  if (sizeof(unsigned long) == 4) {
    return entropy * small_factory;
  } else {
    return entropy * (unsigned long)big_factory;
  }
}
