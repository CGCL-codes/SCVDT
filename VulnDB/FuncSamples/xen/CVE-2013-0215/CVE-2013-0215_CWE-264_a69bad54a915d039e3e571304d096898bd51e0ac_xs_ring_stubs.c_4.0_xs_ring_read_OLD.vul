static int xs_ring_read(struct mmap_interface *interface,
                             char *buffer, int len)
{
	struct xenstore_domain_interface *intf = interface->addr;
	XENSTORE_RING_IDX cons, prod;
	int to_read;

	cons = intf->req_cons;
	prod = intf->req_prod;
	xen_mb();
	if (prod == cons)
		return 0;
	if (MASK_XENSTORE_IDX(prod) > MASK_XENSTORE_IDX(cons)) 
		to_read = prod - cons;
	else
		to_read = XENSTORE_RING_SIZE - MASK_XENSTORE_IDX(cons);
	if (to_read < len)
		len = to_read;
	memcpy(buffer, intf->req + MASK_XENSTORE_IDX(cons), len);
	xen_mb();
	intf->req_cons += len;
	return len;
}
