static void domain_cleanup(void)
{
	xc_dominfo_t dominfo;
	struct domain *domain;
	int notify = 0;

 again:
	list_for_each_entry(domain, &domains, list) {
		if (xc_domain_getinfo(*xc_handle, domain->domid, 1,
				      &dominfo) == 1 &&
		    dominfo.domid == domain->domid) {
			if ((dominfo.crashed || dominfo.shutdown)
			    && !domain->shutdown) {
				domain->shutdown = 1;
				notify = 1;
			}
			if (!dominfo.dying)
				continue;
		}
		if (domain->conn) {
			talloc_unlink(talloc_autofree_context(), domain->conn);
			domain->conn = NULL;
			notify = 0; /* destroy_domain() fires the watch */
			goto again;
		}
	}

	if (notify)
		fire_watches(NULL, "@releaseDomain", false);
}
