uint8_t epte_get_entry_emt(struct domain *d, unsigned long gfn, mfn_t mfn,
                           uint8_t *ipat, bool_t direct_mmio)
{
    uint8_t gmtrr_mtype, hmtrr_mtype;
    uint32_t type;
    struct vcpu *v = current;

    *ipat = 0;

    if ( (current->domain != d) &&
         ((d->vcpu == NULL) || ((v = d->vcpu[0]) == NULL)) )
        return MTRR_TYPE_WRBACK;

    if ( !v->domain->arch.hvm_domain.params[HVM_PARAM_IDENT_PT] )
        return MTRR_TYPE_WRBACK;

    if ( !mfn_valid(mfn_x(mfn)) )
        return MTRR_TYPE_UNCACHABLE;

    if ( hvm_get_mem_pinned_cacheattr(d, gfn, &type) )
        return type;

    if ( !iommu_enabled )
    {
        *ipat = 1;
        return MTRR_TYPE_WRBACK;
    }

    if ( direct_mmio )
        return MTRR_TYPE_UNCACHABLE;

    if ( iommu_snoop )
    {
        *ipat = 1;
        return MTRR_TYPE_WRBACK;
    }

    gmtrr_mtype = get_mtrr_type(&v->arch.hvm_vcpu.mtrr, (gfn << PAGE_SHIFT));
    hmtrr_mtype = get_mtrr_type(&mtrr_state, (mfn_x(mfn) << PAGE_SHIFT));
    return ((gmtrr_mtype <= hmtrr_mtype) ? gmtrr_mtype : hmtrr_mtype);
}
