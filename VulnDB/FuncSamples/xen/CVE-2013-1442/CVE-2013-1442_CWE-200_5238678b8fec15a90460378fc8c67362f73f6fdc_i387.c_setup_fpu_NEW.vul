void setup_fpu(struct vcpu *v)
{
    ASSERT(!is_idle_vcpu(v));

    /* Avoid recursion. */
    clts();

    if ( v->fpu_dirtied )
        return;

    if ( xsave_enabled(v) )
    {
        /*
         * XCR0 normally represents what guest OS set. In case of Xen itself, 
         * we set all supported feature mask before restoring.
         */
        set_xcr0(xfeature_mask);
        xrstor(v);
        set_xcr0(v->arch.xcr0);
    }
    else if ( v->fpu_initialised )
    {
        restore_fpu(v);
    }
    else
    {
        init_fpu();
    }

    v->fpu_initialised = 1;
    v->fpu_dirtied = 1;
}
