long p2m_set_mem_access(struct domain *d, unsigned long pfn, uint32_t nr,
                        hvmmem_access_t access)
{
    struct p2m_domain *p2m = p2m_get_hostp2m(d);
    p2m_access_t a, _a;
    p2m_type_t t;
    mfn_t mfn;
    long rc;

    /* N.B. _not_ static: initializer depends on p2m->default_access */
    p2m_access_t memaccess[] = {
        p2m_access_n,
        p2m_access_r,
        p2m_access_w,
        p2m_access_rw,
        p2m_access_x,
        p2m_access_rx,
        p2m_access_wx,
        p2m_access_rwx,
        p2m_access_rx2rw,
        p2m_access_n2rwx,
        p2m->default_access,
    };

    if ( (unsigned) access >= HVMMEM_access_default )
        return -EINVAL;

    a = memaccess[access];

    /* If request to set default access */
    if ( pfn == ~0ul )
    {
        p2m->default_access = a;
        return 0;
    }

    if ( !nr )
        return 0;

    p2m_lock(p2m);
    for ( ; ; ++pfn )
    {
        mfn = p2m->get_entry(p2m, pfn, &t, &_a, 0, NULL);
        if ( p2m->set_entry(p2m, pfn, mfn, PAGE_ORDER_4K, t, a) == 0 )
        {
            rc = -ENOMEM;
            break;
        }

        /* Check for continuation if it's not the last interation. */
        if ( !--nr || hypercall_preempt_check() )
        {
            rc = nr;
            break;
        }
    }
    p2m_unlock(p2m);
    return rc;
}
