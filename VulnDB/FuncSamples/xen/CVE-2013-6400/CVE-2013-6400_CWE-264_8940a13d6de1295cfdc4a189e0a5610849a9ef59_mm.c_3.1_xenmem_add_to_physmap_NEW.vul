static int xenmem_add_to_physmap(struct domain *d,
                                 struct xen_add_to_physmap *xatp)
{
    struct xen_add_to_physmap start_xatp;
    int rc = 0;

    if ( xatp->space == XENMAPSPACE_gmfn_range )
    {
        if ( need_iommu(d) )
            this_cpu(iommu_dont_flush_iotlb) = 1;

        start_xatp = *xatp;
        while ( xatp->size > 0 )
        {
            rc = xenmem_add_to_physmap_once(d, xatp);
            if ( rc < 0 )
                break;

            xatp->idx++;
            xatp->gpfn++;
            xatp->size--;

            /* Check for continuation if it's not the last interation */
            if ( xatp->size > 0 && hypercall_preempt_check() )
            {
                rc = -EAGAIN;
                break;
            }
        }

        if ( need_iommu(d) )
        {
            this_cpu(iommu_dont_flush_iotlb) = 0;
            iommu_iotlb_flush(d, start_xatp.idx, start_xatp.size - xatp->size);
            iommu_iotlb_flush(d, start_xatp.gpfn, start_xatp.size - xatp->size);
        }

        return rc;
    }

    return xenmem_add_to_physmap_once(d, xatp);
}
