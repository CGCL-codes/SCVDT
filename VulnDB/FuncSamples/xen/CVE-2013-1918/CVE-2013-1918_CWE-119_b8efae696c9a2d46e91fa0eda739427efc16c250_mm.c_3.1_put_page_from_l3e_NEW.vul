static int put_page_from_l3e(l3_pgentry_t l3e, unsigned long pfn,
                             int partial, int preemptible)
{
    if ( !(l3e_get_flags(l3e) & _PAGE_PRESENT) || (l3e_get_pfn(l3e) == pfn) )
        return 1;

    if ( unlikely(l3e_get_flags(l3e) & _PAGE_PSE) )
    {
        unsigned long mfn = l3e_get_pfn(l3e);
        int writeable = l3e_get_flags(l3e) & _PAGE_RW;

        ASSERT(!(mfn & ((1UL << (L3_PAGETABLE_SHIFT - PAGE_SHIFT)) - 1)));
        do {
            put_data_page(mfn_to_page(mfn), writeable);
        } while ( ++mfn & ((1UL << (L3_PAGETABLE_SHIFT - PAGE_SHIFT)) - 1) );

        return 0;
    }

    if ( unlikely(partial > 0) )
    {
        ASSERT(preemptible >= 0);
        return __put_page_type(l3e_get_page(l3e), preemptible);
    }

    if ( preemptible < 0 )
    {
        current->arch.old_guest_table = l3e_get_page(l3e);
        return 0;
    }

    return put_page_and_type_preemptible(l3e_get_page(l3e), preemptible);
}
