void _read_lock_irq(rwlock_t *lock)
{
    uint32_t x;

    ASSERT(local_irq_is_enabled());
    local_irq_disable();
    check_lock(&lock->debug);
    do {
        if ( (x = lock->lock) & RW_WRITE_FLAG )
        {
            local_irq_enable();
            while ( (x = lock->lock) & RW_WRITE_FLAG )
                cpu_relax();
            local_irq_disable();
        }
    } while ( cmpxchg(&lock->lock, x, x+1) != x );
    preempt_disable();
}
