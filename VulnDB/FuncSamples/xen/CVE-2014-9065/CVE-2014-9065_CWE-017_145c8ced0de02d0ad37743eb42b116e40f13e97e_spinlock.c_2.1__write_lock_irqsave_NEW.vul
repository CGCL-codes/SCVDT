unsigned long _write_lock_irqsave(rwlock_t *lock)
{
    uint32_t x;
    unsigned long flags;

    local_irq_save(flags);
    check_lock(&lock->debug);
    do {
        if ( (x = lock->lock) & RW_WRITE_FLAG )
        {
            local_irq_restore(flags);
            while ( (x = lock->lock) & RW_WRITE_FLAG )
                cpu_relax();
            local_irq_save(flags);
        }
    } while ( cmpxchg(&lock->lock, x, x|RW_WRITE_FLAG) != x );
    while ( x != 0 )
    {
        cpu_relax();
        x = lock->lock & ~RW_WRITE_FLAG;
    }
    preempt_disable();
    return flags;
}
