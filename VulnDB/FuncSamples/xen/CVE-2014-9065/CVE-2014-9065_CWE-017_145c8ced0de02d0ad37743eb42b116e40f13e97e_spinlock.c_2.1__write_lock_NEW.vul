void _write_lock(rwlock_t *lock)
{
    uint32_t x;

    check_lock(&lock->debug);
    do {
        while ( (x = lock->lock) & RW_WRITE_FLAG )
            cpu_relax();
    } while ( cmpxchg(&lock->lock, x, x|RW_WRITE_FLAG) != x );
    while ( x != 0 )
    {
        cpu_relax();
        x = lock->lock & ~RW_WRITE_FLAG;
    }
    preempt_disable();
}
