static int paging_log_dirty_disable(struct domain *d, bool_t resuming)
{
    int ret = 1;

    if ( !resuming )
    {
        domain_pause(d);
        /* Safe because the domain is paused. */
        ret = d->arch.paging.log_dirty.disable_log_dirty(d);
        ASSERT(ret <= 0);
    }

    if ( !paging_mode_log_dirty(d) )
    {
        ret = paging_free_log_dirty_bitmap(d, ret);
        if ( ret == -EAGAIN )
            return ret;
    }

    domain_unpause(d);

    return ret;
}
