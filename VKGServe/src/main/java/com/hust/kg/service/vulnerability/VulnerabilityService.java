package com.hust.kg.service.vulnerability;

import com.hust.kg.controller.CommonController;
import com.hust.kg.entity.PathConfig;
import com.hust.kg.parse.ParseToJson;
import com.hust.kg.entity.vulnerability.Vulnerability;
import com.hust.kg.repository.vulnerability.VulnerabilityRepository;
import com.hust.kg.service.CypherService;
import org.springframework.data.neo4j.core.DatabaseSelectionProvider;
import org.springframework.data.neo4j.core.Neo4jClient;
import org.springframework.stereotype.Service;

import org.neo4j.driver.Driver;

import java.io.BufferedWriter;
import java.io.FileWriter;
import java.io.IOException;
import java.util.List;

/**
 * @Author wk
 * @Date 2021/03/25 10:24
 * @Description:
 */
@Service
public class VulnerabilityService {

    private final VulnerabilityRepository repository;

    private final Neo4jClient neo4jClient;

    private final Driver driver;

    private final DatabaseSelectionProvider databaseSelectionProvider;

    private final CypherService cypherService;

    public VulnerabilityService(VulnerabilityRepository repository, Neo4jClient neo4jClient, Driver driver, DatabaseSelectionProvider databaseSelectionProvider, CypherService cypherService) {
        this.repository = repository;
        this.neo4jClient = neo4jClient;
        this.driver = driver;
        this.databaseSelectionProvider = databaseSelectionProvider;
        this.cypherService = cypherService;
    }

    public Vulnerability findByID(Long id){
        return this.repository.findResultsByID(id);
    }

    public List<Vulnerability> findByCVE(String cveID){
        return this.repository.findResultsByCVE(cveID);
    }

    public String fuzzyFind(String cveID){
        List<Vulnerability> vulnerabilities = this.repository.fuzzyFindCVE(cveID);
        return ParseToJson.listToJson(vulnerabilities, "Vulnerability");
    }

    public String findAllCVEs(){
        List<Vulnerability> vulnerabilities = this.repository.findAllCVEs();
        return ParseToJson.listToJson(vulnerabilities, "Vulnerability");
    }

    public String findAllRelations(String cveID) {
        String cypher = "match p=(n:Vulnerability)-[*]->() where n.cve_id='" + cveID + "' return p";
        String result = cypherService.executeCypher(cypher);
        return result;
    }
}
