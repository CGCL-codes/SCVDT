From 4619c662cc6f3d63a5acc373b3d4ae3f75f9485a Mon Sep 17 00:00:00 2001
From: Tom Needham <needham.thomas@gmail.com>
Date: Tue, 6 Nov 2012 23:49:25 +0000
Subject: [PATCH] Migration: Allow for no app data cases; handle file copying
 better

---
 lib/migrate.php | 12 +++++-------
 1 file changed, 5 insertions(+), 7 deletions(-)

diff --git a/lib/migrate.php b/lib/migrate.php
index 72caf9fc8de..8d3610c9309 100644
--- a/lib/migrate.php
+++ b/lib/migrate.php
@@ -238,18 +238,16 @@ public static function import( $path, $type='user', $uid=null ) {
 				$userfolder = $extractpath . $json->exporteduser;
 				$newuserfolder = $datadir . '/' . self::$uid;
 				foreach(scandir($userfolder) as $file){
-					$success = true;
 					if($file !== '.' && $file !== '..' && is_dir($file)){
 						// Then copy the folder over
-						$success = OC_Helper::copyr($userfolder.'/'.$file, $newuserfolder.'/'.$file);
-					}
-					if(!$success){
-						return json_encode( array( 'success' => false ) );
+						OC_Helper::copyr($userfolder.'/'.$file, $newuserfolder.'/'.$file);
 					}
 				}
 				// Import user app data
-				if( !$appsimported = self::importAppData( $extractpath . $json->exporteduser . '/migration.db', $json, self::$uid ) ) {
-					return json_encode( array( 'success' => false ) );
+				if(file_exists($extractpath . $json->exporteduser . '/migration.db')){
+					if( !$appsimported = self::importAppData( $extractpath . $json->exporteduser . '/migration.db', $json, self::$uid ) ) {
+						return json_encode( array( 'success' => false ) );
+					}
 				}
 				// All done!
 				if( !self::unlink_r( $extractpath ) ) {
