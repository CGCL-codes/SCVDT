commit c3d7083b7605d1753946c4c4411e3a3241ea7ffe
Author:     Thejas Nair <thejas@apache.org>
AuthorDate: Fri Sep 12 18:59:07 2014 +0000
Commit:     Thejas Nair <thejas@apache.org>
CommitDate: Fri Sep 12 18:59:07 2014 +0000

    HIVE-8019 : Missing hive 0.13.1 commit in trunk : export/import statement authorization - CVE-2014-0228
    
    git-svn-id: https://svn.apache.org/repos/asf/hive/trunk@1624615 13f79535-47bb-0310-9956-ffa450edef68

diff --git a/common/src/java/org/apache/hadoop/hive/common/FileUtils.java b/common/src/java/org/apache/hadoop/hive/common/FileUtils.java
index b5434f7a29..95e8d7c509 100644
--- a/common/src/java/org/apache/hadoop/hive/common/FileUtils.java
+++ b/common/src/java/org/apache/hadoop/hive/common/FileUtils.java
@@ -446,12 +446,26 @@ public static boolean isActionPermittedForFileHierarchy(FileSystem fs, FileStatu
   public static boolean isLocalFile(HiveConf conf, String fileName) {
     try {
       // do best effor to determine if this is a local file
-      FileSystem fsForFile = FileSystem.get(new URI(fileName), conf);
-      return LocalFileSystem.class.isInstance(fsForFile);
+      return isLocalFile(conf, new URI(fileName));
     } catch (URISyntaxException e) {
       LOG.warn("Unable to create URI from " + fileName, e);
+    }
+    return false;
+  }
+
+  /**
+   * A best effort attempt to determine if if the file is a local file
+   * @param conf
+   * @param fileUri
+   * @return true if it was successfully able to determine that it is a local file
+   */
+  public static boolean isLocalFile(HiveConf conf, URI fileUri) {
+    try {
+      // do best effor to determine if this is a local file
+      FileSystem fsForFile = FileSystem.get(fileUri, conf);
+      return LocalFileSystem.class.isInstance(fsForFile);
     } catch (IOException e) {
-      LOG.warn("Unable to get FileSystem for " + fileName, e);
+      LOG.warn("Unable to get FileSystem for " + fileUri, e);
     }
     return false;
   }
diff --git a/ql/src/java/org/apache/hadoop/hive/ql/parse/ExportSemanticAnalyzer.java b/ql/src/java/org/apache/hadoop/hive/ql/parse/ExportSemanticAnalyzer.java
index 0d1dd10964..f96209c2fa 100644
--- a/ql/src/java/org/apache/hadoop/hive/ql/parse/ExportSemanticAnalyzer.java
+++ b/ql/src/java/org/apache/hadoop/hive/ql/parse/ExportSemanticAnalyzer.java
@@ -28,6 +28,7 @@
 import org.apache.hadoop.fs.FileStatus;
 import org.apache.hadoop.fs.FileSystem;
 import org.apache.hadoop.fs.Path;
+import org.apache.hadoop.hive.common.FileUtils;
 import org.apache.hadoop.hive.conf.HiveConf;
 import org.apache.hadoop.hive.ql.ErrorMsg;
 import org.apache.hadoop.hive.ql.exec.Task;
@@ -70,7 +71,7 @@ public void analyzeInternal(ASTNode ast) throws SemanticException {
                     "Target is not a directory : " + toURI));
         } else {
           FileStatus[] files = fs.listStatus(toPath);
-          if (files != null) {
+          if (files != null && files.length != 0) {
             throw new SemanticException(ErrorMsg.INVALID_PATH.getMsg(ast,
                           "Target is not an empty directory : " + toURI));
           }
@@ -120,6 +121,7 @@ public void analyzeInternal(ASTNode ast) throws SemanticException {
       rootTasks.add(rTask);
       inputs.add(new ReadEntity(ts.tableHandle));
     }
-    outputs.add(new WriteEntity(parentPath, toURI.getScheme().equals("hdfs")));
+    boolean isLocal = FileUtils.isLocalFile(conf, toURI);
+    outputs.add(new WriteEntity(parentPath, isLocal));
   }
 }
diff --git a/ql/src/java/org/apache/hadoop/hive/ql/parse/ImportSemanticAnalyzer.java b/ql/src/java/org/apache/hadoop/hive/ql/parse/ImportSemanticAnalyzer.java
index de4025bd8e..48915185d3 100644
--- a/ql/src/java/org/apache/hadoop/hive/ql/parse/ImportSemanticAnalyzer.java
+++ b/ql/src/java/org/apache/hadoop/hive/ql/parse/ImportSemanticAnalyzer.java
@@ -18,11 +18,24 @@
 
 package org.apache.hadoop.hive.ql.parse;
 
+import java.io.IOException;
+import java.net.URI;
+import java.net.URISyntaxException;
+import java.util.ArrayList;
+import java.util.Collections;
+import java.util.Comparator;
+import java.util.Iterator;
+import java.util.LinkedHashMap;
+import java.util.List;
+import java.util.Map;
+import java.util.TreeMap;
+
 import org.antlr.runtime.tree.Tree;
 import org.apache.commons.lang.ObjectUtils;
 import org.apache.hadoop.fs.FileStatus;
 import org.apache.hadoop.fs.FileSystem;
 import org.apache.hadoop.fs.Path;
+import org.apache.hadoop.hive.common.FileUtils;
 import org.apache.hadoop.hive.common.JavaUtils;
 import org.apache.hadoop.hive.conf.HiveConf;
 import org.apache.hadoop.hive.metastore.TableType;
@@ -35,21 +48,22 @@
 import org.apache.hadoop.hive.ql.exec.Task;
 import org.apache.hadoop.hive.ql.exec.TaskFactory;
 import org.apache.hadoop.hive.ql.exec.Utilities;
+import org.apache.hadoop.hive.ql.hooks.ReadEntity;
 import org.apache.hadoop.hive.ql.hooks.WriteEntity;
 import org.apache.hadoop.hive.ql.io.HiveFileFormatUtils;
 import org.apache.hadoop.hive.ql.io.HiveOutputFormat;
 import org.apache.hadoop.hive.ql.metadata.HiveException;
 import org.apache.hadoop.hive.ql.metadata.InvalidTableException;
 import org.apache.hadoop.hive.ql.metadata.Table;
-import org.apache.hadoop.hive.ql.plan.*;
+import org.apache.hadoop.hive.ql.plan.AddPartitionDesc;
+import org.apache.hadoop.hive.ql.plan.CopyWork;
+import org.apache.hadoop.hive.ql.plan.CreateTableDesc;
+import org.apache.hadoop.hive.ql.plan.DDLWork;
+import org.apache.hadoop.hive.ql.plan.LoadTableDesc;
+import org.apache.hadoop.hive.ql.plan.MoveWork;
 import org.apache.hadoop.hive.ql.session.SessionState;
 import org.apache.hadoop.hive.serde.serdeConstants;
 
-import java.io.IOException;
-import java.net.URI;
-import java.net.URISyntaxException;
-import java.util.*;
-
 /**
  * ImportSemanticAnalyzer.
  *
@@ -82,6 +96,8 @@ public void analyzeInternal(ASTNode ast) throws SemanticException {
       List<AddPartitionDesc> partitionDescs = new ArrayList<AddPartitionDesc>();
       Path fromPath = new Path(fromURI.getScheme(), fromURI.getAuthority(),
           fromURI.getPath());
+      boolean isLocal = FileUtils.isLocalFile(conf, fromURI);
+      inputs.add(new ReadEntity(fromPath, isLocal));
       try {
         Path metadataPath = new Path(fromPath, METADATA_NAME);
         Map.Entry<org.apache.hadoop.hive.metastore.api.Table,
@@ -475,7 +491,7 @@ private static void checkTable(Table table, CreateTableDesc tableDesc)
       String importedSerdeFormat = tableDesc.getSerdeProps().get(
           serdeConstants.SERIALIZATION_FORMAT);
       /*
-       * If Imported SerdeFormat is null, then set it to "1" just as 
+       * If Imported SerdeFormat is null, then set it to "1" just as
        * metadata.Table.getEmptyTable
        */
       importedSerdeFormat = importedSerdeFormat == null ? "1" : importedSerdeFormat;
diff --git a/ql/src/java/org/apache/hadoop/hive/ql/security/authorization/plugin/sqlstd/Operation2Privilege.java b/ql/src/java/org/apache/hadoop/hive/ql/security/authorization/plugin/sqlstd/Operation2Privilege.java
index ebe67d94a2..3236341948 100644
--- a/ql/src/java/org/apache/hadoop/hive/ql/security/authorization/plugin/sqlstd/Operation2Privilege.java
+++ b/ql/src/java/org/apache/hadoop/hive/ql/security/authorization/plugin/sqlstd/Operation2Privilege.java
@@ -267,9 +267,9 @@ public HivePrivilegeObjectType getObjectType() {
 
     // select with grant for exporting contents
     op2Priv.put(HiveOperationType.EXPORT, PrivRequirement.newIOPrivRequirement
-(SEL_GRANT_AR, null));
+(SEL_GRANT_AR, OWNER_INS_SEL_DEL_NOGRANT_AR));
     op2Priv.put(HiveOperationType.IMPORT, PrivRequirement.newIOPrivRequirement
-(INS_NOGRANT_AR, null));
+(OWNER_INS_SEL_DEL_NOGRANT_AR, INS_NOGRANT_AR));
 
     // operations require select priv
     op2Priv.put(HiveOperationType.SHOWCOLUMNS, PrivRequirement.newIOPrivRequirement
diff --git a/ql/src/test/queries/clientnegative/authorization_uri_export.q b/ql/src/test/queries/clientnegative/authorization_uri_export.q
new file mode 100644
index 0000000000..05dea162e4
--- /dev/null
+++ b/ql/src/test/queries/clientnegative/authorization_uri_export.q
@@ -0,0 +1,23 @@
+set hive.test.authz.sstd.hs2.mode=true;
+set hive.security.authorization.manager=org.apache.hadoop.hive.ql.security.authorization.plugin.sqlstd.SQLStdHiveAuthorizerFactoryForTest;
+set hive.security.authenticator.manager=org.apache.hadoop.hive.ql.security.SessionStateConfigUserAuthenticator;
+set hive.security.authorization.enabled=true;
+
+set hive.test.mode=true;
+set hive.test.mode.prefix=;
+set hive.test.mode.nosamplelist=export_auth_uri;
+
+
+create table export_auth_uri ( dep_id int comment "department id")
+	stored as textfile;
+
+dfs ${system:test.dfs.mkdir} target/tmp/ql/test/data/exports/export_auth_uri/temp;
+dfs -rmr target/tmp/ql/test/data/exports/export_auth_uri;
+
+
+dfs ${system:test.dfs.mkdir} target/tmp/ql/test/data/exports/export_auth_uri/;
+dfs -chmod 555 target/tmp/ql/test/data/exports/export_auth_uri;
+
+export table export_auth_uri to 'ql/test/data/exports/export_auth_uri';
+
+-- Attempt to export to location without sufficient permissions should fail
diff --git a/ql/src/test/queries/clientnegative/authorization_uri_import.q b/ql/src/test/queries/clientnegative/authorization_uri_import.q
new file mode 100644
index 0000000000..a6733b5d68
--- /dev/null
+++ b/ql/src/test/queries/clientnegative/authorization_uri_import.q
@@ -0,0 +1,26 @@
+set hive.test.authz.sstd.hs2.mode=true;
+set hive.security.authorization.manager=org.apache.hadoop.hive.ql.security.authorization.plugin.sqlstd.SQLStdHiveAuthorizerFactoryForTest;
+set hive.security.authenticator.manager=org.apache.hadoop.hive.ql.security.SessionStateConfigUserAuthenticator;
+set hive.security.authorization.enabled=true;
+
+set hive.test.mode=true;
+set hive.test.mode.prefix=;
+set hive.test.mode.nosamplelist=import_auth_uri;
+
+
+create table import_auth_uri ( dep_id int comment "department id")
+	stored as textfile;
+dfs ${system:test.dfs.mkdir} target/tmp/ql/test/data/exports/import_auth_uri/temp;
+dfs -rmr target/tmp/ql/test/data/exports/import_auth_uri;
+export table import_auth_uri to 'ql/test/data/exports/import_auth_uri';
+drop table import_auth_uri;
+
+dfs -touchz target/tmp/ql/test/data/exports/import_auth_uri/1.txt;
+dfs -chmod 555 target/tmp/ql/test/data/exports/import_auth_uri/1.txt;
+
+create database importer;
+use importer;
+
+import from 'ql/test/data/exports/import_auth_uri';
+
+-- Attempt to import from location without sufficient permissions should fail
diff --git a/ql/src/test/queries/clientpositive/exim_00_nonpart_empty.q b/ql/src/test/queries/clientpositive/exim_00_nonpart_empty.q
index 6f9a4815fa..8288bbfd86 100644
--- a/ql/src/test/queries/clientpositive/exim_00_nonpart_empty.q
+++ b/ql/src/test/queries/clientpositive/exim_00_nonpart_empty.q
@@ -1,3 +1,6 @@
+set hive.security.authorization.manager=org.apache.hadoop.hive.ql.security.authorization.plugin.sqlstd.SQLStdHiveAuthorizerFactoryForTest;
+set hive.security.authenticator.manager=org.apache.hadoop.hive.ql.security.SessionStateConfigUserAuthenticator;
+
 set hive.test.mode=true;
 set hive.test.mode.prefix=;
 set hive.test.mode.nosamplelist=exim_department,exim_employee;
diff --git a/ql/src/test/results/clientnegative/authorization_uri_export.q.out b/ql/src/test/results/clientnegative/authorization_uri_export.q.out
new file mode 100644
index 0000000000..f6ed94821f
--- /dev/null
+++ b/ql/src/test/results/clientnegative/authorization_uri_export.q.out
@@ -0,0 +1,11 @@
+PREHOOK: query: create table export_auth_uri ( dep_id int comment "department id")
+	stored as textfile
+PREHOOK: type: CREATETABLE
+PREHOOK: Output: database:default
+PREHOOK: Output: default@export_auth_uri
+POSTHOOK: query: create table export_auth_uri ( dep_id int comment "department id")
+	stored as textfile
+POSTHOOK: type: CREATETABLE
+POSTHOOK: Output: database:default
+POSTHOOK: Output: default@export_auth_uri
+#### A masked pattern was here ####
diff --git a/ql/src/test/results/clientnegative/authorization_uri_import.q.out b/ql/src/test/results/clientnegative/authorization_uri_import.q.out
new file mode 100644
index 0000000000..1ffe83187e
--- /dev/null
+++ b/ql/src/test/results/clientnegative/authorization_uri_import.q.out
@@ -0,0 +1,11 @@
+PREHOOK: query: create table import_auth_uri ( dep_id int comment "department id")
+	stored as textfile
+PREHOOK: type: CREATETABLE
+PREHOOK: Output: database:default
+PREHOOK: Output: default@import_auth_uri
+POSTHOOK: query: create table import_auth_uri ( dep_id int comment "department id")
+	stored as textfile
+POSTHOOK: type: CREATETABLE
+POSTHOOK: Output: database:default
+POSTHOOK: Output: default@import_auth_uri
+#### A masked pattern was here ####
diff --git a/ql/src/test/results/clientpositive/exim_00_nonpart_empty.q.out b/ql/src/test/results/clientpositive/exim_00_nonpart_empty.q.out
index 57202437eb..2d34c5bd7e 100644
--- a/ql/src/test/results/clientpositive/exim_00_nonpart_empty.q.out
+++ b/ql/src/test/results/clientpositive/exim_00_nonpart_empty.q.out
@@ -41,8 +41,10 @@ POSTHOOK: type: SWITCHDATABASE
 POSTHOOK: Input: database:importer
 PREHOOK: query: import from 'ql/test/data/exports/exim_department'
 PREHOOK: type: IMPORT
+#### A masked pattern was here ####
 POSTHOOK: query: import from 'ql/test/data/exports/exim_department'
 POSTHOOK: type: IMPORT
+#### A masked pattern was here ####
 POSTHOOK: Output: importer@exim_department
 PREHOOK: query: describe extended exim_department
 PREHOOK: type: DESCTABLE
diff --git a/ql/src/test/results/clientpositive/exim_01_nonpart.q.out b/ql/src/test/results/clientpositive/exim_01_nonpart.q.out
index 22a55965a8..c919ca4887 100644
--- a/ql/src/test/results/clientpositive/exim_01_nonpart.q.out
+++ b/ql/src/test/results/clientpositive/exim_01_nonpart.q.out
@@ -49,8 +49,10 @@ POSTHOOK: type: SWITCHDATABASE
 POSTHOOK: Input: database:importer
 PREHOOK: query: import from 'ql/test/data/exports/exim_department'
 PREHOOK: type: IMPORT
+#### A masked pattern was here ####
 POSTHOOK: query: import from 'ql/test/data/exports/exim_department'
 POSTHOOK: type: IMPORT
+#### A masked pattern was here ####
 POSTHOOK: Output: importer@exim_department
 PREHOOK: query: describe extended exim_department
 PREHOOK: type: DESCTABLE
diff --git a/ql/src/test/results/clientpositive/exim_02_00_part_empty.q.out b/ql/src/test/results/clientpositive/exim_02_00_part_empty.q.out
index ded481bc40..1a28bb511f 100644
--- a/ql/src/test/results/clientpositive/exim_02_00_part_empty.q.out
+++ b/ql/src/test/results/clientpositive/exim_02_00_part_empty.q.out
@@ -43,8 +43,10 @@ POSTHOOK: type: SWITCHDATABASE
 POSTHOOK: Input: database:importer
 PREHOOK: query: import from 'ql/test/data/exports/exim_employee'
 PREHOOK: type: IMPORT
+#### A masked pattern was here ####
 POSTHOOK: query: import from 'ql/test/data/exports/exim_employee'
 POSTHOOK: type: IMPORT
+#### A masked pattern was here ####
 POSTHOOK: Output: importer@exim_employee
 PREHOOK: query: describe extended exim_employee
 PREHOOK: type: DESCTABLE
diff --git a/ql/src/test/results/clientpositive/exim_02_part.q.out b/ql/src/test/results/clientpositive/exim_02_part.q.out
index 8afceffa39..6e0988a5f6 100644
--- a/ql/src/test/results/clientpositive/exim_02_part.q.out
+++ b/ql/src/test/results/clientpositive/exim_02_part.q.out
@@ -56,8 +56,10 @@ POSTHOOK: type: SWITCHDATABASE
 POSTHOOK: Input: database:importer
 PREHOOK: query: import from 'ql/test/data/exports/exim_employee'
 PREHOOK: type: IMPORT
+#### A masked pattern was here ####
 POSTHOOK: query: import from 'ql/test/data/exports/exim_employee'
 POSTHOOK: type: IMPORT
+#### A masked pattern was here ####
 POSTHOOK: Output: importer@exim_employee
 POSTHOOK: Output: importer@exim_employee@emp_country=in/emp_state=tn
 PREHOOK: query: describe extended exim_employee
diff --git a/ql/src/test/results/clientpositive/exim_03_nonpart_over_compat.q.out b/ql/src/test/results/clientpositive/exim_03_nonpart_over_compat.q.out
index 7403d720a2..791a4cb8ad 100644
--- a/ql/src/test/results/clientpositive/exim_03_nonpart_over_compat.q.out
+++ b/ql/src/test/results/clientpositive/exim_03_nonpart_over_compat.q.out
@@ -61,9 +61,11 @@ POSTHOOK: Output: database:importer
 POSTHOOK: Output: importer@exim_department
 PREHOOK: query: import from 'ql/test/data/exports/exim_department'
 PREHOOK: type: IMPORT
+#### A masked pattern was here ####
 PREHOOK: Output: importer@exim_department
 POSTHOOK: query: import from 'ql/test/data/exports/exim_department'
 POSTHOOK: type: IMPORT
+#### A masked pattern was here ####
 POSTHOOK: Output: importer@exim_department
 PREHOOK: query: describe extended exim_department
 PREHOOK: type: DESCTABLE
diff --git a/ql/src/test/results/clientpositive/exim_04_all_part.q.out b/ql/src/test/results/clientpositive/exim_04_all_part.q.out
index 77d15e289a..862efa3906 100644
--- a/ql/src/test/results/clientpositive/exim_04_all_part.q.out
+++ b/ql/src/test/results/clientpositive/exim_04_all_part.q.out
@@ -95,8 +95,10 @@ POSTHOOK: type: SWITCHDATABASE
 POSTHOOK: Input: database:importer
 PREHOOK: query: import from 'ql/test/data/exports/exim_employee'
 PREHOOK: type: IMPORT
+#### A masked pattern was here ####
 POSTHOOK: query: import from 'ql/test/data/exports/exim_employee'
 POSTHOOK: type: IMPORT
+#### A masked pattern was here ####
 POSTHOOK: Output: importer@exim_employee
 POSTHOOK: Output: importer@exim_employee@emp_country=in/emp_state=ka
 POSTHOOK: Output: importer@exim_employee@emp_country=in/emp_state=tn
diff --git a/ql/src/test/results/clientpositive/exim_04_evolved_parts.q.out b/ql/src/test/results/clientpositive/exim_04_evolved_parts.q.out
index ae274a437c..4151a94bfb 100644
--- a/ql/src/test/results/clientpositive/exim_04_evolved_parts.q.out
+++ b/ql/src/test/results/clientpositive/exim_04_evolved_parts.q.out
@@ -101,8 +101,10 @@ POSTHOOK: type: SWITCHDATABASE
 POSTHOOK: Input: database:importer
 PREHOOK: query: import from 'ql/test/data/exports/exim_employee'
 PREHOOK: type: IMPORT
+#### A masked pattern was here ####
 POSTHOOK: query: import from 'ql/test/data/exports/exim_employee'
 POSTHOOK: type: IMPORT
+#### A masked pattern was here ####
 POSTHOOK: Output: importer@exim_employee
 POSTHOOK: Output: importer@exim_employee@emp_country=in/emp_state=ka
 POSTHOOK: Output: importer@exim_employee@emp_country=in/emp_state=tn
diff --git a/ql/src/test/results/clientpositive/exim_05_some_part.q.out b/ql/src/test/results/clientpositive/exim_05_some_part.q.out
index 8f65d081c5..1b6a515774 100644
--- a/ql/src/test/results/clientpositive/exim_05_some_part.q.out
+++ b/ql/src/test/results/clientpositive/exim_05_some_part.q.out
@@ -91,8 +91,10 @@ POSTHOOK: type: SWITCHDATABASE
 POSTHOOK: Input: database:importer
 PREHOOK: query: import from 'ql/test/data/exports/exim_employee'
 PREHOOK: type: IMPORT
+#### A masked pattern was here ####
 POSTHOOK: query: import from 'ql/test/data/exports/exim_employee'
 POSTHOOK: type: IMPORT
+#### A masked pattern was here ####
 POSTHOOK: Output: importer@exim_employee
 POSTHOOK: Output: importer@exim_employee@emp_country=in/emp_state=ka
 POSTHOOK: Output: importer@exim_employee@emp_country=us/emp_state=ka
diff --git a/ql/src/test/results/clientpositive/exim_06_one_part.q.out b/ql/src/test/results/clientpositive/exim_06_one_part.q.out
index 0024fefc1d..39c83c3f2a 100644
--- a/ql/src/test/results/clientpositive/exim_06_one_part.q.out
+++ b/ql/src/test/results/clientpositive/exim_06_one_part.q.out
@@ -89,8 +89,10 @@ POSTHOOK: type: SWITCHDATABASE
 POSTHOOK: Input: database:importer
 PREHOOK: query: import from 'ql/test/data/exports/exim_employee'
 PREHOOK: type: IMPORT
+#### A masked pattern was here ####
 POSTHOOK: query: import from 'ql/test/data/exports/exim_employee'
 POSTHOOK: type: IMPORT
+#### A masked pattern was here ####
 POSTHOOK: Output: importer@exim_employee
 POSTHOOK: Output: importer@exim_employee@emp_country=in/emp_state=ka
 PREHOOK: query: describe extended exim_employee
diff --git a/ql/src/test/results/clientpositive/exim_07_all_part_over_nonoverlap.q.out b/ql/src/test/results/clientpositive/exim_07_all_part_over_nonoverlap.q.out
index c6f136829c..b55a0bd330 100644
--- a/ql/src/test/results/clientpositive/exim_07_all_part_over_nonoverlap.q.out
+++ b/ql/src/test/results/clientpositive/exim_07_all_part_over_nonoverlap.q.out
@@ -122,9 +122,11 @@ POSTHOOK: Output: importer@exim_employee
 POSTHOOK: Output: importer@exim_employee@emp_country=us/emp_state=al
 PREHOOK: query: import from 'ql/test/data/exports/exim_employee'
 PREHOOK: type: IMPORT
+#### A masked pattern was here ####
 PREHOOK: Output: importer@exim_employee
 POSTHOOK: query: import from 'ql/test/data/exports/exim_employee'
 POSTHOOK: type: IMPORT
+#### A masked pattern was here ####
 POSTHOOK: Output: importer@exim_employee
 POSTHOOK: Output: importer@exim_employee@emp_country=in/emp_state=ka
 POSTHOOK: Output: importer@exim_employee@emp_country=in/emp_state=tn
diff --git a/ql/src/test/results/clientpositive/exim_08_nonpart_rename.q.out b/ql/src/test/results/clientpositive/exim_08_nonpart_rename.q.out
index b712de1eb3..740833bb56 100644
--- a/ql/src/test/results/clientpositive/exim_08_nonpart_rename.q.out
+++ b/ql/src/test/results/clientpositive/exim_08_nonpart_rename.q.out
@@ -72,8 +72,10 @@ POSTHOOK: Output: importer@exim_department
 POSTHOOK: Output: importer@exim_department@emp_org=hr
 PREHOOK: query: import table exim_imported_dept from 'ql/test/data/exports/exim_department'
 PREHOOK: type: IMPORT
+#### A masked pattern was here ####
 POSTHOOK: query: import table exim_imported_dept from 'ql/test/data/exports/exim_department'
 POSTHOOK: type: IMPORT
+#### A masked pattern was here ####
 POSTHOOK: Output: importer@exim_imported_dept
 PREHOOK: query: describe extended exim_imported_dept
 PREHOOK: type: DESCTABLE
diff --git a/ql/src/test/results/clientpositive/exim_09_part_spec_nonoverlap.q.out b/ql/src/test/results/clientpositive/exim_09_part_spec_nonoverlap.q.out
index ad197b8468..d71f36f599 100644
--- a/ql/src/test/results/clientpositive/exim_09_part_spec_nonoverlap.q.out
+++ b/ql/src/test/results/clientpositive/exim_09_part_spec_nonoverlap.q.out
@@ -133,9 +133,11 @@ POSTHOOK: Output: importer@exim_employee
 POSTHOOK: Output: importer@exim_employee@emp_country=in/emp_state=ka
 PREHOOK: query: import table exim_employee partition (emp_country="us", emp_state="tn") from 'ql/test/data/exports/exim_employee'
 PREHOOK: type: IMPORT
+#### A masked pattern was here ####
 PREHOOK: Output: importer@exim_employee
 POSTHOOK: query: import table exim_employee partition (emp_country="us", emp_state="tn") from 'ql/test/data/exports/exim_employee'
 POSTHOOK: type: IMPORT
+#### A masked pattern was here ####
 POSTHOOK: Output: importer@exim_employee
 POSTHOOK: Output: importer@exim_employee@emp_country=us/emp_state=tn
 PREHOOK: query: describe extended exim_employee
diff --git a/ql/src/test/results/clientpositive/exim_10_external_managed.q.out b/ql/src/test/results/clientpositive/exim_10_external_managed.q.out
index 8d924315d4..fdb5c918b4 100644
--- a/ql/src/test/results/clientpositive/exim_10_external_managed.q.out
+++ b/ql/src/test/results/clientpositive/exim_10_external_managed.q.out
@@ -55,8 +55,10 @@ POSTHOOK: type: SWITCHDATABASE
 POSTHOOK: Input: database:importer
 PREHOOK: query: import from 'ql/test/data/exports/exim_department'
 PREHOOK: type: IMPORT
+#### A masked pattern was here ####
 POSTHOOK: query: import from 'ql/test/data/exports/exim_department'
 POSTHOOK: type: IMPORT
+#### A masked pattern was here ####
 POSTHOOK: Output: importer@exim_department
 PREHOOK: query: describe extended exim_department
 PREHOOK: type: DESCTABLE
diff --git a/ql/src/test/results/clientpositive/exim_11_managed_external.q.out b/ql/src/test/results/clientpositive/exim_11_managed_external.q.out
index 8cc4224977..7bdefdc003 100644
--- a/ql/src/test/results/clientpositive/exim_11_managed_external.q.out
+++ b/ql/src/test/results/clientpositive/exim_11_managed_external.q.out
@@ -49,8 +49,10 @@ POSTHOOK: type: SWITCHDATABASE
 POSTHOOK: Input: database:importer
 PREHOOK: query: import external table exim_department from 'ql/test/data/exports/exim_department'
 PREHOOK: type: IMPORT
+#### A masked pattern was here ####
 POSTHOOK: query: import external table exim_department from 'ql/test/data/exports/exim_department'
 POSTHOOK: type: IMPORT
+#### A masked pattern was here ####
 POSTHOOK: Output: importer@exim_department
 PREHOOK: query: describe extended exim_department
 PREHOOK: type: DESCTABLE
diff --git a/ql/src/test/results/clientpositive/exim_12_external_location.q.out b/ql/src/test/results/clientpositive/exim_12_external_location.q.out
index 5e5c32fb3a..a8bf137351 100644
--- a/ql/src/test/results/clientpositive/exim_12_external_location.q.out
+++ b/ql/src/test/results/clientpositive/exim_12_external_location.q.out
@@ -51,9 +51,11 @@ POSTHOOK: Input: database:importer
 PREHOOK: query: import external table exim_department from 'ql/test/data/exports/exim_department' 
 	location 'ql/test/data/tablestore/exim_department'
 PREHOOK: type: IMPORT
+#### A masked pattern was here ####
 POSTHOOK: query: import external table exim_department from 'ql/test/data/exports/exim_department' 
 	location 'ql/test/data/tablestore/exim_department'
 POSTHOOK: type: IMPORT
+#### A masked pattern was here ####
 POSTHOOK: Output: importer@exim_department
 PREHOOK: query: describe extended exim_department
 PREHOOK: type: DESCTABLE
diff --git a/ql/src/test/results/clientpositive/exim_13_managed_location.q.out b/ql/src/test/results/clientpositive/exim_13_managed_location.q.out
index ae7bf56e0f..4118a3279a 100644
--- a/ql/src/test/results/clientpositive/exim_13_managed_location.q.out
+++ b/ql/src/test/results/clientpositive/exim_13_managed_location.q.out
@@ -51,9 +51,11 @@ POSTHOOK: Input: database:importer
 PREHOOK: query: import table exim_department from 'ql/test/data/exports/exim_department' 
 	location 'ql/test/data/tablestore/exim_department'
 PREHOOK: type: IMPORT
+#### A masked pattern was here ####
 POSTHOOK: query: import table exim_department from 'ql/test/data/exports/exim_department' 
 	location 'ql/test/data/tablestore/exim_department'
 POSTHOOK: type: IMPORT
+#### A masked pattern was here ####
 POSTHOOK: Output: importer@exim_department
 PREHOOK: query: describe extended exim_department
 PREHOOK: type: DESCTABLE
diff --git a/ql/src/test/results/clientpositive/exim_14_managed_location_over_existing.q.out b/ql/src/test/results/clientpositive/exim_14_managed_location_over_existing.q.out
index 0bccb9fb79..8e7f50401c 100644
--- a/ql/src/test/results/clientpositive/exim_14_managed_location_over_existing.q.out
+++ b/ql/src/test/results/clientpositive/exim_14_managed_location_over_existing.q.out
@@ -67,10 +67,12 @@ POSTHOOK: Output: importer@exim_department
 PREHOOK: query: import table exim_department from 'ql/test/data/exports/exim_department'
 	location 'ql/test/data/tablestore/exim_department'
 PREHOOK: type: IMPORT
+#### A masked pattern was here ####
 PREHOOK: Output: importer@exim_department
 POSTHOOK: query: import table exim_department from 'ql/test/data/exports/exim_department'
 	location 'ql/test/data/tablestore/exim_department'
 POSTHOOK: type: IMPORT
+#### A masked pattern was here ####
 POSTHOOK: Output: importer@exim_department
 PREHOOK: query: describe extended exim_department
 PREHOOK: type: DESCTABLE
diff --git a/ql/src/test/results/clientpositive/exim_15_external_part.q.out b/ql/src/test/results/clientpositive/exim_15_external_part.q.out
index 26d8e6f2b5..d24f18a5c4 100644
--- a/ql/src/test/results/clientpositive/exim_15_external_part.q.out
+++ b/ql/src/test/results/clientpositive/exim_15_external_part.q.out
@@ -139,10 +139,12 @@ POSTHOOK: Output: importer@exim_employee@emp_country=in/emp_state=ka
 PREHOOK: query: import external table exim_employee partition (emp_country="us", emp_state="tn") 
 	from 'ql/test/data/exports/exim_employee'
 PREHOOK: type: IMPORT
+#### A masked pattern was here ####
 PREHOOK: Output: importer@exim_employee
 POSTHOOK: query: import external table exim_employee partition (emp_country="us", emp_state="tn") 
 	from 'ql/test/data/exports/exim_employee'
 POSTHOOK: type: IMPORT
+#### A masked pattern was here ####
 POSTHOOK: Output: importer@exim_employee
 POSTHOOK: Output: importer@exim_employee@emp_country=us/emp_state=tn
 PREHOOK: query: describe extended exim_employee
diff --git a/ql/src/test/results/clientpositive/exim_16_part_external.q.out b/ql/src/test/results/clientpositive/exim_16_part_external.q.out
index 23e790afd9..af748c9273 100644
--- a/ql/src/test/results/clientpositive/exim_16_part_external.q.out
+++ b/ql/src/test/results/clientpositive/exim_16_part_external.q.out
@@ -118,11 +118,13 @@ PREHOOK: query: import table exim_employee partition (emp_country="us", emp_stat
 	from 'ql/test/data/exports/exim_employee'
 	location 'ql/test/data/tablestore/exim_employee'
 PREHOOK: type: IMPORT
+#### A masked pattern was here ####
 PREHOOK: Output: importer@exim_employee
 POSTHOOK: query: import table exim_employee partition (emp_country="us", emp_state="tn") 
 	from 'ql/test/data/exports/exim_employee'
 	location 'ql/test/data/tablestore/exim_employee'
 POSTHOOK: type: IMPORT
+#### A masked pattern was here ####
 POSTHOOK: Output: importer@exim_employee
 POSTHOOK: Output: importer@exim_employee@emp_country=us/emp_state=tn
 PREHOOK: query: show table extended like exim_employee
diff --git a/ql/src/test/results/clientpositive/exim_17_part_managed.q.out b/ql/src/test/results/clientpositive/exim_17_part_managed.q.out
index e129fe6d7a..9036a280c2 100644
--- a/ql/src/test/results/clientpositive/exim_17_part_managed.q.out
+++ b/ql/src/test/results/clientpositive/exim_17_part_managed.q.out
@@ -114,11 +114,13 @@ PREHOOK: query: import table exim_employee partition (emp_country="us", emp_stat
 	from 'ql/test/data/exports/exim_employee'
 	location 'ql/test/data/tablestore/exim_employee'
 PREHOOK: type: IMPORT
+#### A masked pattern was here ####
 PREHOOK: Output: importer@exim_employee
 POSTHOOK: query: import table exim_employee partition (emp_country="us", emp_state="tn") 
 	from 'ql/test/data/exports/exim_employee'
 	location 'ql/test/data/tablestore/exim_employee'
 POSTHOOK: type: IMPORT
+#### A masked pattern was here ####
 POSTHOOK: Output: importer@exim_employee
 POSTHOOK: Output: importer@exim_employee@emp_country=us/emp_state=tn
 PREHOOK: query: alter table exim_employee add partition	(emp_country="us", emp_state="ap")
diff --git a/ql/src/test/results/clientpositive/exim_18_part_external.q.out b/ql/src/test/results/clientpositive/exim_18_part_external.q.out
index 95f85480a4..a082a11a69 100644
--- a/ql/src/test/results/clientpositive/exim_18_part_external.q.out
+++ b/ql/src/test/results/clientpositive/exim_18_part_external.q.out
@@ -96,9 +96,11 @@ POSTHOOK: Input: database:importer
 PREHOOK: query: import external table exim_employee partition (emp_country="us", emp_state="tn") 
 	from 'ql/test/data/exports/exim_employee'
 PREHOOK: type: IMPORT
+#### A masked pattern was here ####
 POSTHOOK: query: import external table exim_employee partition (emp_country="us", emp_state="tn") 
 	from 'ql/test/data/exports/exim_employee'
 POSTHOOK: type: IMPORT
+#### A masked pattern was here ####
 POSTHOOK: Output: importer@exim_employee
 POSTHOOK: Output: importer@exim_employee@emp_country=us/emp_state=tn
 PREHOOK: query: describe extended exim_employee
diff --git a/ql/src/test/results/clientpositive/exim_19_00_part_external_location.q.out b/ql/src/test/results/clientpositive/exim_19_00_part_external_location.q.out
index 7a8830f945..5a97e03f59 100644
--- a/ql/src/test/results/clientpositive/exim_19_00_part_external_location.q.out
+++ b/ql/src/test/results/clientpositive/exim_19_00_part_external_location.q.out
@@ -72,10 +72,12 @@ PREHOOK: query: import external table exim_employee
 	from 'ql/test/data/exports/exim_employee'
 	location 'ql/test/data/tablestore/exim_employee'
 PREHOOK: type: IMPORT
+#### A masked pattern was here ####
 POSTHOOK: query: import external table exim_employee 
 	from 'ql/test/data/exports/exim_employee'
 	location 'ql/test/data/tablestore/exim_employee'
 POSTHOOK: type: IMPORT
+#### A masked pattern was here ####
 POSTHOOK: Output: importer@exim_employee
 POSTHOOK: Output: importer@exim_employee@emp_country=in/emp_state=ka
 POSTHOOK: Output: importer@exim_employee@emp_country=in/emp_state=tn
diff --git a/ql/src/test/results/clientpositive/exim_19_part_external_location.q.out b/ql/src/test/results/clientpositive/exim_19_part_external_location.q.out
index 278a6cd524..f9a20f7ba6 100644
--- a/ql/src/test/results/clientpositive/exim_19_part_external_location.q.out
+++ b/ql/src/test/results/clientpositive/exim_19_part_external_location.q.out
@@ -98,10 +98,12 @@ PREHOOK: query: import external table exim_employee partition (emp_country="us",
 	from 'ql/test/data/exports/exim_employee'
 	location 'ql/test/data/tablestore/exim_employee'
 PREHOOK: type: IMPORT
+#### A masked pattern was here ####
 POSTHOOK: query: import external table exim_employee partition (emp_country="us", emp_state="tn") 
 	from 'ql/test/data/exports/exim_employee'
 	location 'ql/test/data/tablestore/exim_employee'
 POSTHOOK: type: IMPORT
+#### A masked pattern was here ####
 POSTHOOK: Output: importer@exim_employee
 POSTHOOK: Output: importer@exim_employee@emp_country=us/emp_state=tn
 PREHOOK: query: describe extended exim_employee
diff --git a/ql/src/test/results/clientpositive/exim_20_part_managed_location.q.out b/ql/src/test/results/clientpositive/exim_20_part_managed_location.q.out
index 6a32f0a0fc..b196ba52d9 100644
--- a/ql/src/test/results/clientpositive/exim_20_part_managed_location.q.out
+++ b/ql/src/test/results/clientpositive/exim_20_part_managed_location.q.out
@@ -98,10 +98,12 @@ PREHOOK: query: import table exim_employee partition (emp_country="us", emp_stat
 	from 'ql/test/data/exports/exim_employee'
 	location 'ql/test/data/tablestore/exim_employee'
 PREHOOK: type: IMPORT
+#### A masked pattern was here ####
 POSTHOOK: query: import table exim_employee partition (emp_country="us", emp_state="tn") 
 	from 'ql/test/data/exports/exim_employee'
 	location 'ql/test/data/tablestore/exim_employee'
 POSTHOOK: type: IMPORT
+#### A masked pattern was here ####
 POSTHOOK: Output: importer@exim_employee
 POSTHOOK: Output: importer@exim_employee@emp_country=us/emp_state=tn
 PREHOOK: query: describe extended exim_employee
diff --git a/ql/src/test/results/clientpositive/exim_22_import_exist_authsuccess.q.out b/ql/src/test/results/clientpositive/exim_22_import_exist_authsuccess.q.out
index b17d509a96..97c3b28187 100644
--- a/ql/src/test/results/clientpositive/exim_22_import_exist_authsuccess.q.out
+++ b/ql/src/test/results/clientpositive/exim_22_import_exist_authsuccess.q.out
@@ -65,9 +65,11 @@ POSTHOOK: type: GRANT_PRIVILEGE
 POSTHOOK: Output: importer@exim_department
 PREHOOK: query: import from 'ql/test/data/exports/exim_department'
 PREHOOK: type: IMPORT
+#### A masked pattern was here ####
 PREHOOK: Output: importer@exim_department
 POSTHOOK: query: import from 'ql/test/data/exports/exim_department'
 POSTHOOK: type: IMPORT
+#### A masked pattern was here ####
 POSTHOOK: Output: importer@exim_department
 PREHOOK: query: select * from exim_department
 PREHOOK: type: QUERY
diff --git a/ql/src/test/results/clientpositive/exim_23_import_part_authsuccess.q.out b/ql/src/test/results/clientpositive/exim_23_import_part_authsuccess.q.out
index 99ccf435c3..5f78a76209 100644
--- a/ql/src/test/results/clientpositive/exim_23_import_part_authsuccess.q.out
+++ b/ql/src/test/results/clientpositive/exim_23_import_part_authsuccess.q.out
@@ -84,9 +84,11 @@ POSTHOOK: type: GRANT_PRIVILEGE
 POSTHOOK: Output: importer@exim_employee
 PREHOOK: query: import from 'ql/test/data/exports/exim_employee'
 PREHOOK: type: IMPORT
+#### A masked pattern was here ####
 PREHOOK: Output: importer@exim_employee
 POSTHOOK: query: import from 'ql/test/data/exports/exim_employee'
 POSTHOOK: type: IMPORT
+#### A masked pattern was here ####
 POSTHOOK: Output: importer@exim_employee
 POSTHOOK: Output: importer@exim_employee@emp_country=in/emp_state=tn
 PREHOOK: query: select * from exim_employee
diff --git a/ql/src/test/results/clientpositive/exim_24_import_nonexist_authsuccess.q.out b/ql/src/test/results/clientpositive/exim_24_import_nonexist_authsuccess.q.out
index c7225f79fa..3b97179d6f 100644
--- a/ql/src/test/results/clientpositive/exim_24_import_nonexist_authsuccess.q.out
+++ b/ql/src/test/results/clientpositive/exim_24_import_nonexist_authsuccess.q.out
@@ -49,8 +49,10 @@ POSTHOOK: query: grant Create on database importer to user hive_test_user
 POSTHOOK: type: GRANT_PRIVILEGE
 PREHOOK: query: import from 'ql/test/data/exports/exim_department'
 PREHOOK: type: IMPORT
+#### A masked pattern was here ####
 POSTHOOK: query: import from 'ql/test/data/exports/exim_department'
 POSTHOOK: type: IMPORT
+#### A masked pattern was here ####
 POSTHOOK: Output: importer@exim_department
 PREHOOK: query: select * from exim_department
 PREHOOK: type: QUERY
diff --git a/ql/src/test/results/clientpositive/exim_hidden_files.q.out b/ql/src/test/results/clientpositive/exim_hidden_files.q.out
index 95d8b28d18..e449e0ea0d 100644
--- a/ql/src/test/results/clientpositive/exim_hidden_files.q.out
+++ b/ql/src/test/results/clientpositive/exim_hidden_files.q.out
@@ -45,8 +45,10 @@ POSTHOOK: type: SWITCHDATABASE
 POSTHOOK: Input: database:importer
 PREHOOK: query: import from 'ql/test/data/exports/exim_employee'
 PREHOOK: type: IMPORT
+#### A masked pattern was here ####
 POSTHOOK: query: import from 'ql/test/data/exports/exim_employee'
 POSTHOOK: type: IMPORT
+#### A masked pattern was here ####
 POSTHOOK: Output: importer@exim_employee
 POSTHOOK: Output: importer@exim_employee@emp_country=in
 PREHOOK: query: describe formatted exim_employee
diff --git a/ql/src/test/results/clientpositive/import_exported_table.q.out b/ql/src/test/results/clientpositive/import_exported_table.q.out
index 4645b3b833..d2f098d6d9 100644
--- a/ql/src/test/results/clientpositive/import_exported_table.q.out
+++ b/ql/src/test/results/clientpositive/import_exported_table.q.out
@@ -2,6 +2,7 @@
 PREHOOK: type: IMPORT
 #### A masked pattern was here ####
 POSTHOOK: type: IMPORT
+#### A masked pattern was here ####
 POSTHOOK: Output: default@j1_41
 PREHOOK: query: DESCRIBE j1_41
 PREHOOK: type: DESCTABLE
