commit 915b416aa48f9b02dfffb2a27e482c279157e477
Author:     Shing Wai Chan <shing.wai.chan@oracle.com>
AuthorDate: Wed Jul 16 18:23:29 2014 +0000
Commit:     Shing Wai Chan <shing.wai.chan@oracle.com>
CommitDate: Wed Jul 16 18:23:29 2014 +0000

    port web container part of the Tomcat fix
    http://svn.apache.org/viewvc?view=revision&revision=1593821
    Defensive coding around some XML activities that are triggered by web
    applications and are therefore at potential risk of a memory leak.
    Patch by markt.
    This is part 3 of 3 of the fix for CVE-2014-0119
    
    svn path=/trunk/; revision=63507
    
    
    Former-commit-id: 35b334a8f8294a6e5cff059e71919a87f41feb78

diff --git a/main/appserver/web/web-core/src/main/java/org/apache/catalina/security/SecurityClassLoad.java b/main/appserver/web/web-core/src/main/java/org/apache/catalina/security/SecurityClassLoad.java
index e1b2459fcc..f5cd1180c1 100644
--- a/main/appserver/web/web-core/src/main/java/org/apache/catalina/security/SecurityClassLoad.java
+++ b/main/appserver/web/web-core/src/main/java/org/apache/catalina/security/SecurityClassLoad.java
@@ -41,13 +41,14 @@
  * This file incorporates work covered by the following copyright and
  * permission notice:
  *
- * Copyright 2004 The Apache Software Foundation
+ * Licensed to the Apache Software Foundation (ASF) under one or more
+ * contributor license agreements.  See the NOTICE file distributed with
+ * this work for additional information regarding copyright ownership.
+ * The ASF licenses this file to You under the Apache License, Version 2.0
+ * (the "License"); you may not use this file except in compliance with
+ * the License.  You may obtain a copy of the License at
  *
- * Licensed under the Apache License, Version 2.0 (the "License");
- * you may not use this file except in compliance with the License.
- * You may obtain a copy of the License at
- *
- *     http://www.apache.org/licenses/LICENSE-2.0
+ *      http://www.apache.org/licenses/LICENSE-2.0
  *
  * Unless required by applicable law or agreed to in writing, software
  * distributed under the License is distributed on an "AS IS" BASIS,
@@ -132,15 +133,10 @@ public final class SecurityClassLoad {
     
     private final static void loadSessionPackage(ClassLoader loader)
         throws Exception {
-        String basePackage = "org.apache.catalina.";
-        loader.loadClass
-            (basePackage + "session.StandardSession");
-        loader.loadClass
-            (basePackage +
-             "session.StandardSession$1");
-        loader.loadClass
-            (basePackage +
-             "session.StandardManager$PrivilegedDoUnload");
+        String basePackage = "org.apache.catalina.session.";
+        loader.loadClass(basePackage + "StandardSession");
+        loader.loadClass(basePackage + "StandardSession$1");
+        loader.loadClass(basePackage + "StandardManager$PrivilegedDoUnload");
     }
     
     
@@ -252,5 +248,10 @@ public final class SecurityClassLoad {
         throws Exception {
         String basePackage = "org.glassfish.grizzly.";
         loader.loadClass(basePackage + "util.net.SSLSupport$CipherData");
+
+        // security
+        basePackage = "org.apache.tomcat.";
+        loader.loadClass(basePackage + "util.security.PrivilegedGetTccl");
+        loader.loadClass(basePackage + "util.security.PrivilegedSetTccl");
     }
 }
diff --git a/main/appserver/web/web-core/src/main/java/org/apache/catalina/servlets/DefaultServlet.java b/main/appserver/web/web-core/src/main/java/org/apache/catalina/servlets/DefaultServlet.java
index 09fd415f8b..33b8e99d13 100644
--- a/main/appserver/web/web-core/src/main/java/org/apache/catalina/servlets/DefaultServlet.java
+++ b/main/appserver/web/web-core/src/main/java/org/apache/catalina/servlets/DefaultServlet.java
@@ -41,13 +41,14 @@
  * This file incorporates work covered by the following copyright and
  * permission notice:
  *
- * Copyright 2004 The Apache Software Foundation
+ * Licensed to the Apache Software Foundation (ASF) under one or more
+ * contributor license agreements.  See the NOTICE file distributed with
+ * this work for additional information regarding copyright ownership.
+ * The ASF licenses this file to You under the Apache License, Version 2.0
+ * (the "License"); you may not use this file except in compliance with
+ * the License.  You may obtain a copy of the License at
  *
- * Licensed under the Apache License, Version 2.0 (the "License");
- * you may not use this file except in compliance with the License.
- * You may obtain a copy of the License at
- *
- *     http://www.apache.org/licenses/LICENSE-2.0
+ *      http://www.apache.org/licenses/LICENSE-2.0
  *
  * Unless required by applicable law or agreed to in writing, software
  * distributed under the License is distributed on an "AS IS" BASIS,
@@ -73,6 +74,7 @@ import java.io.RandomAccessFile;
 import java.io.Reader;
 import java.io.StringReader;
 import java.io.StringWriter;
+import java.security.AccessController;
 import java.text.MessageFormat;
 import java.util.*;
 import javax.naming.InitialContext;
@@ -107,6 +109,8 @@ import org.apache.naming.resources.CacheEntry;
 import org.apache.naming.resources.ProxyDirContext;
 import org.apache.naming.resources.Resource;
 import org.apache.naming.resources.ResourceAttributes;
+import org.apache.tomcat.util.security.PrivilegedGetTccl;
+import org.apache.tomcat.util.security.PrivilegedSetTccl;
 import org.glassfish.grizzly.http.server.util.AlternateDocBase;
 import org.glassfish.logging.annotation.LogMessageInfo;
 import org.glassfish.web.util.HtmlEntityEncoder;
@@ -1505,8 +1509,24 @@ public class DefaultServlet
 
         sb.append("</listing>");
 
-
+        // Prevent possible memory leak. Ensure Transformer and
+        // TransformerFactory are not loaded from the web application.
+        ClassLoader original;
+        if (Globals.IS_SECURITY_ENABLED) {
+            PrivilegedGetTccl pa = new PrivilegedGetTccl();
+            original = AccessController.doPrivileged(pa);
+        } else {
+            original = Thread.currentThread().getContextClassLoader();
+        }
         try {
+            if (Globals.IS_SECURITY_ENABLED) {
+                PrivilegedSetTccl pa =
+                        new PrivilegedSetTccl(DefaultServlet.class.getClassLoader());
+                AccessController.doPrivileged(pa);
+            } else {
+                Thread.currentThread().setContextClassLoader(
+                        DefaultServlet.class.getClassLoader());
+            }
             TransformerFactory tFactory = TransformerFactory.newInstance();
             Source xmlSource = new StreamSource(new StringReader(sb.toString()));
             Transformer transformer = tFactory.newTransformer(xsltSource);
@@ -1520,6 +1540,13 @@ public class DefaultServlet
         } catch (Exception e) {
             log("directory transform failure: " + e.getMessage());
             return renderHtml(contextPath, cacheEntry);
+        } finally {
+            if (Globals.IS_SECURITY_ENABLED) {
+                PrivilegedSetTccl pa = new PrivilegedSetTccl(original);
+                AccessController.doPrivileged(pa);
+            } else {
+                Thread.currentThread().setContextClassLoader(original);
+            }
         }
     }
 
diff --git a/main/appserver/web/web-core/src/main/java/org/apache/catalina/session/StandardManager.java b/main/appserver/web/web-core/src/main/java/org/apache/catalina/session/StandardManager.java
index f7013f7f43..0b62403eb3 100644
--- a/main/appserver/web/web-core/src/main/java/org/apache/catalina/session/StandardManager.java
+++ b/main/appserver/web/web-core/src/main/java/org/apache/catalina/session/StandardManager.java
@@ -1,7 +1,7 @@
 /*
  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS HEADER.
  *
- * Copyright (c) 1997-2013 Oracle and/or its affiliates. All rights reserved.
+ * Copyright (c) 1997-2014 Oracle and/or its affiliates. All rights reserved.
  *
  * The contents of this file are subject to the terms of either the GNU
  * General Public License Version 2 only ("GPL") or the Common Development
@@ -41,13 +41,14 @@
  * This file incorporates work covered by the following copyright and
  * permission notice:
  *
- * Copyright 2004 The Apache Software Foundation
+ * Licensed to the Apache Software Foundation (ASF) under one or more
+ * contributor license agreements.  See the NOTICE file distributed with
+ * this work for additional information regarding copyright ownership.
+ * The ASF licenses this file to You under the Apache License, Version 2.0
+ * (the "License"); you may not use this file except in compliance with
+ * the License.  You may obtain a copy of the License at
  *
- * Licensed under the Apache License, Version 2.0 (the "License");
- * you may not use this file except in compliance with the License.
- * You may obtain a copy of the License at
- *
- *     http://www.apache.org/licenses/LICENSE-2.0
+ *      http://www.apache.org/licenses/LICENSE-2.0
  *
  * Unless required by applicable law or agreed to in writing, software
  * distributed under the License is distributed on an "AS IS" BASIS,
@@ -166,19 +167,19 @@ public class StandardManager
         }                       
     }
         
-    private class PrivilegedDoUnloadToFile
+    private class PrivilegedDoUnload
         implements PrivilegedExceptionAction<Void> {
 
         private boolean expire;
         private boolean isShutdown;
 
-        PrivilegedDoUnloadToFile(boolean expire, boolean shutDown) {
+        PrivilegedDoUnload(boolean expire, boolean shutDown) {
             this.expire = expire;
             isShutdown = shutDown;
         }
 
         public Void run() throws Exception{
-            doUnloadToFile(expire, isShutdown);
+            doUnload(expire, isShutdown);
             return null;
         }            
            
@@ -638,7 +639,7 @@ public class StandardManager
         if (SecurityUtil.isPackageProtectionEnabled()){       
             try {
                 AccessController.doPrivileged(
-                    new PrivilegedDoUnloadToFile(doExpire, isShutdown));
+                    new PrivilegedDoUnload(doExpire, isShutdown));
             } catch (PrivilegedActionException ex){
                 Exception exception = ex.getException();
                 if (exception instanceof IOException){
@@ -648,7 +649,7 @@ public class StandardManager
                     log.log(Level.FINE, "Unreported exception in unLoad() " + exception);
             }
         } else {
-            doUnloadToFile(doExpire, isShutdown);
+            doUnload(doExpire, isShutdown);
         }       
     }
         
@@ -661,7 +662,7 @@ public class StandardManager
      *
      * @exception IOException if an input/output error occurs
      */
-    private void doUnloadToFile(boolean doExpire, boolean isShutdown) throws IOException {
+    private void doUnload(boolean doExpire, boolean isShutdown) throws IOException {
         if(isShutdown) {
             if(log.isLoggable(Level.FINE)) {
                 log.log(Level.FINE, "Unloading persisted sessions");
diff --git a/main/appserver/web/web-core/src/main/java/org/apache/catalina/session/StandardSession.java b/main/appserver/web/web-core/src/main/java/org/apache/catalina/session/StandardSession.java
index 5d80abe933..cc3ae3309d 100644
--- a/main/appserver/web/web-core/src/main/java/org/apache/catalina/session/StandardSession.java
+++ b/main/appserver/web/web-core/src/main/java/org/apache/catalina/session/StandardSession.java
@@ -1,7 +1,7 @@
 /*
  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS HEADER.
  *
- * Copyright (c) 1997-2013 Oracle and/or its affiliates. All rights reserved.
+ * Copyright (c) 1997-2014 Oracle and/or its affiliates. All rights reserved.
  *
  * The contents of this file are subject to the terms of either the GNU
  * General Public License Version 2 only ("GPL") or the Common Development
@@ -41,13 +41,14 @@
  * This file incorporates work covered by the following copyright and
  * permission notice:
  *
- * Copyright 2004 The Apache Software Foundation
+ * Licensed to the Apache Software Foundation (ASF) under one or more
+ * contributor license agreements.  See the NOTICE file distributed with
+ * this work for additional information regarding copyright ownership.
+ * The ASF licenses this file to You under the Apache License, Version 2.0
+ * (the "License"); you may not use this file except in compliance with
+ * the License.  You may obtain a copy of the License at
  *
- * Licensed under the Apache License, Version 2.0 (the "License");
- * you may not use this file except in compliance with the License.
- * You may obtain a copy of the License at
- *
- *     http://www.apache.org/licenses/LICENSE-2.0
+ *      http://www.apache.org/licenses/LICENSE-2.0
  *
  * Unless required by applicable law or agreed to in writing, software
  * distributed under the License is distributed on an "AS IS" BASIS,
@@ -64,6 +65,7 @@ import org.apache.catalina.core.StandardContext;
 import org.apache.catalina.core.StandardServer;
 import org.apache.catalina.security.SecurityUtil;
 import org.apache.catalina.util.Enumerator;
+import org.apache.tomcat.util.security.PrivilegedSetTccl;
 import org.glassfish.logging.annotation.LogMessageInfo;
 
 import javax.servlet.ServletContext;
@@ -2399,19 +2401,6 @@ public class StandardSession
         }
     }
 
-    private static class PrivilegedSetTccl implements PrivilegedAction<Void> {
-        private ClassLoader cl;
-
-        PrivilegedSetTccl(ClassLoader cl) {
-            this.cl = cl;
-        }
-
-        @Override
-        public Void run() {
-            Thread.currentThread().setContextClassLoader(cl);
-            return null;
-        }
-    }
 }
 
 
diff --git a/main/appserver/web/web-core/src/main/java/org/apache/tomcat/util/security/PrivilegedGetTccl.java b/main/appserver/web/web-core/src/main/java/org/apache/tomcat/util/security/PrivilegedGetTccl.java
new file mode 100644
index 0000000000..b72e6c8503
--- /dev/null
+++ b/main/appserver/web/web-core/src/main/java/org/apache/tomcat/util/security/PrivilegedGetTccl.java
@@ -0,0 +1,71 @@
+/*
+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS HEADER.
+ *
+ * Copyright (c) 2014 Oracle and/or its affiliates. All rights reserved.
+ *
+ * The contents of this file are subject to the terms of either the GNU
+ * General Public License Version 2 only ("GPL") or the Common Development
+ * and Distribution License("CDDL") (collectively, the "License").  You
+ * may not use this file except in compliance with the License.  You can
+ * obtain a copy of the License at
+ * https://glassfish.dev.java.net/public/CDDL+GPL_1_1.html
+ * or packager/legal/LICENSE.txt.  See the License for the specific
+ * language governing permissions and limitations under the License.
+ *
+ * When distributing the software, include this License Header Notice in each
+ * file and include the License file at packager/legal/LICENSE.txt.
+ *
+ * GPL Classpath Exception:
+ * Oracle designates this particular file as subject to the "Classpath"
+ * exception as provided by Oracle in the GPL Version 2 section of the License
+ * file that accompanied this code.
+ *
+ * Modifications:
+ * If applicable, add the following below the License Header, with the fields
+ * enclosed by brackets [] replaced by your own identifying information:
+ * "Portions Copyright [year] [name of copyright owner]"
+ *
+ * Contributor(s):
+ * If you wish your version of this file to be governed by only the CDDL or
+ * only the GPL Version 2, indicate your decision by adding "[Contributor]
+ * elects to include this software in this distribution under the [CDDL or GPL
+ * Version 2] license."  If you don't indicate a single choice of license, a
+ * recipient has the option to distribute your version of this file under
+ * either the CDDL, the GPL Version 2 or to extend the choice of license to
+ * its licensees as provided above.  However, if you add GPL Version 2 code
+ * and therefore, elected the GPL Version 2 license, then the option applies
+ * only if the new code is made subject to such option by the copyright
+ * holder.
+ *
+ *
+ * This file incorporates work covered by the following copyright and
+ * permission notice:
+ *
+ * Licensed to the Apache Software Foundation (ASF) under one or more
+ * contributor license agreements.  See the NOTICE file distributed with
+ * this work for additional information regarding copyright ownership.
+ * The ASF licenses this file to You under the Apache License, Version 2.0
+ * (the "License"); you may not use this file except in compliance with
+ * the License.  You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package org.apache.tomcat.util.security;
+
+import java.security.PrivilegedAction;
+
+public class PrivilegedGetTccl implements PrivilegedAction<ClassLoader> {
+    @Override
+    public ClassLoader run() {
+        return Thread.currentThread().getContextClassLoader();
+    }
+}
+
+
diff --git a/main/appserver/web/web-core/src/main/java/org/apache/tomcat/util/security/PrivilegedSetTccl.java b/main/appserver/web/web-core/src/main/java/org/apache/tomcat/util/security/PrivilegedSetTccl.java
new file mode 100644
index 0000000000..ec1b9e3705
--- /dev/null
+++ b/main/appserver/web/web-core/src/main/java/org/apache/tomcat/util/security/PrivilegedSetTccl.java
@@ -0,0 +1,77 @@
+/*
+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS HEADER.
+ *
+ * Copyright (c) 2014 Oracle and/or its affiliates. All rights reserved.
+ *
+ * The contents of this file are subject to the terms of either the GNU
+ * General Public License Version 2 only ("GPL") or the Common Development
+ * and Distribution License("CDDL") (collectively, the "License").  You
+ * may not use this file except in compliance with the License.  You can
+ * obtain a copy of the License at
+ * https://glassfish.dev.java.net/public/CDDL+GPL_1_1.html
+ * or packager/legal/LICENSE.txt.  See the License for the specific
+ * language governing permissions and limitations under the License.
+ *
+ * When distributing the software, include this License Header Notice in each
+ * file and include the License file at packager/legal/LICENSE.txt.
+ *
+ * GPL Classpath Exception:
+ * Oracle designates this particular file as subject to the "Classpath"
+ * exception as provided by Oracle in the GPL Version 2 section of the License
+ * file that accompanied this code.
+ *
+ * Modifications:
+ * If applicable, add the following below the License Header, with the fields
+ * enclosed by brackets [] replaced by your own identifying information:
+ * "Portions Copyright [year] [name of copyright owner]"
+ *
+ * Contributor(s):
+ * If you wish your version of this file to be governed by only the CDDL or
+ * only the GPL Version 2, indicate your decision by adding "[Contributor]
+ * elects to include this software in this distribution under the [CDDL or GPL
+ * Version 2] license."  If you don't indicate a single choice of license, a
+ * recipient has the option to distribute your version of this file under
+ * either the CDDL, the GPL Version 2 or to extend the choice of license to
+ * its licensees as provided above.  However, if you add GPL Version 2 code
+ * and therefore, elected the GPL Version 2 license, then the option applies
+ * only if the new code is made subject to such option by the copyright
+ * holder.
+ *
+ *
+ * This file incorporates work covered by the following copyright and
+ * permission notice:
+ *
+ * Licensed to the Apache Software Foundation (ASF) under one or more
+ * contributor license agreements.  See the NOTICE file distributed with
+ * this work for additional information regarding copyright ownership.
+ * The ASF licenses this file to You under the Apache License, Version 2.0
+ * (the "License"); you may not use this file except in compliance with
+ * the License.  You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package org.apache.tomcat.util.security;
+
+import java.security.PrivilegedAction;
+
+public class PrivilegedSetTccl implements PrivilegedAction<Void> {
+
+    private ClassLoader cl;
+
+    public PrivilegedSetTccl(ClassLoader cl) {
+        this.cl = cl;
+    }
+
+    @Override
+    public Void run() {
+        Thread.currentThread().setContextClassLoader(cl);
+        return null;
+    }
+}
