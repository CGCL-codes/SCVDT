commit 23671895831bbae90e3560e0c5638b8fe2d61a55
Author:     Shing Wai Chan <shing.wai.chan@oracle.com>
AuthorDate: Wed Jul 9 16:41:38 2014 +0000
Commit:     Shing Wai Chan <shing.wai.chan@oracle.com>
CommitDate: Wed Jul 9 16:41:38 2014 +0000

    port Tomcat fix http://svn.apache.org/viewvc?view=revision&revision=1589640
    "Avoid memory leak and add small optimisation to default Servlet
    This is part 1 of 3 of the fix for CVE-2014-0119"
    
    svn path=/trunk/; revision=63453
    
    
    Former-commit-id: 0e2fb060729ee375abb2713e9164262a7c447dac

diff --git a/main/appserver/web/web-core/src/main/java/org/apache/catalina/security/SecurityClassLoad.java b/main/appserver/web/web-core/src/main/java/org/apache/catalina/security/SecurityClassLoad.java
index 9770193247..d87f77a848 100644
--- a/main/appserver/web/web-core/src/main/java/org/apache/catalina/security/SecurityClassLoad.java
+++ b/main/appserver/web/web-core/src/main/java/org/apache/catalina/security/SecurityClassLoad.java
@@ -79,6 +79,7 @@ public final class SecurityClassLoad {
         
         loadCorePackage(loader);
         loadLoaderPackage(loader);
+        loadServletsPackage(loader);
         loadSessionPackage(loader);
         loadUtilPackage(loader);
         loadJavaxPackage(loader);
@@ -116,6 +117,17 @@ public final class SecurityClassLoad {
             (basePackage +
              "loader.WebappClassLoader$PrivilegedFindResource");
     }
+
+    private static final void loadServletsPackage(ClassLoader loader)
+            throws Exception {
+        final String basePackage = "org.apache.catalina.servlets.";
+        // Avoid a possible memory leak in the DefaultServlet when running with
+        // a security manager. The DefaultServlet needs to load an XML parser
+        // when running under a security manager. We want this to be loaded by
+        // the container rather than a web application to prevent a memory leak
+        // via web application class loader.
+        loader.loadClass(basePackage + "DefaultServlet");
+    }
     
     
     private final static void loadSessionPackage(ClassLoader loader)
diff --git a/main/appserver/web/web-core/src/main/java/org/apache/catalina/servlets/DefaultServlet.java b/main/appserver/web/web-core/src/main/java/org/apache/catalina/servlets/DefaultServlet.java
index 6f744bdf18..09fd415f8b 100644
--- a/main/appserver/web/web-core/src/main/java/org/apache/catalina/servlets/DefaultServlet.java
+++ b/main/appserver/web/web-core/src/main/java/org/apache/catalina/servlets/DefaultServlet.java
@@ -226,8 +226,7 @@ public class DefaultServlet
 
     private static final DocumentBuilderFactory factory;
 
-    private static final SecureEntityResolver secureEntityResolver =
-            new SecureEntityResolver();
+    private static final SecureEntityResolver secureEntityResolver;
 
     // ----------------------------------------------------- Instance Variables
 
@@ -355,9 +354,15 @@ public class DefaultServlet
         urlEncoder.addSafeCharacter('*');
         urlEncoder.addSafeCharacter('/');
 
-        factory = DocumentBuilderFactory.newInstance();
-        factory.setNamespaceAware(true);
-        factory.setValidating(false);
+        if (Globals.IS_SECURITY_ENABLED) {
+            factory = DocumentBuilderFactory.newInstance();
+            factory.setNamespaceAware(true);
+            factory.setValidating(false);
+            secureEntityResolver = new SecureEntityResolver();
+        } else {
+            factory = null;
+            secureEntityResolver = null;
+        }
     }
 
 
