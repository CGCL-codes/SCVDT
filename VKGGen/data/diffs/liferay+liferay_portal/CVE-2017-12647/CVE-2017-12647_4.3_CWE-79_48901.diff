From 0473f9c2c8adb73e03a1180a37769ffc98c18a92 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?U=C4=9Furcan=20=C3=87etin?= <ugurcan.cetin@liferay.com>
Date: Tue, 25 Apr 2017 13:29:45 +0200
Subject: [PATCH 1/4] LPS-72090 XSS in KB article's and template's title when
 printing

---
 .../resources/META-INF/resources/admin/common/print_article.jsp | 2 +-
 .../META-INF/resources/admin/common/print_template.jsp          | 2 +-
 2 files changed, 2 insertions(+), 2 deletions(-)

diff --git a/modules/apps/knowledge-base/knowledge-base-web/src/main/resources/META-INF/resources/admin/common/print_article.jsp b/modules/apps/knowledge-base/knowledge-base-web/src/main/resources/META-INF/resources/admin/common/print_article.jsp
index 0cba246694fb9..3c1a0ded29569 100644
--- a/modules/apps/knowledge-base/knowledge-base-web/src/main/resources/META-INF/resources/admin/common/print_article.jsp
+++ b/modules/apps/knowledge-base/knowledge-base-web/src/main/resources/META-INF/resources/admin/common/print_article.jsp
@@ -22,7 +22,7 @@ KBArticle kbArticle = (KBArticle)request.getAttribute(KBWebKeys.KNOWLEDGE_BASE_K
 
 <div class="float-container kb-entity-header">
 	<div class="kb-title">
-		<%= kbArticle.getTitle() %>
+		<%= HtmlUtil.escape(kbArticle.getTitle()) %>
 	</div>
 
 	<div class="kb-tools">
diff --git a/modules/apps/knowledge-base/knowledge-base-web/src/main/resources/META-INF/resources/admin/common/print_template.jsp b/modules/apps/knowledge-base/knowledge-base-web/src/main/resources/META-INF/resources/admin/common/print_template.jsp
index 8a211f1b952d7..bd37f1140209c 100644
--- a/modules/apps/knowledge-base/knowledge-base-web/src/main/resources/META-INF/resources/admin/common/print_template.jsp
+++ b/modules/apps/knowledge-base/knowledge-base-web/src/main/resources/META-INF/resources/admin/common/print_template.jsp
@@ -22,7 +22,7 @@ KBTemplate kbTemplate = (KBTemplate)request.getAttribute(KBWebKeys.KNOWLEDGE_BAS
 
 <div class="float-container kb-entity-header">
 	<div class="kb-title">
-		<%= kbTemplate.getTitle() %>
+		<%= HtmlUtil.escape(kbTemplate.getTitle()) %>
 	</div>
 
 	<div class="kb-tools">

From 3889bb34255ddd6f1ba7ec5d08fa6e71ce9748ce Mon Sep 17 00:00:00 2001
From: Tibor Lipusz <tibor.lipusz@liferay.com>
Date: Thu, 27 Apr 2017 18:47:11 +0200
Subject: [PATCH 2/4] LPS-72090 Escape more

---
 .../main/resources/META-INF/resources/article/configuration.jsp | 2 +-
 .../src/main/resources/META-INF/resources/section/view.jsp      | 2 +-
 2 files changed, 2 insertions(+), 2 deletions(-)

diff --git a/modules/apps/knowledge-base/knowledge-base-web/src/main/resources/META-INF/resources/article/configuration.jsp b/modules/apps/knowledge-base/knowledge-base-web/src/main/resources/META-INF/resources/article/configuration.jsp
index 8570da924af7b..7339313c21e72 100644
--- a/modules/apps/knowledge-base/knowledge-base-web/src/main/resources/META-INF/resources/article/configuration.jsp
+++ b/modules/apps/knowledge-base/knowledge-base-web/src/main/resources/META-INF/resources/article/configuration.jsp
@@ -45,7 +45,7 @@ kbArticlePortletInstanceConfiguration = ParameterMapUtil.setParameterMap(KBArtic
 									KBArticle kbArticle = KBArticleLocalServiceUtil.fetchLatestKBArticle(kbArticlePortletInstanceConfiguration.resourcePrimKey(), WorkflowConstants.STATUS_APPROVED);
 									%>
 
-									<aui:input label="article" name="configurationKBArticle" type="resource" value="<%= (kbArticle != null) ? kbArticle.getTitle() : StringPool.BLANK %>" />
+									<aui:input label="article" name="configurationKBArticle" type="resource" value="<%= (kbArticle != null) ? HtmlUtil.escape(kbArticle.getTitle()) : StringPool.BLANK %>" />
 
 									<aui:button name="selectKBArticleButton" value="select" />
 								</div>
diff --git a/modules/apps/knowledge-base/knowledge-base-web/src/main/resources/META-INF/resources/section/view.jsp b/modules/apps/knowledge-base/knowledge-base-web/src/main/resources/META-INF/resources/section/view.jsp
index a57841b4b8cf0..8e7d562080b2a 100644
--- a/modules/apps/knowledge-base/knowledge-base-web/src/main/resources/META-INF/resources/section/view.jsp
+++ b/modules/apps/knowledge-base/knowledge-base-web/src/main/resources/META-INF/resources/section/view.jsp
@@ -74,7 +74,7 @@ String kbArticleDisplayStyle = kbSectionPortletInstanceConfiguration.kbArticleDi
 						<liferay-ui:icon
 							iconCssClass="icon-file-alt"
 							label="<%= true %>"
-							message="<%= kbArticle.getTitle() %>"
+							message="<%= HtmlUtil.escape(kbArticle.getTitle()) %>"
 							method="get"
 							url="<%= viewKBArticleURL.toString() %>"
 						/>

From bd92daa70ab77a40eff0eb18e8e91f3e095694e1 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Tom=C3=A1=C5=A1=20Pole=C5=A1ovsk=C3=BD?=
 <tomas.polesovsky@liferay.com>
Date: Tue, 9 May 2017 14:24:18 +0200
Subject: [PATCH 3/4] LPS-72090 Fix XSS

---
 .../META-INF/resources/add_menu/page.jsp         |  2 +-
 .../META-INF/resources/admin/add_button.jsp      |  2 +-
 .../admin/common/article_asset_entries.jsp       |  4 ++--
 .../resources/admin/common/article_history.jsp   |  2 +-
 .../admin/common/article_suggestions.jsp         |  3 +--
 .../resources/admin/common/article_tools.jsp     |  4 ++--
 .../resources/admin/common/attachments.jsp       |  2 +-
 .../resources/admin/common/edit_article.jsp      |  2 +-
 .../META-INF/resources/admin/common/history.jsp  |  2 +-
 .../resources/admin/common/move_object.jsp       |  2 +-
 .../resources/admin/common/select_parent.jsp     | 12 ++++--------
 .../resources/admin/common/view_suggestion.jsp   |  2 +-
 .../admin/common/view_suggestions_by_status.jsp  |  2 +-
 .../META-INF/resources/admin/import.jsp          |  4 ++--
 .../resources/admin/template_comment.jsp         |  2 +-
 .../resources/META-INF/resources/admin/view.jsp  | 14 +++++---------
 .../META-INF/resources/admin/view_templates.jsp  |  5 ++---
 .../META-INF/resources/article/configuration.jsp |  6 +++---
 .../META-INF/resources/article/view_article.jsp  |  2 +-
 .../META-INF/resources/display/configuration.jsp |  6 +++---
 .../resources/display/content_root_selector.jsp  |  2 +-
 .../META-INF/resources/display/view_article.jsp  |  2 +-
 .../main/resources/META-INF/resources/init.jsp   |  2 +-
 .../resources/search/view_prp_articles.jsp       | 16 ++++++----------
 .../META-INF/resources/section/configuration.jsp |  2 +-
 .../META-INF/resources/section/view.jsp          |  4 ++--
 .../src/com/liferay/taglib/ui/HeaderTag.java     |  4 +++-
 27 files changed, 50 insertions(+), 62 deletions(-)

diff --git a/modules/apps/foundation/frontend-taglib/frontend-taglib/src/main/resources/META-INF/resources/add_menu/page.jsp b/modules/apps/foundation/frontend-taglib/frontend-taglib/src/main/resources/META-INF/resources/add_menu/page.jsp
index df18d82bab5a6..742d34c661c9e 100644
--- a/modules/apps/foundation/frontend-taglib/frontend-taglib/src/main/resources/META-INF/resources/add_menu/page.jsp
+++ b/modules/apps/foundation/frontend-taglib/frontend-taglib/src/main/resources/META-INF/resources/add_menu/page.jsp
@@ -48,7 +48,7 @@ String viewMoreURL = (String)request.getAttribute("liferay-frontend:add-menu:vie
 		}
 		%>
 
-		<a <%= AUIUtil.buildData(menuItem.getAnchorData()) %> class="btn btn-action btn-bottom-right btn-primary" data-placement="left" data-qa-id="addButton" data-toggle="tooltip" href="<%= HtmlUtil.escapeAttribute(menuItem.getUrl()) %>" id="<%= namespace + id %>" title="<%= title %>">
+		<a <%= AUIUtil.buildData(menuItem.getAnchorData()) %> class="btn btn-action btn-bottom-right btn-primary" data-placement="left" data-qa-id="addButton" data-toggle="tooltip" href="<%= HtmlUtil.escapeAttribute(menuItem.getUrl()) %>" id="<%= namespace + id %>" title="<%= HtmlUtil.escapeAttribute(title) %>">
 			<aui:icon image="plus" markupView="lexicon" />
 		</a>
 
diff --git a/modules/apps/knowledge-base/knowledge-base-web/src/main/resources/META-INF/resources/admin/add_button.jsp b/modules/apps/knowledge-base/knowledge-base-web/src/main/resources/META-INF/resources/admin/add_button.jsp
index 53001c4d4fcc4..a8af36f26f34f 100644
--- a/modules/apps/knowledge-base/knowledge-base-web/src/main/resources/META-INF/resources/admin/add_button.jsp
+++ b/modules/apps/knowledge-base/knowledge-base-web/src/main/resources/META-INF/resources/admin/add_button.jsp
@@ -77,7 +77,7 @@ else {
 					<portlet:param name="kbTemplateId" value="<%= String.valueOf(kbTemplate.getKbTemplateId()) %>" />
 				</liferay-portlet:renderURL>
 
-				<liferay-frontend:add-menu-item title="<%= LanguageUtil.get(resourceBundle, HtmlUtil.escape(kbTemplate.getTitle())) %>" url="<%= addKBArticleURL.toString() %>" />
+				<liferay-frontend:add-menu-item title="<%= LanguageUtil.get(resourceBundle, kbTemplate.getTitle()) %>" url="<%= addKBArticleURL.toString() %>" />
 
 			<%
 			}
diff --git a/modules/apps/knowledge-base/knowledge-base-web/src/main/resources/META-INF/resources/admin/common/article_asset_entries.jsp b/modules/apps/knowledge-base/knowledge-base-web/src/main/resources/META-INF/resources/admin/common/article_asset_entries.jsp
index ef2623c0d2984..3781c456541ba 100644
--- a/modules/apps/knowledge-base/knowledge-base-web/src/main/resources/META-INF/resources/admin/common/article_asset_entries.jsp
+++ b/modules/apps/knowledge-base/knowledge-base-web/src/main/resources/META-INF/resources/admin/common/article_asset_entries.jsp
@@ -60,7 +60,7 @@ KBArticle kbArticle = (KBArticle)request.getAttribute(KBWebKeys.KNOWLEDGE_BASE_K
 									<liferay-ui:icon
 										iconCssClass="<%= assetRenderer.getIconCssClass() %>"
 										label="<%= true %>"
-										message="<%= assetRenderer.getTitle(locale) %>"
+										message="<%= HtmlUtil.escape(assetRenderer.getTitle(locale)) %>"
 										url="<%= KBArticleAssetEntriesUtil.getURL(request, themeDisplay, assetRendererFactory, assetRenderer) %>"
 									/>
 
@@ -92,7 +92,7 @@ KBArticle kbArticle = (KBArticle)request.getAttribute(KBWebKeys.KNOWLEDGE_BASE_K
 									<liferay-ui:icon
 										iconCssClass="<%= assetRenderer.getIconCssClass() %>"
 										label="<%= true %>"
-										message="<%= assetRenderer.getTitle(locale) %>"
+										message="<%= HtmlUtil.escape(assetRenderer.getTitle(locale)) %>"
 										url="<%= KBArticleAssetEntriesUtil.getURL(request, themeDisplay, assetRendererFactory, assetRenderer) %>"
 									/>
 
diff --git a/modules/apps/knowledge-base/knowledge-base-web/src/main/resources/META-INF/resources/admin/common/article_history.jsp b/modules/apps/knowledge-base/knowledge-base-web/src/main/resources/META-INF/resources/admin/common/article_history.jsp
index dd613be2640a0..9e3467a8d09d2 100644
--- a/modules/apps/knowledge-base/knowledge-base-web/src/main/resources/META-INF/resources/admin/common/article_history.jsp
+++ b/modules/apps/knowledge-base/knowledge-base-web/src/main/resources/META-INF/resources/admin/common/article_history.jsp
@@ -117,7 +117,7 @@
 													<portlet:param name="resourcePrimKey" value="<%= String.valueOf(kbArticle.getResourcePrimKey()) %>" />
 												</portlet:renderURL>
 
-												var uri = '<%= compareVersionURL %>';
+												var uri = '<%= HtmlUtil.escapeJS(compareVersionURL) %>';
 
 												uri = Liferay.Util.addParams('<portlet:namespace />sourceVersion=' + event.sourceversion, uri);
 												uri = Liferay.Util.addParams('<portlet:namespace />targetVersion=' + event.targetversion, uri);
diff --git a/modules/apps/knowledge-base/knowledge-base-web/src/main/resources/META-INF/resources/admin/common/article_suggestions.jsp b/modules/apps/knowledge-base/knowledge-base-web/src/main/resources/META-INF/resources/admin/common/article_suggestions.jsp
index 2ad6b8156d8b0..cb39236c0d0ce 100644
--- a/modules/apps/knowledge-base/knowledge-base-web/src/main/resources/META-INF/resources/admin/common/article_suggestions.jsp
+++ b/modules/apps/knowledge-base/knowledge-base-web/src/main/resources/META-INF/resources/admin/common/article_suggestions.jsp
@@ -165,7 +165,6 @@ if (ratingsType == null) {
 
 					<liferay-ui:search-container-row
 						className="com.liferay.knowledge.base.model.KBComment"
-						escapedModel="<%= true %>"
 						modelVar="kbComment"
 					>
 						<liferay-ui:search-container-column-text
@@ -173,7 +172,7 @@ if (ratingsType == null) {
 							name="comment"
 							orderable="<%= true %>"
 						>
-							<%= kbComment.getContent() %>
+							<%= HtmlUtil.escape(kbComment.getContent()) %>
 						</liferay-ui:search-container-column-text>
 
 						<liferay-ui:search-container-column-date
diff --git a/modules/apps/knowledge-base/knowledge-base-web/src/main/resources/META-INF/resources/admin/common/article_tools.jsp b/modules/apps/knowledge-base/knowledge-base-web/src/main/resources/META-INF/resources/admin/common/article_tools.jsp
index 85cc10c059458..e95fbf4b1f9ee 100644
--- a/modules/apps/knowledge-base/knowledge-base-web/src/main/resources/META-INF/resources/admin/common/article_tools.jsp
+++ b/modules/apps/knowledge-base/knowledge-base-web/src/main/resources/META-INF/resources/admin/common/article_tools.jsp
@@ -24,9 +24,9 @@ int status = (Integer)request.getAttribute(KBWebKeys.KNOWLEDGE_BASE_STATUS);
 
 <div class="kb-article-tools">
 	<c:if test="<%= kbGroupServiceConfiguration.sourceURLEnabled() && Validator.isUrl(kbArticle.getSourceURL()) %>">
-		<a href="<%= kbArticle.getSourceURL() %>" target="_blank">
+		<a href="<%= HtmlUtil.escapeAttribute(kbArticle.getSourceURL()) %>" target="_blank">
 			<span class="kb-article-source-url label label-success">
-				<liferay-ui:message key="<%= kbGroupServiceConfiguration.sourceURLEditMessageKey() %>" />
+				<liferay-ui:message key="<%= HtmlUtil.escape(kbGroupServiceConfiguration.sourceURLEditMessageKey()) %>" />
 			</span>
 		</a>
 	</c:if>
diff --git a/modules/apps/knowledge-base/knowledge-base-web/src/main/resources/META-INF/resources/admin/common/attachments.jsp b/modules/apps/knowledge-base/knowledge-base-web/src/main/resources/META-INF/resources/admin/common/attachments.jsp
index b01e2875ba532..535bf98007914 100644
--- a/modules/apps/knowledge-base/knowledge-base-web/src/main/resources/META-INF/resources/admin/common/attachments.jsp
+++ b/modules/apps/knowledge-base/knowledge-base-web/src/main/resources/META-INF/resources/admin/common/attachments.jsp
@@ -64,7 +64,7 @@ if (kbArticle != null) {
 						data="<%= data %>"
 						iconCssClass="icon-paper-clip"
 						label="<%= true %>"
-						message='<%= fileEntry.getTitle() + " (" + TextFormatter.formatStorageSize(fileEntry.getSize(), locale) + ")" %>'
+						message='<%= HtmlUtil.escape(fileEntry.getTitle()) + " (" + TextFormatter.formatStorageSize(fileEntry.getSize(), locale) + ")" %>'
 						method="get"
 						url="<%= rowURL %>"
 					/>
diff --git a/modules/apps/knowledge-base/knowledge-base-web/src/main/resources/META-INF/resources/admin/common/edit_article.jsp b/modules/apps/knowledge-base/knowledge-base-web/src/main/resources/META-INF/resources/admin/common/edit_article.jsp
index 8f731ea695b85..0728b59cf747d 100644
--- a/modules/apps/knowledge-base/knowledge-base-web/src/main/resources/META-INF/resources/admin/common/edit_article.jsp
+++ b/modules/apps/knowledge-base/knowledge-base-web/src/main/resources/META-INF/resources/admin/common/edit_article.jsp
@@ -221,7 +221,7 @@ if (portletTitleBasedNavigation) {
 							for (Map.Entry<String, String> entry : sectionsMap.entrySet()) {
 							%>
 
-								<aui:option label="<%= entry.getKey() %>" selected="<%= ArrayUtil.contains(sections, entry.getValue()) %>" value="<%= entry.getValue() %>" />
+								<aui:option label="<%= HtmlUtil.escape(entry.getKey()) %>" selected="<%= ArrayUtil.contains(sections, entry.getValue()) %>" value="<%= HtmlUtil.escape(entry.getValue()) %>" />
 
 							<%
 							}
diff --git a/modules/apps/knowledge-base/knowledge-base-web/src/main/resources/META-INF/resources/admin/common/history.jsp b/modules/apps/knowledge-base/knowledge-base-web/src/main/resources/META-INF/resources/admin/common/history.jsp
index 3e0e91f48bf17..469c8aa403a95 100644
--- a/modules/apps/knowledge-base/knowledge-base-web/src/main/resources/META-INF/resources/admin/common/history.jsp
+++ b/modules/apps/knowledge-base/knowledge-base-web/src/main/resources/META-INF/resources/admin/common/history.jsp
@@ -197,7 +197,7 @@ if (portletTitleBasedNavigation) {
 					<portlet:param name="resourcePrimKey" value="<%= String.valueOf(kbArticle.getResourcePrimKey()) %>" />
 				</portlet:renderURL>
 
-				var uri = '<%= compareVersionURL %>';
+				var uri = '<%= HtmlUtil.escapeJS(compareVersionURL) %>';
 
 				uri = Liferay.Util.addParams('<portlet:namespace />sourceVersion=' + rowIds.eq(1).val(), uri);
 				uri = Liferay.Util.addParams('<portlet:namespace />targetVersion=' + rowIds.eq(0).val(), uri);
diff --git a/modules/apps/knowledge-base/knowledge-base-web/src/main/resources/META-INF/resources/admin/common/move_object.jsp b/modules/apps/knowledge-base/knowledge-base-web/src/main/resources/META-INF/resources/admin/common/move_object.jsp
index 31f045dc5d21c..68ea4292cf74c 100644
--- a/modules/apps/knowledge-base/knowledge-base-web/src/main/resources/META-INF/resources/admin/common/move_object.jsp
+++ b/modules/apps/knowledge-base/knowledge-base-web/src/main/resources/META-INF/resources/admin/common/move_object.jsp
@@ -136,7 +136,7 @@ if (portletTitleBasedNavigation) {
 						<portlet:param name="targetStatus" value="<%= String.valueOf(targetStatus) %>" />
 					</liferay-portlet:renderURL>
 
-					uri: '<%= selectKBObjectURL %>'
+					uri: '<%= HtmlUtil.escapeJS(selectKBObjectURL) %>'
 				},
 				function(event) {
 					document.<portlet:namespace />fm.<portlet:namespace />parentPriority.value = event.priority;
diff --git a/modules/apps/knowledge-base/knowledge-base-web/src/main/resources/META-INF/resources/admin/common/select_parent.jsp b/modules/apps/knowledge-base/knowledge-base-web/src/main/resources/META-INF/resources/admin/common/select_parent.jsp
index 9a3bf60e244d7..e7612396cb4a2 100644
--- a/modules/apps/knowledge-base/knowledge-base-web/src/main/resources/META-INF/resources/admin/common/select_parent.jsp
+++ b/modules/apps/knowledge-base/knowledge-base-web/src/main/resources/META-INF/resources/admin/common/select_parent.jsp
@@ -120,8 +120,6 @@ else {
 
 						<%
 						KBFolder kbFolder = (KBFolder)kbObject;
-
-						kbFolder = kbFolder.toEscapedModel();
 						%>
 
 						<liferay-portlet:renderURL var="rowURL" windowState="<%= LiferayWindowState.POP_UP.toString() %>">
@@ -148,11 +146,11 @@ else {
 							<c:choose>
 								<c:when test="<%= Validator.isNotNull(rowURL) %>">
 									<aui:a href="<%= rowURL %>">
-										<%= kbFolder.getName() %>
+										<%= HtmlUtil.escape(kbFolder.getName()) %>
 									</aui:a>
 								</c:when>
 								<c:otherwise>
-									<%= kbFolder.getName() %>
+									<%= HtmlUtil.escape(kbFolder.getName()) %>
 								</c:otherwise>
 							</c:choose>
 						</liferay-ui:search-container-column-text>
@@ -194,8 +192,6 @@ else {
 
 						<%
 						KBArticle kbArticle = (KBArticle)kbObject;
-
-						kbArticle = kbArticle.toEscapedModel();
 						%>
 
 						<liferay-portlet:renderURL var="rowURL" windowState="<%= LiferayWindowState.POP_UP.toString() %>">
@@ -223,11 +219,11 @@ else {
 							<c:choose>
 								<c:when test="<%= Validator.isNotNull(rowURL) %>">
 									<aui:a href="<%= rowURL %>">
-										<%= kbArticle.getTitle() %>
+										<%= HtmlUtil.escape(kbArticle.getTitle()) %>
 									</aui:a>
 								</c:when>
 								<c:otherwise>
-									<%= kbArticle.getTitle() %>
+									<%= HtmlUtil.escape(kbArticle.getTitle()) %>
 								</c:otherwise>
 							</c:choose>
 						</liferay-ui:search-container-column-text>
diff --git a/modules/apps/knowledge-base/knowledge-base-web/src/main/resources/META-INF/resources/admin/common/view_suggestion.jsp b/modules/apps/knowledge-base/knowledge-base-web/src/main/resources/META-INF/resources/admin/common/view_suggestion.jsp
index c5d64efff4a22..07656979b61c2 100644
--- a/modules/apps/knowledge-base/knowledge-base-web/src/main/resources/META-INF/resources/admin/common/view_suggestion.jsp
+++ b/modules/apps/knowledge-base/knowledge-base-web/src/main/resources/META-INF/resources/admin/common/view_suggestion.jsp
@@ -47,7 +47,7 @@ renderResponse.setTitle(kbCommentTitle);
 				%>
 
 				<h5 class="text-default">
-					<liferay-ui:message arguments="<%= new String[] {kbComment.getUserName(), modifiedDateDescription} %>" key="x-suggested-x-ago" />
+					<liferay-ui:message arguments="<%= new String[] {HtmlUtil.escape(kbComment.getUserName()), modifiedDateDescription} %>" key="x-suggested-x-ago" />
 				</h5>
 
 				<h4>
diff --git a/modules/apps/knowledge-base/knowledge-base-web/src/main/resources/META-INF/resources/admin/common/view_suggestions_by_status.jsp b/modules/apps/knowledge-base/knowledge-base-web/src/main/resources/META-INF/resources/admin/common/view_suggestions_by_status.jsp
index 7c2fec0d05efb..bbcf7482e3afb 100644
--- a/modules/apps/knowledge-base/knowledge-base-web/src/main/resources/META-INF/resources/admin/common/view_suggestions_by_status.jsp
+++ b/modules/apps/knowledge-base/knowledge-base-web/src/main/resources/META-INF/resources/admin/common/view_suggestions_by_status.jsp
@@ -53,7 +53,7 @@ KBCommentResultRowSplitter resultRowSplitter = (KBCommentResultRowSplitter)reque
 				%>
 
 				<h5 class="text-default">
-					<liferay-ui:message arguments="<%= new String[] {kbComment.getUserName(), modifiedDateDescription} %>" key="x-suggested-x-ago" />
+					<liferay-ui:message arguments="<%= new String[] {HtmlUtil.escape(kbComment.getUserName()), modifiedDateDescription} %>" key="x-suggested-x-ago" />
 				</h5>
 
 				<h4>
diff --git a/modules/apps/knowledge-base/knowledge-base-web/src/main/resources/META-INF/resources/admin/import.jsp b/modules/apps/knowledge-base/knowledge-base-web/src/main/resources/META-INF/resources/admin/import.jsp
index 19f6000ddd24e..92a5ad52afaba 100644
--- a/modules/apps/knowledge-base/knowledge-base-web/src/main/resources/META-INF/resources/admin/import.jsp
+++ b/modules/apps/knowledge-base/knowledge-base-web/src/main/resources/META-INF/resources/admin/import.jsp
@@ -44,7 +44,7 @@ renderResponse.setTitle(LanguageUtil.get(resourceBundle, "import"));
 			KBArticleImportException kbaie = (KBArticleImportException)errorException;
 			%>
 
-			<%= LanguageUtil.format(request, "an-unexpected-error-occurred-while-importing-articles-x", kbaie.getLocalizedMessage()) %>
+			<%= LanguageUtil.format(request, "an-unexpected-error-occurred-while-importing-articles-x", HtmlUtil.escape(kbaie.getLocalizedMessage())) %>
 		</liferay-ui:error>
 
 		<liferay-ui:error exception="<%= UploadRequestSizeException.class %>">
@@ -56,7 +56,7 @@ renderResponse.setTitle(LanguageUtil.get(resourceBundle, "import"));
 				<aui:field-wrapper>
 					<div class="alert alert-info">
 						<liferay-ui:message
-							arguments="<%= StringUtil.merge(kbGroupServiceConfiguration.markdownImporterArticleExtensions(), StringPool.COMMA_AND_SPACE) %>"
+							arguments="<%= HtmlUtil.escape(StringUtil.merge(kbGroupServiceConfiguration.markdownImporterArticleExtensions(), StringPool.COMMA_AND_SPACE)) %>"
 							key="upload-your-zip-file-help"
 						/>
 					</div>
diff --git a/modules/apps/knowledge-base/knowledge-base-web/src/main/resources/META-INF/resources/admin/template_comment.jsp b/modules/apps/knowledge-base/knowledge-base-web/src/main/resources/META-INF/resources/admin/template_comment.jsp
index 83caedfc0c0cc..75bfff4487976 100644
--- a/modules/apps/knowledge-base/knowledge-base-web/src/main/resources/META-INF/resources/admin/template_comment.jsp
+++ b/modules/apps/knowledge-base/knowledge-base-web/src/main/resources/META-INF/resources/admin/template_comment.jsp
@@ -49,7 +49,7 @@ KBComment kbComment = (KBComment)request.getAttribute("template_comment.jsp-kb_c
 				<br />
 
 				<div>
-					<%= kbComment.getContent() %>
+					<%= HtmlUtil.escape(kbComment.getContent()) %>
 				</div>
 
 				<br />
diff --git a/modules/apps/knowledge-base/knowledge-base-web/src/main/resources/META-INF/resources/admin/view.jsp b/modules/apps/knowledge-base/knowledge-base-web/src/main/resources/META-INF/resources/admin/view.jsp
index 1af8713793ed7..29fa7b162d854 100644
--- a/modules/apps/knowledge-base/knowledge-base-web/src/main/resources/META-INF/resources/admin/view.jsp
+++ b/modules/apps/knowledge-base/knowledge-base-web/src/main/resources/META-INF/resources/admin/view.jsp
@@ -183,7 +183,7 @@ if (parentResourcePrimKey != KBFolderConstants.DEFAULT_PARENT_FOLDER_ID) {
 					<c:otherwise>
 						<div class="alert alert-warning">
 							<liferay-ui:message
-								arguments="<%= StringUtil.merge(kbGroupServiceConfiguration.markdownImporterArticleExtensions(), StringPool.COMMA_AND_SPACE) %>"
+								arguments="<%= HtmlUtil.escape(StringUtil.merge(kbGroupServiceConfiguration.markdownImporterArticleExtensions(), StringPool.COMMA_AND_SPACE)) %>"
 								key="nothing-was-imported-no-articles-were-found-with-one-of-the-supported-extensions-x"
 							/>
 						</div>
@@ -205,8 +205,6 @@ if (parentResourcePrimKey != KBFolderConstants.DEFAULT_PARENT_FOLDER_ID) {
 							<%
 							KBFolder kbFolder = (KBFolder)kbObject;
 
-							kbFolder = kbFolder.toEscapedModel();
-
 							Date modifiedDate = kbFolder.getModifiedDate();
 
 							String modifiedDateDescription = LanguageUtil.getTimeDescription(request, System.currentTimeMillis() - modifiedDate.getTime(), true);
@@ -228,12 +226,12 @@ if (parentResourcePrimKey != KBFolderConstants.DEFAULT_PARENT_FOLDER_ID) {
 
 							<liferay-ui:search-container-column-text colspan="<%= 2 %>">
 								<h5 class="text-default">
-									<liferay-ui:message arguments="<%= new String[] {kbFolder.getUserName(), modifiedDateDescription} %>" key="x-modified-x-ago" />
+									<liferay-ui:message arguments="<%= new String[] {HtmlUtil.escape(kbFolder.getUserName()), modifiedDateDescription} %>" key="x-modified-x-ago" />
 								</h5>
 
 								<h4>
 									<aui:a href="<%= rowURL.toString() %>">
-										<%= kbFolder.getName() %>
+										<%= HtmlUtil.escape(kbFolder.getName()) %>
 									</aui:a>
 								</h4>
 
@@ -256,8 +254,6 @@ if (parentResourcePrimKey != KBFolderConstants.DEFAULT_PARENT_FOLDER_ID) {
 							<%
 							KBArticle kbArticle = (KBArticle)kbObject;
 
-							kbArticle = kbArticle.toEscapedModel();
-
 							Date modifiedDate = kbArticle.getModifiedDate();
 
 							String modifiedDateDescription = LanguageUtil.getTimeDescription(request, System.currentTimeMillis() - modifiedDate.getTime(), true);
@@ -277,12 +273,12 @@ if (parentResourcePrimKey != KBFolderConstants.DEFAULT_PARENT_FOLDER_ID) {
 
 							<liferay-ui:search-container-column-text colspan="<%= 2 %>">
 								<h5 class="text-default">
-									<liferay-ui:message arguments="<%= new String[] {kbArticle.getUserName(), modifiedDateDescription} %>" key="x-modified-x-ago" />
+									<liferay-ui:message arguments="<%= new String[] {HtmlUtil.escape(kbArticle.getUserName()), modifiedDateDescription} %>" key="x-modified-x-ago" />
 								</h5>
 
 								<h4>
 									<aui:a href="<%= viewURL.toString() %>">
-										<%= kbArticle.getTitle() %>
+										<%= HtmlUtil.escape(kbArticle.getTitle()) %>
 									</aui:a>
 								</h4>
 
diff --git a/modules/apps/knowledge-base/knowledge-base-web/src/main/resources/META-INF/resources/admin/view_templates.jsp b/modules/apps/knowledge-base/knowledge-base-web/src/main/resources/META-INF/resources/admin/view_templates.jsp
index 63851a203411a..4b04efd255875 100644
--- a/modules/apps/knowledge-base/knowledge-base-web/src/main/resources/META-INF/resources/admin/view_templates.jsp
+++ b/modules/apps/knowledge-base/knowledge-base-web/src/main/resources/META-INF/resources/admin/view_templates.jsp
@@ -133,7 +133,6 @@ String keywords = ParamUtil.getString(request, "keywords");
 
 				<liferay-ui:search-container-row
 					className="com.liferay.knowledge.base.model.KBTemplate"
-					escapedModel="<%= true %>"
 					keyProperty="kbTemplateId"
 					modelVar="kbTemplate"
 				>
@@ -152,7 +151,7 @@ String keywords = ParamUtil.getString(request, "keywords");
 						%>
 
 						<h5 class="text-default">
-							<liferay-ui:message arguments="<%= new String[] {kbTemplate.getUserName(), modifiedDateDescription} %>" key="x-modified-x-ago" />
+							<liferay-ui:message arguments="<%= new String[] {HtmlUtil.escape(kbTemplate.getUserName()), modifiedDateDescription} %>" key="x-modified-x-ago" />
 						</h5>
 
 						<liferay-portlet:renderURL var="editURL">
@@ -163,7 +162,7 @@ String keywords = ParamUtil.getString(request, "keywords");
 
 						<h4>
 							<aui:a href="<%= editURL.toString() %>">
-								<%= kbTemplate.getTitle() %>
+								<%= HtmlUtil.escape(kbTemplate.getTitle()) %>
 							</aui:a>
 						</h4>
 					</liferay-ui:search-container-column-text>
diff --git a/modules/apps/knowledge-base/knowledge-base-web/src/main/resources/META-INF/resources/article/configuration.jsp b/modules/apps/knowledge-base/knowledge-base-web/src/main/resources/META-INF/resources/article/configuration.jsp
index 7339313c21e72..7adde5d2e3479 100644
--- a/modules/apps/knowledge-base/knowledge-base-web/src/main/resources/META-INF/resources/article/configuration.jsp
+++ b/modules/apps/knowledge-base/knowledge-base-web/src/main/resources/META-INF/resources/article/configuration.jsp
@@ -42,10 +42,10 @@ kbArticlePortletInstanceConfiguration = ParameterMapUtil.setParameterMap(KBArtic
 								<div class="form-group kb-field-wrapper">
 
 									<%
-									KBArticle kbArticle = KBArticleLocalServiceUtil.fetchLatestKBArticle(kbArticlePortletInstanceConfiguration.resourcePrimKey(), WorkflowConstants.STATUS_APPROVED);
+									KBArticle kbArticle = KBArticleServiceUtil.fetchLatestKBArticle(kbArticlePortletInstanceConfiguration.resourcePrimKey(), WorkflowConstants.STATUS_APPROVED);
 									%>
 
-									<aui:input label="article" name="configurationKBArticle" type="resource" value="<%= (kbArticle != null) ? HtmlUtil.escape(kbArticle.getTitle()) : StringPool.BLANK %>" />
+									<aui:input label="article" name="configurationKBArticle" type="resource" value="<%= (kbArticle != null) ? kbArticle.getTitle() : StringPool.BLANK %>" />
 
 									<aui:button name="selectKBArticleButton" value="select" />
 								</div>
@@ -120,7 +120,7 @@ kbArticlePortletInstanceConfiguration = ParameterMapUtil.setParameterMap(KBArtic
 							<portlet:param name="selectableClassNameIds" value="<%= String.valueOf(PortalUtil.getClassNameId(KBArticleConstants.getClassName())) %>" />
 						</liferay-portlet:renderURL>
 
-						uri: '<%= selectKBObjectURL %>'
+						uri: '<%= HtmlUtil.escapeJS(selectKBObjectURL) %>'
 					},
 					function(event) {
 						var kbArticleData = {
diff --git a/modules/apps/knowledge-base/knowledge-base-web/src/main/resources/META-INF/resources/article/view_article.jsp b/modules/apps/knowledge-base/knowledge-base-web/src/main/resources/META-INF/resources/article/view_article.jsp
index daabfa84572fd..a62ec37edce91 100644
--- a/modules/apps/knowledge-base/knowledge-base-web/src/main/resources/META-INF/resources/article/view_article.jsp
+++ b/modules/apps/knowledge-base/knowledge-base-web/src/main/resources/META-INF/resources/article/view_article.jsp
@@ -20,7 +20,7 @@
 
 <c:if test="<%= Objects.equals(portletDisplay.getId(), KBPortletKeys.KNOWLEDGE_BASE_ARTICLE_DEFAULT_INSTANCE) && PortletPermissionUtil.contains(permissionChecker, plid, portletDisplay.getId(), KBActionKeys.CONFIGURATION) %>">
 	<div class="alert alert-info portlet-configuration">
-		<aui:a href="<%= portletDisplay.getURLConfiguration() %>" label='<%= LanguageUtil.format(request, "portlet-configuration-page-x-instance-id-x", new String[] {layout.getName(locale), portletDisplay.getInstanceId()}, false) %>' onClick="<%= portletDisplay.getURLConfigurationJS() %>" />
+		<aui:a href="<%= portletDisplay.getURLConfiguration() %>" label='<%= LanguageUtil.format(request, "portlet-configuration-page-x-instance-id-x", new String[] {HtmlUtil.escape(layout.getName(locale)), portletDisplay.getInstanceId()}, false) %>' onClick="<%= portletDisplay.getURLConfigurationJS() %>" />
 	</div>
 </c:if>
 
diff --git a/modules/apps/knowledge-base/knowledge-base-web/src/main/resources/META-INF/resources/display/configuration.jsp b/modules/apps/knowledge-base/knowledge-base-web/src/main/resources/META-INF/resources/display/configuration.jsp
index f3e473a47e18e..6c0b566537cd9 100644
--- a/modules/apps/knowledge-base/knowledge-base-web/src/main/resources/META-INF/resources/display/configuration.jsp
+++ b/modules/apps/knowledge-base/knowledge-base-web/src/main/resources/META-INF/resources/display/configuration.jsp
@@ -56,7 +56,7 @@ kbDisplayPortletInstanceConfiguration = ParameterMapUtil.setParameterMap(KBDispl
 										String title = StringPool.BLANK;
 
 										if (resourceClassNameId != kbFolderClassNameId) {
-											KBArticle kbArticle = KBArticleLocalServiceUtil.fetchLatestKBArticle(kbDisplayPortletInstanceConfiguration.resourcePrimKey(), WorkflowConstants.STATUS_APPROVED);
+											KBArticle kbArticle = KBArticleServiceUtil.fetchLatestKBArticle(kbDisplayPortletInstanceConfiguration.resourcePrimKey(), WorkflowConstants.STATUS_APPROVED);
 
 											if (kbArticle != null) {
 												title = kbArticle.getTitle();
@@ -66,7 +66,7 @@ kbDisplayPortletInstanceConfiguration = ParameterMapUtil.setParameterMap(KBDispl
 											title = LanguageUtil.get(resourceBundle, "home");
 										}
 										else {
-											KBFolder kbFolder = KBFolderLocalServiceUtil.fetchKBFolder(kbDisplayPortletInstanceConfiguration.resourcePrimKey());
+											KBFolder kbFolder = KBFolderServiceUtil.fetchKBFolder(kbDisplayPortletInstanceConfiguration.resourcePrimKey());
 
 											if (kbFolder != null) {
 												title = kbFolder.getName();
@@ -153,7 +153,7 @@ kbDisplayPortletInstanceConfiguration = ParameterMapUtil.setParameterMap(KBDispl
 							<portlet:param name="eventName" value='<%= liferayPortletResponse.getNamespace() + "selectKBObject" %>' />
 						</liferay-portlet:renderURL>
 
-						uri: '<%= selectKBObjectURL %>'
+						uri: '<%= HtmlUtil.escapeJS(selectKBObjectURL) %>'
 					},
 					function(event) {
 						document.<portlet:namespace />fm.<portlet:namespace />resourceClassNameId.value = event.resourceclassnameid;
diff --git a/modules/apps/knowledge-base/knowledge-base-web/src/main/resources/META-INF/resources/display/content_root_selector.jsp b/modules/apps/knowledge-base/knowledge-base-web/src/main/resources/META-INF/resources/display/content_root_selector.jsp
index 637cfb5280713..dc4fbc0b98ef7 100644
--- a/modules/apps/knowledge-base/knowledge-base-web/src/main/resources/META-INF/resources/display/content_root_selector.jsp
+++ b/modules/apps/knowledge-base/knowledge-base-web/src/main/resources/META-INF/resources/display/content_root_selector.jsp
@@ -45,7 +45,7 @@ List<KBFolder> kbFolders = KBUtil.getAlternateRootKBFolders(scopeGroupId, kbDisp
 						selected="<%= currentKBFolderURLTitle.equals(kbFolder.getUrlTitle()) %>"
 						value="<%= kbFolder.getKbFolderId() %>"
 					>
-						<%= kbDisplayPortletInstanceConfiguration.contentRootPrefix() + " " + kbFolder.getName() %>
+						<%= HtmlUtil.escape(kbDisplayPortletInstanceConfiguration.contentRootPrefix() + " " + kbFolder.getName()) %>
 					</aui:option>
 
 				<%
diff --git a/modules/apps/knowledge-base/knowledge-base-web/src/main/resources/META-INF/resources/display/view_article.jsp b/modules/apps/knowledge-base/knowledge-base-web/src/main/resources/META-INF/resources/display/view_article.jsp
index a5457d50feb8b..61dc5593ad495 100644
--- a/modules/apps/knowledge-base/knowledge-base-web/src/main/resources/META-INF/resources/display/view_article.jsp
+++ b/modules/apps/knowledge-base/knowledge-base-web/src/main/resources/META-INF/resources/display/view_article.jsp
@@ -25,7 +25,7 @@ String[] searchKeywords = (String[])renderRequest.getAttribute(KBWebKeys.KNOWLED
 
 <c:if test="<%= Objects.equals(portletDisplay.getId(), KBPortletKeys.KNOWLEDGE_BASE_ARTICLE_DEFAULT_INSTANCE) && PortletPermissionUtil.contains(permissionChecker, plid, portletDisplay.getId(), KBActionKeys.CONFIGURATION) %>">
 	<div class="alert alert-info portlet-configuration">
-		<aui:a href="<%= portletDisplay.getURLConfiguration() %>" label='<%= LanguageUtil.format(request, "portlet-configuration-page-x-instance-id-x", new String[] {layout.getName(locale), portletDisplay.getInstanceId()}, false) %>' onClick="<%= portletDisplay.getURLConfigurationJS() %>" />
+		<aui:a href="<%= portletDisplay.getURLConfiguration() %>" label='<%= LanguageUtil.format(request, "portlet-configuration-page-x-instance-id-x", new String[] {HtmlUtil.escape(layout.getName(locale)), portletDisplay.getInstanceId()}, false) %>' onClick="<%= portletDisplay.getURLConfigurationJS() %>" />
 	</div>
 </c:if>
 
diff --git a/modules/apps/knowledge-base/knowledge-base-web/src/main/resources/META-INF/resources/init.jsp b/modules/apps/knowledge-base/knowledge-base-web/src/main/resources/META-INF/resources/init.jsp
index f9d66bffe984f..376aa046480cc 100644
--- a/modules/apps/knowledge-base/knowledge-base-web/src/main/resources/META-INF/resources/init.jsp
+++ b/modules/apps/knowledge-base/knowledge-base-web/src/main/resources/META-INF/resources/init.jsp
@@ -208,7 +208,7 @@ page import="javax.portlet.WindowState" %>
 <portlet:defineObjects />
 
 <%
-String redirect = ParamUtil.getString(request, "redirect", currentURL);
+String redirect = PortalUtil.escapeRedirect(ParamUtil.getString(request, "redirect", currentURL));
 
 String rootPortletId = portletDisplay.getRootPortletId();
 
diff --git a/modules/apps/knowledge-base/knowledge-base-web/src/main/resources/META-INF/resources/search/view_prp_articles.jsp b/modules/apps/knowledge-base/knowledge-base-web/src/main/resources/META-INF/resources/search/view_prp_articles.jsp
index 0427c622d5e7e..263c831c83a1b 100644
--- a/modules/apps/knowledge-base/knowledge-base-web/src/main/resources/META-INF/resources/search/view_prp_articles.jsp
+++ b/modules/apps/knowledge-base/knowledge-base-web/src/main/resources/META-INF/resources/search/view_prp_articles.jsp
@@ -129,31 +129,27 @@ String orderByType = ParamUtil.getString(request, "orderByType", "desc");
 					<%
 					AssetCategory assetCategory = AssetCategoryLocalServiceUtil.getAssetCategory(assetCategoryId);
 
-					assetCategory = assetCategory.toEscapedModel();
-
 					AssetVocabulary assetVocabulary = AssetVocabularyLocalServiceUtil.getAssetVocabulary(assetCategory.getVocabularyId());
-
-					assetVocabulary = assetVocabulary.toEscapedModel();
 					%>
 
 					<c:choose>
 						<c:when test="<%= Validator.isNotNull(assetTagName) %>">
 							<c:choose>
 								<c:when test="<%= total > 0 %>">
-									<%= LanguageUtil.format(request, "articles-with-x-x-and-tag-x", new String[] {assetVocabulary.getTitle(locale), assetCategory.getTitle(locale), assetTagName}, false) %>
+									<%= LanguageUtil.format(request, "articles-with-x-x-and-tag-x", new String[] {HtmlUtil.escape(assetVocabulary.getTitle(locale)), HtmlUtil.escape(assetCategory.getTitle(locale)), HtmlUtil.escape(assetTagName)}, false) %>
 								</c:when>
 								<c:otherwise>
-									<%= LanguageUtil.format(request, "there-are-no-articles-with-x-x-and-tag-x", new String[] {assetVocabulary.getTitle(locale), assetCategory.getTitle(locale), assetTagName}, false) %>
+									<%= LanguageUtil.format(request, "there-are-no-articles-with-x-x-and-tag-x", new String[] {HtmlUtil.escape(assetVocabulary.getTitle(locale)), HtmlUtil.escape(assetCategory.getTitle(locale)), HtmlUtil.escape(assetTagName)}, false) %>
 								</c:otherwise>
 							</c:choose>
 						</c:when>
 						<c:otherwise>
 							<c:choose>
 								<c:when test="<%= total > 0 %>">
-									<%= LanguageUtil.format(request, "articles-with-x-x", new String[] {assetVocabulary.getTitle(locale), assetCategory.getTitle(locale)}, false) %>
+									<%= LanguageUtil.format(request, "articles-with-x-x", new String[] {HtmlUtil.escape(assetVocabulary.getTitle(locale)), HtmlUtil.escape(assetCategory.getTitle(locale))}, false) %>
 								</c:when>
 								<c:otherwise>
-									<%= LanguageUtil.format(request, "there-are-no-articles-with-x-x", new String[] {assetVocabulary.getTitle(locale), assetCategory.getTitle(locale)}, false) %>
+									<%= LanguageUtil.format(request, "there-are-no-articles-with-x-x", new String[] {HtmlUtil.escape(assetVocabulary.getTitle(locale)), HtmlUtil.escape(assetCategory.getTitle(locale))}, false) %>
 								</c:otherwise>
 							</c:choose>
 						</c:otherwise>
@@ -162,10 +158,10 @@ String orderByType = ParamUtil.getString(request, "orderByType", "desc");
 				<c:otherwise>
 					<c:choose>
 						<c:when test="<%= total > 0 %>">
-							<%= LanguageUtil.format(request, "articles-with-tag-x", assetTagName, false) %>
+							<%= LanguageUtil.format(request, "articles-with-tag-x", HtmlUtil.escape(assetTagName), false) %>
 						</c:when>
 						<c:otherwise>
-							<%= LanguageUtil.format(request, "there-are-no-articles-with-tag-x", assetTagName, false) %>
+							<%= LanguageUtil.format(request, "there-are-no-articles-with-tag-x", HtmlUtil.escape(assetTagName), false) %>
 						</c:otherwise>
 					</c:choose>
 				</c:otherwise>
diff --git a/modules/apps/knowledge-base/knowledge-base-web/src/main/resources/META-INF/resources/section/configuration.jsp b/modules/apps/knowledge-base/knowledge-base-web/src/main/resources/META-INF/resources/section/configuration.jsp
index 08eaca228f085..5f9403167a678 100644
--- a/modules/apps/knowledge-base/knowledge-base-web/src/main/resources/META-INF/resources/section/configuration.jsp
+++ b/modules/apps/knowledge-base/knowledge-base-web/src/main/resources/META-INF/resources/section/configuration.jsp
@@ -51,7 +51,7 @@ kbSectionPortletInstanceConfiguration = ParameterMapUtil.setParameterMap(KBSecti
 								for (Map.Entry<String, String> entry : sectionsMap.entrySet()) {
 								%>
 
-									<aui:option label="<%= entry.getKey() %>" selected="<%= ArrayUtil.contains(kbSectionPortletInstanceConfiguration.kbArticlesSections(), entry.getValue()) %>" value="<%= entry.getValue() %>" />
+									<aui:option label="<%= HtmlUtil.escape(entry.getKey()) %>" selected="<%= ArrayUtil.contains(kbSectionPortletInstanceConfiguration.kbArticlesSections(), entry.getValue()) %>" value="<%= HtmlUtil.escape(entry.getValue()) %>" />
 
 								<%
 								}
diff --git a/modules/apps/knowledge-base/knowledge-base-web/src/main/resources/META-INF/resources/section/view.jsp b/modules/apps/knowledge-base/knowledge-base-web/src/main/resources/META-INF/resources/section/view.jsp
index 8e7d562080b2a..5007e3bdbde7c 100644
--- a/modules/apps/knowledge-base/knowledge-base-web/src/main/resources/META-INF/resources/section/view.jsp
+++ b/modules/apps/knowledge-base/knowledge-base-web/src/main/resources/META-INF/resources/section/view.jsp
@@ -50,7 +50,7 @@ String kbArticleDisplayStyle = kbSectionPortletInstanceConfiguration.kbArticleDi
 				%>
 
 				<div class="kb-articles-sections-title">
-					<%= StringUtil.merge(titles, StringPool.COMMA_AND_SPACE) %>
+					<%= HtmlUtil.escape(StringUtil.merge(titles, StringPool.COMMA_AND_SPACE)) %>
 				</div>
 			</c:if>
 
@@ -84,7 +84,7 @@ String kbArticleDisplayStyle = kbSectionPortletInstanceConfiguration.kbArticleDi
 						<div class="kb-article-content">
 							<c:choose>
 								<c:when test='<%= kbArticleDisplayStyle.equals("abstract") && Validator.isNotNull(kbArticle.getDescription()) %>'>
-									<%= kbArticle.getDescription() %>
+									<%= HtmlUtil.escape(kbArticle.getDescription()) %>
 								</c:when>
 								<c:when test='<%= kbArticleDisplayStyle.equals("abstract") %>'>
 									<%= StringUtil.shorten(HtmlUtil.extractText(kbArticle.getContent()), 500) %>
diff --git a/util-taglib/src/com/liferay/taglib/ui/HeaderTag.java b/util-taglib/src/com/liferay/taglib/ui/HeaderTag.java
index 3613e1760a6de..88805dda9971e 100644
--- a/util-taglib/src/com/liferay/taglib/ui/HeaderTag.java
+++ b/util-taglib/src/com/liferay/taglib/ui/HeaderTag.java
@@ -15,6 +15,7 @@
 package com.liferay.taglib.ui;
 
 import com.liferay.portal.kernel.util.ParamUtil;
+import com.liferay.portal.kernel.util.PortalUtil;
 import com.liferay.portal.kernel.util.Validator;
 import com.liferay.taglib.util.IncludeTag;
 
@@ -78,7 +79,8 @@ protected boolean isCleanUpSetAttributes() {
 	protected void setAttributes(HttpServletRequest request) {
 		request.setAttribute("liferay-ui:header:backLabel", _backLabel);
 
-		String redirect = ParamUtil.getString(request, "redirect");
+		String redirect = PortalUtil.escapeRedirect(
+			ParamUtil.getString(request, "redirect"));
 
 		if (Validator.isNull(_backURL) && Validator.isNotNull(redirect)) {
 			request.setAttribute("liferay-ui:header:backURL", redirect);

From ef93d984be9d4d478a5c4b1ca9a86f4e80174774 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Tom=C3=A1=C5=A1=20Pole=C5=A1ovsk=C3=BD?=
 <tomas.polesovsky@liferay.com>
Date: Tue, 9 May 2017 14:25:18 +0200
Subject: [PATCH 4/4] LPS-72090 Sanitize content to prevent XSS

---
 .../impl/KBArticlePersistenceImpl.java        | 31 +++++++++++++++++++
 .../impl/KBTemplatePersistenceImpl.java       | 31 +++++++++++++++++++
 .../META-INF/portlet-model-hints.xml          |  2 ++
 3 files changed, 64 insertions(+)

diff --git a/modules/apps/knowledge-base/knowledge-base-service/src/main/java/com/liferay/knowledge/base/service/persistence/impl/KBArticlePersistenceImpl.java b/modules/apps/knowledge-base/knowledge-base-service/src/main/java/com/liferay/knowledge/base/service/persistence/impl/KBArticlePersistenceImpl.java
index 82cdbfcfdd353..b5f28b88aaba3 100644
--- a/modules/apps/knowledge-base/knowledge-base-service/src/main/java/com/liferay/knowledge/base/service/persistence/impl/KBArticlePersistenceImpl.java
+++ b/modules/apps/knowledge-base/knowledge-base-service/src/main/java/com/liferay/knowledge/base/service/persistence/impl/KBArticlePersistenceImpl.java
@@ -30,8 +30,13 @@
 import com.liferay.portal.kernel.dao.orm.QueryUtil;
 import com.liferay.portal.kernel.dao.orm.SQLQuery;
 import com.liferay.portal.kernel.dao.orm.Session;
+import com.liferay.portal.kernel.exception.SystemException;
 import com.liferay.portal.kernel.log.Log;
 import com.liferay.portal.kernel.log.LogFactoryUtil;
+import com.liferay.portal.kernel.sanitizer.Sanitizer;
+import com.liferay.portal.kernel.sanitizer.SanitizerException;
+import com.liferay.portal.kernel.sanitizer.SanitizerUtil;
+import com.liferay.portal.kernel.security.auth.PrincipalThreadLocal;
 import com.liferay.portal.kernel.security.permission.InlineSQLHelperUtil;
 import com.liferay.portal.kernel.service.ServiceContext;
 import com.liferay.portal.kernel.service.ServiceContextThreadLocal;
@@ -40,6 +45,8 @@
 import com.liferay.portal.kernel.service.persistence.impl.BasePersistenceImpl;
 import com.liferay.portal.kernel.util.ArrayUtil;
 import com.liferay.portal.kernel.util.CharPool;
+import com.liferay.portal.kernel.util.ContentTypes;
+import com.liferay.portal.kernel.util.GetterUtil;
 import com.liferay.portal.kernel.util.OrderByComparator;
 import com.liferay.portal.kernel.util.ReflectionUtil;
 import com.liferay.portal.kernel.util.SetUtil;
@@ -32159,6 +32166,30 @@ public KBArticle updateImpl(KBArticle kbArticle) {
 			}
 		}
 
+		long userId = GetterUtil.getLong(PrincipalThreadLocal.getName());
+
+		if (userId > 0) {
+			long companyId = kbArticle.getCompanyId();
+
+			long groupId = kbArticle.getGroupId();
+
+			long kbArticleId = 0;
+
+			if (!isNew) {
+				kbArticleId = kbArticle.getPrimaryKey();
+			}
+
+			try {
+				kbArticle.setContent(SanitizerUtil.sanitize(companyId, groupId,
+						userId, KBArticle.class.getName(), kbArticleId,
+						ContentTypes.TEXT_HTML, Sanitizer.MODE_ALL,
+						kbArticle.getContent(), null));
+			}
+			catch (SanitizerException se) {
+				throw new SystemException(se);
+			}
+		}
+
 		Session session = null;
 
 		try {
diff --git a/modules/apps/knowledge-base/knowledge-base-service/src/main/java/com/liferay/knowledge/base/service/persistence/impl/KBTemplatePersistenceImpl.java b/modules/apps/knowledge-base/knowledge-base-service/src/main/java/com/liferay/knowledge/base/service/persistence/impl/KBTemplatePersistenceImpl.java
index 9c0f0fbc264cc..37310aac37e78 100644
--- a/modules/apps/knowledge-base/knowledge-base-service/src/main/java/com/liferay/knowledge/base/service/persistence/impl/KBTemplatePersistenceImpl.java
+++ b/modules/apps/knowledge-base/knowledge-base-service/src/main/java/com/liferay/knowledge/base/service/persistence/impl/KBTemplatePersistenceImpl.java
@@ -30,14 +30,21 @@
 import com.liferay.portal.kernel.dao.orm.QueryUtil;
 import com.liferay.portal.kernel.dao.orm.SQLQuery;
 import com.liferay.portal.kernel.dao.orm.Session;
+import com.liferay.portal.kernel.exception.SystemException;
 import com.liferay.portal.kernel.log.Log;
 import com.liferay.portal.kernel.log.LogFactoryUtil;
+import com.liferay.portal.kernel.sanitizer.Sanitizer;
+import com.liferay.portal.kernel.sanitizer.SanitizerException;
+import com.liferay.portal.kernel.sanitizer.SanitizerUtil;
+import com.liferay.portal.kernel.security.auth.PrincipalThreadLocal;
 import com.liferay.portal.kernel.security.permission.InlineSQLHelperUtil;
 import com.liferay.portal.kernel.service.ServiceContext;
 import com.liferay.portal.kernel.service.ServiceContextThreadLocal;
 import com.liferay.portal.kernel.service.persistence.CompanyProvider;
 import com.liferay.portal.kernel.service.persistence.CompanyProviderWrapper;
 import com.liferay.portal.kernel.service.persistence.impl.BasePersistenceImpl;
+import com.liferay.portal.kernel.util.ContentTypes;
+import com.liferay.portal.kernel.util.GetterUtil;
 import com.liferay.portal.kernel.util.OrderByComparator;
 import com.liferay.portal.kernel.util.ReflectionUtil;
 import com.liferay.portal.kernel.util.SetUtil;
@@ -2620,6 +2627,30 @@ public KBTemplate updateImpl(KBTemplate kbTemplate) {
 			}
 		}
 
+		long userId = GetterUtil.getLong(PrincipalThreadLocal.getName());
+
+		if (userId > 0) {
+			long companyId = kbTemplate.getCompanyId();
+
+			long groupId = kbTemplate.getGroupId();
+
+			long kbTemplateId = 0;
+
+			if (!isNew) {
+				kbTemplateId = kbTemplate.getPrimaryKey();
+			}
+
+			try {
+				kbTemplate.setContent(SanitizerUtil.sanitize(companyId,
+						groupId, userId, KBTemplate.class.getName(),
+						kbTemplateId, ContentTypes.TEXT_HTML,
+						Sanitizer.MODE_ALL, kbTemplate.getContent(), null));
+			}
+			catch (SanitizerException se) {
+				throw new SystemException(se);
+			}
+		}
+
 		Session session = null;
 
 		try {
diff --git a/modules/apps/knowledge-base/knowledge-base-service/src/main/resources/META-INF/portlet-model-hints.xml b/modules/apps/knowledge-base/knowledge-base-service/src/main/resources/META-INF/portlet-model-hints.xml
index 03e3ad4508165..08970f504aa6e 100644
--- a/modules/apps/knowledge-base/knowledge-base-service/src/main/resources/META-INF/portlet-model-hints.xml
+++ b/modules/apps/knowledge-base/knowledge-base-service/src/main/resources/META-INF/portlet-model-hints.xml
@@ -22,6 +22,7 @@
 		<field name="urlTitle" type="String" />
 		<field name="content" type="String">
 			<hint-collection name="CLOB" />
+			<sanitize content-type="text/html" modes="ALL" />
 		</field>
 		<field name="description" type="String">
 			<hint-collection name="TEXTAREA" />
@@ -93,6 +94,7 @@
 		</field>
 		<field name="content" type="String">
 			<hint-collection name="CLOB" />
+			<sanitize content-type="text/html" modes="ALL" />
 		</field>
 		<field name="lastPublishDate" type="Date" />
 	</model>