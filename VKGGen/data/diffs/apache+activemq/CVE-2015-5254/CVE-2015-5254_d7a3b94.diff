From d7a3b9406b8496c3f1508bebf3c7ff5367374b90 Mon Sep 17 00:00:00 2001
From: gtully <gary.tully@gmail.com>
Date: Tue, 17 Nov 2015 14:27:38 +0000
Subject: [PATCH] https://issues.apache.org/jira/browse/AMQ-6029 - make certs
 available to tunnle servlet - HttpsNeedClientAuthSendAndReceiveTest
 regression, add javax.security so login exceptions can propogate over http -
 https://issues.apache.org/jira/browse/AMQ-6013

---
 .../activemq/util/ClassLoadingAwareObjectInputStream.java     | 2 +-
 .../org/apache/activemq/transport/http/HttpTunnelServlet.java | 4 ++++
 2 files changed, 5 insertions(+), 1 deletion(-)

diff --git a/activemq-client/src/main/java/org/apache/activemq/util/ClassLoadingAwareObjectInputStream.java b/activemq-client/src/main/java/org/apache/activemq/util/ClassLoadingAwareObjectInputStream.java
index 645a47dd0c..d3e3110448 100644
--- a/activemq-client/src/main/java/org/apache/activemq/util/ClassLoadingAwareObjectInputStream.java
+++ b/activemq-client/src/main/java/org/apache/activemq/util/ClassLoadingAwareObjectInputStream.java
@@ -40,7 +40,7 @@
 
     static {
         serializablePackages = System.getProperty("org.apache.activemq.SERIALIZABLE_PACKAGES",
-                    "java.lang,java.util,org.apache.activemq,org.fusesource.hawtbuf,com.thoughtworks.xstream.mapper").split(",");
+                    "java.lang,javax.security,java.util,org.apache.activemq,org.fusesource.hawtbuf,com.thoughtworks.xstream.mapper").split(",");
     }
 
     public ClassLoadingAwareObjectInputStream(InputStream in) throws IOException {
diff --git a/activemq-http/src/main/java/org/apache/activemq/transport/http/HttpTunnelServlet.java b/activemq-http/src/main/java/org/apache/activemq/transport/http/HttpTunnelServlet.java
index 87cfc4295b..e6dc7c9d0e 100755
--- a/activemq-http/src/main/java/org/apache/activemq/transport/http/HttpTunnelServlet.java
+++ b/activemq-http/src/main/java/org/apache/activemq/transport/http/HttpTunnelServlet.java
@@ -34,6 +34,7 @@
 
 import org.apache.activemq.Service;
 import org.apache.activemq.command.Command;
+import org.apache.activemq.command.ConnectionInfo;
 import org.apache.activemq.command.WireFormatInfo;
 import org.apache.activemq.transport.Transport;
 import org.apache.activemq.transport.TransportAcceptListener;
@@ -140,6 +141,9 @@ protected void doPost(HttpServletRequest request, HttpServletResponse response)
                 return;
             }
 
+            if (command instanceof ConnectionInfo) {
+                ((ConnectionInfo) command).setTransportContext(request.getAttribute("javax.servlet.request.X509Certificate"));
+            }
             transport.doConsume(command);
         }
     }
