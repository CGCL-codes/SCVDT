From a3ea7f8522934794945587db9c305cf8d8d960ee Mon Sep 17 00:00:00 2001
From: Patrick Rhomberg <prhomberg@pivotal.io>
Date: Mon, 8 Jan 2018 15:44:32 -0800
Subject: [PATCH 1/2] GEODE-3974: Improve permissions for geode-lucene
 functions

---
 .../functions/LuceneCreateIndexFunction.java  |  14 +-
 .../LuceneDescribeIndexFunction.java          |  13 +
 .../functions/LuceneDestroyIndexFunction.java |  16 +-
 .../functions/LuceneListIndexFunction.java    |  12 +
 .../functions/LuceneSearchIndexFunction.java  |  12 +-
 .../directory/DumpDirectoryFiles.java         |  13 +
 .../distributed/LuceneQueryFunction.java      |   1 -
 .../distributed/WaitUntilFlushedFunction.java |   1 -
 .../results/LuceneGetPageFunction.java        |   1 -
 .../test/LuceneFunctionSecurityTest.java      | 494 ++++++++++++++++++
 10 files changed, 569 insertions(+), 8 deletions(-)
 create mode 100644 geode-lucene/src/test/java/org/apache/geode/cache/lucene/test/LuceneFunctionSecurityTest.java

diff --git a/geode-lucene/src/main/java/org/apache/geode/cache/lucene/internal/cli/functions/LuceneCreateIndexFunction.java b/geode-lucene/src/main/java/org/apache/geode/cache/lucene/internal/cli/functions/LuceneCreateIndexFunction.java
index b1b974d1b4c..df8bf303d33 100644
--- a/geode-lucene/src/main/java/org/apache/geode/cache/lucene/internal/cli/functions/LuceneCreateIndexFunction.java
+++ b/geode-lucene/src/main/java/org/apache/geode/cache/lucene/internal/cli/functions/LuceneCreateIndexFunction.java
@@ -18,6 +18,9 @@
 import static org.apache.geode.cache.lucene.internal.LuceneServiceImpl.validateCommandParameters.INDEX_NAME;
 import static org.apache.geode.cache.lucene.internal.LuceneServiceImpl.validateCommandParameters.REGION_PATH;
 
+import java.util.Collection;
+import java.util.Collections;
+
 import org.apache.commons.lang.StringUtils;
 import org.apache.lucene.analysis.Analyzer;
 import org.apache.lucene.analysis.standard.StandardAnalyzer;
@@ -33,11 +36,15 @@
 import org.apache.geode.cache.lucene.internal.cli.LuceneCliStrings;
 import org.apache.geode.cache.lucene.internal.cli.LuceneIndexDetails;
 import org.apache.geode.cache.lucene.internal.cli.LuceneIndexInfo;
+import org.apache.geode.cache.lucene.internal.security.LucenePermission;
 import org.apache.geode.internal.InternalEntity;
 import org.apache.geode.management.internal.cli.CliUtil;
 import org.apache.geode.management.internal.cli.functions.CliFunctionResult;
 import org.apache.geode.management.internal.cli.i18n.CliStrings;
 import org.apache.geode.management.internal.configuration.domain.XmlEntity;
+import org.apache.geode.security.ResourcePermission;
+import org.apache.geode.security.ResourcePermission.Operation;
+import org.apache.geode.security.ResourcePermission.Resource;
 
 
 /**
@@ -110,6 +117,12 @@ public void execute(final FunctionContext context) {
     }
   }
 
+  @Override
+  public Collection<ResourcePermission> getRequiredPermissions(String regionName) {
+    return Collections.singleton(
+        new ResourcePermission(Resource.CLUSTER, Operation.MANAGE, LucenePermission.TARGET));
+  }
+
   private LuceneSerializer toSerializer(String serializerName)
       throws InstantiationException, IllegalAccessException, ClassNotFoundException {
     String trimmedName = StringUtils.trim(serializerName);
@@ -136,5 +149,4 @@ private Analyzer toAnalyzer(String className) {
         CliUtil.forName(className, LuceneCliStrings.LUCENE_CREATE_INDEX__ANALYZER);
     return CliUtil.newInstance(clazz, LuceneCliStrings.LUCENE_CREATE_INDEX__ANALYZER);
   }
-
 }
diff --git a/geode-lucene/src/main/java/org/apache/geode/cache/lucene/internal/cli/functions/LuceneDescribeIndexFunction.java b/geode-lucene/src/main/java/org/apache/geode/cache/lucene/internal/cli/functions/LuceneDescribeIndexFunction.java
index dd90116856f..8f9bac37ed9 100755
--- a/geode-lucene/src/main/java/org/apache/geode/cache/lucene/internal/cli/functions/LuceneDescribeIndexFunction.java
+++ b/geode-lucene/src/main/java/org/apache/geode/cache/lucene/internal/cli/functions/LuceneDescribeIndexFunction.java
@@ -15,6 +15,9 @@
 
 package org.apache.geode.cache.lucene.internal.cli.functions;
 
+import java.util.Collection;
+import java.util.Collections;
+
 import org.apache.geode.cache.Cache;
 import org.apache.geode.cache.execute.Function;
 import org.apache.geode.cache.execute.FunctionContext;
@@ -25,7 +28,11 @@
 import org.apache.geode.cache.lucene.internal.LuceneServiceImpl;
 import org.apache.geode.cache.lucene.internal.cli.LuceneIndexDetails;
 import org.apache.geode.cache.lucene.internal.cli.LuceneIndexInfo;
+import org.apache.geode.cache.lucene.internal.security.LucenePermission;
 import org.apache.geode.internal.InternalEntity;
+import org.apache.geode.security.ResourcePermission;
+import org.apache.geode.security.ResourcePermission.Operation;
+import org.apache.geode.security.ResourcePermission.Resource;
 
 /**
  * The LuceneDescribeIndexFunction class is a function used to collect the information on a
@@ -66,4 +73,10 @@ public void execute(final FunctionContext context) {
     }
     context.getResultSender().lastResult(result);
   }
+
+  @Override
+  public Collection<ResourcePermission> getRequiredPermissions(String regionName) {
+    return Collections.singleton(
+        new ResourcePermission(Resource.CLUSTER, Operation.READ, LucenePermission.TARGET));
+  }
 }
diff --git a/geode-lucene/src/main/java/org/apache/geode/cache/lucene/internal/cli/functions/LuceneDestroyIndexFunction.java b/geode-lucene/src/main/java/org/apache/geode/cache/lucene/internal/cli/functions/LuceneDestroyIndexFunction.java
index 9803192e3fd..1a12894fdac 100644
--- a/geode-lucene/src/main/java/org/apache/geode/cache/lucene/internal/cli/functions/LuceneDestroyIndexFunction.java
+++ b/geode-lucene/src/main/java/org/apache/geode/cache/lucene/internal/cli/functions/LuceneDestroyIndexFunction.java
@@ -14,6 +14,9 @@
  */
 package org.apache.geode.cache.lucene.internal.cli.functions;
 
+import java.util.Collection;
+import java.util.Collections;
+
 import org.apache.commons.lang.StringUtils;
 
 import org.apache.geode.cache.execute.Function;
@@ -22,16 +25,19 @@
 import org.apache.geode.cache.lucene.LuceneServiceProvider;
 import org.apache.geode.cache.lucene.internal.LuceneServiceImpl;
 import org.apache.geode.cache.lucene.internal.cli.LuceneDestroyIndexInfo;
+import org.apache.geode.cache.lucene.internal.security.LucenePermission;
 import org.apache.geode.cache.lucene.internal.xml.LuceneXmlConstants;
 import org.apache.geode.internal.InternalEntity;
 import org.apache.geode.internal.cache.xmlcache.CacheXml;
 import org.apache.geode.management.internal.cli.functions.CliFunctionResult;
 import org.apache.geode.management.internal.configuration.domain.XmlEntity;
+import org.apache.geode.security.ResourcePermission;
+import org.apache.geode.security.ResourcePermission.Operation;
+import org.apache.geode.security.ResourcePermission.Resource;
 
 public class LuceneDestroyIndexFunction implements Function, InternalEntity {
-
   public void execute(final FunctionContext context) {
-    CliFunctionResult result = null;
+    CliFunctionResult result;
     String memberId = context.getCache().getDistributedSystem().getDistributedMember().getId();
     try {
       LuceneDestroyIndexInfo indexInfo = (LuceneDestroyIndexInfo) context.getArguments();
@@ -66,4 +72,10 @@ protected XmlEntity getXmlEntity(String indexName, String regionPath) {
     return new XmlEntity(CacheXml.REGION, "name", regionName, LuceneXmlConstants.PREFIX,
         LuceneXmlConstants.NAMESPACE, LuceneXmlConstants.INDEX, "name", indexName);
   }
+
+  @Override
+  public Collection<ResourcePermission> getRequiredPermissions(String regionName) {
+    return Collections.singleton(
+        new ResourcePermission(Resource.CLUSTER, Operation.MANAGE, LucenePermission.TARGET));
+  }
 }
diff --git a/geode-lucene/src/main/java/org/apache/geode/cache/lucene/internal/cli/functions/LuceneListIndexFunction.java b/geode-lucene/src/main/java/org/apache/geode/cache/lucene/internal/cli/functions/LuceneListIndexFunction.java
index 34d445b22bc..31c8122d368 100755
--- a/geode-lucene/src/main/java/org/apache/geode/cache/lucene/internal/cli/functions/LuceneListIndexFunction.java
+++ b/geode-lucene/src/main/java/org/apache/geode/cache/lucene/internal/cli/functions/LuceneListIndexFunction.java
@@ -15,6 +15,8 @@
 
 package org.apache.geode.cache.lucene.internal.cli.functions;
 
+import java.util.Collection;
+import java.util.Collections;
 import java.util.HashSet;
 import java.util.Set;
 
@@ -27,7 +29,11 @@
 import org.apache.geode.cache.lucene.internal.LuceneIndexImpl;
 import org.apache.geode.cache.lucene.internal.LuceneServiceImpl;
 import org.apache.geode.cache.lucene.internal.cli.LuceneIndexDetails;
+import org.apache.geode.cache.lucene.internal.security.LucenePermission;
 import org.apache.geode.internal.InternalEntity;
+import org.apache.geode.security.ResourcePermission;
+import org.apache.geode.security.ResourcePermission.Operation;
+import org.apache.geode.security.ResourcePermission.Resource;
 
 /**
  * The LuceneListIndexFunction class is a function used to collect the information on all lucene
@@ -64,4 +70,10 @@ public void execute(final FunctionContext context) {
     }
     context.getResultSender().lastResult(indexDetailsSet);
   }
+
+  @Override
+  public Collection<ResourcePermission> getRequiredPermissions(String regionName) {
+    return Collections.singleton(
+        new ResourcePermission(Resource.CLUSTER, Operation.READ, LucenePermission.TARGET));
+  }
 }
diff --git a/geode-lucene/src/main/java/org/apache/geode/cache/lucene/internal/cli/functions/LuceneSearchIndexFunction.java b/geode-lucene/src/main/java/org/apache/geode/cache/lucene/internal/cli/functions/LuceneSearchIndexFunction.java
index 0a6cc3ec3ea..c0433881b76 100755
--- a/geode-lucene/src/main/java/org/apache/geode/cache/lucene/internal/cli/functions/LuceneSearchIndexFunction.java
+++ b/geode-lucene/src/main/java/org/apache/geode/cache/lucene/internal/cli/functions/LuceneSearchIndexFunction.java
@@ -15,14 +15,14 @@
 
 package org.apache.geode.cache.lucene.internal.cli.functions;
 
+import java.util.Collection;
+import java.util.Collections;
 import java.util.HashSet;
 import java.util.List;
 import java.util.Set;
 
 import org.apache.geode.cache.Cache;
-import org.apache.geode.cache.CacheFactory;
 import org.apache.geode.cache.execute.Function;
-import org.apache.geode.cache.execute.FunctionAdapter;
 import org.apache.geode.cache.execute.FunctionContext;
 import org.apache.geode.cache.lucene.LuceneQuery;
 import org.apache.geode.cache.lucene.LuceneQueryException;
@@ -35,6 +35,9 @@
 import org.apache.geode.cache.lucene.internal.cli.LuceneQueryInfo;
 import org.apache.geode.cache.lucene.internal.cli.LuceneSearchResults;
 import org.apache.geode.internal.InternalEntity;
+import org.apache.geode.security.ResourcePermission;
+import org.apache.geode.security.ResourcePermission.Operation;
+import org.apache.geode.security.ResourcePermission.Resource;
 
 /**
  * The LuceneSearchIndexFunction class is a function used to collect the information on a particular
@@ -95,4 +98,9 @@ public void execute(final FunctionContext context) {
       context.getResultSender().lastResult(result);
     }
   }
+
+  @Override
+  public Collection<ResourcePermission> getRequiredPermissions(String regionName) {
+    return Collections.singleton(new ResourcePermission(Resource.DATA, Operation.READ, regionName));
+  }
 }
diff --git a/geode-lucene/src/main/java/org/apache/geode/cache/lucene/internal/directory/DumpDirectoryFiles.java b/geode-lucene/src/main/java/org/apache/geode/cache/lucene/internal/directory/DumpDirectoryFiles.java
index 910f50f23c8..4d720da3db0 100644
--- a/geode-lucene/src/main/java/org/apache/geode/cache/lucene/internal/directory/DumpDirectoryFiles.java
+++ b/geode-lucene/src/main/java/org/apache/geode/cache/lucene/internal/directory/DumpDirectoryFiles.java
@@ -17,6 +17,8 @@
 
 import java.io.File;
 import java.util.Collection;
+import java.util.HashSet;
+import java.util.Set;
 
 import org.apache.logging.log4j.Logger;
 import org.apache.lucene.index.IndexWriter;
@@ -35,6 +37,9 @@
 import org.apache.geode.internal.InternalEntity;
 import org.apache.geode.internal.cache.BucketNotFoundException;
 import org.apache.geode.internal.logging.LogService;
+import org.apache.geode.security.ResourcePermission;
+import org.apache.geode.security.ResourcePermission.Operation;
+import org.apache.geode.security.ResourcePermission.Resource;
 
 public class DumpDirectoryFiles implements Function, InternalEntity {
   private static final long serialVersionUID = 1L;
@@ -96,4 +101,12 @@ public String getId() {
   public boolean optimizeForWrite() {
     return true;
   }
+
+  @Override
+  public Collection<ResourcePermission> getRequiredPermissions(String regionName) {
+    Set<ResourcePermission> required = new HashSet<>();
+    required.add(new ResourcePermission(Resource.DATA, Operation.READ, regionName));
+    required.add(new ResourcePermission(Resource.CLUSTER, Operation.MANAGE));
+    return required;
+  }
 }
diff --git a/geode-lucene/src/main/java/org/apache/geode/cache/lucene/internal/distributed/LuceneQueryFunction.java b/geode-lucene/src/main/java/org/apache/geode/cache/lucene/internal/distributed/LuceneQueryFunction.java
index 0b104a3152c..bc5ced6134f 100644
--- a/geode-lucene/src/main/java/org/apache/geode/cache/lucene/internal/distributed/LuceneQueryFunction.java
+++ b/geode-lucene/src/main/java/org/apache/geode/cache/lucene/internal/distributed/LuceneQueryFunction.java
@@ -19,7 +19,6 @@
 import java.util.ArrayList;
 import java.util.Collection;
 import java.util.Collections;
-import java.util.Optional;
 
 import org.apache.logging.log4j.Logger;
 import org.apache.lucene.search.Query;
diff --git a/geode-lucene/src/main/java/org/apache/geode/cache/lucene/internal/distributed/WaitUntilFlushedFunction.java b/geode-lucene/src/main/java/org/apache/geode/cache/lucene/internal/distributed/WaitUntilFlushedFunction.java
index c9e10d9daaf..f0c88a4f6f0 100644
--- a/geode-lucene/src/main/java/org/apache/geode/cache/lucene/internal/distributed/WaitUntilFlushedFunction.java
+++ b/geode-lucene/src/main/java/org/apache/geode/cache/lucene/internal/distributed/WaitUntilFlushedFunction.java
@@ -17,7 +17,6 @@
 
 import java.util.Collection;
 import java.util.Collections;
-import java.util.Optional;
 import java.util.concurrent.TimeUnit;
 
 import org.apache.geode.cache.Cache;
diff --git a/geode-lucene/src/main/java/org/apache/geode/cache/lucene/internal/results/LuceneGetPageFunction.java b/geode-lucene/src/main/java/org/apache/geode/cache/lucene/internal/results/LuceneGetPageFunction.java
index 07dc1ad27ef..8e2bfcc02a9 100644
--- a/geode-lucene/src/main/java/org/apache/geode/cache/lucene/internal/results/LuceneGetPageFunction.java
+++ b/geode-lucene/src/main/java/org/apache/geode/cache/lucene/internal/results/LuceneGetPageFunction.java
@@ -18,7 +18,6 @@
 import java.util.Collection;
 import java.util.Collections;
 import java.util.List;
-import java.util.Optional;
 import java.util.Set;
 
 import org.apache.logging.log4j.Logger;
diff --git a/geode-lucene/src/test/java/org/apache/geode/cache/lucene/test/LuceneFunctionSecurityTest.java b/geode-lucene/src/test/java/org/apache/geode/cache/lucene/test/LuceneFunctionSecurityTest.java
new file mode 100644
index 00000000000..c5f5fc7b885
--- /dev/null
+++ b/geode-lucene/src/test/java/org/apache/geode/cache/lucene/test/LuceneFunctionSecurityTest.java
@@ -0,0 +1,494 @@
+/*
+ * Licensed to the Apache Software Foundation (ASF) under one or more contributor license
+ * agreements. See the NOTICE file distributed with this work for additional information regarding
+ * copyright ownership. The ASF licenses this file to You under the Apache License, Version 2.0 (the
+ * "License"); you may not use this file except in compliance with the License. You may obtain a
+ * copy of the License at
+ *
+ * http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software distributed under the License
+ * is distributed on an "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express
+ * or implied. See the License for the specific language governing permissions and limitations under
+ * the License.
+ */
+
+package org.apache.geode.cache.lucene.test;
+
+import static org.assertj.core.api.Assertions.assertThat;
+import static org.mockito.ArgumentMatchers.any;
+
+import java.util.function.Predicate;
+
+import org.apache.logging.log4j.Logger;
+import org.assertj.core.api.Condition;
+import org.junit.BeforeClass;
+import org.junit.ClassRule;
+import org.junit.Rule;
+import org.junit.Test;
+import org.junit.experimental.categories.Category;
+import org.mockito.Mockito;
+import org.mockito.stubbing.Answer;
+
+import org.apache.geode.cache.RegionShortcut;
+import org.apache.geode.cache.execute.Function;
+import org.apache.geode.cache.execute.FunctionService;
+import org.apache.geode.cache.lucene.internal.cli.functions.LuceneCreateIndexFunction;
+import org.apache.geode.cache.lucene.internal.cli.functions.LuceneDescribeIndexFunction;
+import org.apache.geode.cache.lucene.internal.cli.functions.LuceneDestroyIndexFunction;
+import org.apache.geode.cache.lucene.internal.cli.functions.LuceneListIndexFunction;
+import org.apache.geode.cache.lucene.internal.cli.functions.LuceneSearchIndexFunction;
+import org.apache.geode.cache.lucene.internal.directory.DumpDirectoryFiles;
+import org.apache.geode.cache.lucene.internal.distributed.LuceneQueryFunction;
+import org.apache.geode.cache.lucene.internal.distributed.WaitUntilFlushedFunction;
+import org.apache.geode.cache.lucene.internal.results.LuceneGetPageFunction;
+import org.apache.geode.cache.lucene.internal.security.LucenePermission;
+import org.apache.geode.examples.SimpleSecurityManager;
+import org.apache.geode.internal.logging.LogService;
+import org.apache.geode.security.ResourcePermission;
+import org.apache.geode.security.ResourcePermission.Operation;
+import org.apache.geode.security.ResourcePermission.Resource;
+import org.apache.geode.test.junit.categories.IntegrationTest;
+import org.apache.geode.test.junit.categories.SecurityTest;
+import org.apache.geode.test.junit.rules.ConnectionConfiguration;
+import org.apache.geode.test.junit.rules.GfshCommandRule;
+import org.apache.geode.test.junit.rules.ServerStarterRule;
+
+@Category({IntegrationTest.class, SecurityTest.class})
+public class LuceneFunctionSecurityTest {
+  private static final Logger logger = LogService.getLogger();
+
+  private static Function luceneCreateIndexFunction = Mockito.spy(new LuceneCreateIndexFunction());
+  private static Function luceneDescribeIndexFunction =
+      Mockito.spy(new LuceneDescribeIndexFunction());
+  private static Function luceneDestroyIndexFunction =
+      Mockito.spy(new LuceneDestroyIndexFunction());
+  private static Function luceneListIndexFunction = Mockito.spy(new LuceneListIndexFunction());
+  private static Function luceneSearchIndexFunction = Mockito.spy(new LuceneSearchIndexFunction());
+  private static Function dumpDirectoryFiles = Mockito.spy(new DumpDirectoryFiles());
+  private static Function luceneQueryFunction = Mockito.spy(new LuceneQueryFunction());
+  private static Function waitUntilFlushedFunction = Mockito.spy(new WaitUntilFlushedFunction());
+  private static Function luceneGetPageFunction = Mockito.spy(new LuceneGetPageFunction());
+
+  static {
+    Mockito.doAnswer(announceNoOp()).when(luceneCreateIndexFunction).execute(any());
+    Mockito.doAnswer(announceNoOp()).when(luceneDescribeIndexFunction).execute(any());
+    Mockito.doAnswer(announceNoOp()).when(luceneDestroyIndexFunction).execute(any());
+    Mockito.doAnswer(announceNoOp()).when(luceneListIndexFunction).execute(any());
+    Mockito.doAnswer(announceNoOp()).when(luceneSearchIndexFunction).execute(any());
+    Mockito.doAnswer(announceNoOp()).when(dumpDirectoryFiles).execute(any());
+    Mockito.doAnswer(announceNoOp()).when(luceneQueryFunction).execute(any());
+    Mockito.doAnswer(announceNoOp()).when(waitUntilFlushedFunction).execute(any());
+    Mockito.doAnswer(announceNoOp()).when(luceneGetPageFunction).execute(any());
+  }
+
+  private static String regionName = "luceneTestRegion";
+
+  private static ResourcePermission clusterManage =
+      new ResourcePermission(Resource.CLUSTER, Operation.MANAGE);
+
+  private static ResourcePermission clusterManageLucene =
+      new ResourcePermission(Resource.CLUSTER, Operation.MANAGE, LucenePermission.TARGET);
+
+  private static ResourcePermission clusterReadLucene =
+      new ResourcePermission(Resource.CLUSTER, Operation.READ, LucenePermission.TARGET);
+
+  private static ResourcePermission dataRead =
+      new ResourcePermission(Resource.DATA, Operation.READ);
+
+  private static ResourcePermission dataReadRegion =
+      new ResourcePermission(Resource.DATA, Operation.READ, regionName);
+
+  @ClassRule
+  public static ServerStarterRule server =
+      new ServerStarterRule().withJMXManager().withSecurityManager(SimpleSecurityManager.class)
+          .withRegion(RegionShortcut.PARTITION, regionName).withAutoStart();
+
+  @Rule
+  public GfshCommandRule gfsh =
+      new GfshCommandRule(server::getJmxPort, GfshCommandRule.PortType.jmxManager);
+
+  @BeforeClass
+  public static void setupClass() {
+    FunctionService.registerFunction(luceneCreateIndexFunction);
+    FunctionService.registerFunction(luceneDescribeIndexFunction);
+    FunctionService.registerFunction(luceneDestroyIndexFunction);
+    FunctionService.registerFunction(luceneListIndexFunction);
+    FunctionService.registerFunction(luceneSearchIndexFunction);
+    FunctionService.registerFunction(dumpDirectoryFiles);
+    FunctionService.registerFunction(luceneQueryFunction);
+    FunctionService.registerFunction(waitUntilFlushedFunction);
+    FunctionService.registerFunction(luceneGetPageFunction);
+  }
+
+  /* Command authorized tests */
+  @Test
+  @ConnectionConfiguration(user = "clusterManageLucene", password = "clusterManageLucene")
+  public void testValidPermissionsForLuceneCreateIndexFunction() throws Exception {
+    Function thisFunction = luceneCreateIndexFunction;
+
+    gfsh.executeAndAssertThat("execute function --id=" + thisFunction.getId()).statusIsSuccess();
+  }
+
+  @Test
+  @ConnectionConfiguration(user = "clusterReadLucene", password = "clusterReadLucene")
+  public void testValidPermissionsForLuceneDescribeIndexFunction() throws Exception {
+    Function thisFunction = luceneDescribeIndexFunction;
+
+    gfsh.executeAndAssertThat("execute function --id=" + thisFunction.getId()).statusIsSuccess();
+  }
+
+  @Test
+  @ConnectionConfiguration(user = "clusterManageLucene", password = "clusterManageLucene")
+  public void testValidPermissionsForLuceneDestroyIndexFunction() throws Exception {
+    Function thisFunction = luceneDestroyIndexFunction;
+
+    gfsh.executeAndAssertThat("execute function --id=" + thisFunction.getId()).statusIsSuccess();
+  }
+
+  @Test
+  @ConnectionConfiguration(user = "clusterReadLucene", password = "clusterReadLucene")
+  public void testValidPermissionsForLuceneListIndexFunction() throws Exception {
+    Function thisFunction = luceneListIndexFunction;
+
+    gfsh.executeAndAssertThat("execute function --id=" + thisFunction.getId()).statusIsSuccess();
+  }
+
+  @Test
+  @ConnectionConfiguration(user = "dataRead", password = "dataRead")
+  public void testValidPermissionsForDumpDirectoryFilesWithRegionParameter_withClusterManage()
+      throws Exception {
+    Function thisFunction = dumpDirectoryFiles;
+
+    gfsh.executeAndAssertThat(
+        "execute function  --region=" + regionName + " --id=" + thisFunction.getId())
+        .statusIsSuccess();
+  }
+
+  @Test
+  @ConnectionConfiguration(user = "dataRead", password = "dataRead")
+  public void testValidPermissionsForDumpDirectoryFilesWithoutRegionParameter_withClusterManage()
+      throws Exception {
+    Function thisFunction = dumpDirectoryFiles;
+
+    gfsh.executeAndAssertThat("execute function --id=" + thisFunction.getId()).statusIsSuccess();
+  }
+
+
+  @Test
+  @ConnectionConfiguration(user = "dataRead", password = "dataRead")
+  public void testValidPermissionsForLuceneSearchIndexFunctionWithoutRegionParameter()
+      throws Exception {
+    Function thisFunction = luceneSearchIndexFunction;
+
+    gfsh.executeAndAssertThat("execute function --id=" + thisFunction.getId()).statusIsSuccess();
+  }
+
+  @Test
+  @ConnectionConfiguration(user = "dataReadRegion", password = "dataReadRegion")
+  public void testValidPermissionsForLuceneSearchIndexFunctionWithRegionParameter()
+      throws Exception {
+    Function thisFunction = luceneSearchIndexFunction;
+
+    gfsh.executeAndAssertThat(
+        "execute function --region=" + regionName + " --id=" + thisFunction.getId())
+        .statusIsSuccess();
+  }
+
+  @Test
+  @ConnectionConfiguration(user = "dataRead", password = "dataRead")
+  public void testValidPermissionsForLuceneQueryFunctionWithoutRegionParameter() throws Exception {
+    Function thisFunction = luceneQueryFunction;
+
+    gfsh.executeAndAssertThat("execute function --id=" + thisFunction.getId()).statusIsSuccess();
+  }
+
+  @Test
+  @ConnectionConfiguration(user = "dataReadRegion", password = "dataReadRegion")
+  public void testValidPermissionsForLuceneQueryFunctionWithRegionParameter() throws Exception {
+    Function thisFunction = luceneQueryFunction;
+
+    gfsh.executeAndAssertThat(
+        "execute function --region=" + regionName + " --id=" + thisFunction.getId())
+        .statusIsSuccess();
+  }
+
+  @Test
+  @ConnectionConfiguration(user = "dataRead", password = "dataRead")
+  public void testValidPermissionsForWaitUntilFlushedFunctionWithoutRegionParameter()
+      throws Exception {
+    Function thisFunction = waitUntilFlushedFunction;
+
+    gfsh.executeAndAssertThat("execute function --id=" + thisFunction.getId()).statusIsSuccess();
+  }
+
+  @Test
+  @ConnectionConfiguration(user = "dataReadRegion", password = "dataReadRegion")
+  public void testValidPermissionsForWaitUntilFlushedFunctionWithRegionParameter()
+      throws Exception {
+    Function thisFunction = waitUntilFlushedFunction;
+
+    gfsh.executeAndAssertThat(
+        "execute function --region=" + regionName + " --id=" + thisFunction.getId())
+        .statusIsSuccess();
+  }
+
+  @Test
+  @ConnectionConfiguration(user = "dataRead", password = "dataRead")
+  public void testValidPermissionsForLuceneGetPageFunctionWithoutRegionParameter()
+      throws Exception {
+    Function thisFunction = luceneGetPageFunction;
+
+    gfsh.executeAndAssertThat("execute function --id=" + thisFunction.getId()).statusIsSuccess();
+  }
+
+  @Test
+  @ConnectionConfiguration(user = "dataReadRegion", password = "dataReadRegion")
+  public void testValidPermissionsForLuceneGetPageFunctionWithRegionParameter() throws Exception {
+    Function thisFunction = luceneGetPageFunction;
+
+    gfsh.executeAndAssertThat(
+        "execute function --region=" + regionName + " --id=" + thisFunction.getId())
+        .statusIsSuccess();
+  }
+
+
+  /* Command refused tests */
+  @Test
+  @ConnectionConfiguration(user = "noPermissions", password = "noPermissions")
+  public void testInvalidPermissionsForLuceneCreateIndexFunction() throws Exception {
+    Function thisFunction = luceneCreateIndexFunction;
+    ResourcePermission thisRequiredPermission = clusterManageLucene;
+
+    gfsh.executeAndAssertThat("execute function --id=" + thisFunction.getId())
+        .containsOutput("not authorized for " + thisRequiredPermission.toString())
+        .statusIsSuccess();
+  }
+
+  @Test
+  @ConnectionConfiguration(user = "noPermissions", password = "noPermissions")
+  public void testInvalidPermissionsForLuceneDescribeIndexFunction() throws Exception {
+    Function thisFunction = luceneDescribeIndexFunction;
+    ResourcePermission thisRequiredPermission = clusterReadLucene;
+
+    gfsh.executeAndAssertThat("execute function --id=" + thisFunction.getId())
+        .containsOutput("not authorized for " + thisRequiredPermission.toString())
+        .statusIsSuccess();
+  }
+
+  @Test
+  @ConnectionConfiguration(user = "noPermissions", password = "noPermissions")
+  public void testInvalidPermissionsForLuceneDestroyIndexFunction() throws Exception {
+    Function thisFunction = luceneDestroyIndexFunction;
+    ResourcePermission thisRequiredPermission = clusterManageLucene;
+
+    gfsh.executeAndAssertThat("execute function --id=" + thisFunction.getId())
+        .containsOutput("not authorized for " + thisRequiredPermission.toString())
+        .statusIsSuccess();
+  }
+
+  @Test
+  @ConnectionConfiguration(user = "noPermissions", password = "noPermissions")
+  public void testInvalidPermissionsForLuceneListIndexFunction() throws Exception {
+    Function thisFunction = luceneListIndexFunction;
+    ResourcePermission thisRequiredPermission = clusterReadLucene;
+
+    gfsh.executeAndAssertThat("execute function --id=" + thisFunction.getId())
+        .containsOutput("not authorized for " + thisRequiredPermission.toString())
+        .statusIsSuccess();
+  }
+
+  @Test
+  @ConnectionConfiguration(user = "noPermissions", password = "noPermissions")
+  public void testInvalidPermissionsForDumpDirectoryFilesWithoutRegionParameter_noPermission()
+      throws Exception {
+    Function thisFunction = dumpDirectoryFiles;
+
+    Predicate<String> notAuthForDataRead =
+        s -> s.contains("not authorized for " + dataRead.toString());
+    Predicate<String> notAuthForClusterManage =
+        s -> s.contains("not authorized for " + clusterManage.toString());
+    Predicate<String> notAuthForSomePermission =
+        s -> notAuthForDataRead.test(s) || notAuthForClusterManage.test(s);
+
+    String output = gfsh.execute("execute function --id=" + thisFunction.getId());
+
+    Condition<String> containsSomeAuthFailure = new Condition<>(notAuthForSomePermission,
+        "not authorized for for [DATA:MANAGE|CLUSTER:MANAGE]", output);
+    assertThat(output).has(containsSomeAuthFailure);
+  }
+
+  @Test
+  @ConnectionConfiguration(user = "dataRead", password = "dataRead")
+  public void testInvalidPermissionsForDumpDirectoryFilesWithoutRegionParameter_withDataRead()
+      throws Exception {
+    Function thisFunction = dumpDirectoryFiles;
+    ResourcePermission thisMissingPermission = clusterManage;
+
+    gfsh.executeAndAssertThat("execute function --id=" + thisFunction.getId())
+        .containsOutput("not authorized for " + thisMissingPermission.toString()).statusIsSuccess();
+  }
+
+  @Test
+  @ConnectionConfiguration(user = "clusterManage", password = "clusterManage")
+  public void testInvalidPermissionsForDumpDirectoryFilesWithoutRegionParameter_withClusterManage()
+      throws Exception {
+    Function thisFunction = dumpDirectoryFiles;
+    ResourcePermission thisMissingPermission = dataRead;
+
+    gfsh.executeAndAssertThat("execute function --id=" + thisFunction.getId())
+        .containsOutput("not authorized for " + thisMissingPermission.toString()).statusIsSuccess();
+  }
+
+  @Test
+  @ConnectionConfiguration(user = "noPermissions", password = "noPermissions")
+  public void testInvalidPermissionsForDumpDirectoryFilesWithRegionParameter_noPermission()
+      throws Exception {
+    Function thisFunction = dumpDirectoryFiles;
+
+    Predicate<String> notAuthForDataReadRegion =
+        s -> s.contains("not authorized for " + dataReadRegion.toString());
+    Predicate<String> notAuthForClusterManage =
+        s -> s.contains("not authorized for " + clusterManage.toString());
+    Predicate<String> notAuthForSomePermission =
+        s -> notAuthForDataReadRegion.test(s) || notAuthForClusterManage.test(s);
+
+    String output =
+        gfsh.execute("execute function --region=" + regionName + " --id=" + thisFunction.getId());
+
+    Condition<String> containsSomeAuthFailure =
+        new Condition<>(notAuthForSomePermission, "D:R or C:M:L auth failure", output);
+    assertThat(output).has(containsSomeAuthFailure);
+  }
+
+  @Test
+  @ConnectionConfiguration(user = "dataRead", password = "dataRead")
+  public void testInvalidPermissionsForDumpDirectoryFilesWithRegionParameter_withDataRead()
+      throws Exception {
+    Function thisFunction = dumpDirectoryFiles;
+    ResourcePermission thisMissingPermission = clusterManage;
+
+    gfsh.executeAndAssertThat(
+        "execute function  --region=" + regionName + " --id=" + thisFunction.getId())
+        .containsOutput("not authorized for " + thisMissingPermission.toString()).statusIsSuccess();
+  }
+
+  @Test
+  @ConnectionConfiguration(user = "clusterManage", password = "clusterManage")
+  public void testInvalidPermissionsForDumpDirectoryFilesWithRegionParameter_withClusterManage()
+      throws Exception {
+    Function thisFunction = dumpDirectoryFiles;
+    ResourcePermission thisMissingPermission = dataRead;
+
+    gfsh.executeAndAssertThat(
+        "execute function  --region=" + regionName + " --id=" + thisFunction.getId())
+        .containsOutput("not authorized for " + thisMissingPermission.toString()).statusIsSuccess();
+  }
+
+
+  @Test
+  @ConnectionConfiguration(user = "noPermissions", password = "noPermissions")
+  public void testInvalidPermissionsForLuceneSearchIndexFunctionWithoutRegionParameter()
+      throws Exception {
+    Function thisFunction = luceneSearchIndexFunction;
+    ResourcePermission thisRequiredPermission = dataRead;
+
+    gfsh.executeAndAssertThat("execute function --id=" + thisFunction.getId())
+        .containsOutput("not authorized for " + thisRequiredPermission.toString())
+        .statusIsSuccess();
+  }
+
+  @Test
+  @ConnectionConfiguration(user = "noPermissions", password = "noPermissions")
+  public void testInvalidPermissionsForLuceneSearchIndexFunctionWithRegionParameter()
+      throws Exception {
+    Function thisFunction = luceneSearchIndexFunction;
+    ResourcePermission thisRequiredPermission = dataReadRegion;
+
+    gfsh.executeAndAssertThat(
+        "execute function --region=" + regionName + " --id=" + thisFunction.getId())
+        .containsOutput("not authorized for " + thisRequiredPermission.toString())
+        .statusIsSuccess();
+  }
+
+  @Test
+  @ConnectionConfiguration(user = "noPermissions", password = "noPermissions")
+  public void testInvalidPermissionsForLuceneQueryFunctionWithoutRegionParameter()
+      throws Exception {
+    Function thisFunction = luceneQueryFunction;
+    ResourcePermission thisRequiredPermission = dataRead;
+
+    gfsh.executeAndAssertThat("execute function --id=" + thisFunction.getId())
+        .containsOutput("not authorized for " + thisRequiredPermission.toString())
+        .statusIsSuccess();
+  }
+
+  @Test
+  @ConnectionConfiguration(user = "noPermissions", password = "noPermissions")
+  public void testInvalidPermissionsForLuceneQueryFunctionWithRegionParameter() throws Exception {
+    Function thisFunction = luceneQueryFunction;
+    ResourcePermission thisRequiredPermission = dataReadRegion;
+
+    gfsh.executeAndAssertThat(
+        "execute function --region=" + regionName + " --id=" + thisFunction.getId())
+        .containsOutput("not authorized for " + thisRequiredPermission.toString())
+        .statusIsSuccess();
+  }
+
+  @Test
+  @ConnectionConfiguration(user = "noPermissions", password = "noPermissions")
+  public void testInvalidPermissionsForWaitUntilFlushedFunctionWithoutRegionParameter()
+      throws Exception {
+    Function thisFunction = waitUntilFlushedFunction;
+    ResourcePermission thisRequiredPermission = dataRead;
+
+    gfsh.executeAndAssertThat("execute function --id=" + thisFunction.getId())
+        .containsOutput("not authorized for " + thisRequiredPermission.toString())
+        .statusIsSuccess();
+  }
+
+  @Test
+  @ConnectionConfiguration(user = "noPermissions", password = "noPermissions")
+  public void testInvalidPermissionsForWaitUntilFlushedFunctionWithRegionParameter()
+      throws Exception {
+    Function thisFunction = waitUntilFlushedFunction;
+    ResourcePermission thisRequiredPermission = dataReadRegion;
+
+    gfsh.executeAndAssertThat(
+        "execute function --region=" + regionName + " --id=" + thisFunction.getId())
+        .containsOutput("not authorized for " + thisRequiredPermission.toString())
+        .statusIsSuccess();
+  }
+
+  @Test
+  @ConnectionConfiguration(user = "noPermissions", password = "noPermissions")
+  public void testInvalidPermissionsForLuceneGetPageFunctionWithoutRegionParameter()
+      throws Exception {
+    Function thisFunction = luceneGetPageFunction;
+    ResourcePermission thisRequiredPermission = dataRead;
+
+    gfsh.executeAndAssertThat("execute function --id=" + thisFunction.getId())
+        .containsOutput("not authorized for " + thisRequiredPermission.toString())
+        .statusIsSuccess();
+  }
+
+  @Test
+  @ConnectionConfiguration(user = "noPermissions", password = "noPermissions")
+  public void testInvalidPermissionsForLuceneGetPageFunctionWithRegionParameter() throws Exception {
+    Function thisFunction = luceneGetPageFunction;
+    ResourcePermission thisRequiredPermission = dataReadRegion;
+
+    gfsh.executeAndAssertThat(
+        "execute function --region=" + regionName + " --id=" + thisFunction.getId())
+        .containsOutput("not authorized for " + thisRequiredPermission.toString())
+        .statusIsSuccess();
+  }
+
+  private static Answer<Void> announceNoOp() {
+    return invocation -> {
+      String mockedName = invocation.getMethod().getName();
+      logger.info("Performing no-op mock of " + mockedName);
+      return null;
+    };
+  }
+}

From 0a4ce607c0faab23d149f2213d796d0443e5daab Mon Sep 17 00:00:00 2001
From: Patrick Rhomberg <prhomberg@pivotal.io>
Date: Wed, 10 Jan 2018 10:03:32 -0800
Subject: [PATCH 2/2] Suggested changes, reformatting for consistency, and
 added 'doesNotContainOutput("not authorized for")' to each successful-auth
 test, corrected intent on Dump command, corrected permissions for *:*:region
 level commands.

---
 .../test/LuceneFunctionSecurityTest.java      | 159 +++++++++---------
 1 file changed, 75 insertions(+), 84 deletions(-)

diff --git a/geode-lucene/src/test/java/org/apache/geode/cache/lucene/test/LuceneFunctionSecurityTest.java b/geode-lucene/src/test/java/org/apache/geode/cache/lucene/test/LuceneFunctionSecurityTest.java
index c5f5fc7b885..2fa054eef49 100644
--- a/geode-lucene/src/test/java/org/apache/geode/cache/lucene/test/LuceneFunctionSecurityTest.java
+++ b/geode-lucene/src/test/java/org/apache/geode/cache/lucene/test/LuceneFunctionSecurityTest.java
@@ -15,12 +15,13 @@
 
 package org.apache.geode.cache.lucene.test;
 
+import static org.apache.geode.management.internal.security.ResourcePermissions.CLUSTER_MANAGE;
+import static org.apache.geode.management.internal.security.ResourcePermissions.DATA_READ;
 import static org.assertj.core.api.Assertions.assertThat;
 import static org.mockito.ArgumentMatchers.any;
 
 import java.util.function.Predicate;
 
-import org.apache.logging.log4j.Logger;
 import org.assertj.core.api.Condition;
 import org.junit.BeforeClass;
 import org.junit.ClassRule;
@@ -28,7 +29,6 @@
 import org.junit.Test;
 import org.junit.experimental.categories.Category;
 import org.mockito.Mockito;
-import org.mockito.stubbing.Answer;
 
 import org.apache.geode.cache.RegionShortcut;
 import org.apache.geode.cache.execute.Function;
@@ -44,7 +44,6 @@
 import org.apache.geode.cache.lucene.internal.results.LuceneGetPageFunction;
 import org.apache.geode.cache.lucene.internal.security.LucenePermission;
 import org.apache.geode.examples.SimpleSecurityManager;
-import org.apache.geode.internal.logging.LogService;
 import org.apache.geode.security.ResourcePermission;
 import org.apache.geode.security.ResourcePermission.Operation;
 import org.apache.geode.security.ResourcePermission.Resource;
@@ -56,7 +55,16 @@
 
 @Category({IntegrationTest.class, SecurityTest.class})
 public class LuceneFunctionSecurityTest {
-  private static final Logger logger = LogService.getLogger();
+  // Note: this region name is embedded below in several @ConnectionConfiguration inputs,
+  // which is itself case-sensitive in parsing.
+  private static String regionName = "this_test_region";
+
+  private static ResourcePermission CLUSTER_MANAGE_LUCENE =
+      new ResourcePermission(Resource.CLUSTER, Operation.MANAGE, LucenePermission.TARGET);
+  private static ResourcePermission CLUSTER_READ_LUCENE =
+      new ResourcePermission(Resource.CLUSTER, Operation.READ, LucenePermission.TARGET);
+  private static ResourcePermission DATA_READ_REGION =
+      new ResourcePermission(Resource.DATA, Operation.READ, regionName);
 
   private static Function luceneCreateIndexFunction = Mockito.spy(new LuceneCreateIndexFunction());
   private static Function luceneDescribeIndexFunction =
@@ -71,34 +79,17 @@
   private static Function luceneGetPageFunction = Mockito.spy(new LuceneGetPageFunction());
 
   static {
-    Mockito.doAnswer(announceNoOp()).when(luceneCreateIndexFunction).execute(any());
-    Mockito.doAnswer(announceNoOp()).when(luceneDescribeIndexFunction).execute(any());
-    Mockito.doAnswer(announceNoOp()).when(luceneDestroyIndexFunction).execute(any());
-    Mockito.doAnswer(announceNoOp()).when(luceneListIndexFunction).execute(any());
-    Mockito.doAnswer(announceNoOp()).when(luceneSearchIndexFunction).execute(any());
-    Mockito.doAnswer(announceNoOp()).when(dumpDirectoryFiles).execute(any());
-    Mockito.doAnswer(announceNoOp()).when(luceneQueryFunction).execute(any());
-    Mockito.doAnswer(announceNoOp()).when(waitUntilFlushedFunction).execute(any());
-    Mockito.doAnswer(announceNoOp()).when(luceneGetPageFunction).execute(any());
+    Mockito.doNothing().when(luceneCreateIndexFunction).execute(any());
+    Mockito.doNothing().when(luceneDescribeIndexFunction).execute(any());
+    Mockito.doNothing().when(luceneDestroyIndexFunction).execute(any());
+    Mockito.doNothing().when(luceneListIndexFunction).execute(any());
+    Mockito.doNothing().when(luceneSearchIndexFunction).execute(any());
+    Mockito.doNothing().when(dumpDirectoryFiles).execute(any());
+    Mockito.doNothing().when(luceneQueryFunction).execute(any());
+    Mockito.doNothing().when(waitUntilFlushedFunction).execute(any());
+    Mockito.doNothing().when(luceneGetPageFunction).execute(any());
   }
 
-  private static String regionName = "luceneTestRegion";
-
-  private static ResourcePermission clusterManage =
-      new ResourcePermission(Resource.CLUSTER, Operation.MANAGE);
-
-  private static ResourcePermission clusterManageLucene =
-      new ResourcePermission(Resource.CLUSTER, Operation.MANAGE, LucenePermission.TARGET);
-
-  private static ResourcePermission clusterReadLucene =
-      new ResourcePermission(Resource.CLUSTER, Operation.READ, LucenePermission.TARGET);
-
-  private static ResourcePermission dataRead =
-      new ResourcePermission(Resource.DATA, Operation.READ);
-
-  private static ResourcePermission dataReadRegion =
-      new ResourcePermission(Resource.DATA, Operation.READ, regionName);
-
   @ClassRule
   public static ServerStarterRule server =
       new ServerStarterRule().withJMXManager().withSecurityManager(SimpleSecurityManager.class)
@@ -127,7 +118,8 @@ public static void setupClass() {
   public void testValidPermissionsForLuceneCreateIndexFunction() throws Exception {
     Function thisFunction = luceneCreateIndexFunction;
 
-    gfsh.executeAndAssertThat("execute function --id=" + thisFunction.getId()).statusIsSuccess();
+    gfsh.executeAndAssertThat("execute function --id=" + thisFunction.getId())
+        .doesNotContainOutput("not authorized for").statusIsSuccess();
   }
 
   @Test
@@ -135,7 +127,8 @@ public void testValidPermissionsForLuceneCreateIndexFunction() throws Exception
   public void testValidPermissionsForLuceneDescribeIndexFunction() throws Exception {
     Function thisFunction = luceneDescribeIndexFunction;
 
-    gfsh.executeAndAssertThat("execute function --id=" + thisFunction.getId()).statusIsSuccess();
+    gfsh.executeAndAssertThat("execute function --id=" + thisFunction.getId())
+        .doesNotContainOutput("not authorized for").statusIsSuccess();
   }
 
   @Test
@@ -143,7 +136,8 @@ public void testValidPermissionsForLuceneDescribeIndexFunction() throws Exceptio
   public void testValidPermissionsForLuceneDestroyIndexFunction() throws Exception {
     Function thisFunction = luceneDestroyIndexFunction;
 
-    gfsh.executeAndAssertThat("execute function --id=" + thisFunction.getId()).statusIsSuccess();
+    gfsh.executeAndAssertThat("execute function --id=" + thisFunction.getId())
+        .doesNotContainOutput("not authorized for").statusIsSuccess();
   }
 
   @Test
@@ -151,27 +145,28 @@ public void testValidPermissionsForLuceneDestroyIndexFunction() throws Exception
   public void testValidPermissionsForLuceneListIndexFunction() throws Exception {
     Function thisFunction = luceneListIndexFunction;
 
-    gfsh.executeAndAssertThat("execute function --id=" + thisFunction.getId()).statusIsSuccess();
+    gfsh.executeAndAssertThat("execute function --id=" + thisFunction.getId())
+        .doesNotContainOutput("not authorized for").statusIsSuccess();
   }
 
   @Test
-  @ConnectionConfiguration(user = "dataRead", password = "dataRead")
-  public void testValidPermissionsForDumpDirectoryFilesWithRegionParameter_withClusterManage()
-      throws Exception {
+  @ConnectionConfiguration(user = "dataReadThis_test_region,clusterManage",
+      password = "dataReadThis_test_region,clusterManage")
+  public void testValidPermissionsForDumpDirectoryFilesWithRegionParameter() throws Exception {
     Function thisFunction = dumpDirectoryFiles;
 
     gfsh.executeAndAssertThat(
         "execute function  --region=" + regionName + " --id=" + thisFunction.getId())
-        .statusIsSuccess();
+        .doesNotContainOutput("not authorized for").statusIsSuccess();
   }
 
   @Test
-  @ConnectionConfiguration(user = "dataRead", password = "dataRead")
-  public void testValidPermissionsForDumpDirectoryFilesWithoutRegionParameter_withClusterManage()
-      throws Exception {
+  @ConnectionConfiguration(user = "dataRead,clusterManage", password = "dataRead,clusterManage")
+  public void testValidPermissionsForDumpDirectoryFilesWithoutRegionParameter() throws Exception {
     Function thisFunction = dumpDirectoryFiles;
 
-    gfsh.executeAndAssertThat("execute function --id=" + thisFunction.getId()).statusIsSuccess();
+    gfsh.executeAndAssertThat("execute function --id=" + thisFunction.getId())
+        .doesNotContainOutput("not authorized for").statusIsSuccess();
   }
 
 
@@ -181,18 +176,19 @@ public void testValidPermissionsForLuceneSearchIndexFunctionWithoutRegionParamet
       throws Exception {
     Function thisFunction = luceneSearchIndexFunction;
 
-    gfsh.executeAndAssertThat("execute function --id=" + thisFunction.getId()).statusIsSuccess();
+    gfsh.executeAndAssertThat("execute function --id=" + thisFunction.getId())
+        .doesNotContainOutput("not authorized for").statusIsSuccess();
   }
 
   @Test
-  @ConnectionConfiguration(user = "dataReadRegion", password = "dataReadRegion")
+  @ConnectionConfiguration(user = "dataReadThis_test_region", password = "dataReadThis_test_region")
   public void testValidPermissionsForLuceneSearchIndexFunctionWithRegionParameter()
       throws Exception {
     Function thisFunction = luceneSearchIndexFunction;
 
     gfsh.executeAndAssertThat(
         "execute function --region=" + regionName + " --id=" + thisFunction.getId())
-        .statusIsSuccess();
+        .doesNotContainOutput("not authorized for").statusIsSuccess();
   }
 
   @Test
@@ -200,17 +196,18 @@ public void testValidPermissionsForLuceneSearchIndexFunctionWithRegionParameter(
   public void testValidPermissionsForLuceneQueryFunctionWithoutRegionParameter() throws Exception {
     Function thisFunction = luceneQueryFunction;
 
-    gfsh.executeAndAssertThat("execute function --id=" + thisFunction.getId()).statusIsSuccess();
+    gfsh.executeAndAssertThat("execute function --id=" + thisFunction.getId())
+        .doesNotContainOutput("not authorized for").statusIsSuccess();
   }
 
   @Test
-  @ConnectionConfiguration(user = "dataReadRegion", password = "dataReadRegion")
+  @ConnectionConfiguration(user = "dataReadThis_test_region", password = "dataReadThis_test_region")
   public void testValidPermissionsForLuceneQueryFunctionWithRegionParameter() throws Exception {
     Function thisFunction = luceneQueryFunction;
 
     gfsh.executeAndAssertThat(
         "execute function --region=" + regionName + " --id=" + thisFunction.getId())
-        .statusIsSuccess();
+        .doesNotContainOutput("not authorized for").statusIsSuccess();
   }
 
   @Test
@@ -219,18 +216,19 @@ public void testValidPermissionsForWaitUntilFlushedFunctionWithoutRegionParamete
       throws Exception {
     Function thisFunction = waitUntilFlushedFunction;
 
-    gfsh.executeAndAssertThat("execute function --id=" + thisFunction.getId()).statusIsSuccess();
+    gfsh.executeAndAssertThat("execute function --id=" + thisFunction.getId())
+        .doesNotContainOutput("not authorized for").statusIsSuccess();
   }
 
   @Test
-  @ConnectionConfiguration(user = "dataReadRegion", password = "dataReadRegion")
+  @ConnectionConfiguration(user = "dataReadThis_test_region", password = "dataReadThis_test_region")
   public void testValidPermissionsForWaitUntilFlushedFunctionWithRegionParameter()
       throws Exception {
     Function thisFunction = waitUntilFlushedFunction;
 
     gfsh.executeAndAssertThat(
         "execute function --region=" + regionName + " --id=" + thisFunction.getId())
-        .statusIsSuccess();
+        .doesNotContainOutput("not authorized for").statusIsSuccess();
   }
 
   @Test
@@ -239,17 +237,18 @@ public void testValidPermissionsForLuceneGetPageFunctionWithoutRegionParameter()
       throws Exception {
     Function thisFunction = luceneGetPageFunction;
 
-    gfsh.executeAndAssertThat("execute function --id=" + thisFunction.getId()).statusIsSuccess();
+    gfsh.executeAndAssertThat("execute function --id=" + thisFunction.getId())
+        .doesNotContainOutput("not authorized for").statusIsSuccess();
   }
 
   @Test
-  @ConnectionConfiguration(user = "dataReadRegion", password = "dataReadRegion")
+  @ConnectionConfiguration(user = "dataReadThis_test_region", password = "dataReadThis_test_region")
   public void testValidPermissionsForLuceneGetPageFunctionWithRegionParameter() throws Exception {
     Function thisFunction = luceneGetPageFunction;
 
     gfsh.executeAndAssertThat(
         "execute function --region=" + regionName + " --id=" + thisFunction.getId())
-        .statusIsSuccess();
+        .doesNotContainOutput("not authorized for").statusIsSuccess();
   }
 
 
@@ -258,7 +257,7 @@ public void testValidPermissionsForLuceneGetPageFunctionWithRegionParameter() th
   @ConnectionConfiguration(user = "noPermissions", password = "noPermissions")
   public void testInvalidPermissionsForLuceneCreateIndexFunction() throws Exception {
     Function thisFunction = luceneCreateIndexFunction;
-    ResourcePermission thisRequiredPermission = clusterManageLucene;
+    ResourcePermission thisRequiredPermission = CLUSTER_MANAGE_LUCENE;
 
     gfsh.executeAndAssertThat("execute function --id=" + thisFunction.getId())
         .containsOutput("not authorized for " + thisRequiredPermission.toString())
@@ -269,7 +268,7 @@ public void testInvalidPermissionsForLuceneCreateIndexFunction() throws Exceptio
   @ConnectionConfiguration(user = "noPermissions", password = "noPermissions")
   public void testInvalidPermissionsForLuceneDescribeIndexFunction() throws Exception {
     Function thisFunction = luceneDescribeIndexFunction;
-    ResourcePermission thisRequiredPermission = clusterReadLucene;
+    ResourcePermission thisRequiredPermission = CLUSTER_READ_LUCENE;
 
     gfsh.executeAndAssertThat("execute function --id=" + thisFunction.getId())
         .containsOutput("not authorized for " + thisRequiredPermission.toString())
@@ -280,7 +279,7 @@ public void testInvalidPermissionsForLuceneDescribeIndexFunction() throws Except
   @ConnectionConfiguration(user = "noPermissions", password = "noPermissions")
   public void testInvalidPermissionsForLuceneDestroyIndexFunction() throws Exception {
     Function thisFunction = luceneDestroyIndexFunction;
-    ResourcePermission thisRequiredPermission = clusterManageLucene;
+    ResourcePermission thisRequiredPermission = CLUSTER_MANAGE_LUCENE;
 
     gfsh.executeAndAssertThat("execute function --id=" + thisFunction.getId())
         .containsOutput("not authorized for " + thisRequiredPermission.toString())
@@ -291,7 +290,7 @@ public void testInvalidPermissionsForLuceneDestroyIndexFunction() throws Excepti
   @ConnectionConfiguration(user = "noPermissions", password = "noPermissions")
   public void testInvalidPermissionsForLuceneListIndexFunction() throws Exception {
     Function thisFunction = luceneListIndexFunction;
-    ResourcePermission thisRequiredPermission = clusterReadLucene;
+    ResourcePermission thisRequiredPermission = CLUSTER_READ_LUCENE;
 
     gfsh.executeAndAssertThat("execute function --id=" + thisFunction.getId())
         .containsOutput("not authorized for " + thisRequiredPermission.toString())
@@ -305,9 +304,9 @@ public void testInvalidPermissionsForDumpDirectoryFilesWithoutRegionParameter_no
     Function thisFunction = dumpDirectoryFiles;
 
     Predicate<String> notAuthForDataRead =
-        s -> s.contains("not authorized for " + dataRead.toString());
+        s -> s.contains("not authorized for " + DATA_READ.toString());
     Predicate<String> notAuthForClusterManage =
-        s -> s.contains("not authorized for " + clusterManage.toString());
+        s -> s.contains("not authorized for " + CLUSTER_MANAGE.toString());
     Predicate<String> notAuthForSomePermission =
         s -> notAuthForDataRead.test(s) || notAuthForClusterManage.test(s);
 
@@ -323,7 +322,7 @@ public void testInvalidPermissionsForDumpDirectoryFilesWithoutRegionParameter_no
   public void testInvalidPermissionsForDumpDirectoryFilesWithoutRegionParameter_withDataRead()
       throws Exception {
     Function thisFunction = dumpDirectoryFiles;
-    ResourcePermission thisMissingPermission = clusterManage;
+    ResourcePermission thisMissingPermission = CLUSTER_MANAGE;
 
     gfsh.executeAndAssertThat("execute function --id=" + thisFunction.getId())
         .containsOutput("not authorized for " + thisMissingPermission.toString()).statusIsSuccess();
@@ -334,7 +333,7 @@ public void testInvalidPermissionsForDumpDirectoryFilesWithoutRegionParameter_wi
   public void testInvalidPermissionsForDumpDirectoryFilesWithoutRegionParameter_withClusterManage()
       throws Exception {
     Function thisFunction = dumpDirectoryFiles;
-    ResourcePermission thisMissingPermission = dataRead;
+    ResourcePermission thisMissingPermission = DATA_READ;
 
     gfsh.executeAndAssertThat("execute function --id=" + thisFunction.getId())
         .containsOutput("not authorized for " + thisMissingPermission.toString()).statusIsSuccess();
@@ -347,9 +346,9 @@ public void testInvalidPermissionsForDumpDirectoryFilesWithRegionParameter_noPer
     Function thisFunction = dumpDirectoryFiles;
 
     Predicate<String> notAuthForDataReadRegion =
-        s -> s.contains("not authorized for " + dataReadRegion.toString());
+        s -> s.contains("not authorized for " + DATA_READ_REGION.toString());
     Predicate<String> notAuthForClusterManage =
-        s -> s.contains("not authorized for " + clusterManage.toString());
+        s -> s.contains("not authorized for " + CLUSTER_MANAGE.toString());
     Predicate<String> notAuthForSomePermission =
         s -> notAuthForDataReadRegion.test(s) || notAuthForClusterManage.test(s);
 
@@ -362,11 +361,11 @@ public void testInvalidPermissionsForDumpDirectoryFilesWithRegionParameter_noPer
   }
 
   @Test
-  @ConnectionConfiguration(user = "dataRead", password = "dataRead")
-  public void testInvalidPermissionsForDumpDirectoryFilesWithRegionParameter_withDataRead()
+  @ConnectionConfiguration(user = "dataReadThis_test_region", password = "dataReadThis_test_region")
+  public void testInvalidPermissionsForDumpDirectoryFilesWithRegionParameter_withDataReadRegion()
       throws Exception {
     Function thisFunction = dumpDirectoryFiles;
-    ResourcePermission thisMissingPermission = clusterManage;
+    ResourcePermission thisMissingPermission = CLUSTER_MANAGE;
 
     gfsh.executeAndAssertThat(
         "execute function  --region=" + regionName + " --id=" + thisFunction.getId())
@@ -378,7 +377,7 @@ public void testInvalidPermissionsForDumpDirectoryFilesWithRegionParameter_withD
   public void testInvalidPermissionsForDumpDirectoryFilesWithRegionParameter_withClusterManage()
       throws Exception {
     Function thisFunction = dumpDirectoryFiles;
-    ResourcePermission thisMissingPermission = dataRead;
+    ResourcePermission thisMissingPermission = DATA_READ;
 
     gfsh.executeAndAssertThat(
         "execute function  --region=" + regionName + " --id=" + thisFunction.getId())
@@ -391,7 +390,7 @@ public void testInvalidPermissionsForDumpDirectoryFilesWithRegionParameter_withC
   public void testInvalidPermissionsForLuceneSearchIndexFunctionWithoutRegionParameter()
       throws Exception {
     Function thisFunction = luceneSearchIndexFunction;
-    ResourcePermission thisRequiredPermission = dataRead;
+    ResourcePermission thisRequiredPermission = DATA_READ;
 
     gfsh.executeAndAssertThat("execute function --id=" + thisFunction.getId())
         .containsOutput("not authorized for " + thisRequiredPermission.toString())
@@ -403,7 +402,7 @@ public void testInvalidPermissionsForLuceneSearchIndexFunctionWithoutRegionParam
   public void testInvalidPermissionsForLuceneSearchIndexFunctionWithRegionParameter()
       throws Exception {
     Function thisFunction = luceneSearchIndexFunction;
-    ResourcePermission thisRequiredPermission = dataReadRegion;
+    ResourcePermission thisRequiredPermission = DATA_READ_REGION;
 
     gfsh.executeAndAssertThat(
         "execute function --region=" + regionName + " --id=" + thisFunction.getId())
@@ -416,7 +415,7 @@ public void testInvalidPermissionsForLuceneSearchIndexFunctionWithRegionParamete
   public void testInvalidPermissionsForLuceneQueryFunctionWithoutRegionParameter()
       throws Exception {
     Function thisFunction = luceneQueryFunction;
-    ResourcePermission thisRequiredPermission = dataRead;
+    ResourcePermission thisRequiredPermission = DATA_READ;
 
     gfsh.executeAndAssertThat("execute function --id=" + thisFunction.getId())
         .containsOutput("not authorized for " + thisRequiredPermission.toString())
@@ -427,7 +426,7 @@ public void testInvalidPermissionsForLuceneQueryFunctionWithoutRegionParameter()
   @ConnectionConfiguration(user = "noPermissions", password = "noPermissions")
   public void testInvalidPermissionsForLuceneQueryFunctionWithRegionParameter() throws Exception {
     Function thisFunction = luceneQueryFunction;
-    ResourcePermission thisRequiredPermission = dataReadRegion;
+    ResourcePermission thisRequiredPermission = DATA_READ_REGION;
 
     gfsh.executeAndAssertThat(
         "execute function --region=" + regionName + " --id=" + thisFunction.getId())
@@ -440,7 +439,7 @@ public void testInvalidPermissionsForLuceneQueryFunctionWithRegionParameter() th
   public void testInvalidPermissionsForWaitUntilFlushedFunctionWithoutRegionParameter()
       throws Exception {
     Function thisFunction = waitUntilFlushedFunction;
-    ResourcePermission thisRequiredPermission = dataRead;
+    ResourcePermission thisRequiredPermission = DATA_READ;
 
     gfsh.executeAndAssertThat("execute function --id=" + thisFunction.getId())
         .containsOutput("not authorized for " + thisRequiredPermission.toString())
@@ -452,7 +451,7 @@ public void testInvalidPermissionsForWaitUntilFlushedFunctionWithoutRegionParame
   public void testInvalidPermissionsForWaitUntilFlushedFunctionWithRegionParameter()
       throws Exception {
     Function thisFunction = waitUntilFlushedFunction;
-    ResourcePermission thisRequiredPermission = dataReadRegion;
+    ResourcePermission thisRequiredPermission = DATA_READ_REGION;
 
     gfsh.executeAndAssertThat(
         "execute function --region=" + regionName + " --id=" + thisFunction.getId())
@@ -465,7 +464,7 @@ public void testInvalidPermissionsForWaitUntilFlushedFunctionWithRegionParameter
   public void testInvalidPermissionsForLuceneGetPageFunctionWithoutRegionParameter()
       throws Exception {
     Function thisFunction = luceneGetPageFunction;
-    ResourcePermission thisRequiredPermission = dataRead;
+    ResourcePermission thisRequiredPermission = DATA_READ;
 
     gfsh.executeAndAssertThat("execute function --id=" + thisFunction.getId())
         .containsOutput("not authorized for " + thisRequiredPermission.toString())
@@ -476,19 +475,11 @@ public void testInvalidPermissionsForLuceneGetPageFunctionWithoutRegionParameter
   @ConnectionConfiguration(user = "noPermissions", password = "noPermissions")
   public void testInvalidPermissionsForLuceneGetPageFunctionWithRegionParameter() throws Exception {
     Function thisFunction = luceneGetPageFunction;
-    ResourcePermission thisRequiredPermission = dataReadRegion;
+    ResourcePermission thisRequiredPermission = DATA_READ_REGION;
 
     gfsh.executeAndAssertThat(
         "execute function --region=" + regionName + " --id=" + thisFunction.getId())
         .containsOutput("not authorized for " + thisRequiredPermission.toString())
         .statusIsSuccess();
   }
-
-  private static Answer<Void> announceNoOp() {
-    return invocation -> {
-      String mockedName = invocation.getMethod().getName();
-      logger.info("Performing no-op mock of " + mockedName);
-      return null;
-    };
-  }
 }
