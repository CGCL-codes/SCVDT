From 92535ae3de7178008f70bac94adb8155eeba3848 Mon Sep 17 00:00:00 2001
From: Keith Wall <kwall@apache.org>
Date: Wed, 8 Nov 2017 11:26:27 +0000
Subject: [PATCH] QPID-7947: [Broker-J] Improve frame handling

Merged by hand from master 66cef783f63ceb0252fbf236ae0577aa5e14b23d
---
 .../server/protocol/v1_0/framing/FrameHandler.java  | 13 +++++++------
 1 file changed, 7 insertions(+), 6 deletions(-)

diff --git a/broker-plugins/amqp-1-0-protocol/src/main/java/org/apache/qpid/server/protocol/v1_0/framing/FrameHandler.java b/broker-plugins/amqp-1-0-protocol/src/main/java/org/apache/qpid/server/protocol/v1_0/framing/FrameHandler.java
index 942629c712..bfebd23062 100644
--- a/broker-plugins/amqp-1-0-protocol/src/main/java/org/apache/qpid/server/protocol/v1_0/framing/FrameHandler.java
+++ b/broker-plugins/amqp-1-0-protocol/src/main/java/org/apache/qpid/server/protocol/v1_0/framing/FrameHandler.java
@@ -65,12 +65,6 @@ public ProtocolHandler parse(QpidByteBuffer in)
             {
 
                 size = in.getInt();
-                if(remaining < size)
-                {
-                    in.position(in.position()-4);
-                    break;
-                }
-                int dataOffset = (in.get() << 2) & 0x3FF;
 
                 if (size < 8)
                 {
@@ -90,6 +84,13 @@ public ProtocolHandler parse(QpidByteBuffer in)
                     break;
                 }
 
+                if(remaining < size)
+                {
+                    in.position(in.position()-4);
+                    break;
+                }
+                int dataOffset = (in.get() << 2) & 0x3FF;
+
                 if (dataOffset < 8)
                 {
                     frameParsingError = createFramingError(
