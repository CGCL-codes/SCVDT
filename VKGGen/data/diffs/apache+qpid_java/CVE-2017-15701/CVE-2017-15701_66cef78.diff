From 66cef783f63ceb0252fbf236ae0577aa5e14b23d Mon Sep 17 00:00:00 2001
From: Rob Godfrey <rgodfrey@apache.org>
Date: Mon, 2 Oct 2017 23:45:33 +0200
Subject: [PATCH] QPID-7947 : [Java Broker] [AMQP 1.0] Improve handling of
 empty and overlarge frames

---
 .../protocol/v1_0/framing/FrameHandler.java   | 52 ++++++++++++-------
 1 file changed, 34 insertions(+), 18 deletions(-)

diff --git a/broker-plugins/amqp-1-0-protocol/src/main/java/org/apache/qpid/server/protocol/v1_0/framing/FrameHandler.java b/broker-plugins/amqp-1-0-protocol/src/main/java/org/apache/qpid/server/protocol/v1_0/framing/FrameHandler.java
index 523aec1486..6dd69bd220 100644
--- a/broker-plugins/amqp-1-0-protocol/src/main/java/org/apache/qpid/server/protocol/v1_0/framing/FrameHandler.java
+++ b/broker-plugins/amqp-1-0-protocol/src/main/java/org/apache/qpid/server/protocol/v1_0/framing/FrameHandler.java
@@ -72,12 +72,6 @@ public ProtocolHandler parse(QpidByteBuffer in)
             {
 
                 size = in.getInt();
-                if(remaining < size)
-                {
-                    in.position(in.position()-4);
-                    break;
-                }
-                int dataOffset = (in.get() << 2) & 0x3FF;
 
                 if (size < 8)
                 {
@@ -97,6 +91,13 @@ public ProtocolHandler parse(QpidByteBuffer in)
                     break;
                 }
 
+                if(remaining < size)
+                {
+                    in.position(in.position()-4);
+                    break;
+                }
+                int dataOffset = (in.get() << 2) & 0x3FF;
+
                 if (dataOffset < 8)
                 {
                     frameParsingError = createFramingError(
@@ -154,25 +155,40 @@ public ProtocolHandler parse(QpidByteBuffer in)
 
                 try
                 {
-                    Object val = dup.hasRemaining() ? _valueHandler.parse(dup) : null;
-
-                    if (dup.hasRemaining())
+                    final boolean hasFrameBody = dup.hasRemaining();
+                    Object frameBody;
+                    if (hasFrameBody)
                     {
-                        if (val instanceof Transfer)
+                        frameBody = _valueHandler.parse(dup);
+                        if (dup.hasRemaining())
                         {
-                            final QpidByteBuffer payload = dup.slice();
-                            ((Transfer) val).setPayload(Collections.singletonList(payload));
-                            payload.dispose();
+                            if (frameBody instanceof Transfer)
+                            {
+                                final QpidByteBuffer payload = dup.slice();
+                                ((Transfer) frameBody).setPayload(Collections.singletonList(payload));
+                                payload.dispose();
+                            }
+                            else
+                            {
+                                frameParsingError = createFramingError(
+                                        "Frame length %d larger than contained frame body %s.",
+                                        size,
+                                        frameBody);
+                                break;
+                            }
                         }
-                        else
+                    }
+                    else
+                    {
+                        frameBody = null;
+                        if(_isSasl)
                         {
                             frameParsingError = createFramingError(
-                                    "Frame length %d larger than contained frame body %s.",
-                                    size,
-                                    val);
+                                    "Empty (heartbeat) frames are not permitted during SASL negotiation");
                             break;
                         }
                     }
+
                     channelFrameBodies.add(new ChannelFrameBody()
                     {
                         @Override
@@ -184,7 +200,7 @@ public int getChannel()
                         @Override
                         public Object getFrameBody()
                         {
-                            return val;
+                            return frameBody;
                         }
                     });
                 }
