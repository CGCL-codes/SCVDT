Index: branches/6.0.x/broker-plugins/amqp-0-10-protocol/src/main/java/org/apache/qpid/server/protocol/v0_10/ServerConnectionDelegate.java
===================================================================
--- branches/6.0.x/broker-plugins/amqp-0-10-protocol/src/main/java/org/apache/qpid/server/protocol/v0_10/ServerConnectionDelegate.java	(revision 1743392)
+++ branches/6.0.x/broker-plugins/amqp-0-10-protocol/src/main/java/org/apache/qpid/server/protocol/v0_10/ServerConnectionDelegate.java	(revision 1743393)
@@ -50,6 +50,7 @@
 import org.apache.qpid.server.security.auth.SubjectAuthenticationResult;
 import org.apache.qpid.server.transport.AMQPConnection;
 import org.apache.qpid.server.virtualhost.VirtualHostImpl;
+import org.apache.qpid.server.util.ConnectionScopedRuntimeException;
 import org.apache.qpid.server.virtualhost.VirtualHostUnavailableException;
 import org.apache.qpid.transport.*;
 import org.apache.qpid.transport.network.NetworkConnection;
@@ -111,8 +112,10 @@
     {
         if(_state != requiredState)
         {
-            conn.sendConnectionClose(ConnectionCloseCode.FRAMING_ERROR, "Command Invalid expected "+requiredState+" but was "+_state);
+            String replyText = "Command Invalid, expected " + requiredState + " but was " + _state;
+            conn.sendConnectionClose(ConnectionCloseCode.FRAMING_ERROR, replyText);
             conn.closeAndIgnoreFutureInput();
+            throw new ConnectionScopedRuntimeException(replyText);
         }
     }
 
Index: branches/6.0.x/broker-plugins/amqp-0-8-protocol/src/main/java/org/apache/qpid/server/protocol/v0_8/AMQPConnection_0_8.java
===================================================================
--- branches/6.0.x/broker-plugins/amqp-0-8-protocol/src/main/java/org/apache/qpid/server/protocol/v0_8/AMQPConnection_0_8.java	(revision 1743392)
+++ branches/6.0.x/broker-plugins/amqp-0-8-protocol/src/main/java/org/apache/qpid/server/protocol/v0_8/AMQPConnection_0_8.java	(revision 1743393)
@@ -995,8 +995,9 @@
     {
         if(_state != requiredState)
         {
-            sendConnectionClose(AMQConstant.COMMAND_INVALID, "Command Invalid", 0);
-
+            String replyText = "Command Invalid, expected " + requiredState + " but was " + _state;
+            sendConnectionClose(AMQConstant.COMMAND_INVALID, replyText, 0);
+            throw new ConnectionScopedRuntimeException(replyText);
         }
     }
 
@@ -1010,6 +1011,8 @@
             _logger.debug("RECV ConnectionOpen[" +" virtualHost: " + virtualHostName + " capabilities: " + capabilities + " insist: " + insist + " ]");
         }
 
+        assertState(ConnectionState.AWAIT_OPEN);
+
         String virtualHostStr = AMQShortString.toString(virtualHostName);
         if ((virtualHostStr != null) && virtualHostStr.charAt(0) == '/')
         {
Index: branches/6.0.x
===================================================================
--- branches/6.0.x	(revision 1743392)
+++ branches/6.0.x	(revision 1743393)

Property changes on: branches/6.0.x
___________________________________________________________________
Modified: svn:mergeinfo
## -0,0 +0,1 ##
   Merged /qpid/java/trunk:r1743161
