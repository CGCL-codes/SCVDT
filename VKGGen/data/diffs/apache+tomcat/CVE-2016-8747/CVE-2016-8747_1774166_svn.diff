Index: tc8.5.x/trunk/java/org/apache/coyote/http11/Http11InputBuffer.java
===================================================================
--- tc8.5.x/trunk/java/org/apache/coyote/http11/Http11InputBuffer.java	(revision 1774165)
+++ tc8.5.x/trunk/java/org/apache/coyote/http11/Http11InputBuffer.java	(revision 1774166)
@@ -296,12 +296,16 @@
     void nextRequest() {
         request.recycle();
 
-        // Copy leftover bytes to the beginning of the buffer
-        if (byteBuffer.remaining() > 0 && byteBuffer.position() > 0) {
-            byteBuffer.compact();
+        if (byteBuffer.position() > 0) {
+            if (byteBuffer.remaining() > 0) {
+                // Copy leftover bytes to the beginning of the buffer
+                byteBuffer.compact();
+                byteBuffer.flip();
+            } else {
+                // Reset position and limit to 0
+                byteBuffer.position(0).limit(0);
+            }
         }
-        // Always reset pos to zero
-        byteBuffer.limit(byteBuffer.limit() - byteBuffer.position()).position(0);
 
         // Recycle filters
         for (int i = 0; i <= lastActiveFilter; i++) {
Index: tc8.5.x/trunk/webapps/docs/changelog.xml
===================================================================
--- tc8.5.x/trunk/webapps/docs/changelog.xml	(revision 1774165)
+++ tc8.5.x/trunk/webapps/docs/changelog.xml	(revision 1774166)
@@ -83,6 +83,11 @@
         when configured with an address of <code>0.0.0.0</code> or
         <code>::</code>. (markt)
       </fix>
+      <fix>
+        Correct a regression in the refactoring to make wider use of
+        <code>ByteBuffer</code> that caused an intermittent failure in the unit
+        tests. (markt)
+      </fix>
     </changelog>
   </subsection>
   <subsection name="Web Applications">
Index: tc8.5.x/trunk
===================================================================
--- tc8.5.x/trunk	(revision 1774165)
+++ tc8.5.x/trunk	(revision 1774166)

Property changes on: tc8.5.x/trunk
___________________________________________________________________
Modified: svn:mergeinfo
## -0,0 +0,1 ##
   Merged /tomcat/trunk:r1774161,1774164
