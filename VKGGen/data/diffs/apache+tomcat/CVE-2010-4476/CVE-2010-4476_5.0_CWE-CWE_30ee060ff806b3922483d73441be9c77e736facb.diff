commit 30ee060ff806b3922483d73441be9c77e736facb
Author:     Konstantin Kolinko <kkolinko@apache.org>
AuthorDate: Tue Feb 1 22:12:18 2011 +0000
Commit:     Konstantin Kolinko <kkolinko@apache.org>
CommitDate: Tue Feb 1 22:12:18 2011 +0000

    Improve HTTP specification compliance
    This works-around the Oracle JVM bug that triggers a DoS. CVE-2010-4476.
    
    git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1066244 13f79535-47bb-0310-9956-ffa450edef68

diff --git a/java/org/apache/catalina/connector/Request.java b/java/org/apache/catalina/connector/Request.java
index e2c2399b5e..231219499f 100644
--- a/java/org/apache/catalina/connector/Request.java
+++ b/java/org/apache/catalina/connector/Request.java
@@ -3005,7 +3005,12 @@ public class Request
             int semi = entry.indexOf(";q=");
             if (semi >= 0) {
                 try {
-                    quality = Double.parseDouble(entry.substring(semi + 3));
+                    String strQuality = entry.substring(semi + 3);
+                    if (strQuality.length() <= 5) {
+                        quality = Double.parseDouble(strQuality);
+                    } else {
+                        quality = 0.0;
+                    }
                 } catch (NumberFormatException e) {
                     quality = 0.0;
                 }
diff --git a/webapps/docs/changelog.xml b/webapps/docs/changelog.xml
index 5b7f1c9d5f..fd6d004f75 100644
--- a/webapps/docs/changelog.xml
+++ b/webapps/docs/changelog.xml
@@ -113,6 +113,10 @@
         to <code>false</code> in the Host where a web application is deployed.
         (markt)
       </fix>
+      <fix>
+        Improve HTTP specification compliance in support of
+        <code>Accept-Language</code> header. (kkolinko)
+      </fix>
     </changelog>
   </subsection>
   <subsection name="Coyote">
