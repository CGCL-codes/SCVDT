Index: tc8.5.x/trunk/java/org/apache/tomcat/util/net/NioEndpoint.java
===================================================================
--- tc8.5.x/trunk/java/org/apache/tomcat/util/net/NioEndpoint.java	(revision 1771856)
+++ tc8.5.x/trunk/java/org/apache/tomcat/util/net/NioEndpoint.java	(revision 1771857)
@@ -888,7 +888,6 @@
                     // Setup the file channel
                     File f = new File(sd.fileName);
                     if (!f.exists()) {
-                        cancelledKey(sk);
                         return SendfileState.ERROR;
                     }
                     @SuppressWarnings("resource") // Closed when channel is closed
@@ -962,8 +961,6 @@
                 if (log.isDebugEnabled()) log.debug("Unable to complete sendfile request:", x);
                 if (!calledByProcessor && sc != null) {
                     close(sc, sk);
-                } else {
-                    cancelledKey(sk);
                 }
                 return SendfileState.ERROR;
             } catch (Throwable t) {
@@ -970,8 +967,6 @@
                 log.error("", t);
                 if (!calledByProcessor && sc != null) {
                     close(sc, sk);
-                } else {
-                    cancelledKey(sk);
                 }
                 return SendfileState.ERROR;
             }
Index: tc8.5.x/trunk/test/org/apache/catalina/connector/TestSendFile.java
===================================================================
--- tc8.5.x/trunk/test/org/apache/catalina/connector/TestSendFile.java	(revision 1771856)
+++ tc8.5.x/trunk/test/org/apache/catalina/connector/TestSendFile.java	(revision 1771857)
@@ -39,7 +39,6 @@
 import static org.junit.Assert.assertEquals;
 import static org.junit.Assert.fail;
 
-import org.junit.Ignore;
 import org.junit.Test;
 
 import org.apache.catalina.Context;
@@ -157,7 +156,6 @@
     }
 
 
-    @Ignore
     @Test
     public void testBug60409() throws Exception {
         Tomcat tomcat = getTomcatInstance();
Index: tc8.5.x/trunk/webapps/docs/changelog.xml
===================================================================
--- tc8.5.x/trunk/webapps/docs/changelog.xml	(revision 1771856)
+++ tc8.5.x/trunk/webapps/docs/changelog.xml	(revision 1771857)
@@ -140,6 +140,10 @@
         removing closed streams from the priority tree to ensure that the tree
         does not grow too large. (markt)
       </fix>
+      <fix>
+        <bug>60409</bug>: When unable to complete sendfile request, ensure the
+        Processor will be added to the cache only once. (markt/violetagg)
+      </fix>
     </changelog>
   </subsection>
   <subsection name="Web applications">
Index: tc8.5.x/trunk
===================================================================
--- tc8.5.x/trunk	(revision 1771856)
+++ tc8.5.x/trunk	(revision 1771857)

Property changes on: tc8.5.x/trunk
___________________________________________________________________
Modified: svn:mergeinfo
## -0,0 +0,1 ##
   Merged /tomcat/trunk:r1771853
