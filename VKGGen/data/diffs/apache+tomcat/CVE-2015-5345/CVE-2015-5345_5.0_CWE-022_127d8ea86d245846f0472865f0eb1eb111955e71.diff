commit 127d8ea86d245846f0472865f0eb1eb111955e71
Author:     Mark Thomas <markt@apache.org>
AuthorDate: Fri Nov 27 16:11:23 2015 +0000
Commit:     Mark Thomas <markt@apache.org>
CommitDate: Fri Nov 27 16:11:23 2015 +0000

    Additional fix for BZ 58660
    When Mapper root redirect is enabled, ensure '/' is added to path for redirect
    This is part 3 of 3 of the fix for CVE-2015-5345
    
    git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1716894 13f79535-47bb-0310-9956-ffa450edef68

diff --git a/java/org/apache/catalina/mapper/Mapper.java b/java/org/apache/catalina/mapper/Mapper.java
index cb25eda611..0f078d8861 100644
--- a/java/org/apache/catalina/mapper/Mapper.java
+++ b/java/org/apache/catalina/mapper/Mapper.java
@@ -879,8 +879,10 @@ public final class Mapper {
         if(mappingData.wrapper == null && noServletPath &&
                 mappingData.context.getMapperContextRootRedirectEnabled()) {
             // The path is empty, redirect to "/"
+            path.append('/');
+            pathEnd = path.getEnd();
             mappingData.redirectPath.setChars
-                (path.getBuffer(), pathOffset, pathEnd-pathOffset);
+                (path.getBuffer(), pathOffset, pathEnd - pathOffset);
             path.setEnd(pathEnd - 1);
             return;
         }
