Index: tc7.0.x/trunk/java/org/apache/coyote/http11/InternalNioInputBuffer.java
===================================================================
--- tc7.0.x/trunk/java/org/apache/coyote/http11/InternalNioInputBuffer.java	(revision 1350300)
+++ tc7.0.x/trunk/java/org/apache/coyote/http11/InternalNioInputBuffer.java	(revision 1350301)
@@ -473,10 +473,6 @@
         
         do {
             status = parseHeader();
-        } while ( status == HeaderParseStatus.HAVE_MORE_HEADERS );
-        if (status == HeaderParseStatus.DONE) {
-            parsingHeader = false;
-            end = pos;
             // Checking that
             // (1) Headers plus request line size does not exceed its limit
             // (2) There are enough bytes to avoid expanding the buffer when
@@ -485,11 +481,15 @@
             // limitation to enforce the meaning of headerBufferSize
             // From the way how buf is allocated and how blank lines are being
             // read, it should be enough to check (1) only.
-            if (end - skipBlankLinesBytes > headerBufferSize
-                    || buf.length - end < socketReadBufferSize) {
+            if (pos - skipBlankLinesBytes > headerBufferSize
+                    || buf.length - pos < socketReadBufferSize) {
                 throw new IllegalArgumentException(
                         sm.getString("iib.requestheadertoolarge.error"));
             }
+        } while ( status == HeaderParseStatus.HAVE_MORE_HEADERS );
+        if (status == HeaderParseStatus.DONE) {
+            parsingHeader = false;
+            end = pos;
             return true;
         } else {
             return false;
Index: tc7.0.x/trunk/webapps/docs/changelog.xml
===================================================================
--- tc7.0.x/trunk/webapps/docs/changelog.xml	(revision 1350300)
+++ tc7.0.x/trunk/webapps/docs/changelog.xml	(revision 1350301)
@@ -315,6 +315,9 @@
         <bug>53406</bug>: Fix possible stack overflow on connection close when
         using Comet. (fhanik)
       </fix>
+      <fix>
+        Improve <code>InternalNioInputBuffer.parseHeaders()</code>. (kkolinko)
+      </fix>
     </changelog>
   </subsection>
   <subsection name="Jasper">
Index: tc7.0.x/trunk
===================================================================
--- tc7.0.x/trunk	(revision 1350300)
+++ tc7.0.x/trunk	(revision 1350301)

Property changes on: tc7.0.x/trunk
___________________________________________________________________
Modified: svn:mergeinfo
## -0,0 +0,1 ##
   Merged /tomcat/trunk:r1350294
