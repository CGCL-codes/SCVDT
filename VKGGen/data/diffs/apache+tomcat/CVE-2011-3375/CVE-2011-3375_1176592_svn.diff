Index: tc7.0.x/trunk/java/org/apache/coyote/http11/AbstractHttp11Processor.java
===================================================================
--- tc7.0.x/trunk/java/org/apache/coyote/http11/AbstractHttp11Processor.java	(revision 1176591)
+++ tc7.0.x/trunk/java/org/apache/coyote/http11/AbstractHttp11Processor.java	(revision 1176592)
@@ -897,7 +897,6 @@
                 if (endpoint.isPaused()) {
                     // 503 - Service unavailable
                     response.setStatus(503);
-                    adapter.log(request, response, 0);
                     error = true;
                 } else {
                     request.setStartTime(System.currentTimeMillis());
@@ -1087,7 +1086,6 @@
                           " Unsupported HTTP version \""+protocolMB+"\"");
             }
             response.setStatus(505);
-            adapter.log(request, response, 0);
         }
 
         MessageBytes methodMB = request.method();
@@ -1183,7 +1181,6 @@
                     error = true;
                     // 501 - Unimplemented
                     response.setStatus(501);
-                    adapter.log(request, response, 0);
                 }
                 startPos = commaPos + 1;
                 commaPos = transferEncodingValue.indexOf(',', startPos);
@@ -1199,7 +1196,6 @@
                               " Unsupported transfer encoding \""+encodingName+"\"");
                 }
                 response.setStatus(501);
-                adapter.log(request, response, 0);
             }
         }
 
@@ -1222,7 +1218,6 @@
                           " host header missing");
             }
             response.setStatus(400);
-            adapter.log(request, response, 0);
         }
 
         parseHost(valueMB);
@@ -1252,6 +1247,10 @@
             request.setAttribute("org.apache.tomcat.comet.timeout.support",
                     Boolean.TRUE);
         }
+        
+        if (error) {
+            adapter.log(request, response, 0);
+        }
     }
 
 
@@ -1471,7 +1470,6 @@
                     error = true;
                     // 400 - Bad request
                     response.setStatus(400);
-                    adapter.log(request, response, 0);
                     break;
                 }
                 port = port + (charValue * mult);
@@ -1552,8 +1550,9 @@
             ExceptionUtils.handleThrowable(t);
             getLog().error(sm.getString("http11processor.request.finish"), t);
             // 500 - Internal Server Error
+            // Can't add a 500 to the access log since that has already been
+            // written in the Adapter.service method.
             response.setStatus(500);
-            adapter.log(request, response, 0);
             error = true;
         }
         try {
Index: tc7.0.x/trunk/java/org/apache/coyote/ajp/AjpNioProcessor.java
===================================================================
--- tc7.0.x/trunk/java/org/apache/coyote/ajp/AjpNioProcessor.java	(revision 1176591)
+++ tc7.0.x/trunk/java/org/apache/coyote/ajp/AjpNioProcessor.java	(revision 1176592)
@@ -169,7 +169,7 @@
                 }
             }
 
-            if (!cping && endpoint.isPaused()) {
+            if (!error && !cping && endpoint.isPaused()) {
                 // 503 - Service unavailable
                 response.setStatus(503);
                 adapter.log(request, response, 0);
Index: tc7.0.x/trunk/java/org/apache/coyote/ajp/AjpProcessor.java
===================================================================
--- tc7.0.x/trunk/java/org/apache/coyote/ajp/AjpProcessor.java	(revision 1176591)
+++ tc7.0.x/trunk/java/org/apache/coyote/ajp/AjpProcessor.java	(revision 1176592)
@@ -185,7 +185,7 @@
                 }
             }
 
-            if (!cping && endpoint.isPaused()) {
+            if (!error && !cping && endpoint.isPaused()) {
                 // 503 - Service unavailable
                 response.setStatus(503);
                 adapter.log(request, response, 0);
Index: tc7.0.x/trunk/java/org/apache/coyote/ajp/AjpAprProcessor.java
===================================================================
--- tc7.0.x/trunk/java/org/apache/coyote/ajp/AjpAprProcessor.java	(revision 1176591)
+++ tc7.0.x/trunk/java/org/apache/coyote/ajp/AjpAprProcessor.java	(revision 1176592)
@@ -182,7 +182,7 @@
                 }
             }
 
-            if (!cping && endpoint.isPaused()) {
+            if (!error && !cping && endpoint.isPaused()) {
                 // 503 - Service unavailable
                 response.setStatus(503);
                 adapter.log(request, response, 0);
Index: tc7.0.x/trunk/java/org/apache/coyote/ajp/AbstractAjpProcessor.java
===================================================================
--- tc7.0.x/trunk/java/org/apache/coyote/ajp/AbstractAjpProcessor.java	(revision 1176591)
+++ tc7.0.x/trunk/java/org/apache/coyote/ajp/AbstractAjpProcessor.java	(revision 1176592)
@@ -759,7 +759,6 @@
                     secret = true;
                     if (!tmpMB.equals(requiredSecret)) {
                         response.setStatus(403);
-                        adapter.log(request, response, 0);
                         error = true;
                     }
                 }
@@ -776,7 +775,6 @@
         // Check if secret was submitted if required
         if ((requiredSecret != null) && !secret) {
             response.setStatus(403);
-            adapter.log(request, response, 0);
             error = true;
         }
 
@@ -810,6 +808,9 @@
         MessageBytes valueMB = request.getMimeHeaders().getValue("host");
         parseHost(valueMB);
 
+        if (error) {
+            adapter.log(request, response, 0);
+        }
     }
 
 
@@ -825,7 +826,6 @@
                 request.serverName().duplicate(request.localName());
             } catch (IOException e) {
                 response.setStatus(400);
-                adapter.log(request, response, 0);
                 error = true;
             }
             return;
@@ -877,7 +877,6 @@
                     error = true;
                     // 400 - Bad request
                     response.setStatus(400);
-                    adapter.log(request, response, 0);
                     break;
                 }
                 port = port + (charValue * mult);
Index: tc7.0.x/trunk/java/org/apache/catalina/connector/CoyoteAdapter.java
===================================================================
--- tc7.0.x/trunk/java/org/apache/catalina/connector/CoyoteAdapter.java	(revision 1176591)
+++ tc7.0.x/trunk/java/org/apache/catalina/connector/CoyoteAdapter.java	(revision 1176592)
@@ -466,10 +466,8 @@
 
         Request request = (Request) req.getNote(ADAPTER_NOTES);
         Response response = (Response) res.getNote(ADAPTER_NOTES);
-        boolean create = false;
         
         if (request == null) {
-            create = true;
             // Create objects
             request = connector.createRequest();
             request.setCoyoteRequest(req);
@@ -511,9 +509,7 @@
         } catch (Throwable t) {
             ExceptionUtils.handleThrowable(t);
             log.warn(sm.getString("coyoteAdapter.accesslogFail"), t);
-        }
-        
-        if (create) {
+        } finally {
             request.recycle();
             response.recycle();
         }
Index: tc7.0.x/trunk/webapps/docs/changelog.xml
===================================================================
--- tc7.0.x/trunk/webapps/docs/changelog.xml	(revision 1176591)
+++ tc7.0.x/trunk/webapps/docs/changelog.xml	(revision 1176592)
@@ -133,6 +133,11 @@
         Ensure Servlets that implement ContainerServlet always get treated as
         restricted. (markt)
       </fix>
+      <fix>
+        Ensure that the access log always uses the correct value for the remote
+        IP address associated with the request and that requests with multiple
+        errors do not result in multiple entires in the access log. (markt)
+      </fix>
     </changelog>
   </subsection>
   <subsection name="Coyote">
Index: tc7.0.x/trunk
===================================================================
--- tc7.0.x/trunk	(revision 1176591)
+++ tc7.0.x/trunk	(revision 1176592)

Property changes on: tc7.0.x/trunk
___________________________________________________________________
Modified: svn:mergeinfo
## -0,0 +0,1 ##
   Merged /tomcat/trunk:r1176590
