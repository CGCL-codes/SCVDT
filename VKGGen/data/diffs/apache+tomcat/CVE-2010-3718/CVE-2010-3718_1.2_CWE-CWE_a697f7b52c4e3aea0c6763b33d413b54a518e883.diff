commit a697f7b52c4e3aea0c6763b33d413b54a518e883
Author:     Mark Emlyn David Thomas <markt@apache.org>
AuthorDate: Wed Oct 13 15:16:35 2010 +0000
Commit:     Mark Emlyn David Thomas <markt@apache.org>
CommitDate: Wed Oct 13 15:16:35 2010 +0000

    Ensure work dir attribute is made read-only
    CVE-2010-3718
    
    git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1022134 13f79535-47bb-0310-9956-ffa450edef68

diff --git a/java/org/apache/catalina/core/StandardContext.java b/java/org/apache/catalina/core/StandardContext.java
index e810ebf38d..e46e76139f 100644
--- a/java/org/apache/catalina/core/StandardContext.java
+++ b/java/org/apache/catalina/core/StandardContext.java
@@ -5562,11 +5562,11 @@ public class StandardContext extends ContainerBase
         dir.mkdirs();
 
         // Set the appropriate servlet context attribute
-        getServletContext().setAttribute(ServletContext.TEMPDIR, dir);
-        if (getServletContext() instanceof ApplicationContext)
-            ((ApplicationContext) getServletContext()).setAttributeReadOnly
-                (ServletContext.TEMPDIR);
-
+        if (context == null) {
+            getServletContext();
+        }
+        context.setAttribute(ServletContext.TEMPDIR, dir);
+        context.setAttributeReadOnly(ServletContext.TEMPDIR);
     }
 
 
