Index: trunk/java/org/apache/tomcat/util/net/NioEndpoint.java
===================================================================
--- trunk/java/org/apache/tomcat/util/net/NioEndpoint.java	(revision 1145382)
+++ trunk/java/org/apache/tomcat/util/net/NioEndpoint.java	(revision 1145383)
@@ -1240,6 +1240,13 @@
                         sd.pos += written;
                         sd.length -= written;
                         attachment.access();
+                    } else {
+                        // Unusual not to be unable to transfer any bytes
+                        // Check the length was set correctly
+                        if (sd.fchannel.size() <= sd.pos) {
+                            throw new IOException("Sendfile configured to " +
+                                    "send more data than was available");
+                        }
                     }
                 }
                 if ( sd.length <= 0 && sc.getOutboundRemaining()<=0) {
Index: trunk/webapps/docs/changelog.xml
===================================================================
--- trunk/webapps/docs/changelog.xml	(revision 1145382)
+++ trunk/webapps/docs/changelog.xml	(revision 1145383)
@@ -120,6 +120,10 @@
         Add missing thread name in RequestProcessor when Servlet 3 Async
         is used. Fixes null thread name in access log and JMX MBean. (rjung)
       </fix>
+      <fix>
+        Protect against infinite loops in the HTTP NIO connector if sendfile is
+        configured to send more data than is available in the file. (markt)
+      </fix>
     </changelog>
   </subsection>
   <subsection name="Cluster">
