commit f0488ac8a449ac3efa8df9a560c42a835231a479
Author:     Mark Emlyn David Thomas <markt@apache.org>
AuthorDate: Tue Jul 12 12:51:35 2011 +0000
Commit:     Mark Emlyn David Thomas <markt@apache.org>
CommitDate: Tue Jul 12 12:51:35 2011 +0000

    Socket has been closed, return false so an attempt is not made to re-use the socket
    Part of the fix for CVE-2011-2526
    
    git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1145571 13f79535-47bb-0310-9956-ffa450edef68

diff --git a/java/org/apache/tomcat/util/net/NioEndpoint.java b/java/org/apache/tomcat/util/net/NioEndpoint.java
index 2f5344f753..8cd7c06bf2 100644
--- a/java/org/apache/tomcat/util/net/NioEndpoint.java
+++ b/java/org/apache/tomcat/util/net/NioEndpoint.java
@@ -1271,6 +1271,7 @@ public class NioEndpoint extends AbstractEndpoint {
                             log.debug("Send file connection is being closed");
                         }
                         cancelledKey(sk,SocketStatus.STOP,false);
+                        return false;
                     }
                 } else if ( attachment.interestOps() == 0 && reg ) {
                     if (log.isDebugEnabled()) {
diff --git a/webapps/docs/changelog.xml b/webapps/docs/changelog.xml
index a0fa744c63..d82ee63ec9 100644
--- a/webapps/docs/changelog.xml
+++ b/webapps/docs/changelog.xml
@@ -124,6 +124,10 @@
         Protect against infinite loops in the HTTP NIO connector if sendfile is
         configured to send more data than is available in the file. (markt)
       </fix>
+      <fix>
+        Prevent NPEs when a socket is closed in non-error conditions after
+        sendfile processing when using the HTTP NIO connector. (markt) 
+      </fix>
     </changelog>
   </subsection>
   <subsection name="Cluster">
