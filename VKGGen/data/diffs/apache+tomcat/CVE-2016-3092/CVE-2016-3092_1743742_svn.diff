Index: tc7.0.x/trunk/java/org/apache/tomcat/util/http/fileupload/MultipartStream.java
===================================================================
--- tc7.0.x/trunk/java/org/apache/tomcat/util/http/fileupload/MultipartStream.java	(revision 1743741)
+++ tc7.0.x/trunk/java/org/apache/tomcat/util/http/fileupload/MultipartStream.java	(revision 1743742)
@@ -282,11 +282,10 @@
             byte[] boundary,
             int bufSize,
             ProgressNotifier pNotifier) {
-        this.input = input;
-        this.bufSize = bufSize;
-        this.buffer = new byte[bufSize];
-        this.notifier = pNotifier;
 
+        if (boundary == null) {
+            throw new IllegalArgumentException("boundary may not be null");
+        }
         // We prepend CR/LF to the boundary to chop trailing CR/LF from
         // body-data tokens.
         this.boundaryLength = boundary.length + BOUNDARY_PREFIX.length;
@@ -294,6 +293,12 @@
             throw new IllegalArgumentException(
                     "The buffer size specified for the MultipartStream is too small");
         }
+
+        this.input = input;
+        this.bufSize = Math.max(bufSize, boundaryLength*2);
+        this.buffer = new byte[this.bufSize];
+        this.notifier = pNotifier;
+
         this.boundary = new byte[this.boundaryLength];
         this.keepRegion = this.boundary.length;
 
Index: tc7.0.x/trunk/java/org/apache/tomcat/util/http/fileupload
===================================================================
--- tc7.0.x/trunk/java/org/apache/tomcat/util/http/fileupload	(revision 1743741)
+++ tc7.0.x/trunk/java/org/apache/tomcat/util/http/fileupload	(revision 1743742)

Property changes on: tc7.0.x/trunk/java/org/apache/tomcat/util/http/fileupload
___________________________________________________________________
Modified: svn:mergeinfo
## -0,0 +0,3 ##
   Merged /commons/proper/fileupload/trunk/src/main/java/org/apache/commons/fileupload:r1725745-1743698
   Merged /tomcat/trunk/java/org/apache/tomcat/util/http/fileupload:r1743700
   Merged /tomcat/tc8.5.x/trunk/java/org/apache/tomcat/util/http/fileupload:r1743722
Index: tc7.0.x/trunk/webapps/docs/changelog.xml
===================================================================
--- tc7.0.x/trunk/webapps/docs/changelog.xml	(revision 1743741)
+++ tc7.0.x/trunk/webapps/docs/changelog.xml	(revision 1743742)
@@ -198,6 +198,10 @@
         Remove native code (Windows Service Wrapper, APR/native connector)
         support for Windows Itanium. (markt)
       </update>
+      <update>
+        Update the internal fork of Commons File Upload to r1743698 (1.3.1 plus
+        additional fixes). (markt)
+      </update>
     </changelog>
   </subsection>
 </section>
Index: tc7.0.x/trunk
===================================================================
--- tc7.0.x/trunk	(revision 1743741)
+++ tc7.0.x/trunk	(revision 1743742)

Property changes on: tc7.0.x/trunk
___________________________________________________________________
Modified: svn:mergeinfo
## -0,0 +0,2 ##
   Merged /tomcat/trunk:r1743700
   Merged /tomcat/tc8.5.x/trunk:r1743722
