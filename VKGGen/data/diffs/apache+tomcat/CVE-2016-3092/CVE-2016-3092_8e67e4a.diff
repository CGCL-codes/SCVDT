commit 8e67e4a4799a9765b3bd777eed3ee17f00514441
Author:     Mark Thomas <markt@apache.org>
AuthorDate: Fri May 13 16:52:46 2016 +0000
Commit:     Mark Thomas <markt@apache.org>
CommitDate: Fri May 13 16:52:46 2016 +0000

    Update internal fork of Commons File Upload
    
    git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1743700 13f79535-47bb-0310-9956-ffa450edef68

diff --git a/java/org/apache/tomcat/util/http/fileupload/MultipartStream.java b/java/org/apache/tomcat/util/http/fileupload/MultipartStream.java
index ca1051a005..9a3b0a08ae 100644
--- a/java/org/apache/tomcat/util/http/fileupload/MultipartStream.java
+++ b/java/org/apache/tomcat/util/http/fileupload/MultipartStream.java
@@ -288,12 +288,6 @@ public class MultipartStream {
         if (boundary == null) {
             throw new IllegalArgumentException("boundary may not be null");
         }
-
-        this.input = input;
-        this.bufSize = bufSize;
-        this.buffer = new byte[bufSize];
-        this.notifier = pNotifier;
-
         // We prepend CR/LF to the boundary to chop trailing CR/LF from
         // body-data tokens.
         this.boundaryLength = boundary.length + BOUNDARY_PREFIX.length;
@@ -301,6 +295,12 @@ public class MultipartStream {
             throw new IllegalArgumentException(
                     "The buffer size specified for the MultipartStream is too small");
         }
+
+        this.input = input;
+        this.bufSize = Math.max(bufSize, boundaryLength*2);
+        this.buffer = new byte[this.bufSize];
+        this.notifier = pNotifier;
+
         this.boundary = new byte[this.boundaryLength];
         this.keepRegion = this.boundary.length;
 
diff --git a/webapps/docs/changelog.xml b/webapps/docs/changelog.xml
index 3ac65223bf..de12e91859 100644
--- a/webapps/docs/changelog.xml
+++ b/webapps/docs/changelog.xml
@@ -68,6 +68,10 @@
         Update the internal fork of Commons Pool 2 to r1743697 (2.4.2 plus
         additional fixes). (markt)
       </update>
+      <update>
+        Update the internal fork of Commons File Upload to r1743698 (1.3.1 plus
+        additional fixes). (markt)
+      </update>
     </changelog>
   </subsection>
 </section>
