commit 04164c1f01b973e548d95511d417f414ca723cb8
Author:     Mark Thomas <markt@apache.org>
AuthorDate: Wed Jan 6 21:52:24 2016 +0000
Commit:     Mark Thomas <markt@apache.org>
CommitDate: Wed Jan 6 21:52:24 2016 +0000

    Fix https://bz.apache.org/bugzilla/show_bug.cgi?id=58809
    Correctly recycle the cookies when mapping requests for parallel deployment
    
    git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1723414 13f79535-47bb-0310-9956-ffa450edef68

diff --git a/java/org/apache/catalina/connector/CoyoteAdapter.java b/java/org/apache/catalina/connector/CoyoteAdapter.java
index 287908f90e..c4d3392b39 100644
--- a/java/org/apache/catalina/connector/CoyoteAdapter.java
+++ b/java/org/apache/catalina/connector/CoyoteAdapter.java
@@ -719,8 +719,8 @@ public class CoyoteAdapter implements Adapter {
                                 // Recycle cookies and session info in case the
                                 // correct context is configured with different
                                 // settings
-                                req.getCookies().recycle();
                                 request.recycleSessionInfo();
+                                request.recycleCookieInfo(true);
                             }
                             break;
                         }
diff --git a/java/org/apache/catalina/connector/Request.java b/java/org/apache/catalina/connector/Request.java
index 72d7f2d674..8008b20574 100644
--- a/java/org/apache/catalina/connector/Request.java
+++ b/java/org/apache/catalina/connector/Request.java
@@ -452,8 +452,6 @@ public class Request implements HttpServletRequest {
             parts = null;
         }
         partsParseException = null;
-        cookiesParsed = false;
-        cookiesConverted = false;
         locales.clear();
         localesParsed = false;
         secure = false;
@@ -467,9 +465,9 @@ public class Request implements HttpServletRequest {
         attributes.clear();
         sslAttributesParsed = false;
         notes.clear();
-        cookies = null;
 
         recycleSessionInfo();
+        recycleCookieInfo(false);
 
         if (Globals.IS_SECURITY_ENABLED || Connector.RECYCLE_FACADES) {
             parameterMap = new ParameterMap<>();
@@ -520,6 +518,16 @@ public class Request implements HttpServletRequest {
     }
 
 
+    protected void recycleCookieInfo(boolean recycleCoyote) {
+        cookiesParsed = false;
+        cookiesConverted = false;
+        cookies = null;
+        if (recycleCoyote) {
+            getCoyoteRequest().getCookies().recycle();
+        }
+    }
+
+
     // -------------------------------------------------------- Request Methods
 
     /**
