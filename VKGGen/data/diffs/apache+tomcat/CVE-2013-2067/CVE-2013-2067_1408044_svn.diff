Index: tc7.0.x/trunk/java/org/apache/catalina/authenticator/FormAuthenticator.java
===================================================================
--- tc7.0.x/trunk/java/org/apache/catalina/authenticator/FormAuthenticator.java	(revision 1408043)
+++ tc7.0.x/trunk/java/org/apache/catalina/authenticator/FormAuthenticator.java	(revision 1408044)
@@ -31,6 +31,7 @@
 import javax.servlet.http.HttpServletRequest;
 import javax.servlet.http.HttpServletResponse;
 
+import org.apache.catalina.Manager;
 import org.apache.catalina.Realm;
 import org.apache.catalina.Session;
 import org.apache.catalina.connector.Request;
@@ -404,6 +405,15 @@
             return;
         }
 
+        if (getChangeSessionIdOnAuthentication()) {
+            Session session = request.getSessionInternal(false);
+            if (session != null) {
+                Manager manager = request.getContext().getManager();
+                manager.changeSessionId(session);
+                request.changeSessionId(session.getId());
+            }
+        }
+
         // Always use GET for the login page, regardless of the method used
         String oldMethod = request.getMethod();
         request.getCoyoteRequest().method().setString("GET");
Index: tc7.0.x/trunk/webapps/docs/changelog.xml
===================================================================
--- tc7.0.x/trunk/webapps/docs/changelog.xml	(revision 1408043)
+++ tc7.0.x/trunk/webapps/docs/changelog.xml	(revision 1408044)
@@ -114,6 +114,10 @@
         <bug>54127</bug>: Add support for sending a WebSocket Ping. Patch
         provided by Sean Winterberger. (markt)
       </add>
+      <fix>
+        In FormAuthenticator: If it is configured to change Session IDs,
+        do the change before displaying the login form. (kkolinko)
+      </fix>
     </changelog>
   </subsection>
   <subsection name="Coyote">
Index: tc7.0.x/trunk
===================================================================
--- tc7.0.x/trunk	(revision 1408043)
+++ tc7.0.x/trunk	(revision 1408044)

Property changes on: tc7.0.x/trunk
___________________________________________________________________
Modified: svn:mergeinfo
## -0,0 +0,1 ##
   Merged /tomcat/trunk:r1408043
