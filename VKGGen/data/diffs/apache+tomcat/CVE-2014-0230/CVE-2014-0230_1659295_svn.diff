Index: tc7.0.x/trunk/java/org/apache/coyote/http11/filters/IdentityInputFilter.java
===================================================================
--- tc7.0.x/trunk/java/org/apache/coyote/http11/filters/IdentityInputFilter.java	(revision 1659294)
+++ tc7.0.x/trunk/java/org/apache/coyote/http11/filters/IdentityInputFilter.java	(revision 1659295)
@@ -174,21 +174,25 @@
     }
 
 
-    /**
-     * End the current request.
-     */
     @Override
-    public long end()  throws IOException {
+    public long end() throws IOException {
 
-        if (maxSwallowSize > -1 && remaining > maxSwallowSize) {
-            throw new IOException(sm.getString("inputFilter.maxSwallow"));
-        }
+        final boolean maxSwallowSizeExceeded = (maxSwallowSize > -1 && remaining > maxSwallowSize);
+        long swallowed = 0;
 
         // Consume extra bytes.
         while (remaining > 0) {
+
             int nread = buffer.doRead(endChunk, null);
             if (nread > 0 ) {
+                swallowed += nread;
                 remaining = remaining - nread;
+                if (maxSwallowSizeExceeded && swallowed > maxSwallowSize) {
+                    // Note: We do not fail early so the client has a chance to
+                    // read the response before the connection is closed. See:
+                    // http://httpd.apache.org/docs/2.0/misc/fin_wait_2.html#appendix
+                    throw new IOException(sm.getString("inputFilter.maxSwallow"));
+                }
             } else { // errors are handled higher up.
                 remaining = 0;
             }
Index: tc7.0.x/trunk/webapps/docs/changelog.xml
===================================================================
--- tc7.0.x/trunk/webapps/docs/changelog.xml	(revision 1659294)
+++ tc7.0.x/trunk/webapps/docs/changelog.xml	(revision 1659295)
@@ -95,6 +95,11 @@
         leave references to the UpgradeProcessor associated with the connection
         in memory. (markt)
       </fix>
+      <fix>
+        When applying the <code>maxSwallowSize</code> limit to a connection read
+        that many bytes first before closing the connection to give the client a
+        chance to read the reponse. (markt)
+      </fix>
     </changelog>
   </subsection>
   <subsection name="Jasper">
Index: tc7.0.x/trunk
===================================================================
--- tc7.0.x/trunk	(revision 1659294)
+++ tc7.0.x/trunk	(revision 1659295)

Property changes on: tc7.0.x/trunk
___________________________________________________________________
Modified: svn:mergeinfo
## -0,0 +0,2 ##
   Merged /tomcat/tc8.0.x/trunk:r1659294
   Merged /tomcat/trunk:r1659293
