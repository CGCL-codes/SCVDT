Index: tc7.0.x/trunk/java/org/apache/coyote/http11/AbstractHttp11Processor.java
===================================================================
--- tc7.0.x/trunk/java/org/apache/coyote/http11/AbstractHttp11Processor.java	(revision 1603780)
+++ tc7.0.x/trunk/java/org/apache/coyote/http11/AbstractHttp11Processor.java	(revision 1603781)
@@ -683,14 +683,15 @@
     /**
      * Initialize standard input and output filters.
      */
-    protected void initializeFilters(int maxTrailerSize, int maxExtensionSize) {
+    protected void initializeFilters(int maxTrailerSize, int maxExtensionSize,
+            int maxSwallowSize) {
         // Create and add the identity filters.
-        getInputBuffer().addFilter(new IdentityInputFilter());
+        getInputBuffer().addFilter(new IdentityInputFilter(maxSwallowSize));
         getOutputBuffer().addFilter(new IdentityOutputFilter());
 
         // Create and add the chunked filters.
         getInputBuffer().addFilter(
-                new ChunkedInputFilter(maxTrailerSize, maxExtensionSize));
+                new ChunkedInputFilter(maxTrailerSize, maxExtensionSize, maxSwallowSize));
         getOutputBuffer().addFilter(new ChunkedOutputFilter());
 
         // Create and add the void filters.
Index: tc7.0.x/trunk/java/org/apache/coyote/http11/AbstractHttp11Protocol.java
===================================================================
--- tc7.0.x/trunk/java/org/apache/coyote/http11/AbstractHttp11Protocol.java	(revision 1603780)
+++ tc7.0.x/trunk/java/org/apache/coyote/http11/AbstractHttp11Protocol.java	(revision 1603781)
@@ -163,6 +163,16 @@
 
 
     /**
+     * Maximum amount of request body to swallow.
+     */
+    private int maxSwallowSize = 2 * 1024 * 1024;
+    public int getMaxSwallowSize() { return maxSwallowSize; }
+    public void setMaxSwallowSize(int maxSwallowSize) {
+        this.maxSwallowSize = maxSwallowSize;
+    }
+
+
+    /**
      * This field indicates if the protocol is treated as if it is secure. This
      * normally means https is being used but can be used to fake https e.g
      * behind a reverse proxy.
Index: tc7.0.x/trunk/java/org/apache/coyote/http11/Http11AprProcessor.java
===================================================================
--- tc7.0.x/trunk/java/org/apache/coyote/http11/Http11AprProcessor.java	(revision 1603780)
+++ tc7.0.x/trunk/java/org/apache/coyote/http11/Http11AprProcessor.java	(revision 1603781)
@@ -59,7 +59,7 @@
 
 
     public Http11AprProcessor(int headerBufferSize, AprEndpoint endpoint,
-            int maxTrailerSize, int maxExtensionSize) {
+            int maxTrailerSize, int maxExtensionSize, int maxSwallowSize) {
 
         super(endpoint);
 
@@ -69,7 +69,7 @@
         outputBuffer = new InternalAprOutputBuffer(response, headerBufferSize);
         response.setOutputBuffer(outputBuffer);
 
-        initializeFilters(maxTrailerSize, maxExtensionSize);
+        initializeFilters(maxTrailerSize, maxExtensionSize, maxSwallowSize);
     }
 
 
Index: tc7.0.x/trunk/java/org/apache/coyote/http11/Http11AprProtocol.java
===================================================================
--- tc7.0.x/trunk/java/org/apache/coyote/http11/Http11AprProtocol.java	(revision 1603780)
+++ tc7.0.x/trunk/java/org/apache/coyote/http11/Http11AprProtocol.java	(revision 1603781)
@@ -300,7 +300,8 @@
         protected Http11AprProcessor createProcessor() {
             Http11AprProcessor processor = new Http11AprProcessor(
                     proto.getMaxHttpHeaderSize(), (AprEndpoint)proto.endpoint,
-                    proto.getMaxTrailerSize(), proto.getMaxExtensionSize());
+                    proto.getMaxTrailerSize(), proto.getMaxExtensionSize(),
+                    proto.getMaxSwallowSize());
             processor.setAdapter(proto.adapter);
             processor.setMaxKeepAliveRequests(proto.getMaxKeepAliveRequests());
             processor.setKeepAliveTimeout(proto.getKeepAliveTimeout());
Index: tc7.0.x/trunk/java/org/apache/coyote/http11/Http11NioProcessor.java
===================================================================
--- tc7.0.x/trunk/java/org/apache/coyote/http11/Http11NioProcessor.java	(revision 1603780)
+++ tc7.0.x/trunk/java/org/apache/coyote/http11/Http11NioProcessor.java	(revision 1603781)
@@ -64,7 +64,7 @@
 
 
     public Http11NioProcessor(int maxHttpHeaderSize, NioEndpoint endpoint,
-            int maxTrailerSize, int maxExtensionSize) {
+            int maxTrailerSize, int maxExtensionSize, int maxSwallowSize) {
 
         super(endpoint);
 
@@ -74,7 +74,7 @@
         outputBuffer = new InternalNioOutputBuffer(response, maxHttpHeaderSize);
         response.setOutputBuffer(outputBuffer);
 
-        initializeFilters(maxTrailerSize, maxExtensionSize);
+        initializeFilters(maxTrailerSize, maxExtensionSize, maxSwallowSize);
     }
 
 
Index: tc7.0.x/trunk/java/org/apache/coyote/http11/Http11NioProtocol.java
===================================================================
--- tc7.0.x/trunk/java/org/apache/coyote/http11/Http11NioProtocol.java	(revision 1603780)
+++ tc7.0.x/trunk/java/org/apache/coyote/http11/Http11NioProtocol.java	(revision 1603781)
@@ -259,7 +259,8 @@
         public Http11NioProcessor createProcessor() {
             Http11NioProcessor processor = new Http11NioProcessor(
                     proto.getMaxHttpHeaderSize(), (NioEndpoint)proto.endpoint,
-                    proto.getMaxTrailerSize(), proto.getMaxExtensionSize());
+                    proto.getMaxTrailerSize(), proto.getMaxExtensionSize(),
+                    proto.getMaxSwallowSize());
             processor.setAdapter(proto.adapter);
             processor.setMaxKeepAliveRequests(proto.getMaxKeepAliveRequests());
             processor.setKeepAliveTimeout(proto.getKeepAliveTimeout());
Index: tc7.0.x/trunk/java/org/apache/coyote/http11/Http11Processor.java
===================================================================
--- tc7.0.x/trunk/java/org/apache/coyote/http11/Http11Processor.java	(revision 1603780)
+++ tc7.0.x/trunk/java/org/apache/coyote/http11/Http11Processor.java	(revision 1603781)
@@ -50,7 +50,7 @@
 
 
     public Http11Processor(int headerBufferSize, JIoEndpoint endpoint,
-            int maxTrailerSize, int maxExtensionSize) {
+            int maxTrailerSize, int maxExtensionSize, int maxSwallowSize) {
 
         super(endpoint);
         
@@ -60,7 +60,7 @@
         outputBuffer = new InternalOutputBuffer(response, headerBufferSize);
         response.setOutputBuffer(outputBuffer);
 
-        initializeFilters(maxTrailerSize, maxExtensionSize);
+        initializeFilters(maxTrailerSize, maxExtensionSize, maxSwallowSize);
     }
 
 
Index: tc7.0.x/trunk/java/org/apache/coyote/http11/Http11Protocol.java
===================================================================
--- tc7.0.x/trunk/java/org/apache/coyote/http11/Http11Protocol.java	(revision 1603780)
+++ tc7.0.x/trunk/java/org/apache/coyote/http11/Http11Protocol.java	(revision 1603781)
@@ -164,7 +164,8 @@
         protected Http11Processor createProcessor() {
             Http11Processor processor = new Http11Processor(
                     proto.getMaxHttpHeaderSize(), (JIoEndpoint)proto.endpoint,
-                    proto.getMaxTrailerSize(),proto.getMaxExtensionSize());
+                    proto.getMaxTrailerSize(),proto.getMaxExtensionSize(),
+                    proto.getMaxSwallowSize());
             processor.setAdapter(proto.adapter);
             processor.setMaxKeepAliveRequests(proto.getMaxKeepAliveRequests());
             processor.setKeepAliveTimeout(proto.getKeepAliveTimeout());
Index: tc7.0.x/trunk/java/org/apache/coyote/http11/filters/ChunkedInputFilter.java
===================================================================
--- tc7.0.x/trunk/java/org/apache/coyote/http11/filters/ChunkedInputFilter.java	(revision 1603780)
+++ tc7.0.x/trunk/java/org/apache/coyote/http11/filters/ChunkedInputFilter.java	(revision 1603781)
@@ -138,6 +138,9 @@
     private long extensionSize;
 
 
+    private final int maxSwallowSize;
+
+
     /**
      * Flag that indicates if an error has occurred.
      */
@@ -146,10 +149,11 @@
 
     // ----------------------------------------------------------- Constructors
 
-    public ChunkedInputFilter(int maxTrailerSize, int maxExtensionSize) {
+    public ChunkedInputFilter(int maxTrailerSize, int maxExtensionSize, int maxSwallowSize) {
         this.trailingHeaders.setLimit(maxTrailerSize);
         this.maxExtensionSize = maxExtensionSize;
         this.maxTrailerSize = maxTrailerSize;
+        this.maxSwallowSize = maxSwallowSize;
     }
 
 
@@ -235,9 +239,14 @@
      */
     @Override
     public long end() throws IOException {
+        long swallowed = 0;
+        int read = 0;
         // Consume extra bytes : parse the stream until the end chunk is found
-        while (doRead(readChunk, null) >= 0) {
-            // NOOP: Just consume the input
+        while ((read = doRead(readChunk, null)) >= 0) {
+            swallowed += read;
+            if (maxSwallowSize > -1 && swallowed > maxSwallowSize) {
+                throwIOException(sm.getString("inputFilter.maxSwallow"));
+            }
         }
 
         // Return the number of extra bytes which were consumed
Index: tc7.0.x/trunk/java/org/apache/coyote/http11/filters/IdentityInputFilter.java
===================================================================
--- tc7.0.x/trunk/java/org/apache/coyote/http11/filters/IdentityInputFilter.java	(revision 1603780)
+++ tc7.0.x/trunk/java/org/apache/coyote/http11/filters/IdentityInputFilter.java	(revision 1603781)
@@ -24,6 +24,7 @@
 import org.apache.coyote.Request;
 import org.apache.coyote.http11.InputFilter;
 import org.apache.tomcat.util.buf.ByteChunk;
+import org.apache.tomcat.util.res.StringManager;
 
 /**
  * Identity input filter.
@@ -32,7 +33,10 @@
  */
 public class IdentityInputFilter implements InputFilter {
 
+    private static final StringManager sm = StringManager.getManager(
+            IdentityInputFilter.class.getPackage().getName());
 
+
     // -------------------------------------------------------------- Constants
 
 
@@ -76,9 +80,11 @@
     protected ByteChunk endChunk = new ByteChunk();
 
 
+    private final int maxSwallowSize;
+
+
     // ------------------------------------------------------------- Properties
 
-
     /**
      * Get content length.
      *
@@ -101,6 +107,13 @@
     }
 
 
+    // ------------------------------------------------------------ Constructor
+
+    public IdentityInputFilter(int maxSwallowSize) {
+        this.maxSwallowSize = maxSwallowSize;
+    }
+
+
     // ---------------------------------------------------- InputBuffer Methods
 
 
@@ -163,9 +176,12 @@
      * End the current request.
      */
     @Override
-    public long end()
-        throws IOException {
+    public long end()  throws IOException {
 
+        if (maxSwallowSize > -1 && remaining > maxSwallowSize) {
+            throw new IOException(sm.getString("inputFilter.maxSwallow"));
+        }
+
         // Consume extra bytes.
         while (remaining > 0) {
             int nread = buffer.doRead(endChunk, null);
Index: tc7.0.x/trunk/java/org/apache/coyote/http11/filters/LocalStrings.properties
===================================================================
--- tc7.0.x/trunk/java/org/apache/coyote/http11/filters/LocalStrings.properties	(revision 1603780)
+++ tc7.0.x/trunk/java/org/apache/coyote/http11/filters/LocalStrings.properties	(revision 1603781)
@@ -22,4 +22,6 @@
 chunkedInputFilter.invalidCrlfNoData=Invalid end of line sequence (no data available to read)
 chunkedInputFilter.invalidHeader=Invalid chunk header
 chunkedInputFilter.maxExtension=maxExtensionSize exceeded
-chunkedInputFilter.maxTrailer=maxTrailerSize exceeded
\ No newline at end of file
+chunkedInputFilter.maxTrailer=maxTrailerSize exceeded
+
+inputFilter.maxSwallow=maxSwallowSize exceeded
\ No newline at end of file
Index: tc7.0.x/trunk/test/org/apache/catalina/core/TestSwallowAbortedUploads.java
===================================================================
--- tc7.0.x/trunk/test/org/apache/catalina/core/TestSwallowAbortedUploads.java	(revision 1603780)
+++ tc7.0.x/trunk/test/org/apache/catalina/core/TestSwallowAbortedUploads.java	(revision 1603781)
@@ -16,8 +16,14 @@
  */
 package org.apache.catalina.core;
 
+import java.io.BufferedReader;
 import java.io.IOException;
+import java.io.InputStreamReader;
+import java.io.OutputStreamWriter;
 import java.io.PrintWriter;
+import java.io.Writer;
+import java.net.Socket;
+import java.nio.charset.StandardCharsets;
 import java.util.Arrays;
 import java.util.Collection;
 
@@ -32,6 +38,7 @@
 import static org.junit.Assert.assertNull;
 import static org.junit.Assert.assertTrue;
 
+import org.junit.Assert;
 import org.junit.Test;
 
 import org.apache.catalina.Context;
@@ -113,7 +120,7 @@
         Exception ex = doAbortedUploadTest(client, true, true);
         assertNull("Limited upload with swallow enabled generates client exception",
                    ex);
-        assertTrue("Limited upload with swallow enabled returns error status code",
+        assertTrue("Limited upload with swallow enabled returns non-500 status code",
                    client.isResponse500());
         client.reset();
     }
@@ -410,4 +417,78 @@
         }
     }
 
+
+    @Test
+    public void testChunkedPUTLimit() throws Exception {
+        doTestChunkedPUT(true);
+    }
+
+
+    @Test
+    public void testChunkedPUTNoLimit() throws Exception {
+        doTestChunkedPUT(false);
+    }
+
+
+    public void doTestChunkedPUT(boolean limit) throws Exception {
+
+        Tomcat tomcat = getTomcatInstance();
+        tomcat.addContext("", TEMP_DIR);
+        // No need for target to exist.
+
+        if (!limit) {
+            tomcat.getConnector().setAttribute("maxSwallowSize", "-1");
+        }
+
+        tomcat.start();
+
+        Exception writeEx = null;
+        Exception readEx = null;
+        String responseLine = null;
+        Socket conn = null;
+        
+        try {
+            conn = new Socket("localhost", getPort());
+            Writer writer = new OutputStreamWriter(
+                    conn.getOutputStream(), StandardCharsets.US_ASCII);
+            writer.write("PUT /does-not-exist HTTP/1.1\r\n");
+            writer.write("Host: any\r\n");
+            writer.write("Transfer-encoding: chunked\r\n");
+            writer.write("\r\n");
+
+            // Smarter than the typical client. Attempts to read the response
+            // even if the request is not fully written.
+            try {
+                // Write (or try to write) 16MB
+                for (int i = 0; i < 1024 * 1024; i++) {
+                    writer.write("10\r\n");
+                    writer.write("0123456789ABCDEF\r\n");
+                }
+            } catch (Exception e) {
+                writeEx = e;
+            }
+
+            try {
+                BufferedReader reader = new BufferedReader(new InputStreamReader(
+                        conn.getInputStream(), StandardCharsets.US_ASCII));
+
+                responseLine = reader.readLine();
+            } catch (IOException e) {
+                readEx = e;
+            }
+        } finally {
+            if (conn != null) {
+                conn.close();
+            }
+        }
+
+        if (limit) {
+            Assert.assertNotNull(writeEx);
+        } else {
+            Assert.assertNull(writeEx);
+            Assert.assertNull(readEx);
+            Assert.assertNotNull(responseLine);
+            Assert.assertTrue(responseLine.contains("404"));
+        }
+    }
 }
Index: tc7.0.x/trunk/webapps/docs/changelog.xml
===================================================================
--- tc7.0.x/trunk/webapps/docs/changelog.xml	(revision 1603780)
+++ tc7.0.x/trunk/webapps/docs/changelog.xml	(revision 1603781)
@@ -147,6 +147,10 @@
         HTTP connector and ensure that access log entries generated by error
         conditions use the correct request start time. (markt)
       </fix>
+      <add>
+        Add a new limit, defaulting to 2MB, for the amount of data Tomcat will
+        swallow for an aborted upload. (markt)
+      </add>
     </changelog>
   </subsection>
   <subsection name="Jasper">
Index: tc7.0.x/trunk/webapps/docs/config/http.xml
===================================================================
--- tc7.0.x/trunk/webapps/docs/config/http.xml	(revision 1603780)
+++ tc7.0.x/trunk/webapps/docs/config/http.xml	(revision 1603781)
@@ -431,6 +431,16 @@
       If not specified, this attribute is set to 100.</p>
     </attribute>
 
+    <attribute name="maxSwallowSize" required="false">
+      <p>The maximum number of request body bytes (excluding transfer encoding
+      overhead) that will be swallowed by Tomcat for an aborted upload. An
+      aborted upload is when Tomcat knows that the request body is going to be
+      ignored but the client still sends it. If Tomcat does not swallow the body
+      the client is unlikely to see the response. If not specified the default
+      of 2097152 (2 megabytes) will be used. A value of less than zero indicates
+      that no limit should be enforced.</p>
+    </attribute>
+
     <attribute name="maxThreads" required="false">
       <p>The maximum number of request processing threads to be created
       by this <strong>Connector</strong>, which therefore determines the
Index: tc7.0.x/trunk
===================================================================
--- tc7.0.x/trunk	(revision 1603780)
+++ tc7.0.x/trunk	(revision 1603781)

Property changes on: tc7.0.x/trunk
___________________________________________________________________
Modified: svn:mergeinfo
## -0,0 +0,1 ##
   Merged /tomcat/trunk:r1603770,1603775,1603779
