Index: tc7.0.x/trunk/java/org/apache/tomcat/util/buf/Utf8Decoder.java
===================================================================
--- tc7.0.x/trunk/java/org/apache/tomcat/util/buf/Utf8Decoder.java	(revision 1830375)
+++ tc7.0.x/trunk/java/org/apache/tomcat/util/buf/Utf8Decoder.java	(revision 1830376)
@@ -277,6 +277,11 @@
                 outRemaining--;
             } else {
                 if (outRemaining < 2) {
+                    // Encoded with 4 bytes. inIndex currently points
+                    // to the final byte. Move it back to first byte.
+                    inIndex -= 3;
+                    in.position(inIndex - in.arrayOffset());
+                    out.position(outIndex - out.arrayOffset());
                     return CoderResult.OVERFLOW;
                 }
                 cArr[outIndex++] = (char) ((jchar >> 0xA) + 0xD7C0);
Index: tc7.0.x/trunk/webapps/docs/changelog.xml
===================================================================
--- tc7.0.x/trunk/webapps/docs/changelog.xml	(revision 1830375)
+++ tc7.0.x/trunk/webapps/docs/changelog.xml	(revision 1830376)
@@ -92,6 +92,10 @@
         behaviour is enabled by default and configurable via the new Context
         attribute <code>allowMultipleLeadingForwardSlashInPath</code>. (markt)
       </add>
+      <fix>
+        Improve handing of overflow in the UTF-8 decoder with supplementary
+        characters. (markt)
+      </fix>
     </changelog>
   </subsection>
   <subsection name="Coyote">
Index: tc7.0.x/trunk
===================================================================
--- tc7.0.x/trunk	(revision 1830375)
+++ tc7.0.x/trunk	(revision 1830376)

Property changes on: tc7.0.x/trunk
___________________________________________________________________
Modified: svn:mergeinfo
## -0,0 +0,2 ##
   Merged /tomcat/trunk:r1830373
   Merged /tomcat/tc8.5.x/trunk:r1830374
