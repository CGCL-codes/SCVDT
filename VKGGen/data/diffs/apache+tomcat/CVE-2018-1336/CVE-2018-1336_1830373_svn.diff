Index: trunk/java/org/apache/tomcat/util/buf/Utf8Decoder.java
===================================================================
--- trunk/java/org/apache/tomcat/util/buf/Utf8Decoder.java	(revision 1830372)
+++ trunk/java/org/apache/tomcat/util/buf/Utf8Decoder.java	(revision 1830373)
@@ -278,6 +278,11 @@
                 outRemaining--;
             } else {
                 if (outRemaining < 2) {
+                    // Encoded with 4 bytes. inIndex currently points
+                    // to the final byte. Move it back to first byte.
+                    inIndex -= 3;
+                    in.position(inIndex - in.arrayOffset());
+                    out.position(outIndex - out.arrayOffset());
                     return CoderResult.OVERFLOW;
                 }
                 cArr[outIndex++] = (char) ((jchar >> 0xA) + 0xD7C0);
Index: trunk/webapps/docs/changelog.xml
===================================================================
--- trunk/webapps/docs/changelog.xml	(revision 1830372)
+++ trunk/webapps/docs/changelog.xml	(revision 1830373)
@@ -94,6 +94,10 @@
         behaviour is enabled by default and configurable via the new Context
         attribute <code>allowMultipleLeadingForwardSlashInPath</code>. (markt)
       </add>
+      <fix>
+        Improve handing of overflow in the UTF-8 decoder with supplementary
+        characters. (markt)
+      </fix>
     </changelog>
   </subsection>
   <subsection name="Coyote">
