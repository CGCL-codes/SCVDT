Index: tc6.0.x/trunk/java/org/apache/coyote/http11/InternalOutputBuffer.java
===================================================================
--- tc6.0.x/trunk/java/org/apache/coyote/http11/InternalOutputBuffer.java	(revision 673833)
+++ tc6.0.x/trunk/java/org/apache/coyote/http11/InternalOutputBuffer.java	(revision 673834)
@@ -438,11 +438,14 @@
         buf[pos++] = Constants.SP;
 
         // Write message
-        String message = response.getMessage();
+        String message = null;
+        if (org.apache.coyote.Constants.USE_CUSTOM_STATUS_MSG_IN_HEADER) {
+            message = response.getMessage();
+        }
         if (message == null) {
-            write(getMessage(status));
+            write(HttpMessages.getMessage(status)); 
         } else {
-            write(message);
+            write(message.replace('\n', ' ').replace('\r', ' '));
         }
 
         // End the response status line
Index: tc6.0.x/trunk/java/org/apache/coyote/http11/InternalAprOutputBuffer.java
===================================================================
--- tc6.0.x/trunk/java/org/apache/coyote/http11/InternalAprOutputBuffer.java	(revision 673833)
+++ tc6.0.x/trunk/java/org/apache/coyote/http11/InternalAprOutputBuffer.java	(revision 673834)
@@ -421,11 +421,14 @@
         buf[pos++] = Constants.SP;
 
         // Write message
-        String message = response.getMessage();
+        String message = null;
+        if (org.apache.coyote.Constants.USE_CUSTOM_STATUS_MSG_IN_HEADER) {
+            message = response.getMessage();
+        }
         if (message == null) {
             write(HttpMessages.getMessage(status));
         } else {
-            write(message);
+            write(message.replace('\n', ' ').replace('\r', ' '));
         }
 
         // End the response status line
Index: tc6.0.x/trunk/java/org/apache/coyote/http11/InternalNioOutputBuffer.java
===================================================================
--- tc6.0.x/trunk/java/org/apache/coyote/http11/InternalNioOutputBuffer.java	(revision 673833)
+++ tc6.0.x/trunk/java/org/apache/coyote/http11/InternalNioOutputBuffer.java	(revision 673834)
@@ -479,11 +479,14 @@
         buf[pos++] = Constants.SP;
 
         // Write message
-        String message = response.getMessage();
+        String message = null;
+        if (org.apache.coyote.Constants.USE_CUSTOM_STATUS_MSG_IN_HEADER) {
+            message = response.getMessage();
+        }
         if (message == null) {
             write(HttpMessages.getMessage(status));
         } else {
-            write(message);
+            write(message.replace('\n', ' ').replace('\r', ' '));
         }
 
         // End the response status line
Index: tc6.0.x/trunk/java/org/apache/coyote/ajp/AjpProcessor.java
===================================================================
--- tc6.0.x/trunk/java/org/apache/coyote/ajp/AjpProcessor.java	(revision 673833)
+++ tc6.0.x/trunk/java/org/apache/coyote/ajp/AjpProcessor.java	(revision 673834)
@@ -923,7 +923,10 @@
 
         // HTTP header contents
         responseHeaderMessage.appendInt(response.getStatus());
-        String message = response.getMessage();
+        String message = null;
+        if (org.apache.coyote.Constants.USE_CUSTOM_STATUS_MSG_IN_HEADER) {
+            message = response.getMessage();
+        }
         if (message == null){
             message = HttpMessages.getMessage(response.getStatus());
         } else {
Index: tc6.0.x/trunk/java/org/apache/coyote/ajp/AjpAprProcessor.java
===================================================================
--- tc6.0.x/trunk/java/org/apache/coyote/ajp/AjpAprProcessor.java	(revision 673833)
+++ tc6.0.x/trunk/java/org/apache/coyote/ajp/AjpAprProcessor.java	(revision 673834)
@@ -917,7 +917,10 @@
 
         // HTTP header contents
         responseHeaderMessage.appendInt(response.getStatus());
-        String message = response.getMessage();
+        String message = null;
+        if (org.apache.coyote.Constants.USE_CUSTOM_STATUS_MSG_IN_HEADER) {
+            message = response.getMessage();
+        } 
         if (message == null){
             message = HttpMessages.getMessage(response.getStatus());
         } else {
Index: tc6.0.x/trunk/java/org/apache/coyote/Constants.java
===================================================================
--- tc6.0.x/trunk/java/org/apache/coyote/Constants.java	(revision 673833)
+++ tc6.0.x/trunk/java/org/apache/coyote/Constants.java	(revision 673834)
@@ -60,5 +60,12 @@
         (System.getSecurityManager() != null);
 
 
+    /**
+     * If true, custom HTTP status messages will be used in headers.
+     */
+    public static final boolean USE_CUSTOM_STATUS_MSG_IN_HEADER =
+        Boolean.valueOf(System.getProperty(
+                "org.apache.coyote.USE_CUSTOM_STATUS_MSG_IN_HEADER",
+                "false")).booleanValue(); 
 
 }
Index: tc6.0.x/trunk/java/org/apache/jk/common/JkInputStream.java
===================================================================
--- tc6.0.x/trunk/java/org/apache/jk/common/JkInputStream.java	(revision 673833)
+++ tc6.0.x/trunk/java/org/apache/jk/common/JkInputStream.java	(revision 673834)
@@ -272,7 +272,10 @@
         outputMsg.appendByte(AjpConstants.JK_AJP13_SEND_HEADERS);
         outputMsg.appendInt( res.getStatus() );
         
-        String message=res.getMessage();
+        String message = null;
+        if (org.apache.coyote.Constants.USE_CUSTOM_STATUS_MSG_IN_HEADER) {
+            message = res.getMessage();
+        } 
         if( message==null ){
             message= HttpMessages.getMessage(res.getStatus());
         } else {
Index: tc6.0.x/trunk/java/org/apache/catalina/core/StandardContextValve.java
===================================================================
--- tc6.0.x/trunk/java/org/apache/catalina/core/StandardContextValve.java	(revision 673833)
+++ tc6.0.x/trunk/java/org/apache/catalina/core/StandardContextValve.java	(revision 673834)
@@ -120,8 +120,7 @@
             || (requestPathMB.equalsIgnoreCase("/META-INF"))
             || (requestPathMB.startsWithIgnoreCase("/WEB-INF/", 0))
             || (requestPathMB.equalsIgnoreCase("/WEB-INF"))) {
-            String requestURI = request.getDecodedRequestURI();
-            notFound(requestURI, response);
+            notFound(response);
             return;
         }
 
@@ -148,15 +147,13 @@
         // Select the Wrapper to be used for this Request
         Wrapper wrapper = request.getWrapper();
         if (wrapper == null) {
-            String requestURI = request.getDecodedRequestURI();
-            notFound(requestURI, response);
+            notFound(response);
             return;
         } else if (wrapper.isUnavailable()) {
             // May be as a result of a reload, try and find the new wrapper
             wrapper = (Wrapper) container.findChild(wrapper.getName());
             if (wrapper == null) {
-                String requestURI = request.getDecodedRequestURI();
-                notFound(requestURI, response);
+                notFound(response);
                 return;
             }
         }
@@ -305,13 +302,12 @@
      * application, but currently that code runs at the wrapper level rather
      * than the context level.
      *
-     * @param requestURI The request URI for the requested resource
      * @param response The response we are creating
      */
-    private void notFound(String requestURI, HttpServletResponse response) {
+    private void notFound(HttpServletResponse response) {
 
         try {
-            response.sendError(HttpServletResponse.SC_NOT_FOUND, requestURI);
+            response.sendError(HttpServletResponse.SC_NOT_FOUND);
         } catch (IllegalStateException e) {
             ;
         } catch (IOException e) {
Index: tc6.0.x/trunk/webapps/docs/config/systemprops.xml
===================================================================
--- tc6.0.x/trunk/webapps/docs/config/systemprops.xml	(revision 673833)
+++ tc6.0.x/trunk/webapps/docs/config/systemprops.xml	(revision 673834)
@@ -189,6 +189,15 @@
       be used.</p>
     </property>
 
+    <property
+    name="org.apache.coyote. USE_CUSTOM_STATUS_MSG_IN_HEADER"><p>If this is
+      <code>true</code> custom HTTP status messages will be used within HTTP
+      headers. Users must ensure that any such message is ISO-8859-1 encoded,
+      particularly if user provided input is included in the message, to prevent
+      a possible XSS vulnerability. If not specified the default value of
+      <code>false</code> will be used.</p>
+    </property>
+
   </properties>
 
 </section>
Index: tc6.0.x/trunk
===================================================================
--- tc6.0.x/trunk	(revision 673833)
+++ tc6.0.x/trunk	(revision 673834)

Property changes on: tc6.0.x/trunk
___________________________________________________________________
Added: svn:mergeinfo
## -0,0 +0,1 ##
   Merged /tomcat/trunk:r673796
