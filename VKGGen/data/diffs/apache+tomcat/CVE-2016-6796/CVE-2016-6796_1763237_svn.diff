Index: tc6.0.x/trunk/java/org/apache/naming/factory/ResourceLinkFactory.java
===================================================================
--- tc6.0.x/trunk/java/org/apache/naming/factory/ResourceLinkFactory.java	(revision 1763236)
+++ tc6.0.x/trunk/java/org/apache/naming/factory/ResourceLinkFactory.java	(revision 1763237)
@@ -110,9 +110,12 @@
 
     private static boolean validateGlobalResourceAccess(String globalName) {
         ClassLoader cl = Thread.currentThread().getContextClassLoader();
-        Map<String,String> registrations = globalResourceRegistrations.get(cl);
-        if (registrations != null && registrations.containsValue(globalName)) {
-            return true;
+        while (cl != null) {
+            Map<String,String> registrations = globalResourceRegistrations.get(cl);
+            if (registrations != null && registrations.containsValue(globalName)) {
+                return true;
+            }
+            cl = cl.getParent();
         }
         return false;
     }
Index: tc6.0.x/trunk/webapps/docs/changelog.xml
===================================================================
--- tc6.0.x/trunk/webapps/docs/changelog.xml	(revision 1763236)
+++ tc6.0.x/trunk/webapps/docs/changelog.xml	(revision 1763237)
@@ -156,6 +156,11 @@
         </code> in <code>SecurityClassLoad</code> so that tomcat can
         successfully start with the Security Manager enabled. (csutherl)
       </fix>
+      <fix>
+        Improve the access checks for linked global resources to handle the case
+        where the current class loader is a child of the web application class
+        loader. (markt)
+      </fix>
     </changelog>
   </subsection>
   <subsection name="Coyote">
Index: tc6.0.x/trunk
===================================================================
--- tc6.0.x/trunk	(revision 1763236)
+++ tc6.0.x/trunk	(revision 1763237)

Property changes on: tc6.0.x/trunk
___________________________________________________________________
Modified: svn:mergeinfo
## -0,0 +0,3 ##
   Merged /tomcat/tc7.0.x/trunk:r1763236
   Merged /tomcat/trunk:r1763232
   Merged /tomcat/tc8.5.x/trunk:r1763233
