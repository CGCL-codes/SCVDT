Index: tc7.0.x/trunk/conf/web.xml
===================================================================
--- tc7.0.x/trunk/conf/web.xml	(revision 1758494)
+++ tc7.0.x/trunk/conf/web.xml	(revision 1758495)
@@ -163,6 +163,8 @@
   <!--   engineOptionsClass  Allows specifying the Options class used to    -->
   <!--                       configure Jasper. If not present, the default  -->
   <!--                       EmbeddedServletOptions will be used.           -->
+  <!--                       This option is ignored when running under a    -->
+  <!--                       SecurityManager.                               -->
   <!--                                                                      -->
   <!--   errorOnUseBeanInvalidClassAttribute                                -->
   <!--                       Should Jasper issue an error when the value of -->
@@ -224,6 +226,8 @@
   <!--   scratchdir          What scratch directory should we use when      -->
   <!--                       compiling JSP pages?  [default work directory  -->
   <!--                       for the current web application]               -->
+  <!--                       This option is ignored when running under a    -->
+  <!--                       SecurityManager.                               -->
   <!--                                                                      -->
   <!--   suppressSmap        Should the generation of SMAP info for JSR45   -->
   <!--                       debugging be suppressed?  [false]              -->
Index: tc7.0.x/trunk/java/org/apache/jasper/EmbeddedServletOptions.java
===================================================================
--- tc7.0.x/trunk/java/org/apache/jasper/EmbeddedServletOptions.java	(revision 1758494)
+++ tc7.0.x/trunk/java/org/apache/jasper/EmbeddedServletOptions.java	(revision 1758495)
@@ -650,6 +650,10 @@
          * scratchdir
          */
         String dir = config.getInitParameter("scratchdir"); 
+        if (dir != null && Constants.IS_SECURITY_ENABLED) {
+            log.info(Localizer.getMessage("jsp.info.ignoreSetting", "scratchdir", dir));
+            dir = null;
+        }
         if (dir != null) {
             scratchDir = new File(dir);
         } else {
Index: tc7.0.x/trunk/java/org/apache/jasper/resources/LocalStrings.properties
===================================================================
--- tc7.0.x/trunk/java/org/apache/jasper/resources/LocalStrings.properties	(revision 1758494)
+++ tc7.0.x/trunk/java/org/apache/jasper/resources/LocalStrings.properties	(revision 1758495)
@@ -457,6 +457,7 @@
 jsp.error.invalid.bean=The value for the useBean class attribute {0} is invalid.
 jsp.error.prefix.use_before_dcl=The prefix {0} specified in this tag directive has been previously used by an action in file {1} line {2}.
 jsp.error.lastModified=Unable to determine last modified date for file [{0}]
+jsp.info.ignoreSetting=Ignored setting for [{0}] of [{1}] because a SecurityManager was enabled
 
 jsp.exception=An exception occurred processing JSP page {0} at line {1}
 
Index: tc7.0.x/trunk/java/org/apache/jasper/servlet/JspServlet.java
===================================================================
--- tc7.0.x/trunk/java/org/apache/jasper/servlet/JspServlet.java	(revision 1758494)
+++ tc7.0.x/trunk/java/org/apache/jasper/servlet/JspServlet.java	(revision 1758495)
@@ -71,8 +71,8 @@
     private ServletConfig config;
     private transient Options options;
     private transient JspRuntimeContext rctxt;
-    //jspFile for a jsp configured explicitly as a servlet, in environments where this configuration is
-    //translated into an init-param for this servlet.
+    // jspFile for a jsp configured explicitly as a servlet, in environments where this
+    // configuration is translated into an init-param for this servlet.
     private String jspFile;
 
 
@@ -89,6 +89,11 @@
         // Initialize the JSP Runtime Context
         // Check for a custom Options implementation
         String engineOptionsName = config.getInitParameter("engineOptionsClass");
+        if (Constants.IS_SECURITY_ENABLED && engineOptionsName != null) {
+            log.info(Localizer.getMessage(
+                    "jsp.info.ignoreSetting", "engineOptionsClass", engineOptionsName));
+            engineOptionsName = null;
+        }
         if (engineOptionsName != null) {
             // Instantiate the indicated Options implementation
             try {
Index: tc7.0.x/trunk/webapps/docs/changelog.xml
===================================================================
--- tc7.0.x/trunk/webapps/docs/changelog.xml	(revision 1758494)
+++ tc7.0.x/trunk/webapps/docs/changelog.xml	(revision 1758495)
@@ -929,6 +929,10 @@
         Fix handling of missing messages in
         <code>org.apache.el.util.MessageFactory</code>. (violetagg)
       </fix>
+      <fix>
+        Ignore <code>engineOptionsClass</code> and <code>scratchdir</code> when
+        running under a security manager. (markt)
+      </fix>
     </changelog>
   </subsection>
   <subsection name="Cluster">
Index: tc7.0.x/trunk/webapps/docs/jasper-howto.xml
===================================================================
--- tc7.0.x/trunk/webapps/docs/jasper-howto.xml	(revision 1758494)
+++ tc7.0.x/trunk/webapps/docs/jasper-howto.xml	(revision 1758495)
@@ -132,7 +132,7 @@
 
 <li><strong>engineOptionsClass</strong> - Allows specifying the Options class
 used to configure Jasper. If not present, the default EmbeddedServletOptions
-will be used.
+will be used. This option is ignored if running under a SecurityManager.
 </li>
 
 <li><strong>errorOnUseBeanInvalidClassAttribute</strong> - Should Jasper issue
@@ -185,7 +185,7 @@
 
 <li><strong>scratchdir</strong> - What scratch directory should we use when
 compiling JSP pages? Default is the work directory for the current web
-application.</li>
+application. This option is ignored if running under a SecurityManager.</li>
 
 <li><strong>suppressSmap</strong> - Should the generation of SMAP info for JSR45
 debugging be suppressed? <code>true</code> or <code>false</code>, default
Index: tc7.0.x/trunk
===================================================================
--- tc7.0.x/trunk	(revision 1758494)
+++ tc7.0.x/trunk	(revision 1758495)

Property changes on: tc7.0.x/trunk
___________________________________________________________________
Modified: svn:mergeinfo
## -0,0 +0,2 ##
   Merged /tomcat/trunk:r1758487
   Merged /tomcat/tc8.5.x/trunk:r1758493
