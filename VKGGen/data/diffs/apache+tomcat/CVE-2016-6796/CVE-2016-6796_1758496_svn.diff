Index: tc6.0.x/trunk/conf/web.xml
===================================================================
--- tc6.0.x/trunk/conf/web.xml	(revision 1758495)
+++ tc6.0.x/trunk/conf/web.xml	(revision 1758496)
@@ -189,6 +189,8 @@
   <!--   engineOptionsClass  Allows specifying the Options class used to    -->
   <!--                       configure Jasper. If not present, the default  -->
   <!--                       EmbeddedServletOptions will be used.           -->
+  <!--                       This option is ignored when running under a    -->
+  <!--                       SecurityManager.                               -->
   <!--                                                                      -->
   <!--   errorOnUseBeanInvalidClassAttribute                                -->
   <!--                       Should Jasper issue an error when the value of -->
@@ -238,6 +240,8 @@
   <!--   scratchdir          What scratch directory should we use when      -->
   <!--                       compiling JSP pages?  [default work directory  -->
   <!--                       for the current web application]               -->
+  <!--                       This option is ignored when running under a    -->
+  <!--                       SecurityManager.                               -->
   <!--                                                                      -->
   <!--   suppressSmap        Should the generation of SMAP info for JSR45   -->
   <!--                       debugging be suppressed?  [false]              -->
Index: tc6.0.x/trunk/java/org/apache/jasper/EmbeddedServletOptions.java
===================================================================
--- tc6.0.x/trunk/java/org/apache/jasper/EmbeddedServletOptions.java	(revision 1758495)
+++ tc6.0.x/trunk/java/org/apache/jasper/EmbeddedServletOptions.java	(revision 1758496)
@@ -586,6 +586,10 @@
          * scratchdir
          */
         String dir = config.getInitParameter("scratchdir");
+        if (dir != null && Constants.IS_SECURITY_ENABLED) {
+            log.info(Localizer.getMessage("jsp.info.ignoreSetting", "scratchdir", dir));
+            dir = null;
+        }
         if (dir != null) {
             scratchDir = new File(dir);
         } else {
Index: tc6.0.x/trunk/java/org/apache/jasper/resources/LocalStrings.properties
===================================================================
--- tc6.0.x/trunk/java/org/apache/jasper/resources/LocalStrings.properties	(revision 1758495)
+++ tc6.0.x/trunk/java/org/apache/jasper/resources/LocalStrings.properties	(revision 1758496)
@@ -449,6 +449,7 @@
 jsp.error.unbalanced.endtag=The end tag \"&lt;/{0}\" is unbalanced
 jsp.error.invalid.bean=The value for the useBean class attribute {0} is invalid.
 jsp.error.prefix.use_before_dcl=The prefix {0} specified in this tag directive has been previously used by an action in file {1} line {2}.
+jsp.info.ignoreSetting=Ignored setting for [{0}] of [{1}] because a SecurityManager was enabled
 
 jsp.exception=An exception occurred processing JSP page {0} at line {1}
 
Index: tc6.0.x/trunk/java/org/apache/jasper/servlet/JspServlet.java
===================================================================
--- tc6.0.x/trunk/java/org/apache/jasper/servlet/JspServlet.java	(revision 1758495)
+++ tc6.0.x/trunk/java/org/apache/jasper/servlet/JspServlet.java	(revision 1758496)
@@ -81,6 +81,11 @@
         // Initialize the JSP Runtime Context
         // Check for a custom Options implementation
         String engineOptionsName = config.getInitParameter("engineOptionsClass");
+        if (Constants.IS_SECURITY_ENABLED && engineOptionsName != null) {
+            log.info(Localizer.getMessage(
+                    "jsp.info.ignoreSetting", "engineOptionsClass", engineOptionsName));
+            engineOptionsName = null;
+        }
         if (engineOptionsName != null) {
             // Instantiate the indicated Options implementation
             try {
Index: tc6.0.x/trunk/webapps/docs/changelog.xml
===================================================================
--- tc6.0.x/trunk/webapps/docs/changelog.xml	(revision 1758495)
+++ tc6.0.x/trunk/webapps/docs/changelog.xml	(revision 1758496)
@@ -415,6 +415,14 @@
       </fix>
     </changelog>
   </subsection>
+  <subsection name="Jasper">
+    <changelog>
+      <fix>
+        Ignore <code>engineOptionsClass</code> and <code>scratchdir</code> when
+        running under a security manager. (markt)
+      </fix>
+    </changelog>
+  </subsection>
   <subsection name="Web applications">
     <changelog>
       <fix>
Index: tc6.0.x/trunk/webapps/docs/jasper-howto.xml
===================================================================
--- tc6.0.x/trunk/webapps/docs/jasper-howto.xml	(revision 1758495)
+++ tc6.0.x/trunk/webapps/docs/jasper-howto.xml	(revision 1758496)
@@ -127,7 +127,7 @@
 
 <li><strong>engineOptionsClass</strong> - Allows specifying the Options class
 used to configure Jasper. If not present, the default EmbeddedServletOptions
-will be used.
+will be used. This option is ignored if running under a SecurityManager.
 </li>
 
 <li><strong>errorOnUseBeanInvalidClassAttribute</strong> - Should Jasper issue
@@ -172,7 +172,7 @@
 
 <li><strong>scratchdir</strong> - What scratch directory should we use when
 compiling JSP pages? Default is the work directory for the current web
-application.</li>
+application. This option is ignored if running under a SecurityManager.</li>
 
 <li><strong>suppressSmap</strong> - Should the generation of SMAP info for JSR45
 debugging be suppressed? <code>true</code> or <code>false</code>, default
Index: tc6.0.x/trunk
===================================================================
--- tc6.0.x/trunk	(revision 1758495)
+++ tc6.0.x/trunk	(revision 1758496)

Property changes on: tc6.0.x/trunk
___________________________________________________________________
Modified: svn:mergeinfo
## -0,0 +0,3 ##
   Merged /tomcat/tc7.0.x/trunk:r1758490,1758495
   Merged /tomcat/trunk:r1758486-1758487
   Merged /tomcat/tc8.5.x/trunk:r1758488,1758493
