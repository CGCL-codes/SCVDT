Index: tc7.0.x/trunk/java/org/apache/naming/factory/ResourceLinkFactory.java
===================================================================
--- tc7.0.x/trunk/java/org/apache/naming/factory/ResourceLinkFactory.java	(revision 1763235)
+++ tc7.0.x/trunk/java/org/apache/naming/factory/ResourceLinkFactory.java	(revision 1763236)
@@ -109,9 +109,12 @@
 
     private static boolean validateGlobalResourceAccess(String globalName) {
         ClassLoader cl = Thread.currentThread().getContextClassLoader();
-        Map<String,String> registrations = globalResourceRegistrations.get(cl);
-        if (registrations != null && registrations.containsValue(globalName)) {
-            return true;
+        while (cl != null) {
+            Map<String,String> registrations = globalResourceRegistrations.get(cl);
+            if (registrations != null && registrations.containsValue(globalName)) {
+                return true;
+            }
+            cl = cl.getParent();
         }
         return false;
     }
Index: tc7.0.x/trunk/webapps/docs/changelog.xml
===================================================================
--- tc7.0.x/trunk/webapps/docs/changelog.xml	(revision 1763235)
+++ tc7.0.x/trunk/webapps/docs/changelog.xml	(revision 1763236)
@@ -69,6 +69,11 @@
         <bug>60167</bug>: Ignore empty lines in <code>/etc/passwd</code> files
         when using the <code>PasswdUserDatabase</code>. (markt)
       </fix>
+      <fix>
+        Improve the access checks for linked global resources to handle the case
+        where the current class loader is a child of the web application class
+        loader. (markt)
+      </fix>
     </changelog>
   </subsection>
   <subsection name="Coyote">
Index: tc7.0.x/trunk
===================================================================
--- tc7.0.x/trunk	(revision 1763235)
+++ tc7.0.x/trunk	(revision 1763236)

Property changes on: tc7.0.x/trunk
___________________________________________________________________
Modified: svn:mergeinfo
## -0,0 +0,2 ##
   Merged /tomcat/trunk:r1763232
   Merged /tomcat/tc8.5.x/trunk:r1763233
