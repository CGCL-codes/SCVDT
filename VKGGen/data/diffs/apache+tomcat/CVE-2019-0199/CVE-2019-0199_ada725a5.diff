commit ada725a50a60867af3422c8e612aecaeea856a9a
Author:     Mark Thomas <markt@apache.org>
AuthorDate: Fri May 3 21:52:41 2019 +0100
Commit:     Mark Thomas <markt@apache.org>
CommitDate: Fri May 3 21:52:41 2019 +0100

    Fix test failures. Handle full allocation case.

diff --git a/java/org/apache/coyote/http2/Http2UpgradeHandler.java b/java/org/apache/coyote/http2/Http2UpgradeHandler.java
index 58620fda58..170e6c911a 100644
--- a/java/org/apache/coyote/http2/Http2UpgradeHandler.java
+++ b/java/org/apache/coyote/http2/Http2UpgradeHandler.java
@@ -811,8 +811,10 @@ class Http2UpgradeHandler extends AbstractStream implements InternalHttpUpgradeH
                                 stream.wait(writeTimeout);
                             }
                             // Has this stream been granted an allocation
+                            // Note: If the stream in not in this Map then the
+                            //       requested write has been fully allocated
                             int[] value = backLogStreams.get(stream);
-                            if (value[1] == 0) {
+                            if (value != null && value[1] == 0) {
                                 // No allocation
                                 // Close the connection. Do this first since
                                 // closing the stream will raise an exception
