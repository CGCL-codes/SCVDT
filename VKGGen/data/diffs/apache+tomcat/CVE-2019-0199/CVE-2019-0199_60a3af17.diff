commit 60a3af1738879ec06fac1ecb8a149608782f7cc9
Author:     remm <remm@apache.org>
AuthorDate: Fri Mar 8 18:48:45 2019 +0100
Commit:     remm <remm@apache.org>
CommitDate: Fri Mar 8 18:52:37 2019 +0100

    Check stream state after wait
    
    Verify HTTP/2 stream is still writable before assuming a timeout
    occurred. The reason for bad behavior is a bit unclear (I see it with
    logging on and async IO), but the check is inconsistent.
    # Conflicts:
    #       webapps/docs/changelog.xml

diff --git a/java/org/apache/coyote/http2/Stream.java b/java/org/apache/coyote/http2/Stream.java
index 2facca36d3..065f07b90f 100644
--- a/java/org/apache/coyote/http2/Stream.java
+++ b/java/org/apache/coyote/http2/Stream.java
@@ -1135,7 +1135,7 @@ public class Stream extends AbstractStream implements HeaderEmitter {
                             throw new IOException(sm.getString("stream.inputBuffer.reset"));
                         }
 
-                        if (inBuffer.position() == 0) {
+                        if (inBuffer.position() == 0 && isActive() && !isInputFinished()) {
                             String msg = sm.getString("stream.inputBuffer.readTimeout");
                             StreamException se = new StreamException(
                                     msg, Http2Error.ENHANCE_YOUR_CALM, getIdAsInt());
diff --git a/webapps/docs/changelog.xml b/webapps/docs/changelog.xml
index 36c3168b74..f36a7f0ada 100644
--- a/webapps/docs/changelog.xml
+++ b/webapps/docs/changelog.xml
@@ -175,6 +175,10 @@
         <bug>63223</bug>: Correctly account for push requests when tracking
         currently active HTTP/2 streams. (markt)
       </fix>
+      <fix>
+        Verify HTTP/2 stream is still writable before assuming a timeout
+        occurred. (remm)
+      </fix>
     </changelog>
   </subsection>
   <subsection name="WebSocket">
