Index: tc8.5.x/trunk/java/org/apache/tomcat/util/net/Nio2Endpoint.java
===================================================================
--- tc8.5.x/trunk/java/org/apache/tomcat/util/net/Nio2Endpoint.java	(revision 1833906)
+++ tc8.5.x/trunk/java/org/apache/tomcat/util/net/Nio2Endpoint.java	(revision 1833907)
@@ -500,7 +500,7 @@
         private final Semaphore writePending = new Semaphore(1);
         private boolean writeInterest = false; // Guarded by writeCompletionHandler
         private boolean writeNotify = false;
-        private boolean closed = false;
+        private volatile boolean closed = false;
 
         private CompletionHandler<Integer, SocketWrapperBase<Nio2Channel>> awaitBytesHandler
                 = new CompletionHandler<Integer, SocketWrapperBase<Nio2Channel>>() {
@@ -932,7 +932,7 @@
 
         @Override
         public boolean isClosed() {
-            return !getSocket().isOpen();
+            return closed || !getSocket().isOpen();
         }
 
 
Index: tc8.5.x/trunk/java/org/apache/tomcat/util/net/NioEndpoint.java
===================================================================
--- tc8.5.x/trunk/java/org/apache/tomcat/util/net/NioEndpoint.java	(revision 1833906)
+++ tc8.5.x/trunk/java/org/apache/tomcat/util/net/NioEndpoint.java	(revision 1833907)
@@ -582,6 +582,7 @@
                         // since it won't have been counted down when the socket
                         // closed.
                         socket.socketWrapper.getEndpoint().countDownConnection();
+                        ((NioSocketWrapper) socket.socketWrapper).closed = true;
                     } else {
                         final NioSocketWrapper socketWrapper = (NioSocketWrapper) key.attachment();
                         if (socketWrapper != null) {
@@ -765,6 +766,7 @@
                 }
                 if (ka != null) {
                     countDownConnection();
+                    ka.closed = true;
                 }
             } catch (Throwable e) {
                 ExceptionUtils.handleThrowable(e);
@@ -1080,6 +1082,7 @@
         private volatile SendfileData sendfileData = null;
         private volatile long lastRead = System.currentTimeMillis();
         private volatile long lastWrite = lastRead;
+        private volatile boolean closed = false;
 
         public NioSocketWrapper(NioChannel channel, NioEndpoint endpoint) {
             super(channel, endpoint);
@@ -1221,7 +1224,7 @@
 
         @Override
         public boolean isClosed() {
-            return !getSocket().isOpen();
+            return closed || !getSocket().isOpen();
         }
 
 
Index: tc8.5.x/trunk
===================================================================
--- tc8.5.x/trunk	(revision 1833906)
+++ tc8.5.x/trunk	(revision 1833907)

Property changes on: tc8.5.x/trunk
___________________________________________________________________
Modified: svn:mergeinfo
## -0,0 +0,1 ##
   Merged /tomcat/trunk:r1833906
