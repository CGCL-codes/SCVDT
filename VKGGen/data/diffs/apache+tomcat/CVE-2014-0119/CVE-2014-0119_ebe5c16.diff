commit ebe5c16f18ce1559e8462a94b3876a98525980d2
Author:     Mark Emlyn David Thomas <markt@apache.org>
AuthorDate: Fri Apr 25 10:53:44 2014 +0000
Commit:     Mark Emlyn David Thomas <markt@apache.org>
CommitDate: Fri Apr 25 10:53:44 2014 +0000

    Parser uses lazy init so move creation of parser inside the block that uses the container class loader.
    
    git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1589985 13f79535-47bb-0310-9956-ffa450edef68

diff --git a/java/org/apache/jasper/compiler/TagPluginManager.java b/java/org/apache/jasper/compiler/TagPluginManager.java
index 007230d930..8e8a49af99 100644
--- a/java/org/apache/jasper/compiler/TagPluginManager.java
+++ b/java/org/apache/jasper/compiler/TagPluginManager.java
@@ -94,16 +94,6 @@ public class TagPluginManager {
 
             parser = new TagPluginParser(ctxt, blockExternal);
 
-        } finally {
-            if (Constants.IS_SECURITY_ENABLED) {
-                PrivilegedSetTccl pa = new PrivilegedSetTccl(original);
-                AccessController.doPrivileged(pa);
-            } else {
-                Thread.currentThread().setContextClassLoader(original);
-            }
-        }
-
-        try {
             Enumeration<URL> urls =
                     ctxt.getClassLoader().getResources(META_INF_JASPER_TAG_PLUGINS_XML);
             if (urls != null) {
@@ -119,6 +109,13 @@ public class TagPluginManager {
             }
         } catch (IOException | SAXException e) {
             throw new JasperException(e);
+        } finally {
+            if (Constants.IS_SECURITY_ENABLED) {
+                PrivilegedSetTccl pa = new PrivilegedSetTccl(original);
+                AccessController.doPrivileged(pa);
+            } else {
+                Thread.currentThread().setContextClassLoader(original);
+            }
         }
 
         Map<String, String> plugins = parser.getPlugins();
