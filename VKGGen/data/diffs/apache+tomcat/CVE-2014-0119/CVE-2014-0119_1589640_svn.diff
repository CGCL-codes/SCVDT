Index: tc6.0.x/trunk/STATUS.txt
===================================================================
--- tc6.0.x/trunk/STATUS.txt	(revision 1589639)
+++ tc6.0.x/trunk/STATUS.txt	(revision 1589640)
@@ -52,12 +52,7 @@
            http://wiki.openssl.org/index.php/FIPS_mode%28%29
   -1:
 
-* Avoid memory leak and add small optimisation to default Servlet
-  http://svn.apache.org/r1588199
-  +1: markt, kkolinko, remm
-  -1:
 
-
 PATCHES/ISSUES THAT ARE STALLED:
 
 None
Index: tc6.0.x/trunk/java/org/apache/catalina/security/SecurityClassLoad.java
===================================================================
--- tc6.0.x/trunk/java/org/apache/catalina/security/SecurityClassLoad.java	(revision 1589639)
+++ tc6.0.x/trunk/java/org/apache/catalina/security/SecurityClassLoad.java	(revision 1589640)
@@ -39,6 +39,7 @@
         
         loadCorePackage(loader);
         loadLoaderPackage(loader);
+        loadServletsPackage(loader);
         loadSessionPackage(loader);
         loadUtilPackage(loader);
         loadJavaxPackage(loader);
@@ -81,6 +82,18 @@
     }
     
     
+    private static final void loadServletsPackage(ClassLoader loader)
+            throws Exception {
+        final String basePackage = "org.apache.catalina.servlets.";
+        // Avoid a possible memory leak in the DefaultServlet when running with
+        // a security manager. The DefaultServlet needs to load an XML parser
+        // when running under a security manager. We want this to be loaded by
+        // the container rather than a web application to prevent a memory leak
+        // via web application class loader.
+        loader.loadClass(basePackage + "DefaultServlet");
+    }
+
+
     private final static void loadSessionPackage(ClassLoader loader)
         throws Exception {
         String basePackage = "org.apache.catalina.";
Index: tc6.0.x/trunk/java/org/apache/catalina/servlets/DefaultServlet.java
===================================================================
--- tc6.0.x/trunk/java/org/apache/catalina/servlets/DefaultServlet.java	(revision 1589639)
+++ tc6.0.x/trunk/java/org/apache/catalina/servlets/DefaultServlet.java	(revision 1589640)
@@ -123,8 +123,7 @@
 
     private static final DocumentBuilderFactory factory;
 
-    private static final SecureEntityResolver secureEntityResolver =
-            new SecureEntityResolver();
+    private static final SecureEntityResolver secureEntityResolver;
 
 
     // ----------------------------------------------------- Instance Variables
@@ -232,9 +231,15 @@
         urlEncoder.addSafeCharacter('*');
         urlEncoder.addSafeCharacter('/');
 
-        factory = DocumentBuilderFactory.newInstance();
-        factory.setNamespaceAware(true);
-        factory.setValidating(false);
+        if (Globals.IS_SECURITY_ENABLED) {
+            factory = DocumentBuilderFactory.newInstance();
+            factory.setNamespaceAware(true);
+            factory.setValidating(false);
+            secureEntityResolver = new SecureEntityResolver();
+        } else {
+            factory = null;
+            secureEntityResolver = null;
+        }
     }
 
 
Index: tc6.0.x/trunk/webapps/docs/changelog.xml
===================================================================
--- tc6.0.x/trunk/webapps/docs/changelog.xml	(revision 1589639)
+++ tc6.0.x/trunk/webapps/docs/changelog.xml	(revision 1589640)
@@ -87,6 +87,10 @@
         reverts all the operations performed when adding an MBean notification
         listener. (markt)
       </fix>
+      <fix>
+        Only create XML parsing objects if required and fix associated potential
+        memory leak in the default Servlet. (markt)
+      </fix>
     </changelog>
   </subsection>
   <subsection name="Coyote">
Index: tc6.0.x/trunk
===================================================================
--- tc6.0.x/trunk	(revision 1589639)
+++ tc6.0.x/trunk	(revision 1589640)

Property changes on: tc6.0.x/trunk
___________________________________________________________________
Modified: svn:mergeinfo
## -0,0 +0,2 ##
   Merged /tomcat/tc7.0.x/trunk:r1588199
   Merged /tomcat/trunk:r1588193,1588197
