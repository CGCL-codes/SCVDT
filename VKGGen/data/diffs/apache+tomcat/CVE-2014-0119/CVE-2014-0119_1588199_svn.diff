Index: tc7.0.x/trunk/java/org/apache/catalina/security/SecurityClassLoad.java
===================================================================
--- tc7.0.x/trunk/java/org/apache/catalina/security/SecurityClassLoad.java	(revision 1588198)
+++ tc7.0.x/trunk/java/org/apache/catalina/security/SecurityClassLoad.java	(revision 1588199)
@@ -39,6 +39,7 @@
         loadCoyotePackage(loader);
         loadLoaderPackage(loader);
         loadRealmPackage(loader);
+        loadServletsPackage(loader);
         loadSessionPackage(loader);
         loadUtilPackage(loader);
         loadValvesPackage(loader);
@@ -122,6 +123,18 @@
     }
 
 
+    private static final void loadServletsPackage(ClassLoader loader)
+            throws Exception {
+        final String basePackage = "org.apache.catalina.servlets.";
+        // Avoid a possible memory leak in the DefaultServlet when running with
+        // a security manager. The DefaultServlet needs to load an XML parser
+        // when running under a security manager. We want this to be loaded by
+        // the container rather than a web application to prevent a memory leak
+        // via web application class loader.
+        loader.loadClass(basePackage + "DefaultServlet");
+    }
+
+
     private static final void loadSessionPackage(ClassLoader loader)
         throws Exception {
         final String basePackage = "org.apache.catalina.session.";
Index: tc7.0.x/trunk/java/org/apache/catalina/servlets/DefaultServlet.java
===================================================================
--- tc7.0.x/trunk/java/org/apache/catalina/servlets/DefaultServlet.java	(revision 1588198)
+++ tc7.0.x/trunk/java/org/apache/catalina/servlets/DefaultServlet.java	(revision 1588199)
@@ -129,8 +129,7 @@
 
     private static final DocumentBuilderFactory factory;
 
-    private static final SecureEntityResolver secureEntityResolver =
-            new SecureEntityResolver();
+    private static final SecureEntityResolver secureEntityResolver;
 
 
     // ----------------------------------------------------- Instance Variables
@@ -238,9 +237,15 @@
         urlEncoder.addSafeCharacter('*');
         urlEncoder.addSafeCharacter('/');
         
-        factory = DocumentBuilderFactory.newInstance();
-        factory.setNamespaceAware(true);
-        factory.setValidating(false);
+        if (Globals.IS_SECURITY_ENABLED) {
+            factory = DocumentBuilderFactory.newInstance();
+            factory.setNamespaceAware(true);
+            factory.setValidating(false);
+            secureEntityResolver = new SecureEntityResolver();
+        } else {
+            factory = null;
+            secureEntityResolver = null;
+        }
     }
 
 
Index: tc7.0.x/trunk/webapps/docs/changelog.xml
===================================================================
--- tc7.0.x/trunk/webapps/docs/changelog.xml	(revision 1588198)
+++ tc7.0.x/trunk/webapps/docs/changelog.xml	(revision 1588199)
@@ -87,6 +87,10 @@
         reverts all the operations performed when adding an MBean notification
         listener. (markt)
       </fix>
+      <fix>
+        Only create XML parsing objects if required and fix associated potential
+        memory leak in the default Servlet. (markt)
+      </fix>
     </changelog>
   </subsection>
   <subsection name="Jasper">
Index: tc7.0.x/trunk
===================================================================
--- tc7.0.x/trunk	(revision 1588198)
+++ tc7.0.x/trunk	(revision 1588199)

Property changes on: tc7.0.x/trunk
___________________________________________________________________
Modified: svn:mergeinfo
## -0,0 +0,1 ##
   Merged /tomcat/trunk:r1588193,1588197
