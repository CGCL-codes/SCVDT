Index: tc8.0.x/trunk/java/org/apache/tomcat/util/http/RequestUtil.java
===================================================================
--- tc8.0.x/trunk/java/org/apache/tomcat/util/http/RequestUtil.java	(revision 1700896)
+++ tc8.0.x/trunk/java/org/apache/tomcat/util/http/RequestUtil.java	(revision 1700897)
@@ -67,14 +67,6 @@
         if (!normalized.startsWith("/"))
             normalized = "/" + normalized;
 
-        if (normalized.equals("/.")) {
-            return "/";
-        }
-
-        if (normalized.equals("/..")) {
-            return null;  // Trying to go outside our context
-        }
-
         // Resolve occurrences of "//" in the normalized path
         while (true) {
             int index = normalized.indexOf("//");
@@ -106,6 +98,14 @@
             normalized = normalized.substring(0, index2) + normalized.substring(index + 3);
         }
 
+        if (normalized.equals("/.")) {
+            return "/";
+        }
+
+        if (normalized.equals("/..")) {
+            return null;  // Trying to go outside our context
+        }
+
         // Return the normalized path that we have completed
         return normalized;
     }
Index: tc8.0.x/trunk/test/org/apache/tomcat/util/http/TestRequestUtil.java
===================================================================
--- tc8.0.x/trunk/test/org/apache/tomcat/util/http/TestRequestUtil.java	(revision 1700896)
+++ tc8.0.x/trunk/test/org/apache/tomcat/util/http/TestRequestUtil.java	(revision 1700897)
@@ -87,6 +87,36 @@
         doTestNormalize("..", null);
     }
 
+    @Test
+    public void testNormalize14() {
+        doTestNormalize("//..", null);
+    }
+
+    @Test
+    public void testNormalize15() {
+        doTestNormalize("//../", null);
+    }
+
+    @Test
+    public void testNormalize16() {
+        doTestNormalize("/./..", null);
+    }
+
+    @Test
+    public void testNormalize17() {
+        doTestNormalize("/./../", null);
+    }
+
+    @Test
+    public void testNormalize18() {
+        doTestNormalize("/a/../..", null);
+    }
+
+    @Test
+    public void testNormalize19() {
+        doTestNormalize("/a/../../", null);
+    }
+
     private void doTestNormalize(String input, String expected) {
         assertEquals(expected,RequestUtil.normalize(input));
     }
Index: tc8.0.x/trunk/webapps/docs/changelog.xml
===================================================================
--- tc8.0.x/trunk/webapps/docs/changelog.xml	(revision 1700896)
+++ tc8.0.x/trunk/webapps/docs/changelog.xml	(revision 1700897)
@@ -53,6 +53,13 @@
       </fix>
     </changelog>
   </subsection>
+  <subsection name="Coyote">
+    <changelog>
+      <fix>
+        Correct some edge cases in <code>RequestUtil.normalize()</code>. (markt)
+      </fix>
+    </changelog>
+  </subsection>
   <subsection name="Web applications">
     <changelog>
       <fix>
@@ -212,7 +219,7 @@
         (markt)
       </fix>
       <fix>
-        Correct a coupe of edge cases in <code>RequestUtil.normalize()</code>.
+        Correct a couple of edge cases in <code>RequestUtil.normalize()</code>.
         (markt)
       </fix>
     </changelog>
Index: tc8.0.x/trunk
===================================================================
--- tc8.0.x/trunk	(revision 1700896)
+++ tc8.0.x/trunk	(revision 1700897)

Property changes on: tc8.0.x/trunk
___________________________________________________________________
Modified: svn:mergeinfo
## -0,0 +0,1 ##
   Merged /tomcat/trunk:r1700896
