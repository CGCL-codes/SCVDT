Index: tc7.0.x/trunk/java/org/apache/catalina/servlets/DefaultServlet.java
===================================================================
--- tc7.0.x/trunk/java/org/apache/catalina/servlets/DefaultServlet.java	(revision 1793470)
+++ tc7.0.x/trunk/java/org/apache/catalina/servlets/DefaultServlet.java	(revision 1793471)
@@ -245,7 +245,7 @@
         urlEncoder.addSafeCharacter('.');
         urlEncoder.addSafeCharacter('*');
         urlEncoder.addSafeCharacter('/');
-        
+
         if (Globals.IS_SECURITY_ENABLED) {
             factory = DocumentBuilderFactory.newInstance();
             factory.setNamespaceAware(true);
@@ -860,8 +860,7 @@
             }
         }
 
-        boolean isError =
-            response.getStatus() >= HttpServletResponse.SC_BAD_REQUEST;
+        boolean isError = DispatcherType.ERROR == request.getDispatcherType();
 
         // Check if the conditions specified in the optional If headers are
         // satisfied.
@@ -1326,7 +1325,7 @@
 
     }
 
-    
+
     /**
      * Return an InputStream to an HTML representation of the contents
      * of this directory.
@@ -1767,15 +1766,15 @@
 
 
     private File validateGlobalXsltFile() {
-        
+
         File result = null;
         String base = System.getProperty(Globals.CATALINA_BASE_PROP);
-        
+
         if (base != null) {
             File baseConf = new File(base, "conf");
             result = validateGlobalXsltFile(baseConf);
         }
-        
+
         if (result == null) {
             String home = System.getProperty(Globals.CATALINA_HOME_PROP);
             if (home != null && !home.equals(base)) {
@@ -2364,6 +2363,8 @@
 
         /**
          * Validate range.
+         *
+         * @return true if the range is valid, otherwise false
          */
         public boolean validate() {
             if (end >= length)
Index: tc7.0.x/trunk/webapps/docs/changelog.xml
===================================================================
--- tc7.0.x/trunk/webapps/docs/changelog.xml	(revision 1793470)
+++ tc7.0.x/trunk/webapps/docs/changelog.xml	(revision 1793471)
@@ -74,6 +74,11 @@
         ensure that that correct encoding (path differs from query string) is
         applied and that the encoding is applied consistently. (markt)
       </fix>
+      <fix>
+        Use a more reliable mechanism for the <code>DefaultServlet</code> when
+        determining if the current request is for custom error page or not.
+        (markt)
+      </fix>
     </changelog>
   </subsection>
   <subsection name="Jasper">
Index: tc7.0.x/trunk
===================================================================
--- tc7.0.x/trunk	(revision 1793470)
+++ tc7.0.x/trunk	(revision 1793471)

Property changes on: tc7.0.x/trunk
___________________________________________________________________
Modified: svn:mergeinfo
## -0,0 +0,2 ##
   Merged /tomcat/trunk:r1793468
   Merged /tomcat/tc8.5.x/trunk:r1793469
