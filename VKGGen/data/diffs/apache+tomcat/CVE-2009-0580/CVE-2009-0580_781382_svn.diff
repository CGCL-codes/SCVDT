Index: container/branches/tc4.1.x/RELEASE-NOTES-4.1.txt
===================================================================
--- container/branches/tc4.1.x/RELEASE-NOTES-4.1.txt	(revision 781381)
+++ container/branches/tc4.1.x/RELEASE-NOTES-4.1.txt	(revision 781382)
@@ -1753,7 +1753,12 @@
          Fix typo in French localisation file name for the
          org.apache.catalina.loader package.
 
+[4.1.40] Realms
+         Fix information disclosure vulnerability that permitted user
+         enumeration when using FORM authentication.
+         This is CVE-2009-0580.
 
+
 ----------------
 Coyote Bug Fixes:
 ----------------
Index: container/branches/tc4.1.x/catalina/src/share/org/apache/catalina/realm/DataSourceRealm.java
===================================================================
--- container/branches/tc4.1.x/catalina/src/share/org/apache/catalina/realm/DataSourceRealm.java	(revision 781381)
+++ container/branches/tc4.1.x/catalina/src/share/org/apache/catalina/realm/DataSourceRealm.java	(revision 781382)
@@ -270,8 +270,9 @@
      */
     public Principal authenticate(String username, String credentials) {
 
-        // No user - can't possibly authenticate, don't bother the database then
-        if (username == null) {
+        // No user or no credentials
+        // Can't possibly authenticate, don't bother the database then
+        if (username == null || credentials == null) {
             return null;
         }
 
Index: container/branches/tc4.1.x/catalina/src/share/org/apache/catalina/realm/JDBCRealm.java
===================================================================
--- container/branches/tc4.1.x/catalina/src/share/org/apache/catalina/realm/JDBCRealm.java	(revision 781381)
+++ container/branches/tc4.1.x/catalina/src/share/org/apache/catalina/realm/JDBCRealm.java	(revision 781382)
@@ -391,10 +391,10 @@
                                                String username,
                                                String credentials) {
 
-
-        // No user - can't possibly authenticate
-        if (username == null) {
-            return (null);
+        // No user or no credentials
+        // Can't possibly authenticate, don't bother the database then
+        if (username == null || credentials == null) {
+            return null;
         }
 
         // Look up the user's credentials
Index: container/branches/tc4.1.x/catalina/src/share/org/apache/catalina/realm/MemoryRealm.java
===================================================================
--- container/branches/tc4.1.x/catalina/src/share/org/apache/catalina/realm/MemoryRealm.java	(revision 781381)
+++ container/branches/tc4.1.x/catalina/src/share/org/apache/catalina/realm/MemoryRealm.java	(revision 781382)
@@ -144,7 +144,7 @@
             (GenericPrincipal) principals.get(username);
 
         boolean validated = false;
-        if (principal != null) {
+        if (principal != null && credentials != null) {
             if (hasMessageDigest()) {
                 // Hex hashes should be compared case-insensitive
                 validated = (digest(credentials)
