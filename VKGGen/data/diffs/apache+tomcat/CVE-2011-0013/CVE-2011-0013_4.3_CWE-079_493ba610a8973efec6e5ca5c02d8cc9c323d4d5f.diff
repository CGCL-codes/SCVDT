commit 493ba610a8973efec6e5ca5c02d8cc9c323d4d5f
Author:     Mark Thomas <markt@apache.org>
AuthorDate: Mon Jan 10 16:58:10 2011 +0000
Commit:     Mark Thomas <markt@apache.org>
CommitDate: Mon Jan 10 16:58:10 2011 +0000

    Prevent XSS in Manager application
    This addresses CVE-2011-0013
    
    
    git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1057279 13f79535-47bb-0310-9956-ffa450edef68

diff --git a/java/org/apache/catalina/manager/HTMLManagerServlet.java b/java/org/apache/catalina/manager/HTMLManagerServlet.java
index 5a1e540bb2..93d51fc90e 100644
--- a/java/org/apache/catalina/manager/HTMLManagerServlet.java
+++ b/java/org/apache/catalina/manager/HTMLManagerServlet.java
@@ -523,19 +523,21 @@ public final class HTMLManagerServlet extends ManagerServlet {
                 }
                 
                 args = new Object[7];
-                args[0] = "<a href=\"" + URL_ENCODER.encode(displayPath) +
-                        "\">" + displayPath + "</a>";
-                args[1] = ctxt.getWebappVersion();
-                if ("".equals(args[1])) {
-                    args[1]= noVersion;
+                args[0] = "<a href=\"" + URL_ENCODER.encode(displayPath)
+                        + "\">" + RequestUtil.filter(displayPath) + "</a>";
+                if ("".equals(ctxt.getWebappVersion())) {
+                    args[1] = noVersion;
+                } else {
+                    args[1] = RequestUtil.filter(ctxt.getWebappVersion());
                 }
-                args[2] = ctxt.getDisplayName();
-                if (args[2] == null) {
+                if (ctxt.getDisplayName() == null) {
                     args[2] = "&nbsp;";
+                } else {
+                    args[2] = RequestUtil.filter(ctxt.getDisplayName());
                 }
                 args[3] = Boolean.valueOf(ctxt.getAvailable());
-                args[4] = response.encodeURL(request.getContextPath() +
-                     "/html/sessions?" + pathVersion);
+                args[4] = RequestUtil.filter(response.encodeURL(request.getContextPath() +
+                     "/html/sessions?" + pathVersion));
                 Manager manager = ctxt.getManager(); 
                 if (manager instanceof DistributedManager && showProxySessions) {
                     args[5] = Integer.valueOf(
@@ -552,20 +554,20 @@ public final class HTMLManagerServlet extends ManagerServlet {
                     (MessageFormat.format(APPS_ROW_DETAILS_SECTION, args));
 
                 args = new Object[14];
-                args[0] = response.encodeURL(request.getContextPath() +
-                        "/html/start?" + pathVersion);
+                args[0] = RequestUtil.filter(response.encodeURL(request
+                        .getContextPath() + "/html/start?" + pathVersion));
                 args[1] = appsStart;
-                args[2] = response.encodeURL(request.getContextPath() +
-                        "/html/stop?" + pathVersion);
+                args[2] = RequestUtil.filter(response.encodeURL(request
+                        .getContextPath() + "/html/stop?" + pathVersion));
                 args[3] = appsStop;
-                args[4] = response.encodeURL(request.getContextPath() +
-                     "/html/reload?" + pathVersion);
+                args[4] = RequestUtil.filter(response.encodeURL(request
+                        .getContextPath() + "/html/reload?" + pathVersion));
                 args[5] = appsReload;
-                args[6] = response.encodeURL(request.getContextPath() +
-                     "/html/undeploy?" + pathVersion);
+                args[6] = RequestUtil.filter(response.encodeURL(request
+                        .getContextPath() + "/html/undeploy?" + pathVersion));
                 args[7] = appsUndeploy;
-                args[8] = response.encodeURL(request.getContextPath() +
-                     "/html/expire?" + pathVersion);
+                args[8] = RequestUtil.filter(response.encodeURL(request
+                        .getContextPath() + "/html/expire?" + pathVersion));
                 args[9] = appsExpire;
                 args[10] = smClient.getString(
                         "htmlManagerServlet.expire.explain");
diff --git a/java/org/apache/catalina/manager/StatusTransformer.java b/java/org/apache/catalina/manager/StatusTransformer.java
index f93bb5819a..4f84fb0afe 100644
--- a/java/org/apache/catalina/manager/StatusTransformer.java
+++ b/java/org/apache/catalina/manager/StatusTransformer.java
@@ -572,7 +572,7 @@ public class StatusTransformer {
                 }
 
                 writer.print("<a href=\"#" + (count++) + ".0\">");
-                writer.print(webModuleName);
+                writer.print(filter(webModuleName));
                 writer.print("</a>");
                 if (iterator.hasNext()) {
                     writer.print("<br>");
@@ -649,7 +649,7 @@ public class StatusTransformer {
             }
 
             writer.print("<h1>");
-            writer.print(name);
+            writer.print(filter(name));
             writer.print("</h1>");
             writer.print("</a>");
 
@@ -778,11 +778,11 @@ public class StatusTransformer {
                 mBeanServer.invoke(objectName, "findMappings", null, null);
             
             writer.print("<h2>");
-            writer.print(servletName);
+            writer.print(filter(servletName));
             if ((mappings != null) && (mappings.length > 0)) {
                 writer.print(" [ ");
                 for (int i = 0; i < mappings.length; i++) {
-                    writer.print(mappings[i]);
+                    writer.print(filter(mappings[i]));
                     if (i < mappings.length - 1) {
                         writer.print(" , ");
                     }
diff --git a/webapps/docs/changelog.xml b/webapps/docs/changelog.xml
index ce8454e389..91694323bf 100644
--- a/webapps/docs/changelog.xml
+++ b/webapps/docs/changelog.xml
@@ -314,6 +314,9 @@
         <bug>50488</bug>: Update classpath required when using jsvc and add a
         note regarding server VMs. (markt)
       </fix>
+      <fix>
+        Further filtering of Manager and Host Manager display output. (kkolinko) 
+      </fix>
     </changelog>
   </subsection>
   <subsection name="Other">
