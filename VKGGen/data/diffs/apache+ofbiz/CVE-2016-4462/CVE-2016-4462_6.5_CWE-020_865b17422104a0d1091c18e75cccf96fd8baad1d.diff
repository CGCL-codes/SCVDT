commit 865b17422104a0d1091c18e75cccf96fd8baad1d
Author:     Jacques Le Roux <jleroux@apache.org>
AuthorDate: Thu Sep 22 16:52:56 2016 +0000
Commit:     Jacques Le Roux <jleroux@apache.org>
CommitDate: Thu Sep 22 16:52:56 2016 +0000

    Fixes: Sorting of lists generates undesired results
    (OFBIZ-8302)
    
    This was due to r1759555 has Scott spotted on. r1759555 fixed a vulnerability
    but as explained in r1759555 commit message we used
    >2 redundant mechanisms (better safe than sorry):
    >1) linkUrl = URLEncoder.encode(linkUrl, "UTF-8");
    >2) sr.append("\" linkUrl=r\"");
    
    Removing the 1st way fixes the reported issue and we are still safe.
    
    I'll have a look at how the catalog/control/FindProduct URL is generated to be
    sure it's OK as is
    
    Thanks: Pierre for report, Scott for spotting the issue.
    
    [CVE-2016-4462] OFBiz template remote code vulnerability
    By manipulating the URL parameter externalLoginKey, a malicious, logged in
    user could pass valid Freemarker directives to the Template Engine that are
    reflected on the webpage; a specially crafted Freemarker template could be
    used for remote code execution.
    
    
    
    git-svn-id: https://svn.apache.org/repos/asf/ofbiz/trunk@1761978 13f79535-47bb-0310-9956-ffa450edef68

diff --git a/framework/widget/src/main/java/org/apache/ofbiz/widget/renderer/macro/MacroFormRenderer.java b/framework/widget/src/main/java/org/apache/ofbiz/widget/renderer/macro/MacroFormRenderer.java
index 79b4bf7cbd..0a1c7c377f 100644
--- a/framework/widget/src/main/java/org/apache/ofbiz/widget/renderer/macro/MacroFormRenderer.java
+++ b/framework/widget/src/main/java/org/apache/ofbiz/widget/renderer/macro/MacroFormRenderer.java
@@ -22,7 +22,6 @@ import java.io.IOException;
 import java.io.Reader;
 import java.io.StringReader;
 import java.io.StringWriter;
-import java.net.URLEncoder;
 import java.rmi.server.UID;
 import java.sql.Timestamp;
 import java.util.HashSet;
@@ -2867,7 +2866,6 @@ public final class MacroFormRenderer implements FormStringRenderer {
             String newQueryString = sb.toString();
             String urlPath = UtilHttp.removeQueryStringFromTarget(paginateTarget);
             linkUrl = rh.makeLink(this.request, this.response, urlPath.concat(newQueryString));
-            linkUrl = URLEncoder.encode(linkUrl, "UTF-8");
         }
         StringWriter sr = new StringWriter();
         sr.append("<@renderSortField ");
