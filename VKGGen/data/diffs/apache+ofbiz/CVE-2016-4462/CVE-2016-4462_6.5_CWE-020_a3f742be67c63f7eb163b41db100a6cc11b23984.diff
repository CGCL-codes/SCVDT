commit a3f742be67c63f7eb163b41db100a6cc11b23984
Author:     Jacques Le Roux <jleroux@apache.org>
AuthorDate: Thu Sep 22 18:04:26 2016 +0000
Commit:     Jacques Le Roux <jleroux@apache.org>
CommitDate: Thu Sep 22 18:04:26 2016 +0000

    "Applied fix from trunk for revision: 1761978" (conflict handled by hand)
    ------------------------------------------------------------------------
    r1761978 | jleroux | 2016-09-22 18:52:56 +0200 (jeu. 22 sept. 2016) | 15 lignes
    
    Fixes: Sorting of lists generates undesired results
    (OFBIZ-8302)
    
    This was due to r1759555 has Scott spotted on. r1759555 fixed a vulnerability
    but as explained in r1759555 commit message we used
    >2 redundant mechanisms (better safe than sorry):
    >1) linkUrl = URLEncoder.encode(linkUrl, "UTF-8");
    >2) sr.append("\" linkUrl=r\"");
    
    Removing the 1st way fixes the reported issue and we are still safe.
    
    I'll have a look at how the catalog/control/FindProduct URL is generated to be
    sure it's OK as is
    
    Thanks: Pierre for report, Scott for spotting the issue.
    ------------------------------------------------------------------------
    
    [CVE-2016-4462] OFBiz template remote code vulnerability
    By manipulating the URL parameter externalLoginKey, a malicious, logged in
    user could pass valid Freemarker directives to the Template Engine that are
    reflected on the webpage; a specially crafted Freemarker template could be
    used for remote code execution.
    
    
    
    git-svn-id: https://svn.apache.org/repos/asf/ofbiz/branches/release13.07@1761986 13f79535-47bb-0310-9956-ffa450edef68

diff --git a/framework/widget/src/org/ofbiz/widget/form/MacroFormRenderer.java b/framework/widget/src/org/ofbiz/widget/form/MacroFormRenderer.java
index 9b14aae3a6..40f1f69225 100644
--- a/framework/widget/src/org/ofbiz/widget/form/MacroFormRenderer.java
+++ b/framework/widget/src/org/ofbiz/widget/form/MacroFormRenderer.java
@@ -22,7 +22,6 @@ import java.io.IOException;
 import java.io.Reader;
 import java.io.StringReader;
 import java.io.StringWriter;
-import java.net.URLEncoder;
 import java.rmi.server.UID;
 import java.sql.Timestamp;
 import java.util.HashSet;
@@ -30,16 +29,14 @@ import java.util.Iterator;
 import java.util.List;
 import java.util.Locale;
 import java.util.Map;
+import java.util.Map.Entry;
 import java.util.Set;
 import java.util.WeakHashMap;
-import java.util.Map.Entry;
 
 import javax.servlet.ServletContext;
 import javax.servlet.http.HttpServletRequest;
 import javax.servlet.http.HttpServletResponse;
 
-import javolution.util.FastList;
-
 import org.ofbiz.base.util.Debug;
 import org.ofbiz.base.util.StringUtil;
 import org.ofbiz.base.util.UtilFormatOut;
@@ -83,6 +80,7 @@ import com.ibm.icu.util.Calendar;
 import freemarker.core.Environment;
 import freemarker.template.Template;
 import freemarker.template.TemplateException;
+import javolution.util.FastList;
 
 /**
  * Widget Library - Form Renderer implementation based on Freemarker macros
@@ -2762,8 +2760,6 @@ public class MacroFormRenderer implements FormStringRenderer {
             }
             String newQueryString = sb.toString();
             String urlPath = UtilHttp.removeQueryStringFromTarget(paginateTarget);
-            linkUrl = rh.makeLink(this.request, this.response, urlPath.concat(newQueryString));
-            linkUrl = URLEncoder.encode(linkUrl, "UTF-8");
         }
         StringWriter sr = new StringWriter();
         sr.append("<@renderSortField ");
