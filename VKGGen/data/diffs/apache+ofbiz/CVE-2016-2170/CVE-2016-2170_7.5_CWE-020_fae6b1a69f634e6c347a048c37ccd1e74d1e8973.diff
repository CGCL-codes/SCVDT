commit fae6b1a69f634e6c347a048c37ccd1e74d1e8973
Author:     Jacques Le Roux <jleroux@apache.org>
AuthorDate: Fri Mar 18 12:20:28 2016 +0000
Commit:     Jacques Le Roux <jleroux@apache.org>
CommitDate: Fri Mar 18 12:20:28 2016 +0000

    "Applied fix from trunk for revision: 1735569  " (conflicts handled by hand)
    ------------------------------------------------------------------------
    r1735569 | jleroux | 2016-03-18 11:38:04 +0100 (ven. 18 mars 2016) | 3 lignes
    
    Fixes "Comment out RMI related code because of the Java deserialization issue" - https://issues.apache.org/jira/browse/OFBIZ-6942
    
    I decided to comment out as less as possible because once the RMI loaders, the RMI dispatcher and the related test services are off there is no RMI related danger left (test services are not a danger but would fail during tests run). It's then easier for users who need RMI in their projects to have only to uncomment those and not digg everywhere. Because the naming (JNDI) server relies on the rmi loader it will also be commented out.
    
    [CVE-2016-2170] The infamous Java serialization vulnerability
    ------------------------------------------------------------------------
    
    
    git-svn-id: https://svn.apache.org/repos/asf/ofbiz/branches/release13.07@1735585 13f79535-47bb-0310-9956-ffa450edef68

diff --git a/framework/base/config/ofbiz-containers.xml b/framework/base/config/ofbiz-containers.xml
index d53bfb18b8..de5a17df03 100644
--- a/framework/base/config/ofbiz-containers.xml
+++ b/framework/base/config/ofbiz-containers.xml
@@ -21,8 +21,11 @@ under the License.
 <ofbiz-containers xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:noNamespaceSchemaLocation="http://ofbiz.apache.org/dtds/ofbiz-containers.xsd">
 
+    <!-- Because of the danger of Java deserialization when using RMI, we (PMC) have decided to comment out main RMI related code entries.
+         If you need RMI you just need to uncomment those places - See OFBIZ-6942 for details -->
     <!-- load the ofbiz component container (always first) -->
-    <container name="component-container" loaders="main,rmi,pos,install" class="org.ofbiz.base.container.ComponentContainer"/>
+    <!-- <container name="component-container" loaders="main,rmi,pos,install" class="org.ofbiz.base.container.ComponentContainer"/> -->
+    <container name="component-container" loaders="main,pos,install" class="org.ofbiz.base.container.ComponentContainer"/>
 
     <container name="component-container-test" loaders="test" class="org.ofbiz.base.container.ComponentContainer">
         <property name="ofbiz.instrumenterClassName" value="org.ofbiz.base.config.CoberturaInstrumenter"/>
diff --git a/framework/base/ofbiz-component.xml b/framework/base/ofbiz-component.xml
index de584fb49c..c54955f81d 100644
--- a/framework/base/ofbiz-component.xml
+++ b/framework/base/ofbiz-component.xml
@@ -28,14 +28,17 @@ under the License.
 
     <test-suite loader="main" location="testdef/basetests.xml"/>
 
+    <!-- Because of the danger of Java deserialization when using RMI, we (PMC) have decided to comment out main RMI related code entries.
+         If you need RMI you just need to uncomment those places - See OFBIZ-6942 for details -->
     <!-- load the cached classloader container (always second) -->
-    <container name="classloader-container" loaders="main,rmi,pos,install,test" class="org.ofbiz.base.container.ClassLoaderContainer"/>
+    <!-- <container name="classloader-container" loaders="main,rmi,pos,install,test" class="org.ofbiz.base.container.ClassLoaderContainer"/> -->
+    <container name="classloader-container" loaders="main,pos,install,test" class="org.ofbiz.base.container.ClassLoaderContainer"/>
 
     <!-- load the naming (JNDI) server -->
-    <container name="naming-container" loaders="rmi" class="org.ofbiz.base.container.NamingServiceContainer">
+    <!-- <container name="naming-container" loaders="rmi" class="org.ofbiz.base.container.NamingServiceContainer">
         <property name="host" value="0.0.0.0"/>
         <property name="port" value="1099"/>
-    </container>
+    </container> -->
 
     <!-- load BeanShell remote telnet server -->
     <!-- Commented out by default for security reasons -->
diff --git a/framework/common/servicedef/services_test.xml b/framework/common/servicedef/services_test.xml
index 2a8e07f10d..73d40a0df0 100644
--- a/framework/common/servicedef/services_test.xml
+++ b/framework/common/servicedef/services_test.xml
@@ -47,15 +47,17 @@ under the License.
     <service name="testError" engine="java" export="true" validate="false" require-new-transaction="true" max-retry="1"
             location="org.ofbiz.common.CommonServices" invoke="returnErrorService">
     </service>
+    <!-- Because of the danger of Java deserialization when using RMI, we (PMC) have decided to comment out main RMI related code entries.
+         If you need RMI you just need to uncomment those places - See OFBIZ-6942 for details -->
     <!-- see serviceengine.xml to configure the rmi location alias -->
-    <service name="testRmi" engine="rmi" validate="false"
+    <!-- <service name="testRmi" engine="rmi" validate="false"
             location="main-rmi" invoke="testScv">
         <implements service="testScv"/>
     </service>
     <service name="testRmiFail" engine="rmi" validate="false"
             location="main-rmi" invoke="testBsh">
         <implements service="testScv"/>
-    </service>
+    </service> -->
 
     <service name="testRollback" engine="java" export="true" validate="false"
             location="org.ofbiz.common.CommonServices" invoke="testRollbackListener">
diff --git a/framework/service/ofbiz-component.xml b/framework/service/ofbiz-component.xml
index 32330464a4..ee2d9f1e5e 100644
--- a/framework/service/ofbiz-component.xml
+++ b/framework/service/ofbiz-component.xml
@@ -44,12 +44,17 @@ under the License.
     <keystore name="rmitrust" type="jks" password="changeit" is-truststore="true"
               is-certstore="false" loader="main" location="config/rmitrust.jks"/>
 
-    <container name="service-container" loaders="main,rmi,pos,install,test" class="org.ofbiz.service.ServiceContainer">
+    <!-- Because of the danger of Java deserialization when using RMI, we (PMC) have decided to comment out main RMI related code entries.
+         If you need RMI you just need to uncomment those places - See OFBIZ-6942 for details -->
+    <!-- <container name="service-container" loaders="main,rmi,pos,install,test" class="org.ofbiz.service.ServiceContainer"> -->
+    <container name="service-container" loaders="main,pos,install,test" class="org.ofbiz.service.ServiceContainer">
         <property name="dispatcher-factory" value="org.ofbiz.service.GenericDispatcherFactory"/>
     </container>
 
+    <!-- Because of the danger of Java deserialization when using RMI, we (PMC) have decided to comment out main RMI related code entries.
+         If you need RMI you just need to uncomment those places - See OFBIZ-6942 for details -->
     <!-- RMI Service Dispatcher -->
-    <container name="rmi-dispatcher" loaders="rmi" class="org.ofbiz.service.rmi.RmiServiceContainer">
+    <!-- <container name="rmi-dispatcher" loaders="rmi" class="org.ofbiz.service.rmi.RmiServiceContainer">
         <property name="bound-name" value="RMIDispatcher"/>
         <property name="bound-host" value="127.0.0.1"/>
         <property name="bound-port" value="1099"/>
@@ -61,7 +66,7 @@ under the License.
         <property name="ssl-keystore-pass" value="changeit"/>
         <property name="ssl-keystore-alias" value="rmissl"/>
         <property name="ssl-client-auth" value="false"/>
-    </container>
+    </container> -->
 
     <!-- JavaMail Listener Container - Triggers MCA Rules -->
     <!-- if delete-mail is set to true, will delete messages after fetching them. otherwise, will try to mark them as seen
diff --git a/framework/start/src/org/ofbiz/base/start/both.properties b/framework/start/src/org/ofbiz/base/start/both.properties
index 42e089dca4..ea64c7b7fb 100644
--- a/framework/start/src/org/ofbiz/base/start/both.properties
+++ b/framework/start/src/org/ofbiz/base/start/both.properties
@@ -46,7 +46,10 @@ ofbiz.start.loader1=org.ofbiz.base.splash.SplashLoader
 
 # --- StartupLoader implementations to load (in order)
 ofbiz.start.loader2=org.ofbiz.base.container.ContainerLoader
-ofbiz.start.loader2.loaders=main,pos,rmi
+# Because of the danger of Java deserialization when using RMI, we (PMC) have decided to comment out main RMI related code entries.
+# If you need RMI you just need to uncomment those places - See OFBIZ-6942 for details -->
+#ofbiz.start.loader2.loaders=main,pos,rmi
+ofbiz.start.loader2.loaders=main,pos
 
 # -- Splash Logo
 ofbiz.start.splash.logo=framework/images/webapp/images/ofbiz_logo.gif
