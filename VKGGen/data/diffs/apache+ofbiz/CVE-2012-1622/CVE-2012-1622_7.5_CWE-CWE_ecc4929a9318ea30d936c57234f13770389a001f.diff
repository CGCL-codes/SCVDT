commit ecc4929a9318ea30d936c57234f13770389a001f
Author:     Adrian Crum <adrianc@apache.org>
AuthorDate: Thu Apr 5 14:20:56 2012 +0000
Commit:     Adrian Crum <adrianc@apache.org>
CommitDate: Thu Apr 5 14:20:56 2012 +0000

    CVE-2012-1622: Disable support for nested scripts in FlexibleStringExpander.
    
    
    git-svn-id: https://svn.apache.org/repos/asf/ofbiz/trunk@1309879 13f79535-47bb-0310-9956-ffa450edef68

diff --git a/framework/base/src/org/ofbiz/base/util/string/FlexibleStringExpander.java b/framework/base/src/org/ofbiz/base/util/string/FlexibleStringExpander.java
index 1e54f0ac68..efbf8ee622 100644
--- a/framework/base/src/org/ofbiz/base/util/string/FlexibleStringExpander.java
+++ b/framework/base/src/org/ofbiz/base/util/string/FlexibleStringExpander.java
@@ -720,6 +720,9 @@ public abstract class FlexibleStringExpander implements Serializable, IsEmpty {
                     String str = (String) obj;
                     if (str.contains(openBracket)) {
                         FlexibleStringExpander fse = FlexibleStringExpander.getInstance(str);
+                        if (containsScript(fse)) {
+                            throw new UnsupportedOperationException("Nested scripts are not supported");
+                        }
                         return fse.get(context, timeZone, locale);
                     }
                 } catch (ClassCastException e) {}
diff --git a/framework/base/src/org/ofbiz/base/util/string/test/FlexibleStringExpanderTests.java b/framework/base/src/org/ofbiz/base/util/string/test/FlexibleStringExpanderTests.java
index 22c22e823b..bb30f0902c 100644
--- a/framework/base/src/org/ofbiz/base/util/string/test/FlexibleStringExpanderTests.java
+++ b/framework/base/src/org/ofbiz/base/util/string/test/FlexibleStringExpanderTests.java
@@ -286,6 +286,16 @@ public class FlexibleStringExpanderTests extends TestCase {
         List<String> testList = new ArrayList<String>();
         testList.add("World");
         testMap.put("testList", testList);
+        testMap.put("testScript", "${groovy:return null;}");
+        UnsupportedOperationException caught = null;
+        try {
+            FlexibleStringExpander fse = FlexibleStringExpander.getInstance("${testScript}");
+            fse.expandString(testMap);
+        } catch (UnsupportedOperationException e) {
+            caught = e;
+        } finally {
+            assertNotNull("UnsupportedOperationException thrown for nested script", caught);
+        }
         fseTest("null FlexibleStringExpander, null map", null, null, null, null, "", null, true);
         fseTest("null FlexibleStringExpander", null, testMap, null, null, "", null, true);
         fseTest("null context", "Hello World!", null, null, null, "Hello World!", null, false);
