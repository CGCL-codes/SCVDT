commit 4817d0a883e6668dcd27c7d8ce6e976f57f553e0
Author:     Jacques Le Roux <jleroux@apache.org>
AuthorDate: Mon Dec 31 06:40:04 2018 +0000
Commit:     Jacques Le Roux <jleroux@apache.org>
CommitDate: Mon Dec 31 06:40:04 2018 +0000

    "Applied fix from trunk framework for revision: 1850015  "
    ------------------------------------------------------------------------
    r1850015 | jleroux | 2018-12-31 07:38:36 +0100 (lun. 31 d√©c. 2018) | 16 lignes
    
    Improved: Prepare the migration to XStream 1.5
    (OFBIZ-10756)
    
    Fixes CVE-2018-17200
    
    We currently use the UnsupportedClassConverter method in UtilXml class.
    When the 1.5 version of XStream will be available another way to handle this
    kind of things will be available and used by default. It's already possible to
    use the same with the 1.4 version of XStream with its setupDefaultSecurity method.
    
    So this replaces the UnsupportedClassConverter in UtilXml class by
    XStream::setupDefaultSecurity method.
    
    It's an improvement but better to backport it as much as possible
    
    The UtilXmlTests class and its use is removed and the UnsupportedClassConverter
    method deprecated (no use OOTB)
    
    
    ------------------------------------------------------------------------
    
    
    git-svn-id: https://svn.apache.org/repos/asf/ofbiz/branches/release16.11@1850017 13f79535-47bb-0310-9956-ffa450edef68

diff --git a/framework/base/src/main/java/org/apache/ofbiz/base/util/UtilXml.java b/framework/base/src/main/java/org/apache/ofbiz/base/util/UtilXml.java
index 4c942ea0f5..3ca71bbd41 100644
--- a/framework/base/src/main/java/org/apache/ofbiz/base/util/UtilXml.java
+++ b/framework/base/src/main/java/org/apache/ofbiz/base/util/UtilXml.java
@@ -91,7 +91,15 @@ public final class UtilXml {
 
     private static XStream createXStream() {
         XStream xstream = new XStream();
-        xstream.registerConverter(new UnsupportedClassConverter());
+        /* This method is a pure helper method for XStream 1.4.x. 
+         * It initializes an XStream instance with a white list of well-known and simply types of the Java runtime
+         *  as it is done in XStream 1.5.x by default. This method will do therefore nothing in XStream 1.5
+         *  and could be removed them  
+         */ 
+        XStream.setupDefaultSecurity(xstream); 
+        /* You may want to enhance the white list created by XStream::setupDefaultSecurity (or by default with XStream 1.5) 
+         * using xstream::allowTypesByWildcard with your own classes
+         */  
         return xstream;
     }
 
@@ -1116,6 +1124,11 @@ public final class UtilXml {
         }
     }
 
+    /** This method is now useless
+     * Enhance rather the white list created by XStream::setupDefaultSecurity
+     * using xstream::allowTypesByWildcard with your own classes  
+     */
+    @Deprecated
     private static class UnsupportedClassConverter implements Converter {
 
         @Override
@@ -1140,7 +1153,7 @@ public final class UtilXml {
     /**
      * get node name without any prefix
      * @param node
-     * @return
+     * @return nodeName
      */
     public static String getNodeNameIgnorePrefix(Node node){
         if (node==null) return null;
@@ -1155,8 +1168,8 @@ public final class UtilXml {
     /**
      * get tag name without any prefix
      * @param node
-     * @return
-     */
+     * @return tagName
+     */ 
     public static String getTagNameIgnorePrefix(Element element){
         if (element==null) return null;
         String tagName = element.getTagName();
@@ -1170,7 +1183,7 @@ public final class UtilXml {
     /**
      * get attribute value ignoring prefix in attribute name
      * @param node
-     * @return
+     * @return The value of the node, depending on its type; see the table Node class
      */
     public static String getAttributeValueIgnorePrefix(Element element, String attributeName){
         if (element==null) return "";
diff --git a/framework/base/src/main/java/org/apache/ofbiz/base/util/test/UtilXmlTests.java b/framework/base/src/main/java/org/apache/ofbiz/base/util/test/UtilXmlTests.java
deleted file mode 100644
index b7f5c6d88e..0000000000
--- a/framework/base/src/main/java/org/apache/ofbiz/base/util/test/UtilXmlTests.java
+++ /dev/null
@@ -1,48 +0,0 @@
-/*******************************************************************************
- * Licensed to the Apache Software Foundation (ASF) under one
- * or more contributor license agreements.  See the NOTICE file
- * distributed with this work for additional information
- * regarding copyright ownership.  The ASF licenses this file
- * to you under the Apache License, Version 2.0 (the
- * "License"); you may not use this file except in compliance
- * with the License.  You may obtain a copy of the License at
- *
- * http://www.apache.org/licenses/LICENSE-2.0
- *
- * Unless required by applicable law or agreed to in writing,
- * software distributed under the License is distributed on an
- * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
- * KIND, either express or implied.  See the License for the
- * specific language governing permissions and limitations
- * under the License.
- *******************************************************************************/
-package org.apache.ofbiz.base.util.test;
-
-import org.apache.ofbiz.base.test.GenericTestCaseBase;
-import org.apache.ofbiz.base.util.UtilXml;
-
-public class UtilXmlTests extends GenericTestCaseBase {
-
-    public UtilXmlTests(String name) {
-        super(name);
-    }
-
-    public void testUnsupportedClassConverter() throws Exception {
-        String unsupportedClassInXml =
-            "<handler class=\"java.beans.EventHandler\">" +
-                " <target class=\"java.lang.ProcessBuilder\">" +
-                    " <command>" +
-                        " <string>open</string>" +
-                        " <string>.</string>" +
-                    " </command>" +
-                " </target>" +
-                " <action>start</action>" +
-            "</handler>";
-        try {
-            @SuppressWarnings("unused")
-            Object unsupportedObject = UtilXml.fromXml(unsupportedClassInXml);
-            fail("Unsupported class in XML");
-        } catch (Exception e) {
-        }
-    }
-}
diff --git a/framework/base/testdef/basetests.xml b/framework/base/testdef/basetests.xml
index bf9d876c33..303862db0f 100644
--- a/framework/base/testdef/basetests.xml
+++ b/framework/base/testdef/basetests.xml
@@ -42,6 +42,5 @@
         <!--junit-test-suite class-name="org.apache.ofbiz.base.util.test.UtilIOTests"/-->
         <junit-test-suite class-name="org.apache.ofbiz.base.test.BaseUnitTests"/>
         <junit-test-suite class-name="org.apache.ofbiz.base.util.test.UtilPropertiesTests"/>
-        <junit-test-suite class-name="org.apache.ofbiz.base.util.test.UtilXmlTests"/>
     </test-group>
 </test-suite>
