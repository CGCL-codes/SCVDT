commit 0d8eaab66e054aebc05fb8bef8fbdc564d83c6a3
Author:     Jacopo Cappellato <jacopoc@apache.org>
AuthorDate: Tue Jun 4 14:48:40 2013 +0000
Commit:     Jacopo Cappellato <jacopoc@apache.org>
CommitDate: Tue Jun 4 14:48:40 2013 +0000

    The content rendered in the Webtools "view log" screen is now rendered from the ofbiz.log file rather then the ofbiz.html file in order to provide more control on the html code rendered in the screen. This fixes the vulnerability CVE-2013-2137
    
    
    git-svn-id: https://svn.apache.org/repos/asf/ofbiz/trunk@1489461 13f79535-47bb-0310-9956-ffa450edef68

diff --git a/framework/base/config/log4j.xml b/framework/base/config/log4j.xml
index 9f31323dab..453fe94427 100644
--- a/framework/base/config/log4j.xml
+++ b/framework/base/config/log4j.xml
@@ -54,17 +54,6 @@
         </layout>
     </appender>
 
-    <!-- ofbiz web file appender -->
-    <appender name="ofbiz-html" class="org.apache.log4j.RollingFileAppender">
-        <param name="maxFileSize" value="500KB"/>
-        <param name="maxBackupIndex" value="1"/>
-        <param name="File" value="${ofbiz.home}/runtime/logs/ofbiz.html"/>
-        <param name="threshold" value="info"/>
-        <layout class="org.apache.log4j.PatternLayout">
-            <param name="ConversionPattern" value="&lt;div class=&quot;%p&quot;&gt;%d (%t) [%24F:%-3L:%-5p]%x %m &lt;/div&gt;%n"/>
-        </layout>
-    </appender>
-
     <!-- debug log -->
     <appender name="debug" class="org.apache.log4j.RollingFileAppender">
         <param name="maxFileSize" value="10000KB"/>
diff --git a/framework/webtools/webapp/webtools/WEB-INF/actions/log/LogView.groovy b/framework/webtools/webapp/webtools/WEB-INF/actions/log/LogView.groovy
index bd59c728be..a754faf809 100644
--- a/framework/webtools/webapp/webtools/WEB-INF/actions/log/LogView.groovy
+++ b/framework/webtools/webapp/webtools/WEB-INF/actions/log/LogView.groovy
@@ -19,10 +19,23 @@
 
 import org.ofbiz.base.util.FileUtil;
 
-sb = null;
+List logLines = [];
 try {
-    sb = FileUtil.readTextFile(logFileName, true);
+    File logFile = FileUtil.getFile(logFileName);
+    logFile.eachLine { line ->
+        String ln = line;
+        type = '';
+        if (ln.contains(":INFO ] ")) {
+            type = 'INFO';
+        } else if (ln.contains(":WARN ] ")) {
+            type = 'WARN';
+        } else if (ln.contains(":ERROR] ")) {
+            type = 'ERROR';
+        } else if (ln.contains(":DEBUG] ")) {
+            type = 'DEBUG';
+        }
+        logLines.add([type: type, line:line]);
+    }
 } catch (Exception exc) {}
-if (sb) {
-    context.logFileContent = sb;
-}
+
+context.logLines = logLines;
diff --git a/framework/webtools/webapp/webtools/log/logContent.ftl b/framework/webtools/webapp/webtools/log/logContent.ftl
index ab0cdd8ff4..f8a57c3e93 100644
--- a/framework/webtools/webapp/webtools/log/logContent.ftl
+++ b/framework/webtools/webapp/webtools/log/logContent.ftl
@@ -17,4 +17,6 @@ specific language governing permissions and limitations
 under the License.
 -->
 
-${logFileContent?if_exists}
+<#list logLines as logLine>
+  <div class="${logLine.type}">${logLine.line}</div>
+</#list>
diff --git a/framework/webtools/widget/LogScreens.xml b/framework/webtools/widget/LogScreens.xml
index c72a8ee63d..8cd40ed898 100644
--- a/framework/webtools/widget/LogScreens.xml
+++ b/framework/webtools/widget/LogScreens.xml
@@ -106,7 +106,7 @@ under the License.
                  <set field="tabButtonItem" value="logView"/>
                  <!-- TODO: the following command is not really working (and the default value is always used);
                               my guess is that the base/config/debug.properties file is not found in the classpath -->
-                 <property-to-field resource="debug" property="log4j.appender.css.File" field="logFileName" default="runtime/logs/ofbiz.html" no-locale="true"/>
+                 <property-to-field resource="debug" property="log4j.appender.css.File" field="logFileName" default="runtime/logs/ofbiz.log" no-locale="true"/>
                  <script location="component://webtools/webapp/webtools/WEB-INF/actions/log/LogView.groovy"/>
              </actions>
              <widgets>
