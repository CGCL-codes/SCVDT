From 336751615c5603d8fa2d997d76c923854e2315cf Mon Sep 17 00:00:00 2001
From: Jesse Glick <jglick@cloudbees.com>
Date: Wed, 21 Dec 2016 17:04:10 -0500
Subject: [PATCH 1/7] [SECURITY-353] Reproduced problem in test.

---
 .../java/hudson/model/ParametersTest.java     | 41 +++++++++++++++++++
 1 file changed, 41 insertions(+)

diff --git a/test/src/test/java/hudson/model/ParametersTest.java b/test/src/test/java/hudson/model/ParametersTest.java
index 9f525a420c4..4c837afa97a 100644
--- a/test/src/test/java/hudson/model/ParametersTest.java
+++ b/test/src/test/java/hudson/model/ParametersTest.java
@@ -4,9 +4,12 @@
 
 import com.gargoylesoftware.htmlunit.html.DomNodeUtil;
 import com.gargoylesoftware.htmlunit.html.HtmlFormUtil;
+import static org.hamcrest.Matchers.*;
 import org.junit.Rule;
 import org.junit.Test;
+import org.junit.rules.ErrorCollector;
 
+import org.apache.http.HttpStatus;
 import com.gargoylesoftware.htmlunit.html.HtmlPage;
 import com.gargoylesoftware.htmlunit.html.HtmlForm;
 import com.gargoylesoftware.htmlunit.html.HtmlElement;
@@ -19,6 +22,7 @@
 import org.jvnet.hudson.test.JenkinsRule.WebClient;
 
 import java.util.Set;
+import org.junit.Ignore;
 
 /**
  * @author huybrechts
@@ -28,6 +32,9 @@
     @Rule
     public JenkinsRule j = new JenkinsRule();
 
+    @Rule
+    public ErrorCollector collector = new ErrorCollector();
+
     @Test
     public void parameterTypes() throws Exception {
         FreeStyleProject otherProject = j.createFreeStyleProject();
@@ -216,4 +223,38 @@ public void unicodeParametersArePresetCorrectly() throws Exception {
         final HtmlForm form = page.getFormByName("parameters");
         HtmlFormUtil.submit(form, HtmlFormUtil.getButtonByCaption(form, "Build"));
     }
+
+    @Ignore("TODO fix")
+    @Issue("SECURITY-353")
+    @Test
+    public void xss() throws Exception {
+        FreeStyleProject p = j.createFreeStyleProject("p");
+        p.addProperty(new ParametersDefinitionProperty(new StringParameterDefinition("<param name>", "<param default>", "<param description>")));
+        WebClient wc = j.createWebClient();
+        wc.getOptions().setThrowExceptionOnFailingStatusCode(false);
+        HtmlPage page = wc.getPage(p, "build?delay=0sec");
+        collector.checkThat(page.getWebResponse().getStatusCode(), is(HttpStatus.SC_METHOD_NOT_ALLOWED)); // 405 to dissuade scripts from thinking this triggered the build
+        String text = page.getWebResponse().getContentAsString();
+        collector.checkThat(text, containsString("&lt;param name&gt;"));
+        collector.checkThat(text, not(containsString("<param name>")));
+        collector.checkThat(text, containsString("&lt;param default&gt;"));
+        collector.checkThat(text, not(containsString("<param default>")));
+        collector.checkThat(text, containsString("&lt;param description&gt;"));
+        collector.checkThat(text, not(containsString("<param description>")));
+        HtmlForm form = page.getFormByName("parameters");
+        HtmlTextInput value = form.getInputByValue("<param default>");
+        value.setText("<param value>");
+        j.submit(form);
+        j.waitUntilNoActivity();
+        FreeStyleBuild b = p.getBuildByNumber(1);
+        page = j.createWebClient().getPage(b, "parameters/");
+        text = page.getWebResponse().getContentAsString();
+        collector.checkThat(text, containsString("&lt;param name&gt;"));
+        collector.checkThat(text, not(containsString("<param name>")));
+        collector.checkThat(text, containsString("&lt;param value&gt;"));
+        collector.checkThat(text, not(containsString("<param value>")));
+        collector.checkThat(text, containsString("&lt;param description&gt;"));
+        collector.checkThat(text, not(containsString("<param description>")));
+    }
+
 }

From c8aa949ff5405e86cc4b65860ff7d04579966480 Mon Sep 17 00:00:00 2001
From: Jesse Glick <jglick@cloudbees.com>
Date: Wed, 21 Dec 2016 17:04:20 -0500
Subject: [PATCH 2/7] Noting need for escapes.

---
 core/src/main/resources/lib/form/entry.jelly | 4 ++++
 1 file changed, 4 insertions(+)

diff --git a/core/src/main/resources/lib/form/entry.jelly b/core/src/main/resources/lib/form/entry.jelly
index 78e80aaf0cf..1642dae3b5a 100644
--- a/core/src/main/resources/lib/form/entry.jelly
+++ b/core/src/main/resources/lib/form/entry.jelly
@@ -32,6 +32,8 @@ THE SOFTWARE.
 
     <st:attribute name="title">
       Name of the entry. Think of this like a label for the control.
+
+      This content is HTML. Use h.escape if necessary.
     </st:attribute>
     <st:attribute name="field">
       Used for the databinding. TBD. When this attribute
@@ -46,6 +48,8 @@ THE SOFTWARE.
       This text shouldn't get too long, and in recent Hudson, this feature
       is somewhat de-emphasized, in favor of the inline foldable help page
       specified via @help.
+
+      This content is HTML. Use h.escape if necessary.
     </st:attribute>
     <st:attribute name="help">
       URL to the HTML page. When this attribute is specified, the entry gets

From 2e8837527d82899f719fd9b963667f9e2ecb7035 Mon Sep 17 00:00:00 2001
From: Jesse Glick <jglick@cloudbees.com>
Date: Wed, 21 Dec 2016 17:17:59 -0500
Subject: [PATCH 3/7] We also expect descriptions to be formatted, not merely
 escaped.

---
 .../java/hudson/model/ParametersTest.java     | 71 ++++++++++++-------
 1 file changed, 44 insertions(+), 27 deletions(-)

diff --git a/test/src/test/java/hudson/model/ParametersTest.java b/test/src/test/java/hudson/model/ParametersTest.java
index 4c837afa97a..eb8090d6f6c 100644
--- a/test/src/test/java/hudson/model/ParametersTest.java
+++ b/test/src/test/java/hudson/model/ParametersTest.java
@@ -1,29 +1,31 @@
 package hudson.model;
 
-import static org.junit.Assert.*;
-
 import com.gargoylesoftware.htmlunit.html.DomNodeUtil;
+import com.gargoylesoftware.htmlunit.html.HtmlCheckBoxInput;
+import com.gargoylesoftware.htmlunit.html.HtmlElement;
+import com.gargoylesoftware.htmlunit.html.HtmlForm;
 import com.gargoylesoftware.htmlunit.html.HtmlFormUtil;
+import com.gargoylesoftware.htmlunit.html.HtmlOption;
+import com.gargoylesoftware.htmlunit.html.HtmlPage;
+import com.gargoylesoftware.htmlunit.html.HtmlTextInput;
+import hudson.markup.MarkupFormatter;
+import java.io.IOException;
+import java.io.Writer;
+import java.util.Set;
+import java.util.regex.Matcher;
+import java.util.regex.Pattern;
+import org.apache.http.HttpStatus;
 import static org.hamcrest.Matchers.*;
+import static org.junit.Assert.*;
+import org.junit.Ignore;
 import org.junit.Rule;
 import org.junit.Test;
 import org.junit.rules.ErrorCollector;
-
-import org.apache.http.HttpStatus;
-import com.gargoylesoftware.htmlunit.html.HtmlPage;
-import com.gargoylesoftware.htmlunit.html.HtmlForm;
-import com.gargoylesoftware.htmlunit.html.HtmlElement;
-import com.gargoylesoftware.htmlunit.html.HtmlTextInput;
-import com.gargoylesoftware.htmlunit.html.HtmlCheckBoxInput;
-import com.gargoylesoftware.htmlunit.html.HtmlOption;
 import org.jvnet.hudson.test.CaptureEnvironmentBuilder;
 import org.jvnet.hudson.test.Issue;
 import org.jvnet.hudson.test.JenkinsRule;
 import org.jvnet.hudson.test.JenkinsRule.WebClient;
 
-import java.util.Set;
-import org.junit.Ignore;
-
 /**
  * @author huybrechts
  */
@@ -224,23 +226,26 @@ public void unicodeParametersArePresetCorrectly() throws Exception {
         HtmlFormUtil.submit(form, HtmlFormUtil.getButtonByCaption(form, "Build"));
     }
 
-    @Ignore("TODO fix")
+    @Ignore("TODO build page should not leave param name unescaped; parameters page should escape param name; parameters page should not leave param name unescaped; parameters page should mark up param description; parameters page should not leave param description unescaped")
     @Issue("SECURITY-353")
     @Test
     public void xss() throws Exception {
+        j.jenkins.setMarkupFormatter(new MyMarkupFormatter());
         FreeStyleProject p = j.createFreeStyleProject("p");
-        p.addProperty(new ParametersDefinitionProperty(new StringParameterDefinition("<param name>", "<param default>", "<param description>")));
+        StringParameterDefinition param = new StringParameterDefinition("<param name>", "<param default>", "<param description>");
+        assertEquals("<b>[</b>param description<b>]</b>", param.getFormattedDescription());
+        p.addProperty(new ParametersDefinitionProperty(param));
         WebClient wc = j.createWebClient();
         wc.getOptions().setThrowExceptionOnFailingStatusCode(false);
         HtmlPage page = wc.getPage(p, "build?delay=0sec");
         collector.checkThat(page.getWebResponse().getStatusCode(), is(HttpStatus.SC_METHOD_NOT_ALLOWED)); // 405 to dissuade scripts from thinking this triggered the build
         String text = page.getWebResponse().getContentAsString();
-        collector.checkThat(text, containsString("&lt;param name&gt;"));
-        collector.checkThat(text, not(containsString("<param name>")));
-        collector.checkThat(text, containsString("&lt;param default&gt;"));
-        collector.checkThat(text, not(containsString("<param default>")));
-        collector.checkThat(text, containsString("&lt;param description&gt;"));
-        collector.checkThat(text, not(containsString("<param description>")));
+        collector.checkThat("build page should escape param name", text, containsString("&lt;param name&gt;"));
+        collector.checkThat("build page should not leave param name unescaped", text, not(containsString("<param name>")));
+        collector.checkThat("build page should escape param default", text, containsString("&lt;param default&gt;"));
+        collector.checkThat("build page should not leave param default unescaped", text, not(containsString("<param default>")));
+        collector.checkThat("build page should mark up param description", text, containsString("<b>[</b>param description<b>]</b>"));
+        collector.checkThat("build page should not leave param description unescaped", text, not(containsString("<param description>")));
         HtmlForm form = page.getFormByName("parameters");
         HtmlTextInput value = form.getInputByValue("<param default>");
         value.setText("<param value>");
@@ -249,12 +254,24 @@ public void xss() throws Exception {
         FreeStyleBuild b = p.getBuildByNumber(1);
         page = j.createWebClient().getPage(b, "parameters/");
         text = page.getWebResponse().getContentAsString();
-        collector.checkThat(text, containsString("&lt;param name&gt;"));
-        collector.checkThat(text, not(containsString("<param name>")));
-        collector.checkThat(text, containsString("&lt;param value&gt;"));
-        collector.checkThat(text, not(containsString("<param value>")));
-        collector.checkThat(text, containsString("&lt;param description&gt;"));
-        collector.checkThat(text, not(containsString("<param description>")));
+        collector.checkThat("parameters page should escape param name", text, containsString("&lt;param name&gt;"));
+        collector.checkThat("parameters page should not leave param name unescaped", text, not(containsString("<param name>")));
+        collector.checkThat("parameters page should escape param value", text, containsString("&lt;param value&gt;"));
+        collector.checkThat("parameters page should not leave param value unescaped", text, not(containsString("<param value>")));
+        collector.checkThat("parameters page should mark up param description", text, containsString("<b>[</b>param description<b>]</b>"));
+        collector.checkThat("parameters page should not leave param description unescaped", text, not(containsString("<param description>")));
+    }
+    static class MyMarkupFormatter extends MarkupFormatter {
+        @Override
+        public void translate(String markup, Writer output) throws IOException {
+            Matcher m = Pattern.compile("[<>]").matcher(markup);
+            StringBuffer buf = new StringBuffer();
+            while (m.find()) {
+                m.appendReplacement(buf, m.group().equals("<") ? "<b>[</b>" : "<b>]</b>");
+            }
+            m.appendTail(buf);
+            output.write(buf.toString());
+        }
     }
 
 }

From b561ca5696f12d8e017f79cc2080c394c6710719 Mon Sep 17 00:00:00 2001
From: Jesse Glick <jglick@cloudbees.com>
Date: Wed, 21 Dec 2016 17:49:16 -0500
Subject: [PATCH 4/7] [SECURITY-353] Solved XSS, at the cost of markup
 formatters.

---
 .../main/resources/hudson/model/ParametersAction/index.jelly  | 1 +
 .../hudson/model/ParametersDefinitionProperty/index.jelly     | 1 +
 core/src/main/resources/lib/form/entry.jelly                  | 4 ++--
 test/src/test/java/hudson/model/ParametersTest.java           | 2 +-
 4 files changed, 5 insertions(+), 3 deletions(-)

diff --git a/core/src/main/resources/hudson/model/ParametersAction/index.jelly b/core/src/main/resources/hudson/model/ParametersAction/index.jelly
index 2c25579adcd..d5c4ca771c5 100644
--- a/core/src/main/resources/hudson/model/ParametersAction/index.jelly
+++ b/core/src/main/resources/hudson/model/ParametersAction/index.jelly
@@ -36,6 +36,7 @@ THE SOFTWARE.
 		<l:main-panel>
 			<h1>${%Build} ${build.displayName}</h1>
 			<l:pane title="${%Parameters}" width="3">
+                        <j:set var="escapeEntryTitleAndDescription" value="true"/> <!-- SECURITY-353 defense unless overridden -->
 			<j:forEach var="parameterValue" items="${it.parameters}">
 				<st:include it="${parameterValue}"
 					page="value.jelly" />
diff --git a/core/src/main/resources/hudson/model/ParametersDefinitionProperty/index.jelly b/core/src/main/resources/hudson/model/ParametersDefinitionProperty/index.jelly
index d91f088dcb1..a166f87dc8f 100644
--- a/core/src/main/resources/hudson/model/ParametersDefinitionProperty/index.jelly
+++ b/core/src/main/resources/hudson/model/ParametersDefinitionProperty/index.jelly
@@ -45,6 +45,7 @@ THE SOFTWARE.
       <f:form method="post" action="build${empty(delay)?'':'?delay='+delay}" name="parameters"
               tableClass="parameters">
         <j:forEach var="parameterDefinition" items="${it.parameterDefinitions}">
+          <j:set var="escapeEntryTitleAndDescription" value="true"/> <!-- SECURITY-353 defense unless overridden -->
           <tbody>
             <st:include it="${parameterDefinition}"
                         page="${parameterDefinition.descriptor.valuePage}" />
diff --git a/core/src/main/resources/lib/form/entry.jelly b/core/src/main/resources/lib/form/entry.jelly
index 1642dae3b5a..b8d8a38e3b9 100644
--- a/core/src/main/resources/lib/form/entry.jelly
+++ b/core/src/main/resources/lib/form/entry.jelly
@@ -71,7 +71,7 @@ THE SOFTWARE.
   <tr>
     <td class="setting-leftspace"><st:nbsp/></td>
     <td class="setting-name">
-      <j:out value="${attrs.title}" />
+      <j:out value="${escapeEntryTitleAndDescription ? h.escape(attrs.title) : attrs.title}" />
     </td>
     <td class="setting-main">
       <d:invokeBody />
@@ -82,7 +82,7 @@ THE SOFTWARE.
   <tr class="validation-error-area"><td colspan="2" /><td /><td /></tr>
   <j:if test="${!empty(attrs.description)}">
     <f:description>
-      <j:out value="${description}"/>
+      <j:out value="${escapeEntryTitleAndDescription ? h.escape(attrs.description) : attrs.description}"/>
     </f:description>
   </j:if>
   <j:if test="${attrs.help!=null}">
diff --git a/test/src/test/java/hudson/model/ParametersTest.java b/test/src/test/java/hudson/model/ParametersTest.java
index eb8090d6f6c..46a89eeb26a 100644
--- a/test/src/test/java/hudson/model/ParametersTest.java
+++ b/test/src/test/java/hudson/model/ParametersTest.java
@@ -226,7 +226,7 @@ public void unicodeParametersArePresetCorrectly() throws Exception {
         HtmlFormUtil.submit(form, HtmlFormUtil.getButtonByCaption(form, "Build"));
     }
 
-    @Ignore("TODO build page should not leave param name unescaped; parameters page should escape param name; parameters page should not leave param name unescaped; parameters page should mark up param description; parameters page should not leave param description unescaped")
+    @Ignore("TODO build page should mark up param description; parameters page should mark up param description")
     @Issue("SECURITY-353")
     @Test
     public void xss() throws Exception {

From 0b471b7b693eb370c52c82382257419a07171f93 Mon Sep 17 00:00:00 2001
From: Jesse Glick <jglick@cloudbees.com>
Date: Wed, 21 Dec 2016 18:01:46 -0500
Subject: [PATCH 5/7] [SECURITY-353] Fixed markup formatter for
 StringParameterDefinition/Value.

---
 .../main/java/hudson/model/ParameterValue.java | 18 ++++++++++++++++++
 .../StringParameterDefinition/index.jelly      |  3 ++-
 .../model/StringParameterValue/value.jelly     |  3 ++-
 .../test/java/hudson/model/ParametersTest.java |  2 --
 4 files changed, 22 insertions(+), 4 deletions(-)

diff --git a/core/src/main/java/hudson/model/ParameterValue.java b/core/src/main/java/hudson/model/ParameterValue.java
index d3b39f614a3..fbea3895fd5 100644
--- a/core/src/main/java/hudson/model/ParameterValue.java
+++ b/core/src/main/java/hudson/model/ParameterValue.java
@@ -31,11 +31,16 @@
 import hudson.tasks.BuildWrapper;
 import hudson.tasks.Builder;
 import hudson.util.VariableResolver;
+import java.io.IOException;
 
 import java.io.Serializable;
 import java.util.Map;
+import java.util.logging.Logger;
+import jenkins.model.Jenkins;
 
 import net.sf.json.JSONObject;
+import org.kohsuke.accmod.Restricted;
+import org.kohsuke.accmod.restrictions.DoNotUse;
 
 import org.kohsuke.stapler.StaplerRequest;
 import org.kohsuke.stapler.export.Exported;
@@ -70,6 +75,9 @@
  */
 @ExportedBean(defaultVisibility=3)
 public abstract class ParameterValue implements Serializable {
+
+    private static final Logger LOGGER = Logger.getLogger(ParameterValue.class.getName());
+
     protected final String name;
 
     private String description;
@@ -91,6 +99,16 @@ public void setDescription(String description) {
         this.description = description;
     }
 
+    @Restricted(DoNotUse.class) // for value.jelly
+    public String getFormattedDescription() {
+        try {
+            return Jenkins.getInstance().getMarkupFormatter().translate(description);
+        } catch (IOException e) {
+            LOGGER.warning("failed to translate description using configured markup formatter");
+            return "";
+        }
+    }
+
     /**
      * Name of the parameter.
      *
diff --git a/core/src/main/resources/hudson/model/StringParameterDefinition/index.jelly b/core/src/main/resources/hudson/model/StringParameterDefinition/index.jelly
index 2f99f33da91..2c6a20bfbbc 100644
--- a/core/src/main/resources/hudson/model/StringParameterDefinition/index.jelly
+++ b/core/src/main/resources/hudson/model/StringParameterDefinition/index.jelly
@@ -26,7 +26,8 @@ THE SOFTWARE.
 <j:jelly xmlns:j="jelly:core" xmlns:st="jelly:stapler" xmlns:d="jelly:define"
 	xmlns:l="/lib/layout" xmlns:t="/lib/hudson" xmlns:f="/lib/form"
 	xmlns:i="jelly:fmt" xmlns:p="/lib/hudson/project">
-	<f:entry title="${it.name}" description="${it.formattedDescription}">
+        <j:set var="escapeEntryTitleAndDescription" value="false"/>
+        <f:entry title="${h.escape(it.name)}" description="${it.formattedDescription}">
 		<div name="parameter">
 			<input type="hidden" name="name" value="${it.name}" />
 			<f:textbox name="value" value="${it.defaultValue}" />
diff --git a/core/src/main/resources/hudson/model/StringParameterValue/value.jelly b/core/src/main/resources/hudson/model/StringParameterValue/value.jelly
index 961a583d292..e3de9ff09a3 100644
--- a/core/src/main/resources/hudson/model/StringParameterValue/value.jelly
+++ b/core/src/main/resources/hudson/model/StringParameterValue/value.jelly
@@ -26,7 +26,8 @@ THE SOFTWARE.
 <j:jelly xmlns:j="jelly:core" xmlns:st="jelly:stapler" xmlns:d="jelly:define"
 	xmlns:l="/lib/layout" xmlns:t="/lib/hudson" xmlns:f="/lib/form"
 	xmlns:i="jelly:fmt" xmlns:p="/lib/hudson/project">
-	<f:entry title="${it.name}" description="${it.description}">
+        <j:set var="escapeEntryTitleAndDescription" value="false"/>
+        <f:entry title="${h.escape(it.name)}" description="${it.formattedDescription}">
 		<f:textbox name="value" value="${it.value}" readonly="true" />
 	</f:entry>
 </j:jelly>
\ No newline at end of file
diff --git a/test/src/test/java/hudson/model/ParametersTest.java b/test/src/test/java/hudson/model/ParametersTest.java
index 46a89eeb26a..fe885e164cc 100644
--- a/test/src/test/java/hudson/model/ParametersTest.java
+++ b/test/src/test/java/hudson/model/ParametersTest.java
@@ -17,7 +17,6 @@
 import org.apache.http.HttpStatus;
 import static org.hamcrest.Matchers.*;
 import static org.junit.Assert.*;
-import org.junit.Ignore;
 import org.junit.Rule;
 import org.junit.Test;
 import org.junit.rules.ErrorCollector;
@@ -226,7 +225,6 @@ public void unicodeParametersArePresetCorrectly() throws Exception {
         HtmlFormUtil.submit(form, HtmlFormUtil.getButtonByCaption(form, "Build"));
     }
 
-    @Ignore("TODO build page should mark up param description; parameters page should mark up param description")
     @Issue("SECURITY-353")
     @Test
     public void xss() throws Exception {

From ea2ca1c5cb6be5eaeb73ac8401097529d6e5df1a Mon Sep 17 00:00:00 2001
From: Jesse Glick <jglick@cloudbees.com>
Date: Wed, 21 Dec 2016 18:10:10 -0500
Subject: [PATCH 6/7] Extended markup formatter fix to other core parameter
 types.

---
 .../hudson/model/BooleanParameterDefinition/index.jelly        | 3 ++-
 .../resources/hudson/model/BooleanParameterValue/value.jelly   | 3 ++-
 .../hudson/model/ChoiceParameterDefinition/index.jelly         | 3 ++-
 .../resources/hudson/model/FileParameterDefinition/index.jelly | 3 ++-
 .../main/resources/hudson/model/FileParameterValue/value.jelly | 3 ++-
 .../hudson/model/PasswordParameterDefinition/index.jelly       | 3 ++-
 .../resources/hudson/model/PasswordParameterValue/value.jelly  | 3 ++-
 .../resources/hudson/model/RunParameterDefinition/index.jelly  | 3 ++-
 .../main/resources/hudson/model/RunParameterValue/value.jelly  | 3 ++-
 .../resources/hudson/model/TextParameterDefinition/index.jelly | 3 ++-
 .../main/resources/hudson/model/TextParameterValue/value.jelly | 3 ++-
 11 files changed, 22 insertions(+), 11 deletions(-)

diff --git a/core/src/main/resources/hudson/model/BooleanParameterDefinition/index.jelly b/core/src/main/resources/hudson/model/BooleanParameterDefinition/index.jelly
index 4a06f79573e..b2069b3b67d 100644
--- a/core/src/main/resources/hudson/model/BooleanParameterDefinition/index.jelly
+++ b/core/src/main/resources/hudson/model/BooleanParameterDefinition/index.jelly
@@ -26,7 +26,8 @@ THE SOFTWARE.
 <j:jelly xmlns:j="jelly:core" xmlns:st="jelly:stapler" xmlns:d="jelly:define"
 	xmlns:l="/lib/layout" xmlns:t="/lib/hudson" xmlns:f="/lib/form"
 	xmlns:i="jelly:fmt" xmlns:p="/lib/hudson/project">
-	<f:entry title="${it.name}" description="${it.formattedDescription}">
+        <j:set var="escapeEntryTitleAndDescription" value="false"/>
+        <f:entry title="${h.escape(it.name)}" description="${it.formattedDescription}">
 		<div name="parameter">
 			<input type="hidden" name="name" value="${it.name}" />
 			<f:checkbox name="value" checked="${it.defaultValue}" />
diff --git a/core/src/main/resources/hudson/model/BooleanParameterValue/value.jelly b/core/src/main/resources/hudson/model/BooleanParameterValue/value.jelly
index 4dd9f679d74..7eaf8be8f68 100644
--- a/core/src/main/resources/hudson/model/BooleanParameterValue/value.jelly
+++ b/core/src/main/resources/hudson/model/BooleanParameterValue/value.jelly
@@ -26,7 +26,8 @@ THE SOFTWARE.
 <j:jelly xmlns:j="jelly:core" xmlns:st="jelly:stapler" xmlns:d="jelly:define"
 	xmlns:l="/lib/layout" xmlns:t="/lib/hudson" xmlns:f="/lib/form"
 	xmlns:i="jelly:fmt" xmlns:p="/lib/hudson/project">
-	<f:entry title="${it.name}" description="${it.description}">
+        <j:set var="escapeEntryTitleAndDescription" value="false"/>
+        <f:entry title="${h.escape(it.name)}" description="${it.formattedDescription}">
 		<f:checkbox name="value" checked="${it.value}" readonly="true" />
 	</f:entry>
 </j:jelly>
\ No newline at end of file
diff --git a/core/src/main/resources/hudson/model/ChoiceParameterDefinition/index.jelly b/core/src/main/resources/hudson/model/ChoiceParameterDefinition/index.jelly
index 36795a45f65..60c86d9a244 100644
--- a/core/src/main/resources/hudson/model/ChoiceParameterDefinition/index.jelly
+++ b/core/src/main/resources/hudson/model/ChoiceParameterDefinition/index.jelly
@@ -26,7 +26,8 @@ THE SOFTWARE.
 <j:jelly xmlns:j="jelly:core" xmlns:st="jelly:stapler" xmlns:d="jelly:define"
 	xmlns:l="/lib/layout" xmlns:t="/lib/hudson" xmlns:f="/lib/form"
 	xmlns:i="jelly:fmt" xmlns:p="/lib/hudson/project">
-	<f:entry title="${it.name}" description="${it.formattedDescription}">
+        <j:set var="escapeEntryTitleAndDescription" value="false"/>
+        <f:entry title="${h.escape(it.name)}" description="${it.formattedDescription}">
 		<div name="parameter">
 			<input type="hidden" name="name" value="${it.name}" />
             <select name="value">
diff --git a/core/src/main/resources/hudson/model/FileParameterDefinition/index.jelly b/core/src/main/resources/hudson/model/FileParameterDefinition/index.jelly
index 46e1b7d0eac..cffab71468b 100644
--- a/core/src/main/resources/hudson/model/FileParameterDefinition/index.jelly
+++ b/core/src/main/resources/hudson/model/FileParameterDefinition/index.jelly
@@ -26,7 +26,8 @@ THE SOFTWARE.
 <j:jelly xmlns:j="jelly:core" xmlns:st="jelly:stapler" xmlns:d="jelly:define"
 	xmlns:l="/lib/layout" xmlns:t="/lib/hudson" xmlns:f="/lib/form"
 	xmlns:i="jelly:fmt" xmlns:p="/lib/hudson/project">
-	<f:entry title="${it.name}" description="${it.formattedDescription}">
+        <j:set var="escapeEntryTitleAndDescription" value="false"/>
+        <f:entry title="${h.escape(it.name)}" description="${it.formattedDescription}">
 		<div name="parameter">
 			<input type="hidden" name="name" value="${it.name}" />
 			<input name="file" type="file" jsonAware="true" />
diff --git a/core/src/main/resources/hudson/model/FileParameterValue/value.jelly b/core/src/main/resources/hudson/model/FileParameterValue/value.jelly
index 4c5c35c1d47..0afcb71564d 100644
--- a/core/src/main/resources/hudson/model/FileParameterValue/value.jelly
+++ b/core/src/main/resources/hudson/model/FileParameterValue/value.jelly
@@ -26,7 +26,8 @@ THE SOFTWARE.
 <j:jelly xmlns:j="jelly:core" xmlns:st="jelly:stapler" xmlns:d="jelly:define"
 	xmlns:l="/lib/layout" xmlns:t="/lib/hudson" xmlns:f="/lib/form"
 	xmlns:i="jelly:fmt" xmlns:p="/lib/hudson/project">
-    <f:entry title="${it.name}">
+        <j:set var="escapeEntryTitleAndDescription" value="false"/>
+        <f:entry title="${h.escape(it.name)}" description="${it.formattedDescription}">
         <j:if test="${it.originalFileName != null}">
             <j:invokeStatic var="encodedName" className="hudson.Util" method="rawEncode">
                 <j:arg value="${it.name}" />
diff --git a/core/src/main/resources/hudson/model/PasswordParameterDefinition/index.jelly b/core/src/main/resources/hudson/model/PasswordParameterDefinition/index.jelly
index 9bac23608cc..bf5db564fa0 100644
--- a/core/src/main/resources/hudson/model/PasswordParameterDefinition/index.jelly
+++ b/core/src/main/resources/hudson/model/PasswordParameterDefinition/index.jelly
@@ -26,7 +26,8 @@ THE SOFTWARE.
 <j:jelly xmlns:j="jelly:core" xmlns:st="jelly:stapler" xmlns:d="jelly:define"
 	xmlns:l="/lib/layout" xmlns:t="/lib/hudson" xmlns:f="/lib/form"
 	xmlns:i="jelly:fmt" xmlns:p="/lib/hudson/project">
-	<f:entry title="${it.name}" description="${it.formattedDescription}">
+        <j:set var="escapeEntryTitleAndDescription" value="false"/>
+        <f:entry title="${h.escape(it.name)}" description="${it.formattedDescription}">
 		<div name="parameter">
 			<input type="hidden" name="name" value="${it.name}" />
 			<f:password name="value" value="${it.defaultValueAsSecret}" />
diff --git a/core/src/main/resources/hudson/model/PasswordParameterValue/value.jelly b/core/src/main/resources/hudson/model/PasswordParameterValue/value.jelly
index d1a142f2dbf..e4a50077307 100644
--- a/core/src/main/resources/hudson/model/PasswordParameterValue/value.jelly
+++ b/core/src/main/resources/hudson/model/PasswordParameterValue/value.jelly
@@ -26,7 +26,8 @@ THE SOFTWARE.
 <j:jelly xmlns:j="jelly:core" xmlns:st="jelly:stapler" xmlns:d="jelly:define"
 	xmlns:l="/lib/layout" xmlns:t="/lib/hudson" xmlns:f="/lib/form"
 	xmlns:i="jelly:fmt" xmlns:p="/lib/hudson/project">
-	<f:entry title="${it.name}" description="${it.description}">
+        <j:set var="escapeEntryTitleAndDescription" value="false"/>
+        <f:entry title="${h.escape(it.name)}" description="${it.formattedDescription}">
 		<f:password name="value" value="********" readonly="true" />
 	</f:entry>
 </j:jelly>
\ No newline at end of file
diff --git a/core/src/main/resources/hudson/model/RunParameterDefinition/index.jelly b/core/src/main/resources/hudson/model/RunParameterDefinition/index.jelly
index 62dbc444695..db37d683d3e 100644
--- a/core/src/main/resources/hudson/model/RunParameterDefinition/index.jelly
+++ b/core/src/main/resources/hudson/model/RunParameterDefinition/index.jelly
@@ -26,7 +26,8 @@ THE SOFTWARE.
 <j:jelly xmlns:j="jelly:core" xmlns:st="jelly:stapler" xmlns:d="jelly:define"
 	xmlns:l="/lib/layout" xmlns:t="/lib/hudson" xmlns:f="/lib/form"
 	xmlns:i="jelly:fmt" xmlns:p="/lib/hudson/project">
-	<f:entry title="${it.name}" description="${it.formattedDescription}">
+        <j:set var="escapeEntryTitleAndDescription" value="false"/>
+        <f:entry title="${h.escape(it.name)}" description="${it.formattedDescription}">
 		<div name="parameter">
 			<input type="hidden" name="name" value="${it.name}" />
             <select name="runId">
diff --git a/core/src/main/resources/hudson/model/RunParameterValue/value.jelly b/core/src/main/resources/hudson/model/RunParameterValue/value.jelly
index 019158b4285..da22f28c831 100644
--- a/core/src/main/resources/hudson/model/RunParameterValue/value.jelly
+++ b/core/src/main/resources/hudson/model/RunParameterValue/value.jelly
@@ -26,7 +26,8 @@ THE SOFTWARE.
 <j:jelly xmlns:j="jelly:core" xmlns:st="jelly:stapler" xmlns:d="jelly:define"
 	xmlns:l="/lib/layout" xmlns:t="/lib/hudson" xmlns:f="/lib/form"
 	xmlns:i="jelly:fmt" xmlns:p="/lib/hudson/project">
-	<f:entry title="${it.name}" description="${it.description}">
+        <j:set var="escapeEntryTitleAndDescription" value="false"/>
+        <f:entry title="${h.escape(it.name)}" description="${it.formattedDescription}">
 		<a href="${rootURL}/${it.run.url}" class="model-link inside">${it.run.fullDisplayName}</a>
 	</f:entry>
 </j:jelly>
diff --git a/core/src/main/resources/hudson/model/TextParameterDefinition/index.jelly b/core/src/main/resources/hudson/model/TextParameterDefinition/index.jelly
index fa19ca26ba9..87e48fd16b8 100644
--- a/core/src/main/resources/hudson/model/TextParameterDefinition/index.jelly
+++ b/core/src/main/resources/hudson/model/TextParameterDefinition/index.jelly
@@ -24,7 +24,8 @@ THE SOFTWARE.
 -->
 <?jelly escape-by-default='true'?>
 <j:jelly xmlns:j="jelly:core" xmlns:st="jelly:stapler" xmlns:d="jelly:define" xmlns:l="/lib/layout" xmlns:t="/lib/hudson" xmlns:f="/lib/form" xmlns:i="jelly:fmt" xmlns:p="/lib/hudson/project">
-  <f:entry title="${it.name}" description="${it.formattedDescription}">
+    <j:set var="escapeEntryTitleAndDescription" value="false"/>
+    <f:entry title="${h.escape(it.name)}" description="${it.formattedDescription}">
     <div name="parameter">
       <input type="hidden" name="name" value="${it.name}"/>
       <f:textarea name="value" value="${it.defaultValue}"/>
diff --git a/core/src/main/resources/hudson/model/TextParameterValue/value.jelly b/core/src/main/resources/hudson/model/TextParameterValue/value.jelly
index 5c089e0ac0e..8ae92827ade 100644
--- a/core/src/main/resources/hudson/model/TextParameterValue/value.jelly
+++ b/core/src/main/resources/hudson/model/TextParameterValue/value.jelly
@@ -26,7 +26,8 @@ THE SOFTWARE.
 <j:jelly xmlns:j="jelly:core" xmlns:st="jelly:stapler" xmlns:d="jelly:define"
 	xmlns:l="/lib/layout" xmlns:t="/lib/hudson" xmlns:f="/lib/form"
 	xmlns:i="jelly:fmt" xmlns:p="/lib/hudson/project">
-	<f:entry title="${it.name}" description="${it.description}">
+        <j:set var="escapeEntryTitleAndDescription" value="false"/>
+        <f:entry title="${h.escape(it.name)}" description="${it.formattedDescription}">
 		<f:textarea name="value" value="${it.value}" readonly="readonly" />
 	</f:entry>
 </j:jelly>
\ No newline at end of file

From 169056e7621eee5dc1de307f53c7c5eb321b707a Mon Sep 17 00:00:00 2001
From: Jesse Glick <jglick@cloudbees.com>
Date: Tue, 3 Jan 2017 12:48:26 -0500
Subject: [PATCH 7/7] Documenting existence of escapeEntryTitleAndDescription
 flag as suggested by @daniel-beck.

---
 core/src/main/resources/lib/form/entry.jelly | 4 ++--
 1 file changed, 2 insertions(+), 2 deletions(-)

diff --git a/core/src/main/resources/lib/form/entry.jelly b/core/src/main/resources/lib/form/entry.jelly
index b8d8a38e3b9..0b1c06d1f1a 100644
--- a/core/src/main/resources/lib/form/entry.jelly
+++ b/core/src/main/resources/lib/form/entry.jelly
@@ -33,7 +33,7 @@ THE SOFTWARE.
     <st:attribute name="title">
       Name of the entry. Think of this like a label for the control.
 
-      This content is HTML. Use h.escape if necessary.
+      This content is HTML (unless the boolean variable escapeEntryTitleAndDescription is set). Use h.escape if necessary.
     </st:attribute>
     <st:attribute name="field">
       Used for the databinding. TBD. When this attribute
@@ -49,7 +49,7 @@ THE SOFTWARE.
       is somewhat de-emphasized, in favor of the inline foldable help page
       specified via @help.
 
-      This content is HTML. Use h.escape if necessary.
+      This content is HTML (unless the boolean variable escapeEntryTitleAndDescription is set). Use h.escape if necessary.
     </st:attribute>
     <st:attribute name="help">
       URL to the HTML page. When this attribute is specified, the entry gets
