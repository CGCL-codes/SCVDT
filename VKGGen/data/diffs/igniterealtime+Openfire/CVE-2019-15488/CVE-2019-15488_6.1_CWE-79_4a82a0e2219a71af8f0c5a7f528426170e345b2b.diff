From 4a82a0e2219a71af8f0c5a7f528426170e345b2b Mon Sep 17 00:00:00 2001
From: Guus der Kinderen <guus@goodbytes.nl>
Date: Mon, 5 Aug 2019 20:36:35 +0200
Subject: [PATCH] OF-1192: Fixes Reflected XSS in LDAP Setup test

The testing page for checking a a particular user (that's configured to be an Openfire admin) can be retrieved from LDAP contained an XSS vulnerability. This commit fixes that.

Many thanks to Luke Arntson for finding and reporting this issue.
---
 .../webapp/setup/setup-admin-settings.jsp     |  2 +-
 .../setup/setup-admin-settings_test.jsp       | 58 +++++++++++--------
 2 files changed, 34 insertions(+), 26 deletions(-)

diff --git a/xmppserver/src/main/webapp/setup/setup-admin-settings.jsp b/xmppserver/src/main/webapp/setup/setup-admin-settings.jsp
index 83223dde69..e641c597c4 100644
--- a/xmppserver/src/main/webapp/setup/setup-admin-settings.jsp
+++ b/xmppserver/src/main/webapp/setup/setup-admin-settings.jsp
@@ -459,7 +459,7 @@ if (errors.size() > 0) { %>
 %>
     <tr valign="top">
         <td>
-            <%= JID.unescapeNode( authJID.getNode() )%>
+            <%= StringUtils.escapeForXML(JID.unescapeNode( authJID.getNode() ))%>
         </td>
         <td width="1%" align="center">
             <a href="setup-admin-settings.jsp?ldap=true&test=true&username=<%= URLEncoder.encode(authJID.getNode(), "UTF-8") %>"
diff --git a/xmppserver/src/main/webapp/setup/setup-admin-settings_test.jsp b/xmppserver/src/main/webapp/setup/setup-admin-settings_test.jsp
index 3ce7889998..72c9547d36 100644
--- a/xmppserver/src/main/webapp/setup/setup-admin-settings_test.jsp
+++ b/xmppserver/src/main/webapp/setup/setup-admin-settings_test.jsp
@@ -43,6 +43,11 @@
                 e.printStackTrace();
             }
         }
+
+        pageContext.setAttribute( "errorDetail", errorDetail );
+        pageContext.setAttribute( "success", success );
+        pageContext.setAttribute( "hasPassword", password != null );
+        pageContext.setAttribute( "username", JID.unescapeNode(username) );
 %>
     <!-- BEGIN connection settings test panel -->
     <div class="jive-testPanel">
@@ -53,18 +58,20 @@
             </div>
 
             <h2><fmt:message key="global.test" />: <span><fmt:message key="setup.admin.settings.test.title-desc" /></span></h2>
-            <% if (password != null) { %>
-                <% if (success) { %>
-                <h4 class="jive-testSuccess"><fmt:message key="setup.admin.settings.test.status-success" /></h4>
+            <c:if test="${hasPassword}">
+                <c:choose>
+                    <c:when test="${success}">
+                        <h4 class="jive-testSuccess"><fmt:message key="setup.admin.settings.test.status-success" /></h4>
+                        <p><fmt:message key="setup.admin.settings.test.status-success.detail" /></p>
+                    </c:when>
+                    <c:otherwise>
+                        <h4 class="jive-testError"><fmt:message key="setup.admin.settings.test.status-error" /></h4>
+                        <p><c:out value="${errorDetail}"/></p>
+                    </c:otherwise>
+                </c:choose>
+            </c:if>
 
-                <p><fmt:message key="setup.admin.settings.test.status-success.detail" /></p>
-                <% } else { %>
-                <h4 class="jive-testError"><fmt:message key="setup.admin.settings.test.status-error" /></h4>
-                <p><%= errorDetail %></p>
-                <% }
-                }
-                if (!success) {
-             %>
+            <c:if test="${not success}">
             <form action="setup-admin-settings.jsp" name="testform" method="post">
                 <input type="hidden" name="ldap" value="true">
                 <input type="hidden" name="test" value="true">
@@ -74,8 +81,8 @@
                         <td class="jive-label">
                             <fmt:message key="setup.admin.settings.administrator" />:
                         </td>
-                         <td>
-                        <%= JID.unescapeNode(username) %>
+                        <td>
+                             <c:out value="${username}"/>
                         </td>
                         <td>
                             &nbsp;
@@ -94,7 +101,7 @@
                     </tr>
                 </table>
             </form>
-            <% } %>
+            </c:if>
         </div>
     </div>
     <!-- END connection settings test panel -->
@@ -104,17 +111,18 @@
     <div class="jive-testPanel-content">
 
         <h2><fmt:message key="global.test" />: <span><fmt:message key="setup.admin.settings.test.title-desc" /></span></h2>
-        <% if (password != null) { %>
-            <% if (success) { %>
-            <h4 class="jive-testSuccess"><fmt:message key="setup.admin.settings.test.status-success" /></h4>
-
-            <p><fmt:message key="setup.admin.settings.test.status-success.detail" /></p>
-            <% } else { %>
-            <h4 class="jive-testError"><fmt:message key="setup.admin.settings.test.status-error" /></h4>
-            <p><%= errorDetail %></p>
-            <% }
-            }
-        %>
+        <c:if test="${hasPassword}">
+            <c:choose>
+                <c:when test="${success}">
+                    <h4 class="jive-testSuccess"><fmt:message key="setup.admin.settings.test.status-success" /></h4>
+                    <p><fmt:message key="setup.admin.settings.test.status-success.detail" /></p>
+                </c:when>
+                <c:otherwise>
+                    <h4 class="jive-testError"><fmt:message key="setup.admin.settings.test.status-error" /></h4>
+                    <p><c:out value="${errorDetail}"/></p>
+                </c:otherwise>
+            </c:choose>
+        </c:if>
     </div>
 </div>
 <!-- END connection settings test panel -->